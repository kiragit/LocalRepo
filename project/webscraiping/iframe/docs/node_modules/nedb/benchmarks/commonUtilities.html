<!DOCTYPE html>

<html>
<head>
  <title>commonUtilities.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>commonUtilities.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
 * Functions that are used in several benchmark tests
 */</span>

<span class="hljs-keyword">var</span> customUtils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/customUtils'</span>)
  , fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
  , path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
  , Datastore = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/datastore'</span>)
  , Persistence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/persistence'</span>)
  , executeAsap   <span class="hljs-comment">// process.nextTick or setImmediate depending on your Node version</span>
  ;

<span class="hljs-keyword">try</span> {
  executeAsap = setImmediate;
} <span class="hljs-keyword">catch</span> (e) {
  executeAsap = process.nextTick;
}


<span class="hljs-comment">/**
 * Configure the benchmark
 */</span>
<span class="hljs-built_in">module</span>.exports.getConfiguration = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(benchDb)</span> </span>{
  <span class="hljs-keyword">var</span> d, n
    , program = <span class="hljs-built_in">require</span>(<span class="hljs-string">'commander'</span>)
    ;

  program
    .option(<span class="hljs-string">'-n --number [number]'</span>, <span class="hljs-string">'Size of the collection to test on'</span>, <span class="hljs-built_in">parseInt</span>)
    .option(<span class="hljs-string">'-i --with-index'</span>, <span class="hljs-string">'Use an index'</span>)
    .option(<span class="hljs-string">'-m --in-memory'</span>, <span class="hljs-string">'Test with an in-memory only store'</span>)
    .parse(process.argv);

  n = program.number || <span class="hljs-number">10000</span>;

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"----------------------------"</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Test with "</span> + n + <span class="hljs-string">" documents"</span>);
  <span class="hljs-built_in">console</span>.log(program.withIndex ? <span class="hljs-string">"Use an index"</span> : <span class="hljs-string">"Don't use an index"</span>);
  <span class="hljs-built_in">console</span>.log(program.inMemory ? <span class="hljs-string">"Use an in-memory datastore"</span> : <span class="hljs-string">"Use a persistent datastore"</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"----------------------------"</span>);

  d = <span class="hljs-keyword">new</span> Datastore({ filename: benchDb
                    , inMemoryOnly: program.inMemory
                    });

  <span class="hljs-keyword">return</span> { n: n, d: d, program: program };
};


<span class="hljs-comment">/**
 * Ensure the workspace exists and the db datafile is empty
 */</span>
<span class="hljs-built_in">module</span>.exports.prepareDb = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(filename, cb)</span> </span>{
  Persistence.ensureDirectoryExists(path.dirname(filename), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    fs.exists(filename, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(exists)</span> </span>{
      <span class="hljs-keyword">if</span> (exists) {
        fs.unlink(filename, cb);
      } <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> cb(); }
    });
  });
};


<span class="hljs-comment">/**
 * Return an array with the numbers from 0 to n-1, in a random order
 * Uses Fisher Yates algorithm
 * Useful to get fair tests
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRandomArray</span> <span class="hljs-params">(n)</span> </span>{
  <span class="hljs-keyword">var</span> res = []
    , i, j, temp
    ;

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i += <span class="hljs-number">1</span>) { res[i] = i; }

  <span class="hljs-keyword">for</span> (i = n - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">1</span>; i -= <span class="hljs-number">1</span>) {
    j = <span class="hljs-built_in">Math</span>.floor((i + <span class="hljs-number">1</span>) * <span class="hljs-built_in">Math</span>.random());
    temp = res[i];
    res[i] = res[j];
    res[j] = temp;
  }

  <span class="hljs-keyword">return</span> res;
};
<span class="hljs-built_in">module</span>.exports.getRandomArray = getRandomArray;


<span class="hljs-comment">/**
 * Insert a certain number of documents for testing
 */</span>
<span class="hljs-built_in">module</span>.exports.insertDocs = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d, n, profiler, cb)</span> </span>{
  <span class="hljs-keyword">var</span> beg = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
    , order = getRandomArray(n)
    ;

  profiler.step(<span class="hljs-string">'Begin inserting '</span> + n + <span class="hljs-string">' docs'</span>);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runFrom</span><span class="hljs-params">(i)</span> </span>{
    <span class="hljs-keyword">if</span> (i === n) {   <span class="hljs-comment">// Finished</span>
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"===== RESULT (insert) ===== "</span> + <span class="hljs-built_in">Math</span>.floor(<span class="hljs-number">1000</span>* n / profiler.elapsedSinceLastStep()) + <span class="hljs-string">" ops/s"</span>);
      profiler.step(<span class="hljs-string">'Finished inserting '</span> + n + <span class="hljs-string">' docs'</span>);
      <span class="hljs-keyword">return</span> cb();
    }

    d.insert({ docNumber: order[i] }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
      executeAsap(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        runFrom(i + <span class="hljs-number">1</span>);
      });
    });
  }
  runFrom(<span class="hljs-number">0</span>);
};


<span class="hljs-comment">/**
 * Find documents with find
 */</span>
<span class="hljs-built_in">module</span>.exports.findDocs = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d, n, profiler, cb)</span> </span>{
  <span class="hljs-keyword">var</span> beg = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
    , order = getRandomArray(n)
    ;

  profiler.step(<span class="hljs-string">"Finding "</span> + n + <span class="hljs-string">" documents"</span>);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runFrom</span><span class="hljs-params">(i)</span> </span>{
    <span class="hljs-keyword">if</span> (i === n) {   <span class="hljs-comment">// Finished</span>
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"===== RESULT (find) ===== "</span> + <span class="hljs-built_in">Math</span>.floor(<span class="hljs-number">1000</span>* n / profiler.elapsedSinceLastStep()) + <span class="hljs-string">" ops/s"</span>);
      profiler.step(<span class="hljs-string">'Finished finding '</span> + n + <span class="hljs-string">' docs'</span>);
      <span class="hljs-keyword">return</span> cb();
    }

    d.find({ docNumber: order[i] }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
      <span class="hljs-keyword">if</span> (docs.length !== <span class="hljs-number">1</span> || docs[<span class="hljs-number">0</span>].docNumber !== order[i]) { <span class="hljs-keyword">return</span> cb(<span class="hljs-string">'One find didnt work'</span>); }
      executeAsap(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        runFrom(i + <span class="hljs-number">1</span>);
      });
    });
  }
  runFrom(<span class="hljs-number">0</span>);
};


<span class="hljs-comment">/**
 * Find documents with find and the $in operator
 */</span>
<span class="hljs-built_in">module</span>.exports.findDocsWithIn = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d, n, profiler, cb)</span> </span>{
  <span class="hljs-keyword">var</span> beg = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
    , order = getRandomArray(n)
    , ins = [], i, j
    , arraySize = <span class="hljs-built_in">Math</span>.min(<span class="hljs-number">10</span>, n)   <span class="hljs-comment">// The array for $in needs to be smaller than n (inclusive)</span>
    ;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Preparing all the $in arrays, will take some time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i += <span class="hljs-number">1</span>) {
    ins[i] = [];
    
    <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; arraySize; j += <span class="hljs-number">1</span>) {
      ins[i].push((i + j) % n);
    }
  }
      
  profiler.step(<span class="hljs-string">"Finding "</span> + n + <span class="hljs-string">" documents WITH $IN OPERATOR"</span>);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runFrom</span><span class="hljs-params">(i)</span> </span>{
    <span class="hljs-keyword">if</span> (i === n) {   <span class="hljs-comment">// Finished</span>
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"===== RESULT (find with in selector) ===== "</span> + <span class="hljs-built_in">Math</span>.floor(<span class="hljs-number">1000</span>* n / profiler.elapsedSinceLastStep()) + <span class="hljs-string">" ops/s"</span>);
      profiler.step(<span class="hljs-string">'Finished finding '</span> + n + <span class="hljs-string">' docs'</span>);
      <span class="hljs-keyword">return</span> cb();
    }

    d.find({ docNumber: { $<span class="hljs-keyword">in</span>: ins[i] } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
      <span class="hljs-keyword">if</span> (docs.length !== arraySize) { <span class="hljs-keyword">return</span> cb(<span class="hljs-string">'One find didnt work'</span>); }
      executeAsap(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        runFrom(i + <span class="hljs-number">1</span>);
      });
    });
  }
  runFrom(<span class="hljs-number">0</span>);
};


<span class="hljs-comment">/**
 * Find documents with findOne
 */</span>
<span class="hljs-built_in">module</span>.exports.findOneDocs = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d, n, profiler, cb)</span> </span>{
  <span class="hljs-keyword">var</span> beg = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
    , order = getRandomArray(n)
    ;

  profiler.step(<span class="hljs-string">"FindingOne "</span> + n + <span class="hljs-string">" documents"</span>);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runFrom</span><span class="hljs-params">(i)</span> </span>{
    <span class="hljs-keyword">if</span> (i === n) {   <span class="hljs-comment">// Finished</span>
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"===== RESULT (findOne) ===== "</span> + <span class="hljs-built_in">Math</span>.floor(<span class="hljs-number">1000</span>* n / profiler.elapsedSinceLastStep()) + <span class="hljs-string">" ops/s"</span>);
      profiler.step(<span class="hljs-string">'Finished finding '</span> + n + <span class="hljs-string">' docs'</span>);
      <span class="hljs-keyword">return</span> cb();
    }

    d.findOne({ docNumber: order[i] }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
      <span class="hljs-keyword">if</span> (!doc || doc.docNumber !== order[i]) { <span class="hljs-keyword">return</span> cb(<span class="hljs-string">'One find didnt work'</span>); }
      executeAsap(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        runFrom(i + <span class="hljs-number">1</span>);
      });
    });
  }
  runFrom(<span class="hljs-number">0</span>);
};


<span class="hljs-comment">/**
 * Update documents
 * options is the same as the options object for update
 */</span>
<span class="hljs-built_in">module</span>.exports.updateDocs = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options, d, n, profiler, cb)</span> </span>{
  <span class="hljs-keyword">var</span> beg = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
    , order = getRandomArray(n)
    ;

  profiler.step(<span class="hljs-string">"Updating "</span> + n + <span class="hljs-string">" documents"</span>);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runFrom</span><span class="hljs-params">(i)</span> </span>{
    <span class="hljs-keyword">if</span> (i === n) {   <span class="hljs-comment">// Finished</span>
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"===== RESULT (update) ===== "</span> + <span class="hljs-built_in">Math</span>.floor(<span class="hljs-number">1000</span>* n / profiler.elapsedSinceLastStep()) + <span class="hljs-string">" ops/s"</span>);
      profiler.step(<span class="hljs-string">'Finished updating '</span> + n + <span class="hljs-string">' docs'</span>);
      <span class="hljs-keyword">return</span> cb();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Will not actually modify the document but will take the same time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    d.update({ docNumber: order[i] }, { docNumber: order[i] }, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
      <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> cb(err); }
      <span class="hljs-keyword">if</span> (nr !== <span class="hljs-number">1</span>) { <span class="hljs-keyword">return</span> cb(<span class="hljs-string">'One update didnt work'</span>); }
      executeAsap(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        runFrom(i + <span class="hljs-number">1</span>);
      });
    });
  }
  runFrom(<span class="hljs-number">0</span>);
};


<span class="hljs-comment">/**
 * Remove documents
 * options is the same as the options object for update
 */</span>
<span class="hljs-built_in">module</span>.exports.removeDocs = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options, d, n, profiler, cb)</span> </span>{
  <span class="hljs-keyword">var</span> beg = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
    , order = getRandomArray(n)
    ;

  profiler.step(<span class="hljs-string">"Removing "</span> + n + <span class="hljs-string">" documents"</span>);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runFrom</span><span class="hljs-params">(i)</span> </span>{
    <span class="hljs-keyword">if</span> (i === n) {   <span class="hljs-comment">// Finished</span>
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"===== RESULT (1 remove + 1 insert) ===== "</span> + <span class="hljs-built_in">Math</span>.floor(<span class="hljs-number">1000</span>* n / profiler.elapsedSinceLastStep()) + <span class="hljs-string">" ops/s"</span>);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"====== IMPORTANT: Please note that this is the time that was needed to perform "</span> + n + <span class="hljs-string">" removes and "</span> + n + <span class="hljs-string">" inserts"</span>);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"====== The extra inserts are needed to keep collection size at "</span> + n + <span class="hljs-string">" items for the benchmark to make sense"</span>);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"====== Use the insert speed logged above to calculate the actual remove speed, which is higher (should be significantly so if you use indexing)"</span>);
      profiler.step(<span class="hljs-string">'Finished removing '</span> + n + <span class="hljs-string">' docs'</span>);
      <span class="hljs-keyword">return</span> cb();
    }

    d.remove({ docNumber: order[i] }, options, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
      <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> cb(err); }
      <span class="hljs-keyword">if</span> (nr !== <span class="hljs-number">1</span>) { <span class="hljs-keyword">return</span> cb(<span class="hljs-string">'One remove didnt work'</span>); }
      d.insert({ docNumber: order[i] }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{   <span class="hljs-comment">// We need to reinsert the doc so that we keep the collection's size at n</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>So actually weâ€™re calculating the average time taken by one insert + one remove</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        executeAsap(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          runFrom(i + <span class="hljs-number">1</span>);
        });
      });
    });
  }
  runFrom(<span class="hljs-number">0</span>);
};


<span class="hljs-comment">/**
 * Load database
 */</span>
<span class="hljs-built_in">module</span>.exports.loadDatabase = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d, n, profiler, cb)</span> </span>{
  <span class="hljs-keyword">var</span> beg = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
    , order = getRandomArray(n)
    ;

  profiler.step(<span class="hljs-string">"Loading the database "</span> + n + <span class="hljs-string">" times"</span>);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runFrom</span><span class="hljs-params">(i)</span> </span>{
    <span class="hljs-keyword">if</span> (i === n) {   <span class="hljs-comment">// Finished</span>
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"===== RESULT ===== "</span> + <span class="hljs-built_in">Math</span>.floor(<span class="hljs-number">1000</span>* n / profiler.elapsedSinceLastStep()) + <span class="hljs-string">" ops/s"</span>);
      profiler.step(<span class="hljs-string">'Finished loading a database'</span> + n + <span class="hljs-string">' times'</span>);
      <span class="hljs-keyword">return</span> cb();
    }

    d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
      executeAsap(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        runFrom(i + <span class="hljs-number">1</span>);
      });
    });
  }
  runFrom(<span class="hljs-number">0</span>);
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
