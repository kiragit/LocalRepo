<!DOCTYPE html>

<html>
<head>
  <title>db.test.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>db.test.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> should = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).should()
  , assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).assert
  , testDb = <span class="hljs-string">'workspace/test.db'</span>
  , fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
  , path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
  , _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
  , async = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)
  , model = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/model'</span>)
  , Datastore = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/datastore'</span>)
  , Persistence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/persistence'</span>)
  ;


describe(<span class="hljs-string">'Database'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> d;

  beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    d = <span class="hljs-keyword">new</span> Datastore({ filename: testDb });
    d.filename.should.equal(testDb);
    d.inMemoryOnly.should.equal(<span class="hljs-literal">false</span>);

    async.waterfall([
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        Persistence.ensureDirectoryExists(path.dirname(testDb), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          fs.exists(testDb, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(exists)</span> </span>{
            <span class="hljs-keyword">if</span> (exists) {
              fs.unlink(testDb, cb);
            } <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> cb(); }
          });
        });
      }
    , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          assert.isNull(err);
          d.getAllData().length.should.equal(<span class="hljs-number">0</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
    ], done);
  });

  it(<span class="hljs-string">'Constructor compatibility with v0.6-'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> dbef = <span class="hljs-keyword">new</span> Datastore(<span class="hljs-string">'somefile'</span>);
    dbef.filename.should.equal(<span class="hljs-string">'somefile'</span>);
    dbef.inMemoryOnly.should.equal(<span class="hljs-literal">false</span>);

    <span class="hljs-keyword">var</span> dbef = <span class="hljs-keyword">new</span> Datastore(<span class="hljs-string">''</span>);
    assert.isNull(dbef.filename);
    dbef.inMemoryOnly.should.equal(<span class="hljs-literal">true</span>);

    <span class="hljs-keyword">var</span> dbef = <span class="hljs-keyword">new</span> Datastore();
    assert.isNull(dbef.filename);
    dbef.inMemoryOnly.should.equal(<span class="hljs-literal">true</span>);
  });

  describe(<span class="hljs-string">'Autoloading'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  
    it(<span class="hljs-string">'Can autoload a database and query it right away'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> fileStr = model.serialize({ _id: <span class="hljs-string">'1'</span>, a: <span class="hljs-number">5</span>, planet: <span class="hljs-string">'Earth'</span> }) + <span class="hljs-string">'\n'</span> + model.serialize({ _id: <span class="hljs-string">'2'</span>, a: <span class="hljs-number">5</span>, planet: <span class="hljs-string">'Mars'</span> }) + <span class="hljs-string">'\n'</span>
        , autoDb = <span class="hljs-string">'workspace/auto.db'</span>
        , db
        ;
      
      fs.writeFileSync(autoDb, fileStr, <span class="hljs-string">'utf8'</span>);
      db = <span class="hljs-keyword">new</span> Datastore({ filename: autoDb, autoload: <span class="hljs-literal">true</span> })
      
      db.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
        assert.isNull(err);
        docs.length.should.equal(<span class="hljs-number">2</span>);
        done();
      });
    });
    
    it(<span class="hljs-string">'Throws if autoload fails'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> fileStr = model.serialize({ _id: <span class="hljs-string">'1'</span>, a: <span class="hljs-number">5</span>, planet: <span class="hljs-string">'Earth'</span> }) + <span class="hljs-string">'\n'</span> + model.serialize({ _id: <span class="hljs-string">'2'</span>, a: <span class="hljs-number">5</span>, planet: <span class="hljs-string">'Mars'</span> }) + <span class="hljs-string">'\n'</span> + <span class="hljs-string">'{"$$indexCreated":{"fieldName":"a","unique":true}}'</span>
        , autoDb = <span class="hljs-string">'workspace/auto.db'</span>
        , db
        ;
      
      fs.writeFileSync(autoDb, fileStr, <span class="hljs-string">'utf8'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Check the loadDatabase generated an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onload</span> <span class="hljs-params">(err)</span> </span>{
        err.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);
        done();
      }
      
      db = <span class="hljs-keyword">new</span> Datastore({ filename: autoDb, autoload: <span class="hljs-literal">true</span>, onload: onload })
      
      db.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
        done(<span class="hljs-string">"Find should not be executed since autoload failed"</span>);
      });    
    });
 
  });

  describe(<span class="hljs-string">'Insert'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    it(<span class="hljs-string">'Able to insert a document in the database, setting an _id if none provided, and retrieve it even after a reload'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
        docs.length.should.equal(<span class="hljs-number">0</span>);

        d.insert({ somedata: <span class="hljs-string">'ok'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The data was correctly updated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">1</span>);
            <span class="hljs-built_in">Object</span>.keys(docs[<span class="hljs-number">0</span>]).length.should.equal(<span class="hljs-number">2</span>);
            docs[<span class="hljs-number">0</span>].somedata.should.equal(<span class="hljs-string">'ok'</span>);
            assert.isDefined(docs[<span class="hljs-number">0</span>]._id);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>After a reload the data has been correctly persisted</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                assert.isNull(err);
                docs.length.should.equal(<span class="hljs-number">1</span>);
                <span class="hljs-built_in">Object</span>.keys(docs[<span class="hljs-number">0</span>]).length.should.equal(<span class="hljs-number">2</span>);
                docs[<span class="hljs-number">0</span>].somedata.should.equal(<span class="hljs-string">'ok'</span>);
                assert.isDefined(docs[<span class="hljs-number">0</span>]._id);

                done();
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Can insert multiple documents in the database'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
        docs.length.should.equal(<span class="hljs-number">0</span>);

        d.insert({ somedata: <span class="hljs-string">'ok'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          d.insert({ somedata: <span class="hljs-string">'another'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            d.insert({ somedata: <span class="hljs-string">'again'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                docs.length.should.equal(<span class="hljs-number">3</span>);
                _.pluck(docs, <span class="hljs-string">'somedata'</span>).should.contain(<span class="hljs-string">'ok'</span>);
                _.pluck(docs, <span class="hljs-string">'somedata'</span>).should.contain(<span class="hljs-string">'another'</span>);
                _.pluck(docs, <span class="hljs-string">'somedata'</span>).should.contain(<span class="hljs-string">'again'</span>);
                done();
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Can insert and get back from DB complex objects with all primitive and secondary types'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> da = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
        , obj = { a: [<span class="hljs-string">'ee'</span>, <span class="hljs-string">'ff'</span>, <span class="hljs-number">42</span>], date: da, subobj: { a: <span class="hljs-string">'b'</span>, b: <span class="hljs-string">'c'</span> } }
        ;

      d.insert(obj, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        d.findOne({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, res)</span> </span>{
          assert.isNull(err);
          res.a.length.should.equal(<span class="hljs-number">3</span>);
          res.a[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">'ee'</span>);
          res.a[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">'ff'</span>);
          res.a[<span class="hljs-number">2</span>].should.equal(<span class="hljs-number">42</span>);
          res.date.getTime().should.equal(da.getTime());
          res.subobj.a.should.equal(<span class="hljs-string">'b'</span>);
          res.subobj.b.should.equal(<span class="hljs-string">'c'</span>);

          done();
        });
      });
    });

    it(<span class="hljs-string">'If an object returned from the DB is modified and refetched, the original value should be found'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ a: <span class="hljs-string">'something'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.findOne({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
          doc.a.should.equal(<span class="hljs-string">'something'</span>);
          doc.a = <span class="hljs-string">'another thing'</span>;
          doc.a.should.equal(<span class="hljs-string">'another thing'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Re-fetching with findOne should yield the persisted value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          d.findOne({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
            doc.a.should.equal(<span class="hljs-string">'something'</span>);
            doc.a = <span class="hljs-string">'another thing'</span>;
            doc.a.should.equal(<span class="hljs-string">'another thing'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Re-fetching with find should yield the persisted value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
              docs[<span class="hljs-number">0</span>].a.should.equal(<span class="hljs-string">'something'</span>);

              done();
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Cannot insert a doc that has a field beginning with a $ sign'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ $something: <span class="hljs-string">'atest'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        assert.isDefined(err);
        done();
      });
    });

    it(<span class="hljs-string">'If an _id is already given when we insert a document, use that instead of generating a random one'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ _id: <span class="hljs-string">'test'</span>, stuff: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc)</span> </span>{
        <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> done(err); }

        newDoc.stuff.should.equal(<span class="hljs-literal">true</span>);
        newDoc._id.should.equal(<span class="hljs-string">'test'</span>);

        d.insert({ _id: <span class="hljs-string">'test'</span>, otherstuff: <span class="hljs-number">42</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          err.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);
        
          done();
        });
      });
    });

    it(<span class="hljs-string">'Modifying the insertedDoc after an insert doesnt change the copy saved in the database'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ a: <span class="hljs-number">2</span>, hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc)</span> </span>{
        newDoc.hello = <span class="hljs-string">'changed'</span>;

        d.findOne({ a: <span class="hljs-number">2</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
          doc.hello.should.equal(<span class="hljs-string">'world'</span>);
          done();
        });
      });
    });
    
    it(<span class="hljs-string">'Can insert an array of documents at once'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> docs = [{ a: <span class="hljs-number">5</span>, b: <span class="hljs-string">'hello'</span> }, { a: <span class="hljs-number">42</span>, b: <span class="hljs-string">'world'</span> }];
    
      d.insert(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          <span class="hljs-keyword">var</span> data;
        
          docs.length.should.equal(<span class="hljs-number">2</span>);
          _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">5</span>; }).b.should.equal(<span class="hljs-string">'hello'</span>);
          _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">42</span>; }).b.should.equal(<span class="hljs-string">'world'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The data has been persisted correctly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          data = _.filter(fs.readFileSync(testDb, <span class="hljs-string">'utf8'</span>).split(<span class="hljs-string">'\n'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(line)</span> </span>{ <span class="hljs-keyword">return</span> line.length &gt; <span class="hljs-number">0</span>; });
          data.length.should.equal(<span class="hljs-number">2</span>);
          model.deserialize(data[<span class="hljs-number">0</span>]).a.should.equal(<span class="hljs-number">5</span>);
          model.deserialize(data[<span class="hljs-number">0</span>]).b.should.equal(<span class="hljs-string">'hello'</span>);
          model.deserialize(data[<span class="hljs-number">1</span>]).a.should.equal(<span class="hljs-number">42</span>);
          model.deserialize(data[<span class="hljs-number">1</span>]).b.should.equal(<span class="hljs-string">'world'</span>);
                    
          done();
        });
      });
    });
    
    it(<span class="hljs-string">'If a bulk insert violates a constraint, all changes are rolled back'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> docs = [{ a: <span class="hljs-number">5</span>, b: <span class="hljs-string">'hello'</span> }, { a: <span class="hljs-number">42</span>, b: <span class="hljs-string">'world'</span> }, { a: <span class="hljs-number">5</span>, b: <span class="hljs-string">'bloup'</span> }, { a: <span class="hljs-number">7</span> }];
    
      d.ensureIndex({ fieldName: <span class="hljs-string">'a'</span>, unique: <span class="hljs-literal">true</span> });
    
      d.insert(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        err.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);
      
        d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          docs.length.should.equal(<span class="hljs-number">0</span>);
          fs.readFileSync(testDb, <span class="hljs-string">'utf8'</span>).length.should.equal(<span class="hljs-number">0</span>);   <span class="hljs-comment">// Datafile not written to</span>

          done();
        });
      });
    });
    
    <span class="hljs-comment">/**
     * Complicated behavior here. Basically we need to test that when a user function throws an exception, it is not caught
     * in NeDB and the callback called again, transforming a user error into a NeDB error.
     *
     * So we need a way to check that the callback is called only once and the exception thrown is indeed the client exception
     * Mocha's exception handling mechanism interferes with this since it already registers a listener on uncaughtException
     * which we need to use since findOne is not called in the same turn of the event loop (so no try/catch)
     * So we remove all current listeners, put our own which when called will register the former listeners (incl. Mocha's) again.
     *
     * Note: maybe using an in-memory only NeDB would give us an easier solution
     */</span>
    it(<span class="hljs-string">'If the callback throws an uncaught execption, dont catch it inside findOne, this is userspace concern'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> tryCount = <span class="hljs-number">0</span>
        , currentUncaughtExceptionHandlers = process.listeners(<span class="hljs-string">'uncaughtException'</span>)
        , i
        ;

      process.removeAllListeners(<span class="hljs-string">'uncaughtException'</span>);
      
      process.on(<span class="hljs-string">'uncaughtException'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MINE</span> <span class="hljs-params">(ex)</span> </span>{
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; currentUncaughtExceptionHandlers.length; i += <span class="hljs-number">1</span>) {
          process.on(<span class="hljs-string">'uncaughtException'</span>, currentUncaughtExceptionHandlers[i]);
        }
      
        ex.should.equal(<span class="hljs-string">'SOME EXCEPTION'</span>);
        done();
      });

      d.insert({ a: <span class="hljs-number">5</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.findOne({ a : <span class="hljs-number">5</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{            
          <span class="hljs-keyword">if</span> (tryCount === <span class="hljs-number">0</span>) {
            tryCount += <span class="hljs-number">1</span>;
            <span class="hljs-keyword">throw</span> <span class="hljs-string">'SOME EXCEPTION'</span>;
          } <span class="hljs-keyword">else</span> {
            done(<span class="hljs-string">'Callback was called twice'</span>);
          }
        });
      });      
    });

  });   <span class="hljs-comment">// ==== End of 'Insert' ==== //</span>


  describe(<span class="hljs-string">'#getCandidates'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    it(<span class="hljs-string">'Can use an index to get docs with a basic match'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.ensureIndex({ fieldName: <span class="hljs-string">'tf'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        d.insert({ tf: <span class="hljs-number">4</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc1)</span> </span>{
          d.insert({ tf: <span class="hljs-number">6</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            d.insert({ tf: <span class="hljs-number">4</span>, an: <span class="hljs-string">'other'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc2)</span> </span>{
              d.insert({ tf: <span class="hljs-number">9</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">var</span> data = d.getCandidates({ r: <span class="hljs-number">6</span>, tf: <span class="hljs-number">4</span> })
                  , doc1 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === _doc1._id; })
                  , doc2 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === _doc2._id; })
                  ;

                data.length.should.equal(<span class="hljs-number">2</span>);
                assert.deepEqual(doc1, { _id: doc1._id, tf: <span class="hljs-number">4</span> });
                assert.deepEqual(doc2, { _id: doc2._id, tf: <span class="hljs-number">4</span>, an: <span class="hljs-string">'other'</span> });

                done();
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Can use an index to get docs with a $in match'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.ensureIndex({ fieldName: <span class="hljs-string">'tf'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        d.insert({ tf: <span class="hljs-number">4</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          d.insert({ tf: <span class="hljs-number">6</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc1)</span> </span>{
            d.insert({ tf: <span class="hljs-number">4</span>, an: <span class="hljs-string">'other'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              d.insert({ tf: <span class="hljs-number">9</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc2)</span> </span>{
                <span class="hljs-keyword">var</span> data = d.getCandidates({ r: <span class="hljs-number">6</span>, tf: { $<span class="hljs-keyword">in</span>: [<span class="hljs-number">6</span>, <span class="hljs-number">9</span>, <span class="hljs-number">5</span>] } })
                  , doc1 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === _doc1._id; })
                  , doc2 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === _doc2._id; })
                  ;

                data.length.should.equal(<span class="hljs-number">2</span>);
                assert.deepEqual(doc1, { _id: doc1._id, tf: <span class="hljs-number">6</span> });
                assert.deepEqual(doc2, { _id: doc2._id, tf: <span class="hljs-number">9</span> });

                done();
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'If no index can be used, return the whole database'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.ensureIndex({ fieldName: <span class="hljs-string">'tf'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        d.insert({ tf: <span class="hljs-number">4</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc1)</span> </span>{
          d.insert({ tf: <span class="hljs-number">6</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc2)</span> </span>{
            d.insert({ tf: <span class="hljs-number">4</span>, an: <span class="hljs-string">'other'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc3)</span> </span>{
              d.insert({ tf: <span class="hljs-number">9</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc4)</span> </span>{
                <span class="hljs-keyword">var</span> data = d.getCandidates({ r: <span class="hljs-number">6</span>, notf: { $<span class="hljs-keyword">in</span>: [<span class="hljs-number">6</span>, <span class="hljs-number">9</span>, <span class="hljs-number">5</span>] } })
                  , doc1 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === _doc1._id; })
                  , doc2 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === _doc2._id; })
                  , doc3 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === _doc3._id; })
                  , doc4 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === _doc4._id; })
                  ;

                data.length.should.equal(<span class="hljs-number">4</span>);
                assert.deepEqual(doc1, { _id: doc1._id, tf: <span class="hljs-number">4</span> });
                assert.deepEqual(doc2, { _id: doc2._id, tf: <span class="hljs-number">6</span> });
                assert.deepEqual(doc3, { _id: doc3._id, tf: <span class="hljs-number">4</span>, an: <span class="hljs-string">'other'</span> });
                assert.deepEqual(doc4, { _id: doc4._id, tf: <span class="hljs-number">9</span> });

                done();
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Can use indexes for comparison matches'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.ensureIndex({ fieldName: <span class="hljs-string">'tf'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        d.insert({ tf: <span class="hljs-number">4</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc1)</span> </span>{
          d.insert({ tf: <span class="hljs-number">6</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc2)</span> </span>{
            d.insert({ tf: <span class="hljs-number">4</span>, an: <span class="hljs-string">'other'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc3)</span> </span>{
              d.insert({ tf: <span class="hljs-number">9</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc4)</span> </span>{
                <span class="hljs-keyword">var</span> data = d.getCandidates({ r: <span class="hljs-number">6</span>, tf: { $lte: <span class="hljs-number">9</span>, $gte: <span class="hljs-number">6</span> } })
                  , doc2 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === _doc2._id; })
                  , doc4 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === _doc4._id; })
                  ;

                data.length.should.equal(<span class="hljs-number">2</span>);
                assert.deepEqual(doc2, { _id: doc2._id, tf: <span class="hljs-number">6</span> });
                assert.deepEqual(doc4, { _id: doc4._id, tf: <span class="hljs-number">9</span> });

                done();
              });
            });
          });
        });
      });
    });

  });   <span class="hljs-comment">// ==== End of '#getCandidates' ==== //</span>


  describe(<span class="hljs-string">'Find'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    it(<span class="hljs-string">'Can find all documents if an empty query is used'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      async.waterfall([
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.insert({ somedata: <span class="hljs-string">'ok'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          d.insert({ somedata: <span class="hljs-string">'another'</span>, plus: <span class="hljs-string">'additional data'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            d.insert({ somedata: <span class="hljs-string">'again'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{ <span class="hljs-keyword">return</span> cb(err); });
          });
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{   <span class="hljs-comment">// Test with empty object</span>
        d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isNull(err);
          docs.length.should.equal(<span class="hljs-number">3</span>);
          _.pluck(docs, <span class="hljs-string">'somedata'</span>).should.contain(<span class="hljs-string">'ok'</span>);
          _.pluck(docs, <span class="hljs-string">'somedata'</span>).should.contain(<span class="hljs-string">'another'</span>);
          _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d.somedata === <span class="hljs-string">'another'</span> }).plus.should.equal(<span class="hljs-string">'additional data'</span>);
          _.pluck(docs, <span class="hljs-string">'somedata'</span>).should.contain(<span class="hljs-string">'again'</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      ], done);
    });

    it(<span class="hljs-string">'Can find all documents matching a basic query'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      async.waterfall([
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.insert({ somedata: <span class="hljs-string">'ok'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          d.insert({ somedata: <span class="hljs-string">'again'</span>, plus: <span class="hljs-string">'additional data'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            d.insert({ somedata: <span class="hljs-string">'again'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{ <span class="hljs-keyword">return</span> cb(err); });
          });
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{   <span class="hljs-comment">// Test with query that will return docs</span>
        d.find({ somedata: <span class="hljs-string">'again'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isNull(err);
          docs.length.should.equal(<span class="hljs-number">2</span>);
          _.pluck(docs, <span class="hljs-string">'somedata'</span>).should.not.contain(<span class="hljs-string">'ok'</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{   <span class="hljs-comment">// Test with query that doesn't match anything</span>
        d.find({ somedata: <span class="hljs-string">'nope'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isNull(err);
          docs.length.should.equal(<span class="hljs-number">0</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      ], done);
    });

    it(<span class="hljs-string">'Can find one document matching a basic query and return null if none is found'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      async.waterfall([
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.insert({ somedata: <span class="hljs-string">'ok'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          d.insert({ somedata: <span class="hljs-string">'again'</span>, plus: <span class="hljs-string">'additional data'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            d.insert({ somedata: <span class="hljs-string">'again'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{ <span class="hljs-keyword">return</span> cb(err); });
          });
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{   <span class="hljs-comment">// Test with query that will return docs</span>
        d.findOne({ somedata: <span class="hljs-string">'ok'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
          assert.isNull(err);
          <span class="hljs-built_in">Object</span>.keys(doc).length.should.equal(<span class="hljs-number">2</span>);
          doc.somedata.should.equal(<span class="hljs-string">'ok'</span>);
          assert.isDefined(doc._id);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{   <span class="hljs-comment">// Test with query that doesn't match anything</span>
        d.findOne({ somedata: <span class="hljs-string">'nope'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
          assert.isNull(err);
          assert.isNull(doc);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      ], done);
    });

    it(<span class="hljs-string">'Can find dates and objects (non JS-native types)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> date1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">1234543</span>)
        , date2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">9999</span>)
        ;

      d.insert({ now: date1, sth: { name: <span class="hljs-string">'nedb'</span> } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.findOne({ now: date1 }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
          assert.isNull(err);
          doc.sth.name.should.equal(<span class="hljs-string">'nedb'</span>);

          d.findOne({ now: date2 }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
            assert.isNull(err);
            assert.isNull(doc);

            d.findOne({ sth: { name: <span class="hljs-string">'nedb'</span> } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
              assert.isNull(err);
              doc.sth.name.should.equal(<span class="hljs-string">'nedb'</span>);

              d.findOne({ sth: { name: <span class="hljs-string">'other'</span> } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
                assert.isNull(err);
                assert.isNull(doc);

                done();
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Can use dot-notation to query subfields'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ greeting: { english: <span class="hljs-string">'hello'</span> } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.findOne({ <span class="hljs-string">"greeting.english"</span>: <span class="hljs-string">'hello'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
          assert.isNull(err);
          doc.greeting.english.should.equal(<span class="hljs-string">'hello'</span>);

          d.findOne({ <span class="hljs-string">"greeting.english"</span>: <span class="hljs-string">'hellooo'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
            assert.isNull(err);
            assert.isNull(doc);

            d.findOne({ <span class="hljs-string">"greeting.englis"</span>: <span class="hljs-string">'hello'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
              assert.isNull(err);
              assert.isNull(doc);

              done();
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Array fields match if any element matches'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ fruits: [<span class="hljs-string">'pear'</span>, <span class="hljs-string">'apple'</span>, <span class="hljs-string">'banana'</span>] }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
        d.insert({ fruits: [<span class="hljs-string">'coconut'</span>, <span class="hljs-string">'orange'</span>, <span class="hljs-string">'pear'</span>] }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
          d.insert({ fruits: [<span class="hljs-string">'banana'</span>] }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc3)</span> </span>{
            d.find({ fruits: <span class="hljs-string">'pear'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
              assert.isNull(err);
              docs.length.should.equal(<span class="hljs-number">2</span>);
              _.pluck(docs, <span class="hljs-string">'_id'</span>).should.contain(doc1._id);
              _.pluck(docs, <span class="hljs-string">'_id'</span>).should.contain(doc2._id);

              d.find({ fruits: <span class="hljs-string">'banana'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                assert.isNull(err);
                docs.length.should.equal(<span class="hljs-number">2</span>);
                _.pluck(docs, <span class="hljs-string">'_id'</span>).should.contain(doc1._id);
                _.pluck(docs, <span class="hljs-string">'_id'</span>).should.contain(doc3._id);

                d.find({ fruits: <span class="hljs-string">'doesntexist'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                  assert.isNull(err);
                  docs.length.should.equal(<span class="hljs-number">0</span>);

                  done();
                });
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Returns an error if the query is not well formed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.find({ $or: { hello: <span class="hljs-string">'world'</span> } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isDefined(err);
          assert.isUndefined(docs);

          d.findOne({ $or: { hello: <span class="hljs-string">'world'</span> } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
            assert.isDefined(err);
            assert.isUndefined(doc);

            done();
          });
        });
      });
    });

    it(<span class="hljs-string">'Changing the documents returned by find or findOne do not change the database state'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ a: <span class="hljs-number">2</span>, hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.findOne({ a: <span class="hljs-number">2</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
          doc.hello = <span class="hljs-string">'changed'</span>;

          d.findOne({ a: <span class="hljs-number">2</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
            doc.hello.should.equal(<span class="hljs-string">'world'</span>);

            d.find({ a: <span class="hljs-number">2</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
              docs[<span class="hljs-number">0</span>].hello = <span class="hljs-string">'changed'</span>;

              d.findOne({ a: <span class="hljs-number">2</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
                doc.hello.should.equal(<span class="hljs-string">'world'</span>);

                done();
              });
            });
          });
        });
      });
    });
    
    it(<span class="hljs-string">'Can use sort, skip and limit if the callback is not passed to find but to exec'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ a: <span class="hljs-number">2</span>, hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.insert({ a: <span class="hljs-number">24</span>, hello: <span class="hljs-string">'earth'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          d.insert({ a: <span class="hljs-number">13</span>, hello: <span class="hljs-string">'blueplanet'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            d.insert({ a: <span class="hljs-number">15</span>, hello: <span class="hljs-string">'home'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
              d.find({}).sort({ a: <span class="hljs-number">1</span> }).limit(<span class="hljs-number">2</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                assert.isNull(err);
                docs.length.should.equal(<span class="hljs-number">2</span>);
                docs[<span class="hljs-number">0</span>].hello.should.equal(<span class="hljs-string">'world'</span>);
                docs[<span class="hljs-number">1</span>].hello.should.equal(<span class="hljs-string">'blueplanet'</span>);
                done();
              });
            });
          });
        });      
      });
    });

     it(<span class="hljs-string">'Can use sort and skip if the callback is not passed to findOne but to exec'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ a: <span class="hljs-number">2</span>, hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.insert({ a: <span class="hljs-number">24</span>, hello: <span class="hljs-string">'earth'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          d.insert({ a: <span class="hljs-number">13</span>, hello: <span class="hljs-string">'blueplanet'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            d.insert({ a: <span class="hljs-number">15</span>, hello: <span class="hljs-string">'home'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>No skip no query</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              d.findOne({}).sort({ a: <span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
                assert.isNull(err);
                doc.hello.should.equal(<span class="hljs-string">'world'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>A query</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                d.findOne({ a: { $gt: <span class="hljs-number">14</span> } }).sort({ a: <span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
                  assert.isNull(err);
                  doc.hello.should.equal(<span class="hljs-string">'home'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>And a skip</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  d.findOne({ a: { $gt: <span class="hljs-number">14</span> } }).sort({ a: <span class="hljs-number">1</span> }).skip(<span class="hljs-number">1</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
                    assert.isNull(err);
                    doc.hello.should.equal(<span class="hljs-string">'earth'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>No result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    d.findOne({ a: { $gt: <span class="hljs-number">14</span> } }).sort({ a: <span class="hljs-number">1</span> }).skip(<span class="hljs-number">2</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
                      assert.isNull(err);
                      assert.isNull(doc);

                      done();
                    });
                  });
                });
              });
            });
          });
        });      
      });
    });   

  });   <span class="hljs-comment">// ==== End of 'Find' ==== //</span>

  describe(<span class="hljs-string">'Count'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    it(<span class="hljs-string">'Count all documents if an empty query is used'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      async.waterfall([
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.insert({ somedata: <span class="hljs-string">'ok'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          d.insert({ somedata: <span class="hljs-string">'another'</span>, plus: <span class="hljs-string">'additional data'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            d.insert({ somedata: <span class="hljs-string">'again'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{ <span class="hljs-keyword">return</span> cb(err); });
          });
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{   <span class="hljs-comment">// Test with empty object</span>
        d.count({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isNull(err);
          docs.should.equal(<span class="hljs-number">3</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      ], done);
    });

    it(<span class="hljs-string">'Count all documents matching a basic query'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      async.waterfall([
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.insert({ somedata: <span class="hljs-string">'ok'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          d.insert({ somedata: <span class="hljs-string">'again'</span>, plus: <span class="hljs-string">'additional data'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            d.insert({ somedata: <span class="hljs-string">'again'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{ <span class="hljs-keyword">return</span> cb(err); });
          });
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{   <span class="hljs-comment">// Test with query that will return docs</span>
        d.count({ somedata: <span class="hljs-string">'again'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isNull(err);
          docs.should.equal(<span class="hljs-number">2</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{   <span class="hljs-comment">// Test with query that doesn't match anything</span>
        d.count({ somedata: <span class="hljs-string">'nope'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isNull(err);
          docs.should.equal(<span class="hljs-number">0</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      ], done);
    });

    it(<span class="hljs-string">'Array fields match if any element matches'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ fruits: [<span class="hljs-string">'pear'</span>, <span class="hljs-string">'apple'</span>, <span class="hljs-string">'banana'</span>] }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
        d.insert({ fruits: [<span class="hljs-string">'coconut'</span>, <span class="hljs-string">'orange'</span>, <span class="hljs-string">'pear'</span>] }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
          d.insert({ fruits: [<span class="hljs-string">'banana'</span>] }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc3)</span> </span>{
            d.count({ fruits: <span class="hljs-string">'pear'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
              assert.isNull(err);
              docs.should.equal(<span class="hljs-number">2</span>);

              d.count({ fruits: <span class="hljs-string">'banana'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                assert.isNull(err);
                docs.should.equal(<span class="hljs-number">2</span>);

                d.count({ fruits: <span class="hljs-string">'doesntexist'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                  assert.isNull(err);
                  docs.should.equal(<span class="hljs-number">0</span>);

                  done();
                });
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Returns an error if the query is not well formed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.count({ $or: { hello: <span class="hljs-string">'world'</span> } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isDefined(err);
          assert.isUndefined(docs);

          done();
        });
      });
    });

  }); 

  describe(<span class="hljs-string">'Update'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    it(<span class="hljs-string">"If the query doesn't match anything, database is not modified"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      async.waterfall([
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.insert({ somedata: <span class="hljs-string">'ok'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          d.insert({ somedata: <span class="hljs-string">'again'</span>, plus: <span class="hljs-string">'additional data'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            d.insert({ somedata: <span class="hljs-string">'another'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{ <span class="hljs-keyword">return</span> cb(err); });
          });
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{   <span class="hljs-comment">// Test with query that doesn't match anything</span>
        d.update({ somedata: <span class="hljs-string">'nope'</span> }, { newDoc: <span class="hljs-string">'yes'</span> }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, n)</span> </span>{
          assert.isNull(err);
          n.should.equal(<span class="hljs-number">0</span>);

          d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            <span class="hljs-keyword">var</span> doc1 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d.somedata === <span class="hljs-string">'ok'</span>; })
              , doc2 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d.somedata === <span class="hljs-string">'again'</span>; })
              , doc3 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d.somedata === <span class="hljs-string">'another'</span>; })
              ;

            docs.length.should.equal(<span class="hljs-number">3</span>);
            assert.isUndefined(_.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d.newDoc === <span class="hljs-string">'yes'</span>; }));

            assert.deepEqual(doc1, { _id: doc1._id, somedata: <span class="hljs-string">'ok'</span> });
            assert.deepEqual(doc2, { _id: doc2._id, somedata: <span class="hljs-string">'again'</span>, plus: <span class="hljs-string">'additional data'</span> });
            assert.deepEqual(doc3, { _id: doc3._id, somedata: <span class="hljs-string">'another'</span> });

            <span class="hljs-keyword">return</span> cb();
          });
        });
      }
      ], done);
    });

    it(<span class="hljs-string">"Can update multiple documents matching the query"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> id1, id2, id3;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Test DB state after update and reload</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testPostUpdateState</span> <span class="hljs-params">(cb)</span> </span>{
        d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          <span class="hljs-keyword">var</span> doc1 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === id1; })
            , doc2 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === id2; })
            , doc3 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === id3; })
            ;

          docs.length.should.equal(<span class="hljs-number">3</span>);

          <span class="hljs-built_in">Object</span>.keys(doc1).length.should.equal(<span class="hljs-number">2</span>);
          doc1.somedata.should.equal(<span class="hljs-string">'ok'</span>);
          doc1._id.should.equal(id1);

          <span class="hljs-built_in">Object</span>.keys(doc2).length.should.equal(<span class="hljs-number">2</span>);
          doc2.newDoc.should.equal(<span class="hljs-string">'yes'</span>);
          doc2._id.should.equal(id2);

          <span class="hljs-built_in">Object</span>.keys(doc3).length.should.equal(<span class="hljs-number">2</span>);
          doc3.newDoc.should.equal(<span class="hljs-string">'yes'</span>);
          doc3._id.should.equal(id3);

          <span class="hljs-keyword">return</span> cb();
        });
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Actually launch the tests</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      async.waterfall([
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.insert({ somedata: <span class="hljs-string">'ok'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
          id1 = doc1._id;
          d.insert({ somedata: <span class="hljs-string">'again'</span>, plus: <span class="hljs-string">'additional data'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
            id2 = doc2._id;
            d.insert({ somedata: <span class="hljs-string">'again'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc3)</span> </span>{
              id3 = doc3._id;
              <span class="hljs-keyword">return</span> cb(err);
            });
          });
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.update({ somedata: <span class="hljs-string">'again'</span> }, { newDoc: <span class="hljs-string">'yes'</span> }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, n)</span> </span>{
          assert.isNull(err);
          n.should.equal(<span class="hljs-number">2</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      , async.apply(testPostUpdateState)
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{ cb(err); });
      }
      , async.apply(testPostUpdateState)
      ], done);
    });

    it(<span class="hljs-string">"Can update only one document matching the query"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> id1, id2, id3;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Test DB state after update and reload</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testPostUpdateState</span> <span class="hljs-params">(cb)</span> </span>{
        d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          <span class="hljs-keyword">var</span> doc1 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === id1; })
            , doc2 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === id2; })
            , doc3 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === id3; })
            ;

          docs.length.should.equal(<span class="hljs-number">3</span>);

          assert.deepEqual(doc1, { somedata: <span class="hljs-string">'ok'</span>, _id: doc1._id });</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>doc2 or doc3 was modified. Since we sort on _id and it is random
it can be either of two situations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">try</span> {
            assert.deepEqual(doc2, { newDoc: <span class="hljs-string">'yes'</span>, _id: doc2._id });
            assert.deepEqual(doc3, { somedata: <span class="hljs-string">'again'</span>, _id: doc3._id });
          } <span class="hljs-keyword">catch</span> (e) {
            assert.deepEqual(doc2, { somedata: <span class="hljs-string">'again'</span>, plus: <span class="hljs-string">'additional data'</span>, _id: doc2._id });
            assert.deepEqual(doc3, { newDoc: <span class="hljs-string">'yes'</span>, _id: doc3._id });
          }

          <span class="hljs-keyword">return</span> cb();
        });
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Actually launch the test</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      async.waterfall([
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.insert({ somedata: <span class="hljs-string">'ok'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
          id1 = doc1._id;
          d.insert({ somedata: <span class="hljs-string">'again'</span>, plus: <span class="hljs-string">'additional data'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
            id2 = doc2._id;
            d.insert({ somedata: <span class="hljs-string">'again'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc3)</span> </span>{
              id3 = doc3._id;
              <span class="hljs-keyword">return</span> cb(err);
            });
          });
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{   <span class="hljs-comment">// Test with query that doesn't match anything</span>
        d.update({ somedata: <span class="hljs-string">'again'</span> }, { newDoc: <span class="hljs-string">'yes'</span> }, { multi: <span class="hljs-literal">false</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, n)</span> </span>{
          assert.isNull(err);
          n.should.equal(<span class="hljs-number">1</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      , async.apply(testPostUpdateState)
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{ <span class="hljs-keyword">return</span> cb(err); });
      }
      , async.apply(testPostUpdateState)   <span class="hljs-comment">// The persisted state has been updated</span>
      ], done);
    });

    it(<span class="hljs-string">'Can perform upserts if needed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.update({ impossible: <span class="hljs-string">'db is empty anyway'</span> }, { newDoc: <span class="hljs-literal">true</span> }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr, upsert)</span> </span>{
        assert.isNull(err);
        nr.should.equal(<span class="hljs-number">0</span>);
        assert.isUndefined(upsert);

        d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          docs.length.should.equal(<span class="hljs-number">0</span>);   <span class="hljs-comment">// Default option for upsert is false</span>

          d.update({ impossible: <span class="hljs-string">'db is empty anyway'</span> }, { something: <span class="hljs-string">"created ok"</span> }, { upsert: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr, newDoc)</span> </span>{
            assert.isNull(err);
            nr.should.equal(<span class="hljs-number">1</span>);
            newDoc.something.should.equal(<span class="hljs-string">"created ok"</span>);
            assert.isDefined(newDoc._id);

            d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
              docs.length.should.equal(<span class="hljs-number">1</span>);   <span class="hljs-comment">// Default option for upsert is false</span>
              docs[<span class="hljs-number">0</span>].something.should.equal(<span class="hljs-string">"created ok"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Modifying the returned upserted document doesn’t modify the database</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              newDoc.newField = <span class="hljs-literal">true</span>;
              d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                docs[<span class="hljs-number">0</span>].something.should.equal(<span class="hljs-string">"created ok"</span>);
                assert.isUndefined(docs[<span class="hljs-number">0</span>].newField);
              
                done();
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Cannot perform update if the update query is not either registered-modifiers-only or copy-only, or contain badly formatted fields'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ something: <span class="hljs-string">'yup'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.update({}, { boom: { $badfield: <span class="hljs-number">5</span> } }, { multi: <span class="hljs-literal">false</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          assert.isDefined(err);

          d.update({}, { boom: { <span class="hljs-string">"bad.field"</span>: <span class="hljs-number">5</span> } }, { multi: <span class="hljs-literal">false</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            assert.isDefined(err);

            d.update({}, { $inc: { test: <span class="hljs-number">5</span> }, mixed: <span class="hljs-string">'rrr'</span> }, { multi: <span class="hljs-literal">false</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              assert.isDefined(err);

              d.update({}, { $inexistent: { test: <span class="hljs-number">5</span> } }, { multi: <span class="hljs-literal">false</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                assert.isDefined(err);

                done();
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Can update documents using multiple modifiers'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> id;

      d.insert({ something: <span class="hljs-string">'yup'</span>, other: <span class="hljs-number">40</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc)</span> </span>{
        id = newDoc._id;

        d.update({}, { $set: { something: <span class="hljs-string">'changed'</span> }, $inc: { other: <span class="hljs-number">10</span> } }, { multi: <span class="hljs-literal">false</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
          assert.isNull(err);
          nr.should.equal(<span class="hljs-number">1</span>);

          d.findOne({ _id: id }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
            <span class="hljs-built_in">Object</span>.keys(doc).length.should.equal(<span class="hljs-number">3</span>);
            doc._id.should.equal(id);
            doc.something.should.equal(<span class="hljs-string">'changed'</span>);
            doc.other.should.equal(<span class="hljs-number">50</span>);

            done();
          });
        });
      });
    });

    it(<span class="hljs-string">'Can upsert a document even with modifiers'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.update({ bloup: <span class="hljs-string">'blap'</span> }, { $set: { hello: <span class="hljs-string">'world'</span> } }, { upsert: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr, newDoc)</span> </span>{
        assert.isNull(err);
        nr.should.equal(<span class="hljs-number">1</span>);
        newDoc.bloup.should.equal(<span class="hljs-string">'blap'</span>);
        newDoc.hello.should.equal(<span class="hljs-string">'world'</span>);
        assert.isDefined(newDoc._id);

        d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          docs.length.should.equal(<span class="hljs-number">1</span>);
          <span class="hljs-built_in">Object</span>.keys(docs[<span class="hljs-number">0</span>]).length.should.equal(<span class="hljs-number">3</span>);
          docs[<span class="hljs-number">0</span>].hello.should.equal(<span class="hljs-string">'world'</span>);
          docs[<span class="hljs-number">0</span>].bloup.should.equal(<span class="hljs-string">'blap'</span>);
          assert.isDefined(docs[<span class="hljs-number">0</span>]._id);

          done();
        });
      });
    });

    it(<span class="hljs-string">'When using modifiers, the only way to update subdocs is with the dot-notation'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ bloup: { blip: <span class="hljs-string">"blap"</span>, other: <span class="hljs-literal">true</span> } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Correct methos</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        d.update({}, { $set: { <span class="hljs-string">"bloup.blip"</span>: <span class="hljs-string">"hello"</span> } }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          d.findOne({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
            doc.bloup.blip.should.equal(<span class="hljs-string">"hello"</span>);
            doc.bloup.other.should.equal(<span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Wrong</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            d.update({}, { $set: { bloup: { blip: <span class="hljs-string">"ola"</span> } } }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
              d.findOne({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
                doc.bloup.blip.should.equal(<span class="hljs-string">"ola"</span>);
                assert.isUndefined(doc.bloup.other);   <span class="hljs-comment">// This information was lost</span>

                done();
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Returns an error if the query is not well formed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.update({ $or: { hello: <span class="hljs-string">'world'</span> } }, { a: <span class="hljs-number">1</span> }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr, upsert)</span> </span>{
          assert.isDefined(err);
          assert.isUndefined(nr);
          assert.isUndefined(upsert);

          done();
        });
      });
    });

    it(<span class="hljs-string">'If an error is thrown by a modifier, the database state is not changed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc)</span> </span>{
        d.update({}, { $inc: { hello: <span class="hljs-number">4</span> } }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
          assert.isDefined(err);
          assert.isUndefined(nr);

          d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.deepEqual(docs, [ { _id: newDoc._id, hello: <span class="hljs-string">'world'</span> } ]);

            done();
          });
        });
      });
    });

    it(<span class="hljs-string">'Cant change the _id of a document'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ a: <span class="hljs-number">2</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc)</span> </span>{
        d.update({ a: <span class="hljs-number">2</span> }, { a: <span class="hljs-number">2</span>, _id: <span class="hljs-string">'nope'</span> }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          assert.isDefined(err);

          d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">1</span>);
            <span class="hljs-built_in">Object</span>.keys(docs[<span class="hljs-number">0</span>]).length.should.equal(<span class="hljs-number">2</span>);
            docs[<span class="hljs-number">0</span>].a.should.equal(<span class="hljs-number">2</span>);
            docs[<span class="hljs-number">0</span>]._id.should.equal(newDoc._id);

            d.update({ a: <span class="hljs-number">2</span> }, { $set: { _id: <span class="hljs-string">'nope'</span> } }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              assert.isDefined(err);

              d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                docs.length.should.equal(<span class="hljs-number">1</span>);
                <span class="hljs-built_in">Object</span>.keys(docs[<span class="hljs-number">0</span>]).length.should.equal(<span class="hljs-number">2</span>);
                docs[<span class="hljs-number">0</span>].a.should.equal(<span class="hljs-number">2</span>);
                docs[<span class="hljs-number">0</span>]._id.should.equal(newDoc._id);

                done();
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Non-multi updates are persistent'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ a:<span class="hljs-number">1</span>, hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
        d.insert({ a:<span class="hljs-number">2</span>, hello: <span class="hljs-string">'earth'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
          d.update({ a: <span class="hljs-number">2</span> }, { $set: { hello: <span class="hljs-string">'changed'</span> } }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            assert.isNull(err);

            d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
              docs.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{ <span class="hljs-keyword">return</span> a.a - b.a; });
              docs.length.should.equal(<span class="hljs-number">2</span>);
              _.isEqual(docs[<span class="hljs-number">0</span>], { _id: doc1._id, a:<span class="hljs-number">1</span>, hello: <span class="hljs-string">'world'</span> }).should.equal(<span class="hljs-literal">true</span>);
              _.isEqual(docs[<span class="hljs-number">1</span>], { _id: doc2._id, a:<span class="hljs-number">2</span>, hello: <span class="hljs-string">'changed'</span> }).should.equal(<span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Even after a reload the database state hasn’t changed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                assert.isNull(err);

                d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                  docs.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{ <span class="hljs-keyword">return</span> a.a - b.a; });
                  docs.length.should.equal(<span class="hljs-number">2</span>);
                  _.isEqual(docs[<span class="hljs-number">0</span>], { _id: doc1._id, a:<span class="hljs-number">1</span>, hello: <span class="hljs-string">'world'</span> }).should.equal(<span class="hljs-literal">true</span>);
                  _.isEqual(docs[<span class="hljs-number">1</span>], { _id: doc2._id, a:<span class="hljs-number">2</span>, hello: <span class="hljs-string">'changed'</span> }).should.equal(<span class="hljs-literal">true</span>);

                  done();
                });
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Multi updates are persistent'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ a:<span class="hljs-number">1</span>, hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
        d.insert({ a:<span class="hljs-number">2</span>, hello: <span class="hljs-string">'earth'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
          d.insert({ a:<span class="hljs-number">5</span>, hello: <span class="hljs-string">'pluton'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc3)</span> </span>{
            d.update({ a: { $<span class="hljs-keyword">in</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>] } }, { $set: { hello: <span class="hljs-string">'changed'</span> } }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              assert.isNull(err);

              d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                docs.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{ <span class="hljs-keyword">return</span> a.a - b.a; });
                docs.length.should.equal(<span class="hljs-number">3</span>);
                _.isEqual(docs[<span class="hljs-number">0</span>], { _id: doc1._id, a:<span class="hljs-number">1</span>, hello: <span class="hljs-string">'changed'</span> }).should.equal(<span class="hljs-literal">true</span>);
                _.isEqual(docs[<span class="hljs-number">1</span>], { _id: doc2._id, a:<span class="hljs-number">2</span>, hello: <span class="hljs-string">'changed'</span> }).should.equal(<span class="hljs-literal">true</span>);
                _.isEqual(docs[<span class="hljs-number">2</span>], { _id: doc3._id, a:<span class="hljs-number">5</span>, hello: <span class="hljs-string">'pluton'</span> }).should.equal(<span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Even after a reload the database state hasn’t changed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                  assert.isNull(err);

                  d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                    docs.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{ <span class="hljs-keyword">return</span> a.a - b.a; });
                    docs.length.should.equal(<span class="hljs-number">3</span>);
                    _.isEqual(docs[<span class="hljs-number">0</span>], { _id: doc1._id, a:<span class="hljs-number">1</span>, hello: <span class="hljs-string">'changed'</span> }).should.equal(<span class="hljs-literal">true</span>);
                    _.isEqual(docs[<span class="hljs-number">1</span>], { _id: doc2._id, a:<span class="hljs-number">2</span>, hello: <span class="hljs-string">'changed'</span> }).should.equal(<span class="hljs-literal">true</span>);
                    _.isEqual(docs[<span class="hljs-number">2</span>], { _id: doc3._id, a:<span class="hljs-number">5</span>, hello: <span class="hljs-string">'pluton'</span> }).should.equal(<span class="hljs-literal">true</span>);

                    done();
                  });
                });
              });
            });
          });
        });
      });
    });
    
    it(<span class="hljs-string">'Can update without the options arg (will use defaults then)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ a:<span class="hljs-number">1</span>, hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
        d.insert({ a:<span class="hljs-number">2</span>, hello: <span class="hljs-string">'earth'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
          d.insert({ a:<span class="hljs-number">5</span>, hello: <span class="hljs-string">'pluton'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc3)</span> </span>{
            d.update({ a: <span class="hljs-number">2</span> }, { $inc: { a: <span class="hljs-number">10</span> } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
              assert.isNull(err);
              nr.should.equal(<span class="hljs-number">1</span>);
              d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                <span class="hljs-keyword">var</span> d1 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === doc1._id })
                  , d2 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === doc2._id })
                  , d3 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === doc3._id })
                  ;
                  
                d1.a.should.equal(<span class="hljs-number">1</span>);
                d2.a.should.equal(<span class="hljs-number">12</span>);
                d3.a.should.equal(<span class="hljs-number">5</span>);
                
                done();
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'If a multi update fails on one document, previous updates should be rolled back'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.ensureIndex({ fieldName: <span class="hljs-string">'a'</span> });
      d.insert({ a: <span class="hljs-number">4</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
        d.insert({ a: <span class="hljs-number">5</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
          d.insert({ a: <span class="hljs-string">'abc'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc3)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>With this query, candidates are always returned in the order 4, 5, ‘abc’ so it’s always the last one which fails</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            d.update({ a: { $<span class="hljs-keyword">in</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'abc'</span>] } }, { $inc: { a: <span class="hljs-number">10</span> } }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              assert.isDefined(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>No index modified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              _.each(d.indexes, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(index)</span> </span>{
                <span class="hljs-keyword">var</span> docs = index.getAll()
                  , d1 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === doc1._id })
                  , d2 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === doc2._id })
                  , d3 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === doc3._id })
                  ;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>All changes rolled back, including those that didn’t trigger an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                d1.a.should.equal(<span class="hljs-number">4</span>);
                d2.a.should.equal(<span class="hljs-number">5</span>);
                d3.a.should.equal(<span class="hljs-string">'abc'</span>);
              });
 
              done();
            });
          });
        });
      });
    });
    
    it(<span class="hljs-string">'If an index constraint is violated by an update, all changes should be rolled back'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.ensureIndex({ fieldName: <span class="hljs-string">'a'</span>, unique: <span class="hljs-literal">true</span> });
      d.insert({ a: <span class="hljs-number">4</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
        d.insert({ a: <span class="hljs-number">5</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>With this query, candidates are always returned in the order 4, 5, ‘abc’ so it’s always the last one which fails</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>           d.update({ a: { $<span class="hljs-keyword">in</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'abc'</span>] } }, { $set: { a: <span class="hljs-number">10</span> } }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            assert.isDefined(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Check that no index was modified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            _.each(d.indexes, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(index)</span> </span>{
              <span class="hljs-keyword">var</span> docs = index.getAll()
              , d1 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === doc1._id })
              , d2 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === doc2._id })
              ;
			  
              d1.a.should.equal(<span class="hljs-number">4</span>);
              d2.a.should.equal(<span class="hljs-number">5</span>);
            });
            
            done();
          });
        });
      });
    });

  });   <span class="hljs-comment">// ==== End of 'Update' ==== //</span>


  describe(<span class="hljs-string">'Remove'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    it(<span class="hljs-string">'Can remove multiple documents'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> id1, id2, id3;</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Test DB status</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testPostUpdateState</span> <span class="hljs-params">(cb)</span> </span>{
        d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          docs.length.should.equal(<span class="hljs-number">1</span>);

          <span class="hljs-built_in">Object</span>.keys(docs[<span class="hljs-number">0</span>]).length.should.equal(<span class="hljs-number">2</span>);
          docs[<span class="hljs-number">0</span>]._id.should.equal(id1);
          docs[<span class="hljs-number">0</span>].somedata.should.equal(<span class="hljs-string">'ok'</span>);

          <span class="hljs-keyword">return</span> cb();
        });
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Actually launch the test</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      async.waterfall([
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.insert({ somedata: <span class="hljs-string">'ok'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
          id1 = doc1._id;
          d.insert({ somedata: <span class="hljs-string">'again'</span>, plus: <span class="hljs-string">'additional data'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
            id2 = doc2._id;
            d.insert({ somedata: <span class="hljs-string">'again'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc3)</span> </span>{
              id3 = doc3._id;
              <span class="hljs-keyword">return</span> cb(err);
            });
          });
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{   <span class="hljs-comment">// Test with query that doesn't match anything</span>
        d.remove({ somedata: <span class="hljs-string">'again'</span> }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, n)</span> </span>{
          assert.isNull(err);
          n.should.equal(<span class="hljs-number">2</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      , async.apply(testPostUpdateState)
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{ <span class="hljs-keyword">return</span> cb(err); });
      }
      , async.apply(testPostUpdateState)
      ], done);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>This tests concurrency issues</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    it(<span class="hljs-string">'Remove can be called multiple times in parallel and everything that needs to be removed will be'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ planet: <span class="hljs-string">'Earth'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.insert({ planet: <span class="hljs-string">'Mars'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          d.insert({ planet: <span class="hljs-string">'Saturn'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
              docs.length.should.equal(<span class="hljs-number">3</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Remove two docs simultaneously</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">var</span> toRemove = [<span class="hljs-string">'Mars'</span>, <span class="hljs-string">'Saturn'</span>];
              async.each(toRemove, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(planet, cb)</span> </span>{
                d.remove({ planet: planet }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{ <span class="hljs-keyword">return</span> cb(err); });
              }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                  docs.length.should.equal(<span class="hljs-number">1</span>);

                  done();
                });
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Returns an error if the query is not well formed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.remove({ $or: { hello: <span class="hljs-string">'world'</span> } }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr, upsert)</span> </span>{
          assert.isDefined(err);
          assert.isUndefined(nr);
          assert.isUndefined(upsert);

          done();
        });
      });
    });

    it(<span class="hljs-string">'Non-multi removes are persistent'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ a:<span class="hljs-number">1</span>, hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
        d.insert({ a:<span class="hljs-number">2</span>, hello: <span class="hljs-string">'earth'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
          d.insert({ a:<span class="hljs-number">3</span>, hello: <span class="hljs-string">'moto'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc3)</span> </span>{
            d.remove({ a: <span class="hljs-number">2</span> }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              assert.isNull(err);

              d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                docs.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{ <span class="hljs-keyword">return</span> a.a - b.a; });
                docs.length.should.equal(<span class="hljs-number">2</span>);
                _.isEqual(docs[<span class="hljs-number">0</span>], { _id: doc1._id, a:<span class="hljs-number">1</span>, hello: <span class="hljs-string">'world'</span> }).should.equal(<span class="hljs-literal">true</span>);
                _.isEqual(docs[<span class="hljs-number">1</span>], { _id: doc3._id, a:<span class="hljs-number">3</span>, hello: <span class="hljs-string">'moto'</span> }).should.equal(<span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Even after a reload the database state hasn’t changed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                  assert.isNull(err);

                  d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                    docs.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{ <span class="hljs-keyword">return</span> a.a - b.a; });
                    docs.length.should.equal(<span class="hljs-number">2</span>);
                    _.isEqual(docs[<span class="hljs-number">0</span>], { _id: doc1._id, a:<span class="hljs-number">1</span>, hello: <span class="hljs-string">'world'</span> }).should.equal(<span class="hljs-literal">true</span>);
                    _.isEqual(docs[<span class="hljs-number">1</span>], { _id: doc3._id, a:<span class="hljs-number">3</span>, hello: <span class="hljs-string">'moto'</span> }).should.equal(<span class="hljs-literal">true</span>);

                    done();
                  });
                });
              });
            });
          });
        });
      });
    });

    it(<span class="hljs-string">'Multi removes are persistent'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ a:<span class="hljs-number">1</span>, hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
        d.insert({ a:<span class="hljs-number">2</span>, hello: <span class="hljs-string">'earth'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
          d.insert({ a:<span class="hljs-number">3</span>, hello: <span class="hljs-string">'moto'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc3)</span> </span>{
            d.remove({ a: { $<span class="hljs-keyword">in</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>] } }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              assert.isNull(err);

              d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                docs.length.should.equal(<span class="hljs-number">1</span>);
                _.isEqual(docs[<span class="hljs-number">0</span>], { _id: doc2._id, a:<span class="hljs-number">2</span>, hello: <span class="hljs-string">'earth'</span> }).should.equal(<span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Even after a reload the database state hasn’t changed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                  assert.isNull(err);

                  d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                    docs.length.should.equal(<span class="hljs-number">1</span>);
                    _.isEqual(docs[<span class="hljs-number">0</span>], { _id: doc2._id, a:<span class="hljs-number">2</span>, hello: <span class="hljs-string">'earth'</span> }).should.equal(<span class="hljs-literal">true</span>);

                    done();
                  });
                });
              });
            });
          });
        });
      });
    });
    
    it(<span class="hljs-string">'Can remove without the options arg (will use defaults then)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ a:<span class="hljs-number">1</span>, hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
        d.insert({ a:<span class="hljs-number">2</span>, hello: <span class="hljs-string">'earth'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
          d.insert({ a:<span class="hljs-number">5</span>, hello: <span class="hljs-string">'pluton'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc3)</span> </span>{
            d.remove({ a: <span class="hljs-number">2</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
              assert.isNull(err);
              nr.should.equal(<span class="hljs-number">1</span>);
              d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                <span class="hljs-keyword">var</span> d1 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === doc1._id })
                  , d2 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === doc2._id })
                  , d3 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === doc3._id })
                  ;
                  
                d1.a.should.equal(<span class="hljs-number">1</span>);
                assert.isUndefined(d2);
                d3.a.should.equal(<span class="hljs-number">5</span>);
                
                done();
              });
            });
          });
        });
      });
    });

  });   <span class="hljs-comment">// ==== End of 'Remove' ==== //</span>


  describe(<span class="hljs-string">'Using indexes'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    describe(<span class="hljs-string">'ensureIndex and index initialization in database loading'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

      it(<span class="hljs-string">'ensureIndex can be called right after a loadDatabase and be initialized and filled correctly'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
          , rawData = model.serialize({ _id: <span class="hljs-string">"aaa"</span>, z: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }) + <span class="hljs-string">'\n'</span> +
                      model.serialize({ _id: <span class="hljs-string">"bbb"</span>, z: <span class="hljs-string">"2"</span>, hello: <span class="hljs-string">'world'</span> }) + <span class="hljs-string">'\n'</span> +
                      model.serialize({ _id: <span class="hljs-string">"ccc"</span>, z: <span class="hljs-string">"3"</span>, nested: { today: now } })
          ;

        d.getAllData().length.should.equal(<span class="hljs-number">0</span>);

        fs.writeFile(testDb, rawData, <span class="hljs-string">'utf8'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            d.getAllData().length.should.equal(<span class="hljs-number">3</span>);

            assert.deepEqual(<span class="hljs-built_in">Object</span>.keys(d.indexes), [<span class="hljs-string">'_id'</span>]);

            d.ensureIndex({ fieldName: <span class="hljs-string">'z'</span> });
            d.indexes.z.fieldName.should.equal(<span class="hljs-string">'z'</span>);
            d.indexes.z.unique.should.equal(<span class="hljs-literal">false</span>);
            d.indexes.z.sparse.should.equal(<span class="hljs-literal">false</span>);
            d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
            d.indexes.z.tree.search(<span class="hljs-string">'1'</span>)[<span class="hljs-number">0</span>].should.equal(d.getAllData()[<span class="hljs-number">0</span>]);
            d.indexes.z.tree.search(<span class="hljs-string">'2'</span>)[<span class="hljs-number">0</span>].should.equal(d.getAllData()[<span class="hljs-number">1</span>]);
            d.indexes.z.tree.search(<span class="hljs-string">'3'</span>)[<span class="hljs-number">0</span>].should.equal(d.getAllData()[<span class="hljs-number">2</span>]);

            done();
          });
        });
      });
      
      it(<span class="hljs-string">'ensureIndex can be called twice on the same field, the second call will ahve no effect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        <span class="hljs-built_in">Object</span>.keys(d.indexes).length.should.equal(<span class="hljs-number">1</span>);
        <span class="hljs-built_in">Object</span>.keys(d.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
      
        d.insert({ planet: <span class="hljs-string">"Earth"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          d.insert({ planet: <span class="hljs-string">"Mars"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
              docs.length.should.equal(<span class="hljs-number">2</span>);
              
              d.ensureIndex({ fieldName: <span class="hljs-string">"planet"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                assert.isNull(err);
                <span class="hljs-built_in">Object</span>.keys(d.indexes).length.should.equal(<span class="hljs-number">2</span>);
                <span class="hljs-built_in">Object</span>.keys(d.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);   
                <span class="hljs-built_in">Object</span>.keys(d.indexes)[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">"planet"</span>);   

                d.indexes.planet.getAll().length.should.equal(<span class="hljs-number">2</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>This second call has no effect, documents don’t get inserted twice in the index</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                d.ensureIndex({ fieldName: <span class="hljs-string">"planet"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                  assert.isNull(err);
                  <span class="hljs-built_in">Object</span>.keys(d.indexes).length.should.equal(<span class="hljs-number">2</span>);
                  <span class="hljs-built_in">Object</span>.keys(d.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);   
                  <span class="hljs-built_in">Object</span>.keys(d.indexes)[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">"planet"</span>);   

                  d.indexes.planet.getAll().length.should.equal(<span class="hljs-number">2</span>);                
                  
                  done();
                });
              });
            });
          });
        });
      });

      it(<span class="hljs-string">'ensureIndex can be called after the data set was modified and the index still be correct'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        <span class="hljs-keyword">var</span> rawData = model.serialize({ _id: <span class="hljs-string">"aaa"</span>, z: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }) + <span class="hljs-string">'\n'</span> +
                      model.serialize({ _id: <span class="hljs-string">"bbb"</span>, z: <span class="hljs-string">"2"</span>, hello: <span class="hljs-string">'world'</span> })
          ;

        d.getAllData().length.should.equal(<span class="hljs-number">0</span>);

        fs.writeFile(testDb, rawData, <span class="hljs-string">'utf8'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            d.getAllData().length.should.equal(<span class="hljs-number">2</span>);

            assert.deepEqual(<span class="hljs-built_in">Object</span>.keys(d.indexes), [<span class="hljs-string">'_id'</span>]);

            d.insert({ z: <span class="hljs-string">"12"</span>, yes: <span class="hljs-string">'yes'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc1)</span> </span>{
              d.insert({ z: <span class="hljs-string">"14"</span>, nope: <span class="hljs-string">'nope'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc2)</span> </span>{
                d.remove({ z: <span class="hljs-string">"2"</span> }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                  d.update({ z: <span class="hljs-string">"1"</span> }, { $set: { <span class="hljs-string">'yes'</span>: <span class="hljs-string">'yep'</span> } }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    assert.deepEqual(<span class="hljs-built_in">Object</span>.keys(d.indexes), [<span class="hljs-string">'_id'</span>]);

                    d.ensureIndex({ fieldName: <span class="hljs-string">'z'</span> });
                    d.indexes.z.fieldName.should.equal(<span class="hljs-string">'z'</span>);
                    d.indexes.z.unique.should.equal(<span class="hljs-literal">false</span>);
                    d.indexes.z.sparse.should.equal(<span class="hljs-literal">false</span>);
                    d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>The pointers in the _id and z indexes are the same</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    d.indexes.z.tree.search(<span class="hljs-string">'1'</span>)[<span class="hljs-number">0</span>].should.equal(d.indexes._id.getMatching(<span class="hljs-string">'aaa'</span>)[<span class="hljs-number">0</span>]);
                    d.indexes.z.tree.search(<span class="hljs-string">'12'</span>)[<span class="hljs-number">0</span>].should.equal(d.indexes._id.getMatching(newDoc1._id)[<span class="hljs-number">0</span>]);
                    d.indexes.z.tree.search(<span class="hljs-string">'14'</span>)[<span class="hljs-number">0</span>].should.equal(d.indexes._id.getMatching(newDoc2._id)[<span class="hljs-number">0</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>The data in the z index is correct</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                      <span class="hljs-keyword">var</span> doc0 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === <span class="hljs-string">'aaa'</span>; })
                        , doc1 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === newDoc1._id; })
                        , doc2 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === newDoc2._id; })
                        ;

                      docs.length.should.equal(<span class="hljs-number">3</span>);

                      assert.deepEqual(doc0, { _id: <span class="hljs-string">"aaa"</span>, z: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>], yes: <span class="hljs-string">'yep'</span> });
                      assert.deepEqual(doc1, { _id: newDoc1._id, z: <span class="hljs-string">"12"</span>, yes: <span class="hljs-string">'yes'</span> });
                      assert.deepEqual(doc2, { _id: newDoc2._id, z: <span class="hljs-string">"14"</span>, nope: <span class="hljs-string">'nope'</span> });

                      done();
                    });
                  });
                });
              });
            });
          });
        });
      });

      it(<span class="hljs-string">'ensureIndex can be called before a loadDatabase and still be initialized and filled correctly'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
          , rawData = model.serialize({ _id: <span class="hljs-string">"aaa"</span>, z: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }) + <span class="hljs-string">'\n'</span> +
                      model.serialize({ _id: <span class="hljs-string">"bbb"</span>, z: <span class="hljs-string">"2"</span>, hello: <span class="hljs-string">'world'</span> }) + <span class="hljs-string">'\n'</span> +
                      model.serialize({ _id: <span class="hljs-string">"ccc"</span>, z: <span class="hljs-string">"3"</span>, nested: { today: now } })
          ;

        d.getAllData().length.should.equal(<span class="hljs-number">0</span>);

        d.ensureIndex({ fieldName: <span class="hljs-string">'z'</span> });
        d.indexes.z.fieldName.should.equal(<span class="hljs-string">'z'</span>);
        d.indexes.z.unique.should.equal(<span class="hljs-literal">false</span>);
        d.indexes.z.sparse.should.equal(<span class="hljs-literal">false</span>);
        d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);

        fs.writeFile(testDb, rawData, <span class="hljs-string">'utf8'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> doc1 = _.find(d.getAllData(), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.z === <span class="hljs-string">"1"</span>; })
              , doc2 = _.find(d.getAllData(), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.z === <span class="hljs-string">"2"</span>; })
              , doc3 = _.find(d.getAllData(), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.z === <span class="hljs-string">"3"</span>; })
              ;

            d.getAllData().length.should.equal(<span class="hljs-number">3</span>);

            d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
            d.indexes.z.tree.search(<span class="hljs-string">'1'</span>)[<span class="hljs-number">0</span>].should.equal(doc1);
            d.indexes.z.tree.search(<span class="hljs-string">'2'</span>)[<span class="hljs-number">0</span>].should.equal(doc2);
            d.indexes.z.tree.search(<span class="hljs-string">'3'</span>)[<span class="hljs-number">0</span>].should.equal(doc3);

            done();
          });
        });
      });

      it(<span class="hljs-string">'Can initialize multiple indexes on a database load'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
          , rawData = model.serialize({ _id: <span class="hljs-string">"aaa"</span>, z: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }) + <span class="hljs-string">'\n'</span> +
                      model.serialize({ _id: <span class="hljs-string">"bbb"</span>, z: <span class="hljs-string">"2"</span>, a: <span class="hljs-string">'world'</span> }) + <span class="hljs-string">'\n'</span> +
                      model.serialize({ _id: <span class="hljs-string">"ccc"</span>, z: <span class="hljs-string">"3"</span>, a: { today: now } })
          ;

        d.getAllData().length.should.equal(<span class="hljs-number">0</span>);

        d.ensureIndex({ fieldName: <span class="hljs-string">'z'</span> });
        d.ensureIndex({ fieldName: <span class="hljs-string">'a'</span> });
        d.indexes.a.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);
        d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);

        fs.writeFile(testDb, rawData, <span class="hljs-string">'utf8'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> doc1 = _.find(d.getAllData(), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.z === <span class="hljs-string">"1"</span>; })
              , doc2 = _.find(d.getAllData(), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.z === <span class="hljs-string">"2"</span>; })
              , doc3 = _.find(d.getAllData(), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.z === <span class="hljs-string">"3"</span>; })
              ;

            d.getAllData().length.should.equal(<span class="hljs-number">3</span>);

            d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
            d.indexes.z.tree.search(<span class="hljs-string">'1'</span>)[<span class="hljs-number">0</span>].should.equal(doc1);
            d.indexes.z.tree.search(<span class="hljs-string">'2'</span>)[<span class="hljs-number">0</span>].should.equal(doc2);
            d.indexes.z.tree.search(<span class="hljs-string">'3'</span>)[<span class="hljs-number">0</span>].should.equal(doc3);

            d.indexes.a.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
            d.indexes.a.tree.search(<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>].should.equal(doc1);
            d.indexes.a.tree.search(<span class="hljs-string">'world'</span>)[<span class="hljs-number">0</span>].should.equal(doc2);
            d.indexes.a.tree.search({ today: now })[<span class="hljs-number">0</span>].should.equal(doc3);

            done();
          });
        });
      });

      it(<span class="hljs-string">'If a unique constraint is not respected, database loading will not work and no data will be inserted'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
          , rawData = model.serialize({ _id: <span class="hljs-string">"aaa"</span>, z: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }) + <span class="hljs-string">'\n'</span> +
                      model.serialize({ _id: <span class="hljs-string">"bbb"</span>, z: <span class="hljs-string">"2"</span>, a: <span class="hljs-string">'world'</span> }) + <span class="hljs-string">'\n'</span> +
                      model.serialize({ _id: <span class="hljs-string">"ccc"</span>, z: <span class="hljs-string">"1"</span>, a: { today: now } })
          ;

        d.getAllData().length.should.equal(<span class="hljs-number">0</span>);

        d.ensureIndex({ fieldName: <span class="hljs-string">'z'</span>, unique: <span class="hljs-literal">true</span> });
        d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);

        fs.writeFile(testDb, rawData, <span class="hljs-string">'utf8'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            err.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);
            err.key.should.equal(<span class="hljs-string">"1"</span>);
            d.getAllData().length.should.equal(<span class="hljs-number">0</span>);
            d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);

            done();
          });
        });
      });

      it(<span class="hljs-string">'If a unique constraint is not respected, ensureIndex will return an error and not create an index'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.insert({ a: <span class="hljs-number">1</span>, b: <span class="hljs-number">4</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          d.insert({ a: <span class="hljs-number">2</span>, b: <span class="hljs-number">45</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            d.insert({ a: <span class="hljs-number">1</span>, b: <span class="hljs-number">3</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
              d.ensureIndex({ fieldName: <span class="hljs-string">'b'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                assert.isNull(err);

                d.ensureIndex({ fieldName: <span class="hljs-string">'a'</span>, unique: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                  err.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);
                  assert.deepEqual(<span class="hljs-built_in">Object</span>.keys(d.indexes), [<span class="hljs-string">'_id'</span>, <span class="hljs-string">'b'</span>]);

                  done();
                });
              });
            });
          });
        });
      });
      
      it(<span class="hljs-string">'Can remove an index'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'e'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          assert.isNull(err);
          
          <span class="hljs-built_in">Object</span>.keys(d.indexes).length.should.equal(<span class="hljs-number">2</span>);
          assert.isNotNull(d.indexes.e);
          
          d.removeIndex(<span class="hljs-string">"e"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            assert.isNull(err);
            <span class="hljs-built_in">Object</span>.keys(d.indexes).length.should.equal(<span class="hljs-number">1</span>);
            assert.isUndefined(d.indexes.e); 
 
            done();
          });
        });
      });

    });   <span class="hljs-comment">// ==== End of 'ensureIndex and index initialization in database loading' ==== //</span>

    
    describe(<span class="hljs-string">'Indexing newly inserted documents'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

      it(<span class="hljs-string">'Newly inserted documents are indexed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'z'</span> });
        d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);

        d.insert({ a: <span class="hljs-number">2</span>, z: <span class="hljs-string">'yes'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc)</span> </span>{
          d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
          assert.deepEqual(d.indexes.z.getMatching(<span class="hljs-string">'yes'</span>), [newDoc]);

          d.insert({ a: <span class="hljs-number">5</span>, z: <span class="hljs-string">'nope'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc)</span> </span>{
            d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
            assert.deepEqual(d.indexes.z.getMatching(<span class="hljs-string">'nope'</span>), [newDoc]);

            done();
          });
        });
      });

      it(<span class="hljs-string">'If multiple indexes are defined, the document is inserted in all of them'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'z'</span> });
        d.ensureIndex({ fieldName: <span class="hljs-string">'ya'</span> });
        d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);

        d.insert({ a: <span class="hljs-number">2</span>, z: <span class="hljs-string">'yes'</span>, ya: <span class="hljs-string">'indeed'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc)</span> </span>{
          d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
          d.indexes.ya.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
          assert.deepEqual(d.indexes.z.getMatching(<span class="hljs-string">'yes'</span>), [newDoc]);
          assert.deepEqual(d.indexes.ya.getMatching(<span class="hljs-string">'indeed'</span>), [newDoc]);

          d.insert({ a: <span class="hljs-number">5</span>, z: <span class="hljs-string">'nope'</span>, ya: <span class="hljs-string">'sure'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc2)</span> </span>{
            d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
            d.indexes.ya.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
            assert.deepEqual(d.indexes.z.getMatching(<span class="hljs-string">'nope'</span>), [newDoc2]);
            assert.deepEqual(d.indexes.ya.getMatching(<span class="hljs-string">'sure'</span>), [newDoc2]);

            done();
          });
        });
      });

      it(<span class="hljs-string">'Can insert two docs at the same key for a non unique index'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'z'</span> });
        d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);

        d.insert({ a: <span class="hljs-number">2</span>, z: <span class="hljs-string">'yes'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc)</span> </span>{
          d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
          assert.deepEqual(d.indexes.z.getMatching(<span class="hljs-string">'yes'</span>), [newDoc]);

          d.insert({ a: <span class="hljs-number">5</span>, z: <span class="hljs-string">'yes'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc2)</span> </span>{
            d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
            assert.deepEqual(d.indexes.z.getMatching(<span class="hljs-string">'yes'</span>), [newDoc, newDoc2]);

            done();
          });
        });
      });

      it(<span class="hljs-string">'If the index has a unique constraint, an error is thrown if it is violated and the data is not modified'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'z'</span>, unique: <span class="hljs-literal">true</span> });
        d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);

        d.insert({ a: <span class="hljs-number">2</span>, z: <span class="hljs-string">'yes'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc)</span> </span>{
          d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
          assert.deepEqual(d.indexes.z.getMatching(<span class="hljs-string">'yes'</span>), [newDoc]);

          d.insert({ a: <span class="hljs-number">5</span>, z: <span class="hljs-string">'yes'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            err.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);
            err.key.should.equal(<span class="hljs-string">'yes'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Index didn’t change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            d.indexes.z.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
            assert.deepEqual(d.indexes.z.getMatching(<span class="hljs-string">'yes'</span>), [newDoc]);</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Data didn’t change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            assert.deepEqual(d.getAllData(), [newDoc]);
            d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
              d.getAllData().length.should.equal(<span class="hljs-number">1</span>);
              assert.deepEqual(d.getAllData()[<span class="hljs-number">0</span>], newDoc);

              done();
            });
          });
        });
      });

      it(<span class="hljs-string">'If an index has a unique constraint, other indexes cannot be modified when it raises an error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'nonu1'</span> });
        d.ensureIndex({ fieldName: <span class="hljs-string">'uni'</span>, unique: <span class="hljs-literal">true</span> });
        d.ensureIndex({ fieldName: <span class="hljs-string">'nonu2'</span> });

        d.insert({ nonu1: <span class="hljs-string">'yes'</span>, nonu2: <span class="hljs-string">'yes2'</span>, uni: <span class="hljs-string">'willfail'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc)</span> </span>{
          assert.isNull(err);
          d.indexes.nonu1.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
          d.indexes.uni.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
          d.indexes.nonu2.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);

          d.insert({ nonu1: <span class="hljs-string">'no'</span>, nonu2: <span class="hljs-string">'no2'</span>, uni: <span class="hljs-string">'willfail'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            err.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>No index was modified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            d.indexes.nonu1.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
            d.indexes.uni.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
            d.indexes.nonu2.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);

            assert.deepEqual(d.indexes.nonu1.getMatching(<span class="hljs-string">'yes'</span>), [newDoc]);
            assert.deepEqual(d.indexes.uni.getMatching(<span class="hljs-string">'willfail'</span>), [newDoc]);
            assert.deepEqual(d.indexes.nonu2.getMatching(<span class="hljs-string">'yes2'</span>), [newDoc]);

            done();
          });
        });
      });

      it(<span class="hljs-string">'Unique indexes prevent you from inserting two docs where the field is undefined except if theyre sparse'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'zzz'</span>, unique: <span class="hljs-literal">true</span> });
        d.indexes.zzz.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);

        d.insert({ a: <span class="hljs-number">2</span>, z: <span class="hljs-string">'yes'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc)</span> </span>{
          d.indexes.zzz.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
          assert.deepEqual(d.indexes.zzz.getMatching(<span class="hljs-literal">undefined</span>), [newDoc]);

          d.insert({ a: <span class="hljs-number">5</span>, z: <span class="hljs-string">'other'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            err.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);
            assert.isUndefined(err.key);

            d.ensureIndex({ fieldName: <span class="hljs-string">'yyy'</span>, unique: <span class="hljs-literal">true</span>, sparse: <span class="hljs-literal">true</span> });

            d.insert({ a: <span class="hljs-number">5</span>, z: <span class="hljs-string">'other'</span>, zzz: <span class="hljs-string">'set'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              assert.isNull(err);
              d.indexes.yyy.getAll().length.should.equal(<span class="hljs-number">0</span>);   <span class="hljs-comment">// Nothing indexed</span>
              d.indexes.zzz.getAll().length.should.equal(<span class="hljs-number">2</span>);

              done();
            });
          });
        });
      });

      it(<span class="hljs-string">'Insertion still works as before with indexing'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'a'</span> });
        d.ensureIndex({ fieldName: <span class="hljs-string">'b'</span> });

        d.insert({ a: <span class="hljs-number">1</span>, b: <span class="hljs-string">'hello'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
          d.insert({ a: <span class="hljs-number">2</span>, b: <span class="hljs-string">'si'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
            d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
              assert.deepEqual(doc1, _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === doc1._id; }));
              assert.deepEqual(doc2, _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d._id === doc2._id; }));

              done();
            });
          });
        });
      });

      it(<span class="hljs-string">'All indexes point to the same data as the main index on _id'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'a'</span> });

        d.insert({ a: <span class="hljs-number">1</span>, b: <span class="hljs-string">'hello'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
          d.insert({ a: <span class="hljs-number">2</span>, b: <span class="hljs-string">'si'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
            d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
              docs.length.should.equal(<span class="hljs-number">2</span>);
              d.getAllData().length.should.equal(<span class="hljs-number">2</span>);

              d.indexes._id.getMatching(doc1._id).length.should.equal(<span class="hljs-number">1</span>);
              d.indexes.a.getMatching(<span class="hljs-number">1</span>).length.should.equal(<span class="hljs-number">1</span>);
              d.indexes._id.getMatching(doc1._id)[<span class="hljs-number">0</span>].should.equal(d.indexes.a.getMatching(<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]);

              d.indexes._id.getMatching(doc2._id).length.should.equal(<span class="hljs-number">1</span>);
              d.indexes.a.getMatching(<span class="hljs-number">2</span>).length.should.equal(<span class="hljs-number">1</span>);
              d.indexes._id.getMatching(doc2._id)[<span class="hljs-number">0</span>].should.equal(d.indexes.a.getMatching(<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>]);

              done();
            });
          });
        });
      });

      it(<span class="hljs-string">'If a unique constraint is violated, no index is changed, including the main one'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'a'</span>, unique: <span class="hljs-literal">true</span> });

        d.insert({ a: <span class="hljs-number">1</span>, b: <span class="hljs-string">'hello'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
          d.insert({ a: <span class="hljs-number">1</span>, b: <span class="hljs-string">'si'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            assert.isDefined(err);

            d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
              docs.length.should.equal(<span class="hljs-number">1</span>);
              d.getAllData().length.should.equal(<span class="hljs-number">1</span>);

              d.indexes._id.getMatching(doc1._id).length.should.equal(<span class="hljs-number">1</span>);
              d.indexes.a.getMatching(<span class="hljs-number">1</span>).length.should.equal(<span class="hljs-number">1</span>);
              d.indexes._id.getMatching(doc1._id)[<span class="hljs-number">0</span>].should.equal(d.indexes.a.getMatching(<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]);

              d.indexes.a.getMatching(<span class="hljs-number">2</span>).length.should.equal(<span class="hljs-number">0</span>);

              done();
            });
          });
        });
      });

    });   <span class="hljs-comment">// ==== End of 'Indexing newly inserted documents' ==== //</span>

    describe(<span class="hljs-string">'Updating indexes upon document update'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

      it(<span class="hljs-string">'Updating docs still works as before with indexing'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'a'</span> });

        d.insert({ a: <span class="hljs-number">1</span>, b: <span class="hljs-string">'hello'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc1)</span> </span>{
          d.insert({ a: <span class="hljs-number">2</span>, b: <span class="hljs-string">'si'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc2)</span> </span>{
            d.update({ a: <span class="hljs-number">1</span> }, { $set: { a: <span class="hljs-number">456</span>, b: <span class="hljs-string">'no'</span> } }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
              <span class="hljs-keyword">var</span> data = d.getAllData()
                , doc1 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === _doc1._id; })
                , doc2 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === _doc2._id; })
                ;

              assert.isNull(err);
              nr.should.equal(<span class="hljs-number">1</span>);

              data.length.should.equal(<span class="hljs-number">2</span>);
              assert.deepEqual(doc1, { a: <span class="hljs-number">456</span>, b: <span class="hljs-string">'no'</span>, _id: _doc1._id });
              assert.deepEqual(doc2, { a: <span class="hljs-number">2</span>, b: <span class="hljs-string">'si'</span>, _id: _doc2._id });

              d.update({}, { $inc: { a: <span class="hljs-number">10</span> }, $set: { b: <span class="hljs-string">'same'</span> } }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
                <span class="hljs-keyword">var</span> data = d.getAllData()
                  , doc1 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === _doc1._id; })
                  , doc2 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === _doc2._id; })
                  ;

                assert.isNull(err);
                nr.should.equal(<span class="hljs-number">2</span>);

                data.length.should.equal(<span class="hljs-number">2</span>);
                assert.deepEqual(doc1, { a: <span class="hljs-number">466</span>, b: <span class="hljs-string">'same'</span>, _id: _doc1._id });
                assert.deepEqual(doc2, { a: <span class="hljs-number">12</span>, b: <span class="hljs-string">'same'</span>, _id: _doc2._id });

                done();
              });
            });
          });
        });
      });

      it(<span class="hljs-string">'Indexes get updated when a document (or multiple documents) is updated'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'a'</span> });
        d.ensureIndex({ fieldName: <span class="hljs-string">'b'</span> });

        d.insert({ a: <span class="hljs-number">1</span>, b: <span class="hljs-string">'hello'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
          d.insert({ a: <span class="hljs-number">2</span>, b: <span class="hljs-string">'si'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Simple update</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            d.update({ a: <span class="hljs-number">1</span> }, { $set: { a: <span class="hljs-number">456</span>, b: <span class="hljs-string">'no'</span> } }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
              assert.isNull(err);
              nr.should.equal(<span class="hljs-number">1</span>);

              d.indexes.a.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
              d.indexes.a.getMatching(<span class="hljs-number">456</span>)[<span class="hljs-number">0</span>]._id.should.equal(doc1._id);
              d.indexes.a.getMatching(<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>]._id.should.equal(doc2._id);

              d.indexes.b.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
              d.indexes.b.getMatching(<span class="hljs-string">'no'</span>)[<span class="hljs-number">0</span>]._id.should.equal(doc1._id);
              d.indexes.b.getMatching(<span class="hljs-string">'si'</span>)[<span class="hljs-number">0</span>]._id.should.equal(doc2._id);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>The same pointers are shared between all indexes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              d.indexes.a.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
              d.indexes.b.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
              d.indexes._id.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
              d.indexes.a.getMatching(<span class="hljs-number">456</span>)[<span class="hljs-number">0</span>].should.equal(d.indexes._id.getMatching(doc1._id)[<span class="hljs-number">0</span>]);
              d.indexes.b.getMatching(<span class="hljs-string">'no'</span>)[<span class="hljs-number">0</span>].should.equal(d.indexes._id.getMatching(doc1._id)[<span class="hljs-number">0</span>]);
              d.indexes.a.getMatching(<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>].should.equal(d.indexes._id.getMatching(doc2._id)[<span class="hljs-number">0</span>]);
              d.indexes.b.getMatching(<span class="hljs-string">'si'</span>)[<span class="hljs-number">0</span>].should.equal(d.indexes._id.getMatching(doc2._id)[<span class="hljs-number">0</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Multi update</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              d.update({}, { $inc: { a: <span class="hljs-number">10</span> }, $set: { b: <span class="hljs-string">'same'</span> } }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
                assert.isNull(err);
                nr.should.equal(<span class="hljs-number">2</span>);

                d.indexes.a.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
                d.indexes.a.getMatching(<span class="hljs-number">466</span>)[<span class="hljs-number">0</span>]._id.should.equal(doc1._id);
                d.indexes.a.getMatching(<span class="hljs-number">12</span>)[<span class="hljs-number">0</span>]._id.should.equal(doc2._id);

                d.indexes.b.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
                d.indexes.b.getMatching(<span class="hljs-string">'same'</span>).length.should.equal(<span class="hljs-number">2</span>);
                _.pluck(d.indexes.b.getMatching(<span class="hljs-string">'same'</span>), <span class="hljs-string">'_id'</span>).should.contain(doc1._id);
                _.pluck(d.indexes.b.getMatching(<span class="hljs-string">'same'</span>), <span class="hljs-string">'_id'</span>).should.contain(doc2._id);</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>The same pointers are shared between all indexes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                d.indexes.a.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
                d.indexes.b.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
                d.indexes.b.getAll().length.should.equal(<span class="hljs-number">2</span>);
                d.indexes._id.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
                d.indexes.a.getMatching(<span class="hljs-number">466</span>)[<span class="hljs-number">0</span>].should.equal(d.indexes._id.getMatching(doc1._id)[<span class="hljs-number">0</span>]);
                d.indexes.a.getMatching(<span class="hljs-number">12</span>)[<span class="hljs-number">0</span>].should.equal(d.indexes._id.getMatching(doc2._id)[<span class="hljs-number">0</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Can’t test the pointers in b as their order is randomized, but it is the same as with a</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                done();
              });
            });
          });
        });
      });

      it(<span class="hljs-string">'If a simple update violates a contraint, all changes are rolled back and an error is thrown'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'a'</span>, unique: <span class="hljs-literal">true</span> });
        d.ensureIndex({ fieldName: <span class="hljs-string">'b'</span>, unique: <span class="hljs-literal">true</span> });
        d.ensureIndex({ fieldName: <span class="hljs-string">'c'</span>, unique: <span class="hljs-literal">true</span> });

        d.insert({ a: <span class="hljs-number">1</span>, b: <span class="hljs-number">10</span>, c: <span class="hljs-number">100</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc1)</span> </span>{
          d.insert({ a: <span class="hljs-number">2</span>, b: <span class="hljs-number">20</span>, c: <span class="hljs-number">200</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc2)</span> </span>{
            d.insert({ a: <span class="hljs-number">3</span>, b: <span class="hljs-number">30</span>, c: <span class="hljs-number">300</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc3)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Will conflict with doc3</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              d.update({ a: <span class="hljs-number">2</span> }, { $inc: { a: <span class="hljs-number">10</span>, c: <span class="hljs-number">1000</span> }, $set: { b: <span class="hljs-number">30</span> } }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">var</span> data = d.getAllData()
                  , doc1 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === _doc1._id; })
                  , doc2 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === _doc2._id; })
                  , doc3 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === _doc3._id; })
                  ;

                err.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Data left unchanged</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                data.length.should.equal(<span class="hljs-number">3</span>);
                assert.deepEqual(doc1, { a: <span class="hljs-number">1</span>, b: <span class="hljs-number">10</span>, c: <span class="hljs-number">100</span>, _id: _doc1._id });
                assert.deepEqual(doc2, { a: <span class="hljs-number">2</span>, b: <span class="hljs-number">20</span>, c: <span class="hljs-number">200</span>, _id: _doc2._id });
                assert.deepEqual(doc3, { a: <span class="hljs-number">3</span>, b: <span class="hljs-number">30</span>, c: <span class="hljs-number">300</span>, _id: _doc3._id });</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>All indexes left unchanged and pointing to the same docs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                d.indexes.a.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
                d.indexes.a.getMatching(<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>].should.equal(doc1);
                d.indexes.a.getMatching(<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>].should.equal(doc2);
                d.indexes.a.getMatching(<span class="hljs-number">3</span>)[<span class="hljs-number">0</span>].should.equal(doc3);

                d.indexes.b.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
                d.indexes.b.getMatching(<span class="hljs-number">10</span>)[<span class="hljs-number">0</span>].should.equal(doc1);
                d.indexes.b.getMatching(<span class="hljs-number">20</span>)[<span class="hljs-number">0</span>].should.equal(doc2);
                d.indexes.b.getMatching(<span class="hljs-number">30</span>)[<span class="hljs-number">0</span>].should.equal(doc3);

                d.indexes.c.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
                d.indexes.c.getMatching(<span class="hljs-number">100</span>)[<span class="hljs-number">0</span>].should.equal(doc1);
                d.indexes.c.getMatching(<span class="hljs-number">200</span>)[<span class="hljs-number">0</span>].should.equal(doc2);
                d.indexes.c.getMatching(<span class="hljs-number">300</span>)[<span class="hljs-number">0</span>].should.equal(doc3);

                done();
              });
            });
          });
        });
      });

      it(<span class="hljs-string">'If a multi update violates a contraint, all changes are rolled back and an error is thrown'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'a'</span>, unique: <span class="hljs-literal">true</span> });
        d.ensureIndex({ fieldName: <span class="hljs-string">'b'</span>, unique: <span class="hljs-literal">true</span> });
        d.ensureIndex({ fieldName: <span class="hljs-string">'c'</span>, unique: <span class="hljs-literal">true</span> });

        d.insert({ a: <span class="hljs-number">1</span>, b: <span class="hljs-number">10</span>, c: <span class="hljs-number">100</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc1)</span> </span>{
          d.insert({ a: <span class="hljs-number">2</span>, b: <span class="hljs-number">20</span>, c: <span class="hljs-number">200</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc2)</span> </span>{
            d.insert({ a: <span class="hljs-number">3</span>, b: <span class="hljs-number">30</span>, c: <span class="hljs-number">300</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc3)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Will conflict with doc3</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              d.update({ a: { $<span class="hljs-keyword">in</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>] } }, { $inc: { a: <span class="hljs-number">10</span>, c: <span class="hljs-number">1000</span> }, $set: { b: <span class="hljs-number">30</span> } }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">var</span> data = d.getAllData()
                  , doc1 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === _doc1._id; })
                  , doc2 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === _doc2._id; })
                  , doc3 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === _doc3._id; })
                  ;

                err.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Data left unchanged</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                data.length.should.equal(<span class="hljs-number">3</span>);
                assert.deepEqual(doc1, { a: <span class="hljs-number">1</span>, b: <span class="hljs-number">10</span>, c: <span class="hljs-number">100</span>, _id: _doc1._id });
                assert.deepEqual(doc2, { a: <span class="hljs-number">2</span>, b: <span class="hljs-number">20</span>, c: <span class="hljs-number">200</span>, _id: _doc2._id });
                assert.deepEqual(doc3, { a: <span class="hljs-number">3</span>, b: <span class="hljs-number">30</span>, c: <span class="hljs-number">300</span>, _id: _doc3._id });</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>All indexes left unchanged and pointing to the same docs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                d.indexes.a.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
                d.indexes.a.getMatching(<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>].should.equal(doc1);
                d.indexes.a.getMatching(<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>].should.equal(doc2);
                d.indexes.a.getMatching(<span class="hljs-number">3</span>)[<span class="hljs-number">0</span>].should.equal(doc3);

                d.indexes.b.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
                d.indexes.b.getMatching(<span class="hljs-number">10</span>)[<span class="hljs-number">0</span>].should.equal(doc1);
                d.indexes.b.getMatching(<span class="hljs-number">20</span>)[<span class="hljs-number">0</span>].should.equal(doc2);
                d.indexes.b.getMatching(<span class="hljs-number">30</span>)[<span class="hljs-number">0</span>].should.equal(doc3);

                d.indexes.c.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
                d.indexes.c.getMatching(<span class="hljs-number">100</span>)[<span class="hljs-number">0</span>].should.equal(doc1);
                d.indexes.c.getMatching(<span class="hljs-number">200</span>)[<span class="hljs-number">0</span>].should.equal(doc2);
                d.indexes.c.getMatching(<span class="hljs-number">300</span>)[<span class="hljs-number">0</span>].should.equal(doc3);

                done();
              });
            });
          });
        });
      });

    });   <span class="hljs-comment">// ==== End of 'Updating indexes upon document update' ==== //</span>

    describe(<span class="hljs-string">'Updating indexes upon document remove'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

      it(<span class="hljs-string">'Removing docs still works as before with indexing'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'a'</span> });

        d.insert({ a: <span class="hljs-number">1</span>, b: <span class="hljs-string">'hello'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc1)</span> </span>{
          d.insert({ a: <span class="hljs-number">2</span>, b: <span class="hljs-string">'si'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc2)</span> </span>{
            d.insert({ a: <span class="hljs-number">3</span>, b: <span class="hljs-string">'coin'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc3)</span> </span>{
              d.remove({ a: <span class="hljs-number">1</span> }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
                <span class="hljs-keyword">var</span> data = d.getAllData()
                , doc2 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === _doc2._id; })
                , doc3 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === _doc3._id; })
                ;

                assert.isNull(err);
                nr.should.equal(<span class="hljs-number">1</span>);

                data.length.should.equal(<span class="hljs-number">2</span>);
                assert.deepEqual(doc2, { a: <span class="hljs-number">2</span>, b: <span class="hljs-string">'si'</span>, _id: _doc2._id });
                assert.deepEqual(doc3, { a: <span class="hljs-number">3</span>, b: <span class="hljs-string">'coin'</span>, _id: _doc3._id });

                d.remove({ a: { $<span class="hljs-keyword">in</span>: [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>] } }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
                  <span class="hljs-keyword">var</span> data = d.getAllData()
                  ;

                  assert.isNull(err);
                  nr.should.equal(<span class="hljs-number">2</span>);
                  data.length.should.equal(<span class="hljs-number">0</span>);

                  done();
                });
              });
            });
          });
        });
      });

      it(<span class="hljs-string">'Indexes get updated when a document (or multiple documents) is removed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        d.ensureIndex({ fieldName: <span class="hljs-string">'a'</span> });
        d.ensureIndex({ fieldName: <span class="hljs-string">'b'</span> });

        d.insert({ a: <span class="hljs-number">1</span>, b: <span class="hljs-string">'hello'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc1)</span> </span>{
          d.insert({ a: <span class="hljs-number">2</span>, b: <span class="hljs-string">'si'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc2)</span> </span>{
            d.insert({ a: <span class="hljs-number">3</span>, b: <span class="hljs-string">'coin'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc3)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Simple remove</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              d.remove({ a: <span class="hljs-number">1</span> }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
                assert.isNull(err);
                nr.should.equal(<span class="hljs-number">1</span>);

                d.indexes.a.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
                d.indexes.a.getMatching(<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>]._id.should.equal(doc2._id);
                d.indexes.a.getMatching(<span class="hljs-number">3</span>)[<span class="hljs-number">0</span>]._id.should.equal(doc3._id);

                d.indexes.b.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
                d.indexes.b.getMatching(<span class="hljs-string">'si'</span>)[<span class="hljs-number">0</span>]._id.should.equal(doc2._id);
                d.indexes.b.getMatching(<span class="hljs-string">'coin'</span>)[<span class="hljs-number">0</span>]._id.should.equal(doc3._id);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>The same pointers are shared between all indexes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                d.indexes.a.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
                d.indexes.b.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
                d.indexes._id.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
                d.indexes.a.getMatching(<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>].should.equal(d.indexes._id.getMatching(doc2._id)[<span class="hljs-number">0</span>]);
                d.indexes.b.getMatching(<span class="hljs-string">'si'</span>)[<span class="hljs-number">0</span>].should.equal(d.indexes._id.getMatching(doc2._id)[<span class="hljs-number">0</span>]);
                d.indexes.a.getMatching(<span class="hljs-number">3</span>)[<span class="hljs-number">0</span>].should.equal(d.indexes._id.getMatching(doc3._id)[<span class="hljs-number">0</span>]);
                d.indexes.b.getMatching(<span class="hljs-string">'coin'</span>)[<span class="hljs-number">0</span>].should.equal(d.indexes._id.getMatching(doc3._id)[<span class="hljs-number">0</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Multi remove</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                d.remove({}, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
                  assert.isNull(err);
                  nr.should.equal(<span class="hljs-number">2</span>);

                  d.indexes.a.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);
                  d.indexes.b.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);
                  d.indexes._id.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);

                  done();
                });
              });
            });
          });
        });
      });

    });   <span class="hljs-comment">// ==== End of 'Updating indexes upon document remove' ==== //</span>
    
    
    describe(<span class="hljs-string">'Persisting indexes'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    
      it(<span class="hljs-string">'Indexes are persisted to a separate file and recreated upon reload'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        <span class="hljs-keyword">var</span> persDb = <span class="hljs-string">"workspace/persistIndexes.db"</span>
          , db
          ;
        
        <span class="hljs-keyword">if</span> (fs.existsSync(persDb)) { fs.writeFileSync(persDb, <span class="hljs-string">''</span>, <span class="hljs-string">'utf8'</span>); }
        db = <span class="hljs-keyword">new</span> Datastore({ filename: persDb, autoload: <span class="hljs-literal">true</span> });
        
        <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">1</span>);
        <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
        
        db.insert({ planet: <span class="hljs-string">"Earth"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          assert.isNull(err);
          db.insert({ planet: <span class="hljs-string">"Mars"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            assert.isNull(err);
            
            db.ensureIndex({ fieldName: <span class="hljs-string">"planet"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">2</span>);
              <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
              <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">"planet"</span>);              
              db.indexes._id.getAll().length.should.equal(<span class="hljs-number">2</span>);
              db.indexes.planet.getAll().length.should.equal(<span class="hljs-number">2</span>);
              db.indexes.planet.fieldName.should.equal(<span class="hljs-string">"planet"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>After a reload the indexes are recreated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              db = <span class="hljs-keyword">new</span> Datastore({ filename: persDb });
              db.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                assert.isNull(err);
                <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">2</span>);
                <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
                <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">"planet"</span>);                
                db.indexes._id.getAll().length.should.equal(<span class="hljs-number">2</span>);
                db.indexes.planet.getAll().length.should.equal(<span class="hljs-number">2</span>);
                db.indexes.planet.fieldName.should.equal(<span class="hljs-string">"planet"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>After another reload the indexes are still there (i.e. they are preserved during autocompaction)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                db = <span class="hljs-keyword">new</span> Datastore({ filename: persDb });
                db.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                  assert.isNull(err);
                  <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">2</span>);
                  <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
                  <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">"planet"</span>);                
                  db.indexes._id.getAll().length.should.equal(<span class="hljs-number">2</span>);
                  db.indexes.planet.getAll().length.should.equal(<span class="hljs-number">2</span>);
                  db.indexes.planet.fieldName.should.equal(<span class="hljs-string">"planet"</span>);
              
                  done();                
                });
              });
            });
          });
        });
      });
    
      it(<span class="hljs-string">'Indexes are persisted with their options and recreated even if some db operation happen between loads'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        <span class="hljs-keyword">var</span> persDb = <span class="hljs-string">"workspace/persistIndexes.db"</span>
          , db
          ;
        
        <span class="hljs-keyword">if</span> (fs.existsSync(persDb)) { fs.writeFileSync(persDb, <span class="hljs-string">''</span>, <span class="hljs-string">'utf8'</span>); }
        db = <span class="hljs-keyword">new</span> Datastore({ filename: persDb, autoload: <span class="hljs-literal">true</span> });
        
        <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">1</span>);
        <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
        
        db.insert({ planet: <span class="hljs-string">"Earth"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          assert.isNull(err);
          db.insert({ planet: <span class="hljs-string">"Mars"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            assert.isNull(err);
            
            db.ensureIndex({ fieldName: <span class="hljs-string">"planet"</span>, unique: <span class="hljs-literal">true</span>, sparse: <span class="hljs-literal">false</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">2</span>);
              <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
              <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">"planet"</span>);              
              db.indexes._id.getAll().length.should.equal(<span class="hljs-number">2</span>);
              db.indexes.planet.getAll().length.should.equal(<span class="hljs-number">2</span>);
              db.indexes.planet.unique.should.equal(<span class="hljs-literal">true</span>);
              db.indexes.planet.sparse.should.equal(<span class="hljs-literal">false</span>);
              
              db.insert({ planet: <span class="hljs-string">"Jupiter"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                assert.isNull(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>After a reload the indexes are recreated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                db = <span class="hljs-keyword">new</span> Datastore({ filename: persDb });
                db.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                  assert.isNull(err);
                  <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">2</span>);
                  <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
                  <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">"planet"</span>);                
                  db.indexes._id.getAll().length.should.equal(<span class="hljs-number">3</span>);
                  db.indexes.planet.getAll().length.should.equal(<span class="hljs-number">3</span>);
                  db.indexes.planet.unique.should.equal(<span class="hljs-literal">true</span>);
                  db.indexes.planet.sparse.should.equal(<span class="hljs-literal">false</span>);
                  
                  db.ensureIndex({ fieldName: <span class="hljs-string">'bloup'</span>, unique: <span class="hljs-literal">false</span>, sparse: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                    assert.isNull(err);
                    <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">3</span>);
                    <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
                    <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">"planet"</span>);
                    <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">2</span>].should.equal(<span class="hljs-string">"bloup"</span>);
                    db.indexes._id.getAll().length.should.equal(<span class="hljs-number">3</span>);
                    db.indexes.planet.getAll().length.should.equal(<span class="hljs-number">3</span>);
                    db.indexes.bloup.getAll().length.should.equal(<span class="hljs-number">0</span>);
                    db.indexes.planet.unique.should.equal(<span class="hljs-literal">true</span>);
                    db.indexes.planet.sparse.should.equal(<span class="hljs-literal">false</span>);                  
                    db.indexes.bloup.unique.should.equal(<span class="hljs-literal">false</span>);
                    db.indexes.bloup.sparse.should.equal(<span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>After another reload the indexes are still there (i.e. they are preserved during autocompaction)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    db = <span class="hljs-keyword">new</span> Datastore({ filename: persDb });
                    db.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                      assert.isNull(err);
                      <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">3</span>);
                      <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
                      <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">"planet"</span>);
                      <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">2</span>].should.equal(<span class="hljs-string">"bloup"</span>);
                      db.indexes._id.getAll().length.should.equal(<span class="hljs-number">3</span>);
                      db.indexes.planet.getAll().length.should.equal(<span class="hljs-number">3</span>);
                      db.indexes.bloup.getAll().length.should.equal(<span class="hljs-number">0</span>);
                      db.indexes.planet.unique.should.equal(<span class="hljs-literal">true</span>);
                      db.indexes.planet.sparse.should.equal(<span class="hljs-literal">false</span>);
                      db.indexes.bloup.unique.should.equal(<span class="hljs-literal">false</span>);
                      db.indexes.bloup.sparse.should.equal(<span class="hljs-literal">true</span>);
                  
                      done();                
                    });
                  });
                });
              });
            });
          });
        });
      });
    
      it(<span class="hljs-string">'Indexes can also be removed and the remove persisted'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        <span class="hljs-keyword">var</span> persDb = <span class="hljs-string">"workspace/persistIndexes.db"</span>
          , db
          ;
        
        <span class="hljs-keyword">if</span> (fs.existsSync(persDb)) { fs.writeFileSync(persDb, <span class="hljs-string">''</span>, <span class="hljs-string">'utf8'</span>); }
        db = <span class="hljs-keyword">new</span> Datastore({ filename: persDb, autoload: <span class="hljs-literal">true</span> });
        
        <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">1</span>);
        <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
        
        db.insert({ planet: <span class="hljs-string">"Earth"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          assert.isNull(err);
          db.insert({ planet: <span class="hljs-string">"Mars"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            assert.isNull(err);
            
            db.ensureIndex({ fieldName: <span class="hljs-string">"planet"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              assert.isNull(err);
              db.ensureIndex({ fieldName: <span class="hljs-string">"another"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                assert.isNull(err);
                <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">3</span>);
                <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
                <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">"planet"</span>);
                <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">2</span>].should.equal(<span class="hljs-string">"another"</span>);
                db.indexes._id.getAll().length.should.equal(<span class="hljs-number">2</span>);
                db.indexes.planet.getAll().length.should.equal(<span class="hljs-number">2</span>);
                db.indexes.planet.fieldName.should.equal(<span class="hljs-string">"planet"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>After a reload the indexes are recreated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                db = <span class="hljs-keyword">new</span> Datastore({ filename: persDb });
                db.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                  assert.isNull(err);
                  <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">3</span>);
                  <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
                  <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">"planet"</span>);  
                  <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">2</span>].should.equal(<span class="hljs-string">"another"</span>);                 
                  db.indexes._id.getAll().length.should.equal(<span class="hljs-number">2</span>);
                  db.indexes.planet.getAll().length.should.equal(<span class="hljs-number">2</span>);
                  db.indexes.planet.fieldName.should.equal(<span class="hljs-string">"planet"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Index is removed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  db.removeIndex(<span class="hljs-string">"planet"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                    assert.isNull(err);
                    <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">2</span>);
                    <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
                    <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">"another"</span>);
                    db.indexes._id.getAll().length.should.equal(<span class="hljs-number">2</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>After a reload indexes are preserved</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    db = <span class="hljs-keyword">new</span> Datastore({ filename: persDb });
                    db.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                      assert.isNull(err);
                      <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">2</span>);
                      <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
                      <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">"another"</span>);
                      db.indexes._id.getAll().length.should.equal(<span class="hljs-number">2</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>After another reload the indexes are still there (i.e. they are preserved during autocompaction)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                      db = <span class="hljs-keyword">new</span> Datastore({ filename: persDb });
                      db.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                        assert.isNull(err);
                        <span class="hljs-built_in">Object</span>.keys(db.indexes).length.should.equal(<span class="hljs-number">2</span>);
                        <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"_id"</span>);
                        <span class="hljs-built_in">Object</span>.keys(db.indexes)[<span class="hljs-number">1</span>].should.equal(<span class="hljs-string">"another"</span>);
                        db.indexes._id.getAll().length.should.equal(<span class="hljs-number">2</span>);
                    
                        done();                
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
      
    });   <span class="hljs-comment">// ==== End of 'Persisting indexes' ====    </span>

  });   <span class="hljs-comment">// ==== End of 'Using indexes' ==== //</span>


});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
