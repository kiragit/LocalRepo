<!DOCTYPE html>

<html>
<head>
  <title>cursor.test.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>cursor.test.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> should = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).should()
  , assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).assert
  , testDb = <span class="hljs-string">'workspace/test.db'</span>
  , fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
  , path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
  , _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
  , async = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)
  , model = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/model'</span>)
  , Datastore = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/datastore'</span>)
  , Persistence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/persistence'</span>)
  , Cursor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/cursor'</span>)
  ;


describe(<span class="hljs-string">'Cursor'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> d;

  beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    d = <span class="hljs-keyword">new</span> Datastore({ filename: testDb });
    d.filename.should.equal(testDb);
    d.inMemoryOnly.should.equal(<span class="hljs-literal">false</span>);

    async.waterfall([
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        Persistence.ensureDirectoryExists(path.dirname(testDb), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          fs.exists(testDb, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(exists)</span> </span>{
            <span class="hljs-keyword">if</span> (exists) {
              fs.unlink(testDb, cb);
            } <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> cb(); }
          });
        });
      }
    , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          assert.isNull(err);
          d.getAllData().length.should.equal(<span class="hljs-number">0</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
    ], done);
  });
  
  describe(<span class="hljs-string">'Without sorting'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ age: <span class="hljs-number">5</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        d.insert({ age: <span class="hljs-number">57</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          d.insert({ age: <span class="hljs-number">52</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            d.insert({ age: <span class="hljs-number">23</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              d.insert({ age: <span class="hljs-number">89</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">return</span> done();
              });
            });
          });
        });
      });
    });
  
    it(<span class="hljs-string">'Without query, an empty query or a simple query and no skip or limit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
        cursor.exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isNull(err);
          docs.length.should.equal(<span class="hljs-number">5</span>);
          _.filter(docs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.age === <span class="hljs-number">5</span>; })[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">5</span>);
          _.filter(docs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.age === <span class="hljs-number">57</span>; })[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">57</span>);
          _.filter(docs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.age === <span class="hljs-number">52</span>; })[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">52</span>);
          _.filter(docs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.age === <span class="hljs-number">23</span>; })[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">23</span>);
          _.filter(docs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.age === <span class="hljs-number">89</span>; })[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">89</span>);
          cb();
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, {});
        cursor.exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isNull(err);
          docs.length.should.equal(<span class="hljs-number">5</span>);
          _.filter(docs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.age === <span class="hljs-number">5</span>; })[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">5</span>);
          _.filter(docs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.age === <span class="hljs-number">57</span>; })[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">57</span>);
          _.filter(docs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.age === <span class="hljs-number">52</span>; })[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">52</span>);
          _.filter(docs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.age === <span class="hljs-number">23</span>; })[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">23</span>);
          _.filter(docs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.age === <span class="hljs-number">89</span>; })[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">89</span>);
          cb();
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, { age: { $gt: <span class="hljs-number">23</span> } });
        cursor.exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isNull(err);
          docs.length.should.equal(<span class="hljs-number">3</span>);
          _.filter(docs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.age === <span class="hljs-number">57</span>; })[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">57</span>);
          _.filter(docs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.age === <span class="hljs-number">52</span>; })[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">52</span>);
          _.filter(docs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.age === <span class="hljs-number">89</span>; })[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">89</span>);
          cb();
        });
      }
      ], done);
    });
    
    it(<span class="hljs-string">'With an empty collection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          d.remove({}, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{ <span class="hljs-keyword">return</span> cb(err); })
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">0</span>);
            cb();
          });
        }
      ], done);
    });
    
    it(<span class="hljs-string">'With a limit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
      cursor.limit(<span class="hljs-number">3</span>);
      cursor.exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
        assert.isNull(err);
        docs.length.should.equal(<span class="hljs-number">3</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>No way to predict which results are returned of course …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        done();
      });
    });

    it(<span class="hljs-string">'With a skip'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
      cursor.skip(<span class="hljs-number">2</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
        assert.isNull(err);
        docs.length.should.equal(<span class="hljs-number">3</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>No way to predict which results are returned of course …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        done();
      });
    });
    
    it(<span class="hljs-string">'With a limit and a skip and method chaining'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
      cursor.limit(<span class="hljs-number">4</span>).skip(<span class="hljs-number">3</span>);   <span class="hljs-comment">// Only way to know that the right number of results was skipped is if limit + skip &gt; number of results</span>
      cursor.exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
        assert.isNull(err);
        docs.length.should.equal(<span class="hljs-number">2</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>No way to predict which results are returned of course …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        done();
      });
    });
    
  });   <span class="hljs-comment">// ===== End of 'Without sorting' =====</span>
  
  
  describe(<span class="hljs-string">'Sorting of the results'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>We don’t know the order in which docs wil be inserted but we ensure correctness by testing both sort orders</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      d.insert({ age: <span class="hljs-number">5</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        d.insert({ age: <span class="hljs-number">57</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          d.insert({ age: <span class="hljs-number">52</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            d.insert({ age: <span class="hljs-number">23</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              d.insert({ age: <span class="hljs-number">89</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">return</span> done();
              });
            });
          });
        });
      });
    });
  
    it(<span class="hljs-string">'Using one sort'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> cursor, i;

      cursor = <span class="hljs-keyword">new</span> Cursor(d, {});
      cursor.sort({ age: <span class="hljs-number">1</span> });
      cursor.exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
        assert.isNull(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Results are in ascending order</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; docs.length - <span class="hljs-number">1</span>; i += <span class="hljs-number">1</span>) {
          assert(docs[i].age &lt; docs[i + <span class="hljs-number">1</span>].age)
        }
        
        cursor.sort({ age: -<span class="hljs-number">1</span> });
        cursor.exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isNull(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Results are in descending order</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; docs.length - <span class="hljs-number">1</span>; i += <span class="hljs-number">1</span>) {
            assert(docs[i].age &gt; docs[i + <span class="hljs-number">1</span>].age)
          }

          done();
        });          
      });
    });
    
    it(<span class="hljs-string">'With an empty collection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          d.remove({}, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{ <span class="hljs-keyword">return</span> cb(err); })
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.sort({ age: <span class="hljs-number">1</span> });
          cursor.exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">0</span>);
            cb();
          });
        }
      ], done);
    });
    
    it(<span class="hljs-string">'Ability to chain sorting and exec'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> i;    
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.sort({ age: <span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Results are in ascending order</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; docs.length - <span class="hljs-number">1</span>; i += <span class="hljs-number">1</span>) {
              assert(docs[i].age &lt; docs[i + <span class="hljs-number">1</span>].age)
            }
            cb();
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.sort({ age: -<span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Results are in descending order</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; docs.length - <span class="hljs-number">1</span>; i += <span class="hljs-number">1</span>) {
              assert(docs[i].age &gt; docs[i + <span class="hljs-number">1</span>].age)
            }
            cb();
          });
        }
      ], done);
    });

    it(<span class="hljs-string">'Using limit and sort'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> i;    
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.sort({ age: <span class="hljs-number">1</span> }).limit(<span class="hljs-number">3</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">3</span>);
            docs[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">5</span>);
            docs[<span class="hljs-number">1</span>].age.should.equal(<span class="hljs-number">23</span>);
            docs[<span class="hljs-number">2</span>].age.should.equal(<span class="hljs-number">52</span>);
            cb();
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.sort({ age: -<span class="hljs-number">1</span> }).limit(<span class="hljs-number">2</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">2</span>);
            docs[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">89</span>);
            docs[<span class="hljs-number">1</span>].age.should.equal(<span class="hljs-number">57</span>);
            cb();
          });
        }
      ], done);
    });

    it(<span class="hljs-string">'Using a limit higher than total number of docs shouldnt cause an error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> i;    
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.sort({ age: <span class="hljs-number">1</span> }).limit(<span class="hljs-number">7</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">5</span>);
            docs[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">5</span>);
            docs[<span class="hljs-number">1</span>].age.should.equal(<span class="hljs-number">23</span>);
            docs[<span class="hljs-number">2</span>].age.should.equal(<span class="hljs-number">52</span>);
            docs[<span class="hljs-number">3</span>].age.should.equal(<span class="hljs-number">57</span>);
            docs[<span class="hljs-number">4</span>].age.should.equal(<span class="hljs-number">89</span>);
            cb();
          });
        }
      ], done);
    });

    it(<span class="hljs-string">'Using limit and skip with sort'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> i;    
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.sort({ age: <span class="hljs-number">1</span> }).limit(<span class="hljs-number">1</span>).skip(<span class="hljs-number">2</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">1</span>);
            docs[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">52</span>);
            cb();
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.sort({ age: <span class="hljs-number">1</span> }).limit(<span class="hljs-number">3</span>).skip(<span class="hljs-number">1</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">3</span>);
            docs[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">23</span>);
            docs[<span class="hljs-number">1</span>].age.should.equal(<span class="hljs-number">52</span>);
            docs[<span class="hljs-number">2</span>].age.should.equal(<span class="hljs-number">57</span>);
            cb();
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.sort({ age: -<span class="hljs-number">1</span> }).limit(<span class="hljs-number">2</span>).skip(<span class="hljs-number">2</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">2</span>);
            docs[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">52</span>);
            docs[<span class="hljs-number">1</span>].age.should.equal(<span class="hljs-number">23</span>);
            cb();
          });
        }
      ], done);
    });
    
    it(<span class="hljs-string">'Using too big a limit and a skip with sort'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> i;    
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.sort({ age: <span class="hljs-number">1</span> }).limit(<span class="hljs-number">8</span>).skip(<span class="hljs-number">2</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">3</span>);
            docs[<span class="hljs-number">0</span>].age.should.equal(<span class="hljs-number">52</span>);
            docs[<span class="hljs-number">1</span>].age.should.equal(<span class="hljs-number">57</span>);
            docs[<span class="hljs-number">2</span>].age.should.equal(<span class="hljs-number">89</span>);
            cb();
          });
        }
      ], done);
    });

    it(<span class="hljs-string">'Using too big a skip with sort should return no result'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> i;    
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.sort({ age: <span class="hljs-number">1</span> }).skip(<span class="hljs-number">5</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">0</span>);
            cb();
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.sort({ age: <span class="hljs-number">1</span> }).skip(<span class="hljs-number">7</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">0</span>);
            cb();
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.sort({ age: <span class="hljs-number">1</span> }).limit(<span class="hljs-number">3</span>).skip(<span class="hljs-number">7</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">0</span>);
            cb();
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d);
          cursor.sort({ age: <span class="hljs-number">1</span> }).limit(<span class="hljs-number">6</span>).skip(<span class="hljs-number">7</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">0</span>);
            cb();
          });
        }
      ], done);
    });
    
    it(<span class="hljs-string">'Sorting strings'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          d.remove({}, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> cb(err); }

            d.insert({ name: <span class="hljs-string">'jako'</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
              d.insert({ name: <span class="hljs-string">'jakeb'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                d.insert({ name: <span class="hljs-string">'sue'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                  <span class="hljs-keyword">return</span> cb();
                });
              });            
            });
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, {});
          cursor.sort({ name: <span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">3</span>);
            docs[<span class="hljs-number">0</span>].name.should.equal(<span class="hljs-string">'jakeb'</span>);
            docs[<span class="hljs-number">1</span>].name.should.equal(<span class="hljs-string">'jako'</span>);
            docs[<span class="hljs-number">2</span>].name.should.equal(<span class="hljs-string">'sue'</span>);
            <span class="hljs-keyword">return</span> cb();
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, {});
          cursor.sort({ name: -<span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">3</span>);
            docs[<span class="hljs-number">0</span>].name.should.equal(<span class="hljs-string">'sue'</span>);
            docs[<span class="hljs-number">1</span>].name.should.equal(<span class="hljs-string">'jako'</span>);
            docs[<span class="hljs-number">2</span>].name.should.equal(<span class="hljs-string">'jakeb'</span>);
            <span class="hljs-keyword">return</span> cb();
          });
        }
      ], done);
    });
    
    it(<span class="hljs-string">'Sorting nested fields with dates'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> doc1, doc2, doc3;
      
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          d.remove({}, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> cb(err); }

            d.insert({ event: { recorded: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">400</span>) } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc1)</span> </span>{
              doc1 = _doc1;
              d.insert({ event: { recorded: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">60000</span>) } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc2)</span> </span>{
                doc2 = _doc2;
                d.insert({ event: { recorded: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">32</span>) } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc3)</span> </span>{
                  doc3 = _doc3;
                  <span class="hljs-keyword">return</span> cb();
                });
              });            
            });
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, {});
          cursor.sort({ <span class="hljs-string">"event.recorded"</span>: <span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">3</span>);
            docs[<span class="hljs-number">0</span>]._id.should.equal(doc3._id);
            docs[<span class="hljs-number">1</span>]._id.should.equal(doc1._id);
            docs[<span class="hljs-number">2</span>]._id.should.equal(doc2._id);
            <span class="hljs-keyword">return</span> cb();
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, {});
          cursor.sort({ <span class="hljs-string">"event.recorded"</span>: -<span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">3</span>);
            docs[<span class="hljs-number">0</span>]._id.should.equal(doc2._id);
            docs[<span class="hljs-number">1</span>]._id.should.equal(doc1._id);
            docs[<span class="hljs-number">2</span>]._id.should.equal(doc3._id);
            <span class="hljs-keyword">return</span> cb();
          });
        }
      ], done);
    });
    
    it(<span class="hljs-string">'Sorting when some fields are undefined'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{      
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          d.remove({}, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> cb(err); }

            d.insert({ name: <span class="hljs-string">'jako'</span>, other: <span class="hljs-number">2</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
              d.insert({ name: <span class="hljs-string">'jakeb'</span>, other: <span class="hljs-number">3</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                d.insert({ name: <span class="hljs-string">'sue'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                  d.insert({ name: <span class="hljs-string">'henry'</span>, other: <span class="hljs-number">4</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">return</span> cb();
                  });
                });
              });            
            });
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, {});
          cursor.sort({ other: <span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">4</span>);
            docs[<span class="hljs-number">0</span>].name.should.equal(<span class="hljs-string">'sue'</span>);
            assert.isUndefined(docs[<span class="hljs-number">0</span>].other);
            docs[<span class="hljs-number">1</span>].name.should.equal(<span class="hljs-string">'jako'</span>);
            docs[<span class="hljs-number">1</span>].other.should.equal(<span class="hljs-number">2</span>);
            docs[<span class="hljs-number">2</span>].name.should.equal(<span class="hljs-string">'jakeb'</span>);
            docs[<span class="hljs-number">2</span>].other.should.equal(<span class="hljs-number">3</span>);
            docs[<span class="hljs-number">3</span>].name.should.equal(<span class="hljs-string">'henry'</span>);
            docs[<span class="hljs-number">3</span>].other.should.equal(<span class="hljs-number">4</span>);
            <span class="hljs-keyword">return</span> cb();
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, { name: { $<span class="hljs-keyword">in</span>: [ <span class="hljs-string">'suzy'</span>, <span class="hljs-string">'jakeb'</span>, <span class="hljs-string">'jako'</span> ] } });
          cursor.sort({ other: -<span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">2</span>);
            docs[<span class="hljs-number">0</span>].name.should.equal(<span class="hljs-string">'jakeb'</span>);
            docs[<span class="hljs-number">0</span>].other.should.equal(<span class="hljs-number">3</span>);
            docs[<span class="hljs-number">1</span>].name.should.equal(<span class="hljs-string">'jako'</span>);
            docs[<span class="hljs-number">1</span>].other.should.equal(<span class="hljs-number">2</span>);
            <span class="hljs-keyword">return</span> cb();
          });
        }
      ], done);
    });
    
    it(<span class="hljs-string">'Sorting when all fields are undefined'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{      
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          d.remove({}, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> cb(err); }

            d.insert({ name: <span class="hljs-string">'jako'</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
              d.insert({ name: <span class="hljs-string">'jakeb'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                d.insert({ name: <span class="hljs-string">'sue'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                  <span class="hljs-keyword">return</span> cb();
                });
              });            
            });
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, {});
          cursor.sort({ other: <span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">3</span>);
            <span class="hljs-keyword">return</span> cb();
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, { name: { $<span class="hljs-keyword">in</span>: [ <span class="hljs-string">'sue'</span>, <span class="hljs-string">'jakeb'</span>, <span class="hljs-string">'jakob'</span> ] } });
          cursor.sort({ other: -<span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">2</span>);
            <span class="hljs-keyword">return</span> cb();
          });
        }
      ], done);
    });

    it(<span class="hljs-string">'Multiple consecutive sorts'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(done)</span> </span>{
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          d.remove({}, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> cb(err); }

            d.insert({ name: <span class="hljs-string">'jako'</span>, age: <span class="hljs-number">43</span>, nid: <span class="hljs-number">1</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
              d.insert({ name: <span class="hljs-string">'jakeb'</span>, age: <span class="hljs-number">43</span>, nid: <span class="hljs-number">2</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                d.insert({ name: <span class="hljs-string">'sue'</span>, age: <span class="hljs-number">12</span>, nid: <span class="hljs-number">3</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                  d.insert({ name: <span class="hljs-string">'zoe'</span>, age: <span class="hljs-number">23</span>, nid: <span class="hljs-number">4</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    d.insert({ name: <span class="hljs-string">'jako'</span>, age: <span class="hljs-number">35</span>, nid: <span class="hljs-number">5</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                      <span class="hljs-keyword">return</span> cb();
                    });
                  });
                });
              });            
            });
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, {});
          cursor.sort({ name: <span class="hljs-number">1</span>, age: -<span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">5</span>);
            
            docs[<span class="hljs-number">0</span>].nid.should.equal(<span class="hljs-number">2</span>);
            docs[<span class="hljs-number">1</span>].nid.should.equal(<span class="hljs-number">1</span>);
            docs[<span class="hljs-number">2</span>].nid.should.equal(<span class="hljs-number">5</span>);
            docs[<span class="hljs-number">3</span>].nid.should.equal(<span class="hljs-number">3</span>);
            docs[<span class="hljs-number">4</span>].nid.should.equal(<span class="hljs-number">4</span>);
            <span class="hljs-keyword">return</span> cb();
          });
        }
        , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, {});
          cursor.sort({ name: <span class="hljs-number">1</span>, age: <span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">5</span>);
            
            docs[<span class="hljs-number">0</span>].nid.should.equal(<span class="hljs-number">2</span>);
            docs[<span class="hljs-number">1</span>].nid.should.equal(<span class="hljs-number">5</span>);
            docs[<span class="hljs-number">2</span>].nid.should.equal(<span class="hljs-number">1</span>);
            docs[<span class="hljs-number">3</span>].nid.should.equal(<span class="hljs-number">3</span>);
            docs[<span class="hljs-number">4</span>].nid.should.equal(<span class="hljs-number">4</span>);
            <span class="hljs-keyword">return</span> cb();
          });
        }
        , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, {});
          cursor.sort({ age: <span class="hljs-number">1</span>, name: <span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">5</span>);
            
            docs[<span class="hljs-number">0</span>].nid.should.equal(<span class="hljs-number">3</span>);
            docs[<span class="hljs-number">1</span>].nid.should.equal(<span class="hljs-number">4</span>);
            docs[<span class="hljs-number">2</span>].nid.should.equal(<span class="hljs-number">5</span>);
            docs[<span class="hljs-number">3</span>].nid.should.equal(<span class="hljs-number">2</span>);
            docs[<span class="hljs-number">4</span>].nid.should.equal(<span class="hljs-number">1</span>);
            <span class="hljs-keyword">return</span> cb();
          });
        }
        , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, {});
          cursor.sort({ age: <span class="hljs-number">1</span>, name: -<span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">5</span>);
            
            docs[<span class="hljs-number">0</span>].nid.should.equal(<span class="hljs-number">3</span>);
            docs[<span class="hljs-number">1</span>].nid.should.equal(<span class="hljs-number">4</span>);
            docs[<span class="hljs-number">2</span>].nid.should.equal(<span class="hljs-number">5</span>);
            docs[<span class="hljs-number">3</span>].nid.should.equal(<span class="hljs-number">1</span>);
            docs[<span class="hljs-number">4</span>].nid.should.equal(<span class="hljs-number">2</span>);
            <span class="hljs-keyword">return</span> cb();
          });
        }
      ], done);    });

    it(<span class="hljs-string">'Similar data, multiple consecutive sorts'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> i, j, id
        , companies = [ <span class="hljs-string">'acme'</span>, <span class="hljs-string">'milkman'</span>, <span class="hljs-string">'zoinks'</span> ]
        , entities = []
        ;
    
      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          d.remove({}, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> cb(err); }
            
            id = <span class="hljs-number">1</span>;
            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; companies.length; i++) {
              <span class="hljs-keyword">for</span> (j = <span class="hljs-number">5</span>; j &lt;= <span class="hljs-number">100</span>; j += <span class="hljs-number">5</span>) {
                entities.push({
                  company: companies[i],
                  cost: j,
                  nid: id
                });
                id++;
              }
            }

            async.each(entities, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(entity, callback)</span> </span>{
              d.insert(entity, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
                callback();
              });
            }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
              <span class="hljs-keyword">return</span> cb();
            });
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(d, {});
          cursor.sort({ company: <span class="hljs-number">1</span>, cost: <span class="hljs-number">1</span> }).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">60</span>);
            
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; docs.length; i++) {
              docs[i].nid.should.equal(i+<span class="hljs-number">1</span>);
            };
            <span class="hljs-keyword">return</span> cb();
          });
        }
      ], done);    });

  });   <span class="hljs-comment">// ===== End of 'Sorting' =====</span>
  
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
