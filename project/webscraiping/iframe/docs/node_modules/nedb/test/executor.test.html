<!DOCTYPE html>

<html>
<head>
  <title>executor.test.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>executor.test.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> should = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).should()
  , assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).assert
  , testDb = <span class="hljs-string">'workspace/test.db'</span>
  , fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
  , path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
  , _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
  , async = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)
  , model = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/model'</span>)
  , Datastore = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/datastore'</span>)
  , Persistence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/persistence'</span>)
  ;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Test that even if a callback throws an exception, the next DB operations will still be executed
We prevent Mocha from catching the exception we throw on purpose by remembering all current handlers, remove them and register them back after test ends</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testThrowInCallback</span> <span class="hljs-params">(d, done)</span> </span>{
  <span class="hljs-keyword">var</span> currentUncaughtExceptionHandlers = process.listeners(<span class="hljs-string">'uncaughtException'</span>);
  
  process.removeAllListeners(<span class="hljs-string">'uncaughtException'</span>);

  process.on(<span class="hljs-string">'uncaughtException'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Do nothing with the error which is only there to test we stay on track</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  });

  d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{    
    process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      d.insert({ bar: <span class="hljs-number">1</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; currentUncaughtExceptionHandlers.length; i += <span class="hljs-number">1</span>) {
          process.on(<span class="hljs-string">'uncaughtException'</span>, currentUncaughtExceptionHandlers[i]);
        }
        
        done();
      });
    });
    
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Some error'</span>;
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Test that operations are executed in the right order
We prevent Mocha from catching the exception we throw on purpose by remembering all current handlers, remove them and register them back after test ends</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testRightOrder</span> <span class="hljs-params">(d, done)</span> </span>{
  <span class="hljs-keyword">var</span> currentUncaughtExceptionHandlers = process.listeners(<span class="hljs-string">'uncaughtException'</span>);
  
  process.removeAllListeners(<span class="hljs-string">'uncaughtException'</span>);

  process.on(<span class="hljs-string">'uncaughtException'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Do nothing with the error which is only there to test we stay on track</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  });

  d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
    docs.length.should.equal(<span class="hljs-number">0</span>);
  
    d.insert({ a: <span class="hljs-number">1</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      d.update({ a: <span class="hljs-number">1</span> }, { a: <span class="hljs-number">2</span> }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          docs[<span class="hljs-number">0</span>].a.should.equal(<span class="hljs-number">2</span>);
          
          process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            d.update({ a: <span class="hljs-number">2</span> }, { a: <span class="hljs-number">3</span> }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
              d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                docs[<span class="hljs-number">0</span>].a.should.equal(<span class="hljs-number">3</span>);
                done();

              });
            });
          });
          
          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Some error'</span>;
        });
      });
    });
  });
}  
  
  

describe(<span class="hljs-string">'Executor'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

  describe(<span class="hljs-string">'With persistent database'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> d;

    beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d = <span class="hljs-keyword">new</span> Datastore({ filename: testDb });
      d.filename.should.equal(testDb);
      d.inMemoryOnly.should.equal(<span class="hljs-literal">false</span>);

      async.waterfall([
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          Persistence.ensureDirectoryExists(path.dirname(testDb), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            fs.exists(testDb, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(exists)</span> </span>{
              <span class="hljs-keyword">if</span> (exists) {
                fs.unlink(testDb, cb);
              } <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> cb(); }
            });
          });
        }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
          d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            assert.isNull(err);
            d.getAllData().length.should.equal(<span class="hljs-number">0</span>);
            <span class="hljs-keyword">return</span> cb();
          });
        }
      ], done);
    });

    it(<span class="hljs-string">'A throw in a callback doesnt prevent execution of next operations'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(done)</span> </span>{
      testThrowInCallback(d, done);
    });
    
    it(<span class="hljs-string">'Operations are executed in the right order'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(done)</span> </span>{
      testRightOrder(d, done);
    });
  
  });   <span class="hljs-comment">// ==== End of 'With persistent database' ====</span>


  describe(<span class="hljs-string">'With non persistent database'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> d;

    beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d = <span class="hljs-keyword">new</span> Datastore({ inMemoryOnly: <span class="hljs-literal">true</span> });
      d.inMemoryOnly.should.equal(<span class="hljs-literal">true</span>);

      d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        assert.isNull(err);
        d.getAllData().length.should.equal(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> done();
      });
    });

    it(<span class="hljs-string">'A throw in a callback doesnt prevent execution of next operations'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(done)</span> </span>{
      testThrowInCallback(d, done);
    });
  
    it(<span class="hljs-string">'Operations are executed in the right order'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(done)</span> </span>{
      testRightOrder(d, done);
    });
  
  });   <span class="hljs-comment">// ==== End of 'With non persistent database' ====</span>

});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
