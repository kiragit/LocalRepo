<!DOCTYPE html>

<html>
<head>
  <title>indexes.test.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>indexes.test.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Index = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/indexes'</span>)
  , customUtils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/customUtils'</span>)
  , should = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).should()
  , assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).assert
  , _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
  , async = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)
  , model = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/model'</span>)
  ;

describe(<span class="hljs-string">'Indexes'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

  describe(<span class="hljs-string">'Insertion'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    it(<span class="hljs-string">'Can insert pointers to documents in the index correctly when they have the field'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>The underlying BST now has 3 nodes which contain the docs where it’s expected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'hello'</span>), [{ a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }]);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'world'</span>), [{ a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }]);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'bloup'</span>), [{ a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }]);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The nodes contain pointers to the actual documents</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      idx.tree.search(<span class="hljs-string">'world'</span>)[<span class="hljs-number">0</span>].should.equal(doc2);
      idx.tree.search(<span class="hljs-string">'bloup'</span>)[<span class="hljs-number">0</span>].a = <span class="hljs-number">42</span>;
      doc3.a.should.equal(<span class="hljs-number">42</span>);
    });

    it(<span class="hljs-string">'Inserting twice for the same fieldName in a unique index will result in an error thrown'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span>, unique: <span class="hljs-literal">true</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        ;

      idx.insert(doc1);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
      (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ idx.insert(doc1); }).should.throw();
    });

    it(<span class="hljs-string">'Inserting twice for a fieldName the docs dont have with a unique index results in an error thrown'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'nope'</span>, unique: <span class="hljs-literal">true</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'world'</span> }
        ;

      idx.insert(doc1);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
      (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ idx.insert(doc2); }).should.throw();
    });

    it(<span class="hljs-string">'Inserting twice for a fieldName the docs dont have with a unique and sparse index will not throw, since the docs will be non indexed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'nope'</span>, unique: <span class="hljs-literal">true</span>, sparse: <span class="hljs-literal">true</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'world'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);   <span class="hljs-comment">// Docs are not indexed</span>
    });

    it(<span class="hljs-string">'Works with dot notation'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf.nested'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: { nested: <span class="hljs-string">'hello'</span> } }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: { nested: <span class="hljs-string">'world'</span>, additional: <span class="hljs-literal">true</span> } }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: { nested: <span class="hljs-string">'bloup'</span>, age: <span class="hljs-number">42</span> } }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The underlying BST now has 3 nodes which contain the docs where it’s expected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'hello'</span>), [doc1]);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'world'</span>), [doc2]);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'bloup'</span>), [doc3]);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>The nodes contain pointers to the actual documents</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      idx.tree.search(<span class="hljs-string">'bloup'</span>)[<span class="hljs-number">0</span>].a = <span class="hljs-number">42</span>;
      doc3.a.should.equal(<span class="hljs-number">42</span>);
    });

    it(<span class="hljs-string">'Can insert an array of documents'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        ;

      idx.insert([doc1, doc2, doc3]);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'hello'</span>), [doc1]);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'world'</span>), [doc2]);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'bloup'</span>), [doc3]);
    });

    it(<span class="hljs-string">'When inserting an array of elements, if an error is thrown all inserts need to be rolled back'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span>, unique: <span class="hljs-literal">true</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc2b = { a: <span class="hljs-number">84</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        ;

      <span class="hljs-keyword">try</span> {
        idx.insert([doc1, doc2, doc2b, doc3]);
      } <span class="hljs-keyword">catch</span> (e) {
        e.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);
      }
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'hello'</span>), []);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'world'</span>), []);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'bloup'</span>), []);
    });
	
	describe(<span class="hljs-string">'Array fields'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
	
	  it(<span class="hljs-string">'Inserts one entry per array element in the index'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> obj = { tf: [<span class="hljs-string">'aa'</span>, <span class="hljs-string">'bb'</span>], really: <span class="hljs-string">'yeah'</span> }
        , obj2 = { tf: <span class="hljs-string">'normal'</span>, yes: <span class="hljs-string">'indeed'</span> }
        , idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        ;
      
      idx.insert(obj);
      idx.getAll().length.should.equal(<span class="hljs-number">2</span>);
      idx.getAll()[<span class="hljs-number">0</span>].should.equal(obj);
      idx.getAll()[<span class="hljs-number">1</span>].should.equal(obj);

      idx.insert(obj2);
      idx.getAll().length.should.equal(<span class="hljs-number">3</span>);
	  });

	  it(<span class="hljs-string">'Inserts one entry per array element in the index, type-checked'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> obj = { tf: [<span class="hljs-string">'42'</span>, <span class="hljs-number">42</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">42</span>), <span class="hljs-number">42</span>], really: <span class="hljs-string">'yeah'</span> }
        , idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        ;
      
      idx.insert(obj);
      idx.getAll().length.should.equal(<span class="hljs-number">3</span>);
      idx.getAll()[<span class="hljs-number">0</span>].should.equal(obj);
      idx.getAll()[<span class="hljs-number">1</span>].should.equal(obj);
      idx.getAll()[<span class="hljs-number">2</span>].should.equal(obj);
	  });
    
	  it(<span class="hljs-string">'Inserts one entry per unique array element in the index, the unique constraint only holds across documents'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> obj = { tf: [<span class="hljs-string">'aa'</span>, <span class="hljs-string">'aa'</span>], really: <span class="hljs-string">'yeah'</span> }
        , obj2 = { tf: [<span class="hljs-string">'cc'</span>, <span class="hljs-string">'yy'</span>, <span class="hljs-string">'cc'</span>], yes: <span class="hljs-string">'indeed'</span> }
        , idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span>, unique: <span class="hljs-literal">true</span> })
        ;
      
      idx.insert(obj);
      idx.getAll().length.should.equal(<span class="hljs-number">1</span>);
      idx.getAll()[<span class="hljs-number">0</span>].should.equal(obj);

      idx.insert(obj2);
      idx.getAll().length.should.equal(<span class="hljs-number">3</span>);
	  });

	  it(<span class="hljs-string">'The unique constraint holds across documents'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> obj = { tf: [<span class="hljs-string">'aa'</span>, <span class="hljs-string">'aa'</span>], really: <span class="hljs-string">'yeah'</span> }
        , obj2 = { tf: [<span class="hljs-string">'cc'</span>, <span class="hljs-string">'aa'</span>, <span class="hljs-string">'cc'</span>], yes: <span class="hljs-string">'indeed'</span> }
        , idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span>, unique: <span class="hljs-literal">true</span> })
        ;
      
      idx.insert(obj);
      idx.getAll().length.should.equal(<span class="hljs-number">1</span>);
      idx.getAll()[<span class="hljs-number">0</span>].should.equal(obj);

      (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ idx.insert(obj2); }).should.throw();
	  });
    
    it(<span class="hljs-string">'When removing a document, remove it from the index at all unique array elements'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> obj = { tf: [<span class="hljs-string">'aa'</span>, <span class="hljs-string">'aa'</span>], really: <span class="hljs-string">'yeah'</span> }
        , obj2 = { tf: [<span class="hljs-string">'cc'</span>, <span class="hljs-string">'aa'</span>, <span class="hljs-string">'cc'</span>], yes: <span class="hljs-string">'indeed'</span> }
        , idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        ;
      
      idx.insert(obj);
      idx.insert(obj2);
      idx.getMatching(<span class="hljs-string">'aa'</span>).length.should.equal(<span class="hljs-number">2</span>);
      idx.getMatching(<span class="hljs-string">'aa'</span>).indexOf(obj).should.not.equal(-<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'aa'</span>).indexOf(obj2).should.not.equal(-<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'cc'</span>).length.should.equal(<span class="hljs-number">1</span>);

      idx.remove(obj2);
      idx.getMatching(<span class="hljs-string">'aa'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'aa'</span>).indexOf(obj).should.not.equal(-<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'aa'</span>).indexOf(obj2).should.equal(-<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'cc'</span>).length.should.equal(<span class="hljs-number">0</span>);      
    });
    
    it(<span class="hljs-string">'If a unique constraint is violated when inserting an array key, roll back all inserts before the key'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> obj = { tf: [<span class="hljs-string">'aa'</span>, <span class="hljs-string">'bb'</span>], really: <span class="hljs-string">'yeah'</span> }
        , obj2 = { tf: [<span class="hljs-string">'cc'</span>, <span class="hljs-string">'dd'</span>, <span class="hljs-string">'aa'</span>, <span class="hljs-string">'ee'</span>], yes: <span class="hljs-string">'indeed'</span> }
        , idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span>, unique: <span class="hljs-literal">true</span> })
        ;

      idx.insert(obj);
      idx.getAll().length.should.equal(<span class="hljs-number">2</span>);
      idx.getMatching(<span class="hljs-string">'aa'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'bb'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'cc'</span>).length.should.equal(<span class="hljs-number">0</span>);
      idx.getMatching(<span class="hljs-string">'dd'</span>).length.should.equal(<span class="hljs-number">0</span>);
      idx.getMatching(<span class="hljs-string">'ee'</span>).length.should.equal(<span class="hljs-number">0</span>);
      
      (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ idx.insert(obj2); }).should.throw();
      idx.getAll().length.should.equal(<span class="hljs-number">2</span>);
      idx.getMatching(<span class="hljs-string">'aa'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'bb'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'cc'</span>).length.should.equal(<span class="hljs-number">0</span>);
      idx.getMatching(<span class="hljs-string">'dd'</span>).length.should.equal(<span class="hljs-number">0</span>);      
      idx.getMatching(<span class="hljs-string">'ee'</span>).length.should.equal(<span class="hljs-number">0</span>);
    });
	
	});   <span class="hljs-comment">// ==== End of 'Array fields' ==== //</span>

  });   <span class="hljs-comment">// ==== End of 'Insertion' ==== //</span>


  describe(<span class="hljs-string">'Removal'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    it(<span class="hljs-string">'Can remove pointers from the index, even when multiple documents have the same key'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        , doc4 = { a: <span class="hljs-number">23</span>, tf: <span class="hljs-string">'world'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);
      idx.insert(doc4);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);

      idx.remove(doc1);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
      idx.tree.search(<span class="hljs-string">'hello'</span>).length.should.equal(<span class="hljs-number">0</span>);

      idx.remove(doc2);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
      idx.tree.search(<span class="hljs-string">'world'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.tree.search(<span class="hljs-string">'world'</span>)[<span class="hljs-number">0</span>].should.equal(doc4);
    });

    it(<span class="hljs-string">'If we have a sparse index, removing a non indexed doc has no effect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'nope'</span>, sparse: <span class="hljs-literal">true</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'world'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);

      idx.remove(doc1);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);
    });

    it(<span class="hljs-string">'Works with dot notation'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf.nested'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: { nested: <span class="hljs-string">'hello'</span> } }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: { nested: <span class="hljs-string">'world'</span>, additional: <span class="hljs-literal">true</span> } }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: { nested: <span class="hljs-string">'bloup'</span>, age: <span class="hljs-number">42</span> } }
        , doc4 = { a: <span class="hljs-number">2</span>, tf: { nested: <span class="hljs-string">'world'</span>, fruits: [<span class="hljs-string">'apple'</span>, <span class="hljs-string">'carrot'</span>] } }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);
      idx.insert(doc4);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);

      idx.remove(doc1);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
      idx.tree.search(<span class="hljs-string">'hello'</span>).length.should.equal(<span class="hljs-number">0</span>);

      idx.remove(doc2);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
      idx.tree.search(<span class="hljs-string">'world'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.tree.search(<span class="hljs-string">'world'</span>)[<span class="hljs-number">0</span>].should.equal(doc4);
    });

    it(<span class="hljs-string">'Can remove an array of documents'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        ;

      idx.insert([doc1, doc2, doc3]);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      idx.remove([doc1, doc3]);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'hello'</span>), []);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'world'</span>), [doc2]);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'bloup'</span>), []);
    });

  });   <span class="hljs-comment">// ==== End of 'Removal' ==== //</span>


  describe(<span class="hljs-string">'Update'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    it(<span class="hljs-string">'Can update a document whose key did or didnt change'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        , doc4 = { a: <span class="hljs-number">23</span>, tf: <span class="hljs-string">'world'</span> }
        , doc5 = { a: <span class="hljs-number">1</span>, tf: <span class="hljs-string">'changed'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'world'</span>), [doc2]);

      idx.update(doc2, doc4);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'world'</span>), [doc4]);

      idx.update(doc1, doc5);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'hello'</span>), []);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'changed'</span>), [doc5]);
    });

    it(<span class="hljs-string">'If a simple update violates a unique constraint, changes are rolled back and an error thrown'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span>, unique: <span class="hljs-literal">true</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        , bad = { a: <span class="hljs-number">23</span>, tf: <span class="hljs-string">'world'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);

      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'hello'</span>), [doc1]);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'world'</span>), [doc2]);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'bloup'</span>), [doc3]);

      <span class="hljs-keyword">try</span> {
        idx.update(doc3, bad);
      } <span class="hljs-keyword">catch</span> (e) {
        e.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>No change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'hello'</span>), [doc1]);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'world'</span>), [doc2]);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'bloup'</span>), [doc3]);
    });

    it(<span class="hljs-string">'Can update an array of documents'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        , doc1b = { a: <span class="hljs-number">23</span>, tf: <span class="hljs-string">'world'</span> }
        , doc2b = { a: <span class="hljs-number">1</span>, tf: <span class="hljs-string">'changed'</span> }
        , doc3b = { a: <span class="hljs-number">44</span>, tf: <span class="hljs-string">'bloup'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);

      idx.update([{ oldDoc: doc1, newDoc: doc1b }, { oldDoc: doc2, newDoc: doc2b }, { oldDoc: doc3, newDoc: doc3b }]);

      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      idx.getMatching(<span class="hljs-string">'world'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'world'</span>)[<span class="hljs-number">0</span>].should.equal(doc1b);
      idx.getMatching(<span class="hljs-string">'changed'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'changed'</span>)[<span class="hljs-number">0</span>].should.equal(doc2b);
      idx.getMatching(<span class="hljs-string">'bloup'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'bloup'</span>)[<span class="hljs-number">0</span>].should.equal(doc3b);
    });

    it(<span class="hljs-string">'If a unique constraint is violated during an array-update, all changes are rolled back and an error thrown'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span>, unique: <span class="hljs-literal">true</span> })
        , doc0 = { a: <span class="hljs-number">432</span>, tf: <span class="hljs-string">'notthistoo'</span> }
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        , doc1b = { a: <span class="hljs-number">23</span>, tf: <span class="hljs-string">'changed'</span> }
        , doc2b = { a: <span class="hljs-number">1</span>, tf: <span class="hljs-string">'changed'</span> }   <span class="hljs-comment">// Will violate the constraint (first try)</span>
        , doc2c = { a: <span class="hljs-number">1</span>, tf: <span class="hljs-string">'notthistoo'</span> }   <span class="hljs-comment">// Will violate the constraint (second try)</span>
        , doc3b = { a: <span class="hljs-number">44</span>, tf: <span class="hljs-string">'alsochanged'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);

      <span class="hljs-keyword">try</span> {
        idx.update([{ oldDoc: doc1, newDoc: doc1b }, { oldDoc: doc2, newDoc: doc2b }, { oldDoc: doc3, newDoc: doc3b }]);
      } <span class="hljs-keyword">catch</span> (e) {
        e.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);
      }

      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>)[<span class="hljs-number">0</span>].should.equal(doc1);
      idx.getMatching(<span class="hljs-string">'world'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'world'</span>)[<span class="hljs-number">0</span>].should.equal(doc2);
      idx.getMatching(<span class="hljs-string">'bloup'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'bloup'</span>)[<span class="hljs-number">0</span>].should.equal(doc3);

      <span class="hljs-keyword">try</span> {
        idx.update([{ oldDoc: doc1, newDoc: doc1b }, { oldDoc: doc2, newDoc: doc2b }, { oldDoc: doc3, newDoc: doc3b }]);
      } <span class="hljs-keyword">catch</span> (e) {
        e.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);
      }

      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>)[<span class="hljs-number">0</span>].should.equal(doc1);
      idx.getMatching(<span class="hljs-string">'world'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'world'</span>)[<span class="hljs-number">0</span>].should.equal(doc2);
      idx.getMatching(<span class="hljs-string">'bloup'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'bloup'</span>)[<span class="hljs-number">0</span>].should.equal(doc3);
    });

    it(<span class="hljs-string">'If an update doesnt change a document, the unique constraint is not violated'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span>, unique: <span class="hljs-literal">true</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        , noChange = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'world'</span>), [doc2]);

      idx.update(doc2, noChange);   <span class="hljs-comment">// No error thrown</span>
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      assert.deepEqual(idx.tree.search(<span class="hljs-string">'world'</span>), [noChange]);
    });

    it(<span class="hljs-string">'Can revert simple and batch updates'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        , doc1b = { a: <span class="hljs-number">23</span>, tf: <span class="hljs-string">'world'</span> }
        , doc2b = { a: <span class="hljs-number">1</span>, tf: <span class="hljs-string">'changed'</span> }
        , doc3b = { a: <span class="hljs-number">44</span>, tf: <span class="hljs-string">'bloup'</span> }
        , batchUpdate = [{ oldDoc: doc1, newDoc: doc1b }, { oldDoc: doc2, newDoc: doc2b }, { oldDoc: doc3, newDoc: doc3b }]
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);

      idx.update(batchUpdate);

      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      idx.getMatching(<span class="hljs-string">'world'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'world'</span>)[<span class="hljs-number">0</span>].should.equal(doc1b);
      idx.getMatching(<span class="hljs-string">'changed'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'changed'</span>)[<span class="hljs-number">0</span>].should.equal(doc2b);
      idx.getMatching(<span class="hljs-string">'bloup'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'bloup'</span>)[<span class="hljs-number">0</span>].should.equal(doc3b);

      idx.revertUpdate(batchUpdate);

      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>)[<span class="hljs-number">0</span>].should.equal(doc1);
      idx.getMatching(<span class="hljs-string">'world'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'world'</span>)[<span class="hljs-number">0</span>].should.equal(doc2);
      idx.getMatching(<span class="hljs-string">'bloup'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'bloup'</span>)[<span class="hljs-number">0</span>].should.equal(doc3);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Now a simple update</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      idx.update(doc2, doc2b);

      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>)[<span class="hljs-number">0</span>].should.equal(doc1);
      idx.getMatching(<span class="hljs-string">'changed'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'changed'</span>)[<span class="hljs-number">0</span>].should.equal(doc2b);
      idx.getMatching(<span class="hljs-string">'bloup'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'bloup'</span>)[<span class="hljs-number">0</span>].should.equal(doc3);

      idx.revertUpdate(doc2, doc2b);

      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>)[<span class="hljs-number">0</span>].should.equal(doc1);
      idx.getMatching(<span class="hljs-string">'world'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'world'</span>)[<span class="hljs-number">0</span>].should.equal(doc2);
      idx.getMatching(<span class="hljs-string">'bloup'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'bloup'</span>)[<span class="hljs-number">0</span>].should.equal(doc3);
    });

  });   <span class="hljs-comment">// ==== End of 'Update' ==== //</span>


  describe(<span class="hljs-string">'Get matching documents'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    it(<span class="hljs-string">'Get all documents where fieldName is equal to the given value, or an empty array if no match'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        , doc4 = { a: <span class="hljs-number">23</span>, tf: <span class="hljs-string">'world'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);
      idx.insert(doc4);

      assert.deepEqual(idx.getMatching(<span class="hljs-string">'bloup'</span>), [doc3]);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'world'</span>), [doc2, doc4]);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'nope'</span>), []);
    });

    it(<span class="hljs-string">'Can get all documents for a given key in a unique index'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span>, unique: <span class="hljs-literal">true</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);

      assert.deepEqual(idx.getMatching(<span class="hljs-string">'bloup'</span>), [doc3]);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'world'</span>), [doc2]);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'nope'</span>), []);
    });

    it(<span class="hljs-string">'Can get all documents for which a field is undefined'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">2</span>, nottf: <span class="hljs-string">'bloup'</span> }
        , doc3 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc4 = { a: <span class="hljs-number">7</span>, nottf: <span class="hljs-string">'yes'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);

      assert.deepEqual(idx.getMatching(<span class="hljs-string">'bloup'</span>), []);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'hello'</span>), [doc1]);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'world'</span>), [doc3]);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'yes'</span>), []);
      assert.deepEqual(idx.getMatching(<span class="hljs-literal">undefined</span>), [doc2]);

      idx.insert(doc4);

      assert.deepEqual(idx.getMatching(<span class="hljs-string">'bloup'</span>), []);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'hello'</span>), [doc1]);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'world'</span>), [doc3]);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'yes'</span>), []);
      assert.deepEqual(idx.getMatching(<span class="hljs-literal">undefined</span>), [doc2, doc4]);
    });

    it(<span class="hljs-string">'Can get all documents for which a field is null'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-literal">null</span> }
        , doc3 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc4 = { a: <span class="hljs-number">7</span>, tf: <span class="hljs-literal">null</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);

      assert.deepEqual(idx.getMatching(<span class="hljs-string">'bloup'</span>), []);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'hello'</span>), [doc1]);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'world'</span>), [doc3]);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'yes'</span>), []);
      assert.deepEqual(idx.getMatching(<span class="hljs-literal">null</span>), [doc2]);

      idx.insert(doc4);

      assert.deepEqual(idx.getMatching(<span class="hljs-string">'bloup'</span>), []);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'hello'</span>), [doc1]);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'world'</span>), [doc3]);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'yes'</span>), []);
      assert.deepEqual(idx.getMatching(<span class="hljs-literal">null</span>), [doc2, doc4]);
    });

    it(<span class="hljs-string">'Can get all documents for a given key in a sparse index, but not unindexed docs (= field undefined)'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span>, sparse: <span class="hljs-literal">true</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">2</span>, nottf: <span class="hljs-string">'bloup'</span> }
        , doc3 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc4 = { a: <span class="hljs-number">7</span>, nottf: <span class="hljs-string">'yes'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);
      idx.insert(doc4);

      assert.deepEqual(idx.getMatching(<span class="hljs-string">'bloup'</span>), []);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'hello'</span>), [doc1]);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'world'</span>), [doc3]);
      assert.deepEqual(idx.getMatching(<span class="hljs-string">'yes'</span>), []);
      assert.deepEqual(idx.getMatching(<span class="hljs-literal">undefined</span>), []);
    });

    it(<span class="hljs-string">'Can get all documents whose key is in an array of keys'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        , doc3 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc4 = { a: <span class="hljs-number">7</span>, tf: <span class="hljs-string">'yes'</span> }
        , doc5 = { a: <span class="hljs-number">7</span>, tf: <span class="hljs-string">'yes'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);
      idx.insert(doc4);
      idx.insert(doc5);

      assert.deepEqual(idx.getMatching([]), []);
      assert.deepEqual(idx.getMatching([<span class="hljs-string">'bloup'</span>]), [doc2]);
      assert.deepEqual(idx.getMatching([<span class="hljs-string">'bloup'</span>, <span class="hljs-string">'yes'</span>]), [doc2, doc4, doc5]);
      assert.deepEqual(idx.getMatching([<span class="hljs-string">'hello'</span>, <span class="hljs-string">'no'</span>]), [doc1]);
      assert.deepEqual(idx.getMatching([<span class="hljs-string">'nope'</span>, <span class="hljs-string">'no'</span>]), []);
    });

    it(<span class="hljs-string">'Can get all documents whose key is between certain bounds'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'a'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        , doc3 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc4 = { a: <span class="hljs-number">7</span>, tf: <span class="hljs-string">'yes'</span> }
        , doc5 = { a: <span class="hljs-number">10</span>, tf: <span class="hljs-string">'yes'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);
      idx.insert(doc4);
      idx.insert(doc5);

      assert.deepEqual(idx.getBetweenBounds({ $lt: <span class="hljs-number">10</span>, $gte: <span class="hljs-number">5</span> }), [ doc1, doc4, doc3 ]);
      assert.deepEqual(idx.getBetweenBounds({ $lte: <span class="hljs-number">8</span> }), [ doc2, doc1, doc4, doc3 ]);
      assert.deepEqual(idx.getBetweenBounds({ $gt: <span class="hljs-number">7</span> }), [ doc3, doc5 ]);
    });

  });   <span class="hljs-comment">// ==== End of 'Get matching documents' ==== //</span>


  describe(<span class="hljs-string">'Resetting'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    it(<span class="hljs-string">'Can reset an index without any new data, the index will be empty afterwards'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);

      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'world'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'bloup'</span>).length.should.equal(<span class="hljs-number">1</span>);

      idx.reset();
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">0</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>).length.should.equal(<span class="hljs-number">0</span>);
      idx.getMatching(<span class="hljs-string">'world'</span>).length.should.equal(<span class="hljs-number">0</span>);
      idx.getMatching(<span class="hljs-string">'bloup'</span>).length.should.equal(<span class="hljs-number">0</span>);
    });

    it(<span class="hljs-string">'Can reset an index and initialize it with one document'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        , newDoc = { a: <span class="hljs-number">555</span>, tf: <span class="hljs-string">'new'</span> }
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);

      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'world'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'bloup'</span>).length.should.equal(<span class="hljs-number">1</span>);

      idx.reset(newDoc);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>).length.should.equal(<span class="hljs-number">0</span>);
      idx.getMatching(<span class="hljs-string">'world'</span>).length.should.equal(<span class="hljs-number">0</span>);
      idx.getMatching(<span class="hljs-string">'bloup'</span>).length.should.equal(<span class="hljs-number">0</span>);
      idx.getMatching(<span class="hljs-string">'new'</span>)[<span class="hljs-number">0</span>].a.should.equal(<span class="hljs-number">555</span>);
    });

    it(<span class="hljs-string">'Can reset an index and initialize it with an array of documents'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'tf'</span> })
        , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
        , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
        , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
        , newDocs = [{ a: <span class="hljs-number">555</span>, tf: <span class="hljs-string">'new'</span> }, { a: <span class="hljs-number">666</span>, tf: <span class="hljs-string">'again'</span> }]
        ;

      idx.insert(doc1);
      idx.insert(doc2);
      idx.insert(doc3);

      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">3</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'world'</span>).length.should.equal(<span class="hljs-number">1</span>);
      idx.getMatching(<span class="hljs-string">'bloup'</span>).length.should.equal(<span class="hljs-number">1</span>);

      idx.reset(newDocs);
      idx.tree.getNumberOfKeys().should.equal(<span class="hljs-number">2</span>);
      idx.getMatching(<span class="hljs-string">'hello'</span>).length.should.equal(<span class="hljs-number">0</span>);
      idx.getMatching(<span class="hljs-string">'world'</span>).length.should.equal(<span class="hljs-number">0</span>);
      idx.getMatching(<span class="hljs-string">'bloup'</span>).length.should.equal(<span class="hljs-number">0</span>);
      idx.getMatching(<span class="hljs-string">'new'</span>)[<span class="hljs-number">0</span>].a.should.equal(<span class="hljs-number">555</span>);
      idx.getMatching(<span class="hljs-string">'again'</span>)[<span class="hljs-number">0</span>].a.should.equal(<span class="hljs-number">666</span>);
    });

  });   <span class="hljs-comment">// ==== End of 'Resetting' ==== //</span>

  it(<span class="hljs-string">'Get all elements in the index'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'a'</span> })
      , doc1 = { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }
      , doc2 = { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }
      , doc3 = { a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }
      ;

    idx.insert(doc1);
    idx.insert(doc2);
    idx.insert(doc3);

    assert.deepEqual(idx.getAll(), [{ a: <span class="hljs-number">2</span>, tf: <span class="hljs-string">'bloup'</span> }, { a: <span class="hljs-number">5</span>, tf: <span class="hljs-string">'hello'</span> }, { a: <span class="hljs-number">8</span>, tf: <span class="hljs-string">'world'</span> }]);
  });


});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
