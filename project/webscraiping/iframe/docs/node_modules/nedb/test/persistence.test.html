<!DOCTYPE html>

<html>
<head>
  <title>persistence.test.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>persistence.test.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> should = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).should()
  , assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).assert
  , testDb = <span class="hljs-string">'workspace/test.db'</span>
  , fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
  , path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
  , _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
  , async = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)
  , model = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/model'</span>)
  , customUtils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/customUtils'</span>)
  , Datastore = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/datastore'</span>)
  , Persistence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/persistence'</span>)
  , child_process = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>)
  ;


describe(<span class="hljs-string">'Persistence'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> d;

  beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    d = <span class="hljs-keyword">new</span> Datastore({ filename: testDb });
    d.filename.should.equal(testDb);
    d.inMemoryOnly.should.equal(<span class="hljs-literal">false</span>);

    async.waterfall([
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        Persistence.ensureDirectoryExists(path.dirname(testDb), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          fs.exists(testDb, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(exists)</span> </span>{
            <span class="hljs-keyword">if</span> (exists) {
              fs.unlink(testDb, cb);
            } <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> cb(); }
          });
        });
      }
    , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          assert.isNull(err);
          d.getAllData().length.should.equal(<span class="hljs-number">0</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
    ], done);
  });

  it(<span class="hljs-string">'Every line represents a document'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
      , rawData = model.serialize({ _id: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }) + <span class="hljs-string">'\n'</span> +
                  model.serialize({ _id: <span class="hljs-string">"2"</span>, hello: <span class="hljs-string">'world'</span> }) + <span class="hljs-string">'\n'</span> +
                  model.serialize({ _id: <span class="hljs-string">"3"</span>, nested: { today: now } })
      , treatedData = Persistence.treatRawData(rawData).data
      ;

    treatedData.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{ <span class="hljs-keyword">return</span> a._id - b._id; });
    treatedData.length.should.equal(<span class="hljs-number">3</span>);
    _.isEqual(treatedData[<span class="hljs-number">0</span>], { _id: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }).should.equal(<span class="hljs-literal">true</span>);
    _.isEqual(treatedData[<span class="hljs-number">1</span>], { _id: <span class="hljs-string">"2"</span>, hello: <span class="hljs-string">'world'</span> }).should.equal(<span class="hljs-literal">true</span>);
    _.isEqual(treatedData[<span class="hljs-number">2</span>], { _id: <span class="hljs-string">"3"</span>, nested: { today: now } }).should.equal(<span class="hljs-literal">true</span>);
  });

  it(<span class="hljs-string">'Badly formatted lines have no impact on the treated data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
      , rawData = model.serialize({ _id: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }) + <span class="hljs-string">'\n'</span> +
                  <span class="hljs-string">'garbage\n'</span> +
                  model.serialize({ _id: <span class="hljs-string">"3"</span>, nested: { today: now } })
      , treatedData = Persistence.treatRawData(rawData).data
      ;

    treatedData.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{ <span class="hljs-keyword">return</span> a._id - b._id; });
    treatedData.length.should.equal(<span class="hljs-number">2</span>);
    _.isEqual(treatedData[<span class="hljs-number">0</span>], { _id: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }).should.equal(<span class="hljs-literal">true</span>);
    _.isEqual(treatedData[<span class="hljs-number">1</span>], { _id: <span class="hljs-string">"3"</span>, nested: { today: now } }).should.equal(<span class="hljs-literal">true</span>);
  });

  it(<span class="hljs-string">'Well formatted lines that have no _id are not included in the data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
      , rawData = model.serialize({ _id: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }) + <span class="hljs-string">'\n'</span> +
                  model.serialize({ _id: <span class="hljs-string">"2"</span>, hello: <span class="hljs-string">'world'</span> }) + <span class="hljs-string">'\n'</span> +
                  model.serialize({ nested: { today: now } })
      , treatedData = Persistence.treatRawData(rawData).data
      ;

    treatedData.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{ <span class="hljs-keyword">return</span> a._id - b._id; });
    treatedData.length.should.equal(<span class="hljs-number">2</span>);
    _.isEqual(treatedData[<span class="hljs-number">0</span>], { _id: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }).should.equal(<span class="hljs-literal">true</span>);
    _.isEqual(treatedData[<span class="hljs-number">1</span>], { _id: <span class="hljs-string">"2"</span>, hello: <span class="hljs-string">'world'</span> }).should.equal(<span class="hljs-literal">true</span>);
  });

  it(<span class="hljs-string">'If two lines concern the same doc (= same _id), the last one is the good version'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
      , rawData = model.serialize({ _id: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }) + <span class="hljs-string">'\n'</span> +
                  model.serialize({ _id: <span class="hljs-string">"2"</span>, hello: <span class="hljs-string">'world'</span> }) + <span class="hljs-string">'\n'</span> +
                  model.serialize({ _id: <span class="hljs-string">"1"</span>, nested: { today: now } })
      , treatedData = Persistence.treatRawData(rawData).data
      ;

    treatedData.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{ <span class="hljs-keyword">return</span> a._id - b._id; });
    treatedData.length.should.equal(<span class="hljs-number">2</span>);
    _.isEqual(treatedData[<span class="hljs-number">0</span>], { _id: <span class="hljs-string">"1"</span>, nested: { today: now } }).should.equal(<span class="hljs-literal">true</span>);
    _.isEqual(treatedData[<span class="hljs-number">1</span>], { _id: <span class="hljs-string">"2"</span>, hello: <span class="hljs-string">'world'</span> }).should.equal(<span class="hljs-literal">true</span>);
  });

  it(<span class="hljs-string">'If a doc contains $$deleted: true, that means we need to remove it from the data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
      , rawData = model.serialize({ _id: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }) + <span class="hljs-string">'\n'</span> +
                  model.serialize({ _id: <span class="hljs-string">"2"</span>, hello: <span class="hljs-string">'world'</span> }) + <span class="hljs-string">'\n'</span> +
                  model.serialize({ _id: <span class="hljs-string">"1"</span>, $$deleted: <span class="hljs-literal">true</span> }) + <span class="hljs-string">'\n'</span> +
                  model.serialize({ _id: <span class="hljs-string">"3"</span>, today: now })
      , treatedData = Persistence.treatRawData(rawData).data
      ;

    treatedData.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{ <span class="hljs-keyword">return</span> a._id - b._id; });
    treatedData.length.should.equal(<span class="hljs-number">2</span>);
    _.isEqual(treatedData[<span class="hljs-number">0</span>], { _id: <span class="hljs-string">"2"</span>, hello: <span class="hljs-string">'world'</span> }).should.equal(<span class="hljs-literal">true</span>);
    _.isEqual(treatedData[<span class="hljs-number">1</span>], { _id: <span class="hljs-string">"3"</span>, today: now }).should.equal(<span class="hljs-literal">true</span>);
  });

  it(<span class="hljs-string">'If a doc contains $$deleted: true, no error is thrown if the doc wasnt in the list before'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
      , rawData = model.serialize({ _id: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }) + <span class="hljs-string">'\n'</span> +
                  model.serialize({ _id: <span class="hljs-string">"2"</span>, $$deleted: <span class="hljs-literal">true</span> }) + <span class="hljs-string">'\n'</span> +
                  model.serialize({ _id: <span class="hljs-string">"3"</span>, today: now })
      , treatedData = Persistence.treatRawData(rawData).data
      ;

    treatedData.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{ <span class="hljs-keyword">return</span> a._id - b._id; });
    treatedData.length.should.equal(<span class="hljs-number">2</span>);
    _.isEqual(treatedData[<span class="hljs-number">0</span>], { _id: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }).should.equal(<span class="hljs-literal">true</span>);
    _.isEqual(treatedData[<span class="hljs-number">1</span>], { _id: <span class="hljs-string">"3"</span>, today: now }).should.equal(<span class="hljs-literal">true</span>);
  });
  
  it(<span class="hljs-string">'If a doc contains $$indexCreated, no error is thrown during treatRawData and we can get the index options'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
      , rawData = model.serialize({ _id: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }) + <span class="hljs-string">'\n'</span> +
                  model.serialize({ $$indexCreated: { fieldName: <span class="hljs-string">"test"</span>, unique: <span class="hljs-literal">true</span> } }) + <span class="hljs-string">'\n'</span> +
                  model.serialize({ _id: <span class="hljs-string">"3"</span>, today: now })
      , treatedData = Persistence.treatRawData(rawData).data
      , indexes = Persistence.treatRawData(rawData).indexes
      ;

    <span class="hljs-built_in">Object</span>.keys(indexes).length.should.equal(<span class="hljs-number">1</span>);
    assert.deepEqual(indexes.test, { fieldName: <span class="hljs-string">"test"</span>, unique: <span class="hljs-literal">true</span> });
      
    treatedData.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{ <span class="hljs-keyword">return</span> a._id - b._id; });
    treatedData.length.should.equal(<span class="hljs-number">2</span>);
    _.isEqual(treatedData[<span class="hljs-number">0</span>], { _id: <span class="hljs-string">"1"</span>, a: <span class="hljs-number">2</span>, ages: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>] }).should.equal(<span class="hljs-literal">true</span>);
    _.isEqual(treatedData[<span class="hljs-number">1</span>], { _id: <span class="hljs-string">"3"</span>, today: now }).should.equal(<span class="hljs-literal">true</span>);
  });  

  it(<span class="hljs-string">'Compact database on load'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    d.insert({ a: <span class="hljs-number">2</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      d.insert({ a: <span class="hljs-number">4</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.remove({ a: <span class="hljs-number">2</span> }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Here, the underlying file is 3 lines long for only one document</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> data = fs.readFileSync(d.filename, <span class="hljs-string">'utf8'</span>).split(<span class="hljs-string">'\n'</span>)
            , filledCount = <span class="hljs-number">0</span>;

          data.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{ <span class="hljs-keyword">if</span> (item.length &gt; <span class="hljs-number">0</span>) { filledCount += <span class="hljs-number">1</span>; } });
          filledCount.should.equal(<span class="hljs-number">3</span>);

          d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            assert.isNull(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Now, the file has been compacted and is only 1 line long</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> data = fs.readFileSync(d.filename, <span class="hljs-string">'utf8'</span>).split(<span class="hljs-string">'\n'</span>)
              , filledCount = <span class="hljs-number">0</span>;

            data.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{ <span class="hljs-keyword">if</span> (item.length &gt; <span class="hljs-number">0</span>) { filledCount += <span class="hljs-number">1</span>; } });
            filledCount.should.equal(<span class="hljs-number">1</span>);

            done();
          });
        })
      });
    });
  });

  it(<span class="hljs-string">'Calling loadDatabase after the data was modified doesnt change its contents'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      d.insert({ a: <span class="hljs-number">1</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        assert.isNull(err);
        d.insert({ a: <span class="hljs-number">2</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          <span class="hljs-keyword">var</span> data = d.getAllData()
            , doc1 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">1</span>; })
            , doc2 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">2</span>; })
            ;
          assert.isNull(err);
          data.length.should.equal(<span class="hljs-number">2</span>);
          doc1.a.should.equal(<span class="hljs-number">1</span>);
          doc2.a.should.equal(<span class="hljs-number">2</span>);

          d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">var</span> data = d.getAllData()
              , doc1 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">1</span>; })
              , doc2 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">2</span>; })
              ;
            assert.isNull(err);
            data.length.should.equal(<span class="hljs-number">2</span>);
            doc1.a.should.equal(<span class="hljs-number">1</span>);
            doc2.a.should.equal(<span class="hljs-number">2</span>);

            done();
          });
        });
      });
    });
  });

  it(<span class="hljs-string">'Calling loadDatabase after the datafile was removed will reset the database'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      d.insert({ a: <span class="hljs-number">1</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        assert.isNull(err);
        d.insert({ a: <span class="hljs-number">2</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          <span class="hljs-keyword">var</span> data = d.getAllData()
            , doc1 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">1</span>; })
            , doc2 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">2</span>; })
            ;
          assert.isNull(err);
          data.length.should.equal(<span class="hljs-number">2</span>);
          doc1.a.should.equal(<span class="hljs-number">1</span>);
          doc2.a.should.equal(<span class="hljs-number">2</span>);

          fs.unlink(testDb, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            assert.isNull(err);
            d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              assert.isNull(err);
              d.getAllData().length.should.equal(<span class="hljs-number">0</span>);

              done();
            });
          });
        });
      });
    });
  });

  it(<span class="hljs-string">'Calling loadDatabase after the datafile was modified loads the new data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      d.insert({ a: <span class="hljs-number">1</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        assert.isNull(err);
        d.insert({ a: <span class="hljs-number">2</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          <span class="hljs-keyword">var</span> data = d.getAllData()
            , doc1 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">1</span>; })
            , doc2 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">2</span>; })
            ;
          assert.isNull(err);
          data.length.should.equal(<span class="hljs-number">2</span>);
          doc1.a.should.equal(<span class="hljs-number">1</span>);
          doc2.a.should.equal(<span class="hljs-number">2</span>);

          fs.writeFile(testDb, <span class="hljs-string">'{"a":3,"_id":"aaa"}'</span>, <span class="hljs-string">'utf8'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            assert.isNull(err);
            d.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
              <span class="hljs-keyword">var</span> data = d.getAllData()
              , doc1 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">1</span>; })
              , doc2 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">2</span>; })
              , doc3 = _.find(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">3</span>; })
              ;
              assert.isNull(err);
              data.length.should.equal(<span class="hljs-number">1</span>);
              doc3.a.should.equal(<span class="hljs-number">3</span>);
              assert.isUndefined(doc1);
              assert.isUndefined(doc2);

              done();
            });
          });
        });
      });
    });
  });
  
  
  describe(<span class="hljs-string">'Prevent dataloss when persisting data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    it(<span class="hljs-string">'Creating a datastore with in memory as true and a bad filename wont cause an error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">new</span> Datastore({ filename: <span class="hljs-string">'workspace/bad.db~'</span>, inMemoryOnly: <span class="hljs-literal">true</span> });
    })
    
    it(<span class="hljs-string">'Creating a persistent datastore with a bad filename will cause an error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">new</span> Datastore({ filename: <span class="hljs-string">'workspace/bad.db~'</span> }); }).should.throw();
    })  
  
    it(<span class="hljs-string">'If no file exists, ensureDatafileIntegrity creates an empty datafile'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> p = <span class="hljs-keyword">new</span> Persistence({ db: { inMemoryOnly: <span class="hljs-literal">false</span>, filename: <span class="hljs-string">'workspace/it.db'</span> } });
    
      <span class="hljs-keyword">if</span> (fs.existsSync(<span class="hljs-string">'workspace/it.db'</span>)) { fs.unlinkSync(<span class="hljs-string">'workspace/it.db'</span>); }
      <span class="hljs-keyword">if</span> (fs.existsSync(<span class="hljs-string">'workspace/it.db~~'</span>)) { fs.unlinkSync(<span class="hljs-string">'workspace/it.db~~'</span>); }
      
      fs.existsSync(<span class="hljs-string">'workspace/it.db'</span>).should.equal(<span class="hljs-literal">false</span>);
      fs.existsSync(<span class="hljs-string">'workspace/it.db~~'</span>).should.equal(<span class="hljs-literal">false</span>);      
      
      p.ensureDatafileIntegrity(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        assert.isNull(err);
        
        fs.existsSync(<span class="hljs-string">'workspace/it.db'</span>).should.equal(<span class="hljs-literal">true</span>);
        fs.existsSync(<span class="hljs-string">'workspace/it.db~~'</span>).should.equal(<span class="hljs-literal">false</span>);
        
        fs.readFileSync(<span class="hljs-string">'workspace/it.db'</span>, <span class="hljs-string">'utf8'</span>).should.equal(<span class="hljs-string">''</span>);
        
        done();
      });
    });
  
    it(<span class="hljs-string">'If only datafile exists, ensureDatafileIntegrity will use it'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> p = <span class="hljs-keyword">new</span> Persistence({ db: { inMemoryOnly: <span class="hljs-literal">false</span>, filename: <span class="hljs-string">'workspace/it.db'</span> } });
    
      <span class="hljs-keyword">if</span> (fs.existsSync(<span class="hljs-string">'workspace/it.db'</span>)) { fs.unlinkSync(<span class="hljs-string">'workspace/it.db'</span>); }
      <span class="hljs-keyword">if</span> (fs.existsSync(<span class="hljs-string">'workspace/it.db~~'</span>)) { fs.unlinkSync(<span class="hljs-string">'workspace/it.db~~'</span>); }
      
      fs.writeFileSync(<span class="hljs-string">'workspace/it.db'</span>, <span class="hljs-string">'something'</span>, <span class="hljs-string">'utf8'</span>);

      fs.existsSync(<span class="hljs-string">'workspace/it.db'</span>).should.equal(<span class="hljs-literal">true</span>);
      fs.existsSync(<span class="hljs-string">'workspace/it.db~~'</span>).should.equal(<span class="hljs-literal">false</span>);      
      
      p.ensureDatafileIntegrity(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        assert.isNull(err);

        fs.existsSync(<span class="hljs-string">'workspace/it.db'</span>).should.equal(<span class="hljs-literal">true</span>);
        fs.existsSync(<span class="hljs-string">'workspace/it.db~~'</span>).should.equal(<span class="hljs-literal">false</span>);
        
        fs.readFileSync(<span class="hljs-string">'workspace/it.db'</span>, <span class="hljs-string">'utf8'</span>).should.equal(<span class="hljs-string">'something'</span>);
        
        done();
      });
    });
    
    it(<span class="hljs-string">'If old datafile exists and datafile doesnt, ensureDatafileIntegrity will use it'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> p = <span class="hljs-keyword">new</span> Persistence({ db: { inMemoryOnly: <span class="hljs-literal">false</span>, filename: <span class="hljs-string">'workspace/it.db'</span> } });
    
      <span class="hljs-keyword">if</span> (fs.existsSync(<span class="hljs-string">'workspace/it.db'</span>)) { fs.unlinkSync(<span class="hljs-string">'workspace/it.db'</span>); }
      <span class="hljs-keyword">if</span> (fs.existsSync(<span class="hljs-string">'workspace/it.db~~'</span>)) { fs.unlinkSync(<span class="hljs-string">'workspace/it.db~~'</span>); }
      
      fs.writeFileSync(<span class="hljs-string">'workspace/it.db~~'</span>, <span class="hljs-string">'something'</span>, <span class="hljs-string">'utf8'</span>);
      
      fs.existsSync(<span class="hljs-string">'workspace/it.db'</span>).should.equal(<span class="hljs-literal">false</span>);
      fs.existsSync(<span class="hljs-string">'workspace/it.db~~'</span>).should.equal(<span class="hljs-literal">true</span>);      
      
      p.ensureDatafileIntegrity(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        assert.isNull(err);
        
        fs.existsSync(<span class="hljs-string">'workspace/it.db'</span>).should.equal(<span class="hljs-literal">true</span>);
        fs.existsSync(<span class="hljs-string">'workspace/it.db~~'</span>).should.equal(<span class="hljs-literal">false</span>);
        
        fs.readFileSync(<span class="hljs-string">'workspace/it.db'</span>, <span class="hljs-string">'utf8'</span>).should.equal(<span class="hljs-string">'something'</span>);
        
        done();
      });
    });
    
    it(<span class="hljs-string">'If both old and current datafiles exist, ensureDatafileIntegrity will use the datafile, it means step 4 of persistence failed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> theDb = <span class="hljs-keyword">new</span> Datastore({ filename: <span class="hljs-string">'workspace/it.db'</span> });
    
      <span class="hljs-keyword">if</span> (fs.existsSync(<span class="hljs-string">'workspace/it.db'</span>)) { fs.unlinkSync(<span class="hljs-string">'workspace/it.db'</span>); }
      <span class="hljs-keyword">if</span> (fs.existsSync(<span class="hljs-string">'workspace/it.db~~'</span>)) { fs.unlinkSync(<span class="hljs-string">'workspace/it.db~~'</span>); }
      
      fs.writeFileSync(<span class="hljs-string">'workspace/it.db'</span>, <span class="hljs-string">'{"_id":"0","hello":"world"}'</span>, <span class="hljs-string">'utf8'</span>);
      fs.writeFileSync(<span class="hljs-string">'workspace/it.db~~'</span>, <span class="hljs-string">'{"_id":"0","hello":"other"}'</span>, <span class="hljs-string">'utf8'</span>);
      
      fs.existsSync(<span class="hljs-string">'workspace/it.db'</span>).should.equal(<span class="hljs-literal">true</span>);
      fs.existsSync(<span class="hljs-string">'workspace/it.db~~'</span>).should.equal(<span class="hljs-literal">true</span>);      
      
      theDb.persistence.ensureDatafileIntegrity(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        assert.isNull(err);
        
        fs.existsSync(<span class="hljs-string">'workspace/it.db'</span>).should.equal(<span class="hljs-literal">true</span>);
        fs.existsSync(<span class="hljs-string">'workspace/it.db~~'</span>).should.equal(<span class="hljs-literal">true</span>);
        
        fs.readFileSync(<span class="hljs-string">'workspace/it.db'</span>, <span class="hljs-string">'utf8'</span>).should.equal(<span class="hljs-string">'{"_id":"0","hello":"world"}'</span>);
        
        theDb.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          assert.isNull(err);
          theDb.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">1</span>);
            docs[<span class="hljs-number">0</span>].hello.should.equal(<span class="hljs-string">"world"</span>);
            done();
          });
        });
      });
    });
  
    it(<span class="hljs-string">'persistCachedDatabase should update the contents of the datafile and leave a clean state'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          docs.length.should.equal(<span class="hljs-number">1</span>);
          
          <span class="hljs-keyword">if</span> (fs.existsSync(testDb)) { fs.unlinkSync(testDb); }
          <span class="hljs-keyword">if</span> (fs.existsSync(testDb + <span class="hljs-string">'~'</span>)) { fs.unlinkSync(testDb + <span class="hljs-string">'~'</span>); }
          <span class="hljs-keyword">if</span> (fs.existsSync(testDb + <span class="hljs-string">'~~'</span>)) { fs.unlinkSync(testDb + <span class="hljs-string">'~~'</span>); }
          fs.existsSync(testDb).should.equal(<span class="hljs-literal">false</span>);
          
          fs.writeFileSync(testDb + <span class="hljs-string">'~'</span>, <span class="hljs-string">'something'</span>, <span class="hljs-string">'utf8'</span>);
          fs.writeFileSync(testDb + <span class="hljs-string">'~~'</span>, <span class="hljs-string">'something else'</span>, <span class="hljs-string">'utf8'</span>);
          fs.existsSync(testDb + <span class="hljs-string">'~'</span>).should.equal(<span class="hljs-literal">true</span>);
          fs.existsSync(testDb + <span class="hljs-string">'~~'</span>).should.equal(<span class="hljs-literal">true</span>);
          
          d.persistence.persistCachedDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">var</span> contents = fs.readFileSync(testDb, <span class="hljs-string">'utf8'</span>);
            assert.isNull(err);
            fs.existsSync(testDb).should.equal(<span class="hljs-literal">true</span>);
            fs.existsSync(testDb + <span class="hljs-string">'~'</span>).should.equal(<span class="hljs-literal">false</span>);            
            fs.existsSync(testDb + <span class="hljs-string">'~~'</span>).should.equal(<span class="hljs-literal">false</span>);            
            <span class="hljs-keyword">if</span> (!contents.match(<span class="hljs-regexp">/^{"hello":"world","_id":"[0-9a-zA-Z]{16}"}\n$/</span>)) {
              <span class="hljs-keyword">throw</span> <span class="hljs-string">"Datafile contents not as expected"</span>;
            }
            done();
          });
        });
      });
    });
    
    it(<span class="hljs-string">'After a persistCachedDatabase, there should be no temp or old filename'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          docs.length.should.equal(<span class="hljs-number">1</span>);
          
          <span class="hljs-keyword">if</span> (fs.existsSync(testDb)) { fs.unlinkSync(testDb); }
          <span class="hljs-keyword">if</span> (fs.existsSync(testDb + <span class="hljs-string">'~'</span>)) { fs.unlinkSync(testDb + <span class="hljs-string">'~'</span>); }
          <span class="hljs-keyword">if</span> (fs.existsSync(testDb + <span class="hljs-string">'~~'</span>)) { fs.unlinkSync(testDb + <span class="hljs-string">'~~'</span>); }
          fs.existsSync(testDb).should.equal(<span class="hljs-literal">false</span>);
          
          fs.writeFileSync(testDb + <span class="hljs-string">'~'</span>, <span class="hljs-string">'bloup'</span>, <span class="hljs-string">'utf8'</span>);
          fs.writeFileSync(testDb + <span class="hljs-string">'~~'</span>, <span class="hljs-string">'blap'</span>, <span class="hljs-string">'utf8'</span>);
          fs.existsSync(testDb + <span class="hljs-string">'~'</span>).should.equal(<span class="hljs-literal">true</span>);
          fs.existsSync(testDb + <span class="hljs-string">'~~'</span>).should.equal(<span class="hljs-literal">true</span>);
          
          d.persistence.persistCachedDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">var</span> contents = fs.readFileSync(testDb, <span class="hljs-string">'utf8'</span>);
            assert.isNull(err);
            fs.existsSync(testDb).should.equal(<span class="hljs-literal">true</span>);
            fs.existsSync(testDb + <span class="hljs-string">'~'</span>).should.equal(<span class="hljs-literal">false</span>);            
            fs.existsSync(testDb + <span class="hljs-string">'~~'</span>).should.equal(<span class="hljs-literal">false</span>);            
            <span class="hljs-keyword">if</span> (!contents.match(<span class="hljs-regexp">/^{"hello":"world","_id":"[0-9a-zA-Z]{16}"}\n$/</span>)) {
              <span class="hljs-keyword">throw</span> <span class="hljs-string">"Datafile contents not as expected"</span>;
            }
            done();
          });
        });
      });    
    });
    
    it(<span class="hljs-string">'persistCachedDatabase should update the contents of the datafile and leave a clean state even if there is a temp or old datafile'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      d.insert({ hello: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        d.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          docs.length.should.equal(<span class="hljs-number">1</span>);
          
          <span class="hljs-keyword">if</span> (fs.existsSync(testDb)) { fs.unlinkSync(testDb); }
          fs.writeFileSync(testDb + <span class="hljs-string">'~'</span>, <span class="hljs-string">'blabla'</span>, <span class="hljs-string">'utf8'</span>);
          fs.writeFileSync(testDb + <span class="hljs-string">'~~'</span>, <span class="hljs-string">'bloblo'</span>, <span class="hljs-string">'utf8'</span>);
          fs.existsSync(testDb).should.equal(<span class="hljs-literal">false</span>);
          fs.existsSync(testDb + <span class="hljs-string">'~'</span>).should.equal(<span class="hljs-literal">true</span>);
          fs.existsSync(testDb + <span class="hljs-string">'~~'</span>).should.equal(<span class="hljs-literal">true</span>);
          
          d.persistence.persistCachedDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">var</span> contents = fs.readFileSync(testDb, <span class="hljs-string">'utf8'</span>);
            assert.isNull(err);
            fs.existsSync(testDb).should.equal(<span class="hljs-literal">true</span>);
            fs.existsSync(testDb + <span class="hljs-string">'~'</span>).should.equal(<span class="hljs-literal">false</span>);            
            fs.existsSync(testDb + <span class="hljs-string">'~~'</span>).should.equal(<span class="hljs-literal">false</span>);            
            <span class="hljs-keyword">if</span> (!contents.match(<span class="hljs-regexp">/^{"hello":"world","_id":"[0-9a-zA-Z]{16}"}\n$/</span>)) {
              <span class="hljs-keyword">throw</span> <span class="hljs-string">"Datafile contents not as expected"</span>;
            }
            done();
          });
        });
      });
    });
    
    it(<span class="hljs-string">'persistCachedDatabase should update the contents of the datafile and leave a clean state even if there is a temp or old datafile'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> dbFile = <span class="hljs-string">'workspace/test2.db'</span>, theDb;
    
      <span class="hljs-keyword">if</span> (fs.existsSync(dbFile)) { fs.unlinkSync(dbFile); }
      <span class="hljs-keyword">if</span> (fs.existsSync(dbFile + <span class="hljs-string">'~'</span>)) { fs.unlinkSync(dbFile + <span class="hljs-string">'~'</span>); }
      <span class="hljs-keyword">if</span> (fs.existsSync(dbFile + <span class="hljs-string">'~~'</span>)) { fs.unlinkSync(dbFile + <span class="hljs-string">'~~'</span>); }
      
      theDb = <span class="hljs-keyword">new</span> Datastore({ filename: dbFile });
      
      theDb.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        <span class="hljs-keyword">var</span> contents = fs.readFileSync(dbFile, <span class="hljs-string">'utf8'</span>);
        assert.isNull(err);
        fs.existsSync(dbFile).should.equal(<span class="hljs-literal">true</span>);
        fs.existsSync(dbFile + <span class="hljs-string">'~'</span>).should.equal(<span class="hljs-literal">false</span>);            
        fs.existsSync(dbFile + <span class="hljs-string">'~~'</span>).should.equal(<span class="hljs-literal">false</span>);            
        <span class="hljs-keyword">if</span> (contents != <span class="hljs-string">""</span>) {
          <span class="hljs-keyword">throw</span> <span class="hljs-string">"Datafile contents not as expected"</span>;
        }
        done();
      });
    });

    it(<span class="hljs-string">'Persistence works as expected when everything goes fine'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> dbFile = <span class="hljs-string">'workspace/test2.db'</span>, theDb, theDb2, doc1, doc2;
      
      async.waterfall([
        async.apply(customUtils.ensureFileDoesntExist, dbFile)
      , async.apply(customUtils.ensureFileDoesntExist, dbFile + <span class="hljs-string">'~'</span>)
      , async.apply(customUtils.ensureFileDoesntExist, dbFile + <span class="hljs-string">'~~'</span>)
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        theDb = <span class="hljs-keyword">new</span> Datastore({ filename: dbFile });
        theDb.loadDatabase(cb);
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        theDb.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isNull(err);
          docs.length.should.equal(<span class="hljs-number">0</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        theDb.insert({ a: <span class="hljs-string">'hello'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc1)</span> </span>{
          assert.isNull(err);
          doc1 = _doc1;
          theDb.insert({ a: <span class="hljs-string">'world'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, _doc2)</span> </span>{
            assert.isNull(err);
            doc2 = _doc2;
            <span class="hljs-keyword">return</span> cb();
          });
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        theDb.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isNull(err);
          docs.length.should.equal(<span class="hljs-number">2</span>);
          _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{ <span class="hljs-keyword">return</span> item._id === doc1._id }).a.should.equal(<span class="hljs-string">'hello'</span>);
          _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{ <span class="hljs-keyword">return</span> item._id === doc2._id }).a.should.equal(<span class="hljs-string">'world'</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        theDb.loadDatabase(cb);
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{   <span class="hljs-comment">// No change</span>
        theDb.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isNull(err);
          docs.length.should.equal(<span class="hljs-number">2</span>);
          _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{ <span class="hljs-keyword">return</span> item._id === doc1._id }).a.should.equal(<span class="hljs-string">'hello'</span>);
          _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{ <span class="hljs-keyword">return</span> item._id === doc2._id }).a.should.equal(<span class="hljs-string">'world'</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        fs.existsSync(dbFile).should.equal(<span class="hljs-literal">true</span>);
        fs.existsSync(dbFile + <span class="hljs-string">'~'</span>).should.equal(<span class="hljs-literal">false</span>);
        fs.existsSync(dbFile + <span class="hljs-string">'~~'</span>).should.equal(<span class="hljs-literal">false</span>);
        <span class="hljs-keyword">return</span> cb();
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        theDb2 = <span class="hljs-keyword">new</span> Datastore({ filename: dbFile });
        theDb2.loadDatabase(cb);
      }  
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{   <span class="hljs-comment">// No change in second db</span>
        theDb2.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
          assert.isNull(err);
          docs.length.should.equal(<span class="hljs-number">2</span>);
          _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{ <span class="hljs-keyword">return</span> item._id === doc1._id }).a.should.equal(<span class="hljs-string">'hello'</span>);
          _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{ <span class="hljs-keyword">return</span> item._id === doc2._id }).a.should.equal(<span class="hljs-string">'world'</span>);
          <span class="hljs-keyword">return</span> cb();
        });
      }
      , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
        fs.existsSync(dbFile).should.equal(<span class="hljs-literal">true</span>);
        fs.existsSync(dbFile + <span class="hljs-string">'~'</span>).should.equal(<span class="hljs-literal">false</span>);
        fs.existsSync(dbFile + <span class="hljs-string">'~~'</span>).should.equal(<span class="hljs-literal">false</span>);
        <span class="hljs-keyword">return</span> cb();
      } 
      ], done);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>This test is a bit complicated since it depends on the time I/O actions take to execute
That depends on the machine and the load on the machine when the tests are run
It is timed for my machine with nothing else running but may not work as expected on others (it will not fail but may not be a proof)
Every new version of NeDB passes it on my machine before rtelease</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    it(<span class="hljs-string">'If system crashes during a loadDatabase, the former version is not lost'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
      <span class="hljs-keyword">var</span> cp, N = <span class="hljs-number">150000</span>, toWrite = <span class="hljs-string">""</span>, i;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Ensuring the state is clean</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (fs.existsSync(<span class="hljs-string">'workspace/lac.db'</span>)) { fs.unlinkSync(<span class="hljs-string">'workspace/lac.db'</span>); }
      <span class="hljs-keyword">if</span> (fs.existsSync(<span class="hljs-string">'workspace/lac.db~'</span>)) { fs.unlinkSync(<span class="hljs-string">'workspace/lac.db~'</span>); }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Creating a db file with 150k records (a bit long to load)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; N; i += <span class="hljs-number">1</span>) {
        toWrite += model.serialize({ _id: customUtils.uid(<span class="hljs-number">16</span>), hello: <span class="hljs-string">'world'</span> }) + <span class="hljs-string">'\n'</span>;
      }        
      fs.writeFileSync(<span class="hljs-string">'workspace/lac.db'</span>, toWrite, <span class="hljs-string">'utf8'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Loading it in a separate process that we will crash before finishing the loadDatabase</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cp = child_process.fork(<span class="hljs-string">'test_lac/loadAndCrash.test'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Kill the child process when we’re at step 3 of persistCachedDatabase (during write to datafile)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        cp.kill(<span class="hljs-string">'SIGINT'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>If the timing is correct, only the temp datafile contains data
The datafile was in the middle of being written and is empty</p>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Let the process crash be finished then load database without a crash, and test we didn’t lose data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> Datastore({ filename: <span class="hljs-string">'workspace/lac.db'</span> });
          db.loadDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            assert.isNull(err);
            
            db.count({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, n)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Data has not been lost</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              assert.isNull(err);
              n.should.equal(<span class="hljs-number">150000</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>State is clean, the temp datafile has been erased and the datafile contains all the data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              fs.existsSync(<span class="hljs-string">'workspace/lac.db'</span>).should.equal(<span class="hljs-literal">true</span>);
              fs.existsSync(<span class="hljs-string">'workspace/lac.db~'</span>).should.equal(<span class="hljs-literal">false</span>);
              
              done();
            });
          });
        }, <span class="hljs-number">100</span>);        
      }, <span class="hljs-number">2000</span>);
    });
  
  });   <span class="hljs-comment">// ==== End of 'Prevent dataloss when persisting data' ====</span>

});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
