<!DOCTYPE html>

<html>
<head>
  <title>async.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>async.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*global setImmediate: false, setTimeout: false, console: false */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">var</span> async = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>global on the server, window in the browser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> root, previous_async;

    root = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">if</span> (root != <span class="hljs-literal">null</span>) {
      previous_async = root.async;
    }

    async.noConflict = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        root.async = previous_async;
        <span class="hljs-keyword">return</span> async;
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">only_once</span><span class="hljs-params">(fn)</span> </span>{
        <span class="hljs-keyword">var</span> called = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Callback was already called."</span>);
            called = <span class="hljs-literal">true</span>;
            fn.apply(root, <span class="hljs-built_in">arguments</span>);
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>// cross-browser compatiblity functions ////</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">var</span> _each = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator)</span> </span>{
        <span class="hljs-keyword">if</span> (arr.forEach) {
            <span class="hljs-keyword">return</span> arr.forEach(iterator);
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; arr.length; i += <span class="hljs-number">1</span>) {
            iterator(arr[i], i, arr);
        }
    };

    <span class="hljs-keyword">var</span> _map = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator)</span> </span>{
        <span class="hljs-keyword">if</span> (arr.map) {
            <span class="hljs-keyword">return</span> arr.map(iterator);
        }
        <span class="hljs-keyword">var</span> results = [];
        _each(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, i, a)</span> </span>{
            results.push(iterator(x, i, a));
        });
        <span class="hljs-keyword">return</span> results;
    };

    <span class="hljs-keyword">var</span> _reduce = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator, memo)</span> </span>{
        <span class="hljs-keyword">if</span> (arr.reduce) {
            <span class="hljs-keyword">return</span> arr.reduce(iterator, memo);
        }
        _each(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, i, a)</span> </span>{
            memo = iterator(memo, x, i, a);
        });
        <span class="hljs-keyword">return</span> memo;
    };

    <span class="hljs-keyword">var</span> _keys = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys) {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(obj);
        }
        <span class="hljs-keyword">var</span> keys = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> obj) {
            <span class="hljs-keyword">if</span> (obj.hasOwnProperty(k)) {
                keys.push(k);
            }
        }
        <span class="hljs-keyword">return</span> keys;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>// exported async module functions ////</p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>// nextTick implementation with browser-compatible fallback ////</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> process === <span class="hljs-string">'undefined'</span> || !(process.nextTick)) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> setImmediate === <span class="hljs-string">'function'</span>) {
            async.nextTick = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>not a direct alias for IE10 compatibility</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                setImmediate(fn);
            };
            async.setImmediate = async.nextTick;
        }
        <span class="hljs-keyword">else</span> {
            async.nextTick = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
                setTimeout(fn, <span class="hljs-number">0</span>);
            };
            async.setImmediate = async.nextTick;
        }
    }
    <span class="hljs-keyword">else</span> {
        async.nextTick = process.nextTick;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> setImmediate !== <span class="hljs-string">'undefined'</span>) {
            async.setImmediate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>not a direct alias for IE10 compatibility</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              setImmediate(fn);
            };
        }
        <span class="hljs-keyword">else</span> {
            async.setImmediate = async.nextTick;
        }
    }

    async.each = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator, callback)</span> </span>{
        callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
        <span class="hljs-keyword">if</span> (!arr.length) {
            <span class="hljs-keyword">return</span> callback();
        }
        <span class="hljs-keyword">var</span> completed = <span class="hljs-number">0</span>;
        _each(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
            iterator(x, only_once(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">if</span> (err) {
                    callback(err);
                    callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                }
                <span class="hljs-keyword">else</span> {
                    completed += <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">if</span> (completed &gt;= arr.length) {
                        callback(<span class="hljs-literal">null</span>);
                    }
                }
            }));
        });
    };
    async.forEach = async.each;

    async.eachSeries = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator, callback)</span> </span>{
        callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
        <span class="hljs-keyword">if</span> (!arr.length) {
            <span class="hljs-keyword">return</span> callback();
        }
        <span class="hljs-keyword">var</span> completed = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> iterate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            iterator(arr[completed], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">if</span> (err) {
                    callback(err);
                    callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                }
                <span class="hljs-keyword">else</span> {
                    completed += <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">if</span> (completed &gt;= arr.length) {
                        callback(<span class="hljs-literal">null</span>);
                    }
                    <span class="hljs-keyword">else</span> {
                        iterate();
                    }
                }
            });
        };
        iterate();
    };
    async.forEachSeries = async.eachSeries;

    async.eachLimit = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, limit, iterator, callback)</span> </span>{
        <span class="hljs-keyword">var</span> fn = _eachLimit(limit);
        fn.apply(<span class="hljs-literal">null</span>, [arr, iterator, callback]);
    };
    async.forEachLimit = async.eachLimit;

    <span class="hljs-keyword">var</span> _eachLimit = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(limit)</span> </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator, callback)</span> </span>{
            callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
            <span class="hljs-keyword">if</span> (!arr.length || limit &lt;= <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> callback();
            }
            <span class="hljs-keyword">var</span> completed = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">var</span> started = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">var</span> running = <span class="hljs-number">0</span>;

            (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">replenish</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">if</span> (completed &gt;= arr.length) {
                    <span class="hljs-keyword">return</span> callback();
                }

                <span class="hljs-keyword">while</span> (running &lt; limit &amp;&amp; started &lt; arr.length) {
                    started += <span class="hljs-number">1</span>;
                    running += <span class="hljs-number">1</span>;
                    iterator(arr[started - <span class="hljs-number">1</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                        <span class="hljs-keyword">if</span> (err) {
                            callback(err);
                            callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                        }
                        <span class="hljs-keyword">else</span> {
                            completed += <span class="hljs-number">1</span>;
                            running -= <span class="hljs-number">1</span>;
                            <span class="hljs-keyword">if</span> (completed &gt;= arr.length) {
                                callback();
                            }
                            <span class="hljs-keyword">else</span> {
                                replenish();
                            }
                        }
                    });
                }
            })();
        };
    };


    <span class="hljs-keyword">var</span> doParallel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">return</span> fn.apply(<span class="hljs-literal">null</span>, [async.each].concat(args));
        };
    };
    <span class="hljs-keyword">var</span> doParallelLimit = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(limit, fn)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">return</span> fn.apply(<span class="hljs-literal">null</span>, [_eachLimit(limit)].concat(args));
        };
    };
    <span class="hljs-keyword">var</span> doSeries = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">return</span> fn.apply(<span class="hljs-literal">null</span>, [async.eachSeries].concat(args));
        };
    };


    <span class="hljs-keyword">var</span> _asyncMap = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eachfn, arr, iterator, callback)</span> </span>{
        <span class="hljs-keyword">var</span> results = [];
        arr = _map(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, i)</span> </span>{
            <span class="hljs-keyword">return</span> {index: i, value: x};
        });
        eachfn(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(x.value, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, v)</span> </span>{
                results[x.index] = v;
                callback(err);
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            callback(err, results);
        });
    };
    async.map = doParallel(_asyncMap);
    async.mapSeries = doSeries(_asyncMap);
    async.mapLimit = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, limit, iterator, callback)</span> </span>{
        <span class="hljs-keyword">return</span> _mapLimit(limit)(arr, iterator, callback);
    };

    <span class="hljs-keyword">var</span> _mapLimit = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(limit)</span> </span>{
        <span class="hljs-keyword">return</span> doParallelLimit(limit, _asyncMap);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>reduce only has a series version, as doing reduce in parallel won’t
work in many situations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.reduce = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, memo, iterator, callback)</span> </span>{
        async.eachSeries(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(memo, x, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, v)</span> </span>{
                memo = v;
                callback(err);
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            callback(err, memo);
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>inject alias</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.inject = async.reduce;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>foldl alias</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.foldl = async.reduce;

    async.reduceRight = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, memo, iterator, callback)</span> </span>{
        <span class="hljs-keyword">var</span> reversed = _map(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
            <span class="hljs-keyword">return</span> x;
        }).reverse();
        async.reduce(reversed, memo, iterator, callback);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>foldr alias</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.foldr = async.reduceRight;

    <span class="hljs-keyword">var</span> _filter = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eachfn, arr, iterator, callback)</span> </span>{
        <span class="hljs-keyword">var</span> results = [];
        arr = _map(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, i)</span> </span>{
            <span class="hljs-keyword">return</span> {index: i, value: x};
        });
        eachfn(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(x.value, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
                <span class="hljs-keyword">if</span> (v) {
                    results.push(x);
                }
                callback();
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            callback(_map(results.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
                <span class="hljs-keyword">return</span> a.index - b.index;
            }), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
                <span class="hljs-keyword">return</span> x.value;
            }));
        });
    };
    async.filter = doParallel(_filter);
    async.filterSeries = doSeries(_filter);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>select alias</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.select = async.filter;
    async.selectSeries = async.filterSeries;

    <span class="hljs-keyword">var</span> _reject = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eachfn, arr, iterator, callback)</span> </span>{
        <span class="hljs-keyword">var</span> results = [];
        arr = _map(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, i)</span> </span>{
            <span class="hljs-keyword">return</span> {index: i, value: x};
        });
        eachfn(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(x.value, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
                <span class="hljs-keyword">if</span> (!v) {
                    results.push(x);
                }
                callback();
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            callback(_map(results.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
                <span class="hljs-keyword">return</span> a.index - b.index;
            }), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
                <span class="hljs-keyword">return</span> x.value;
            }));
        });
    };
    async.reject = doParallel(_reject);
    async.rejectSeries = doSeries(_reject);

    <span class="hljs-keyword">var</span> _detect = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eachfn, arr, iterator, main_callback)</span> </span>{
        eachfn(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(x, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(result)</span> </span>{
                <span class="hljs-keyword">if</span> (result) {
                    main_callback(x);
                    main_callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                }
                <span class="hljs-keyword">else</span> {
                    callback();
                }
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            main_callback();
        });
    };
    async.detect = doParallel(_detect);
    async.detectSeries = doSeries(_detect);

    async.some = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator, main_callback)</span> </span>{
        async.each(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(x, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
                <span class="hljs-keyword">if</span> (v) {
                    main_callback(<span class="hljs-literal">true</span>);
                    main_callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                }
                callback();
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            main_callback(<span class="hljs-literal">false</span>);
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>any alias</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.any = async.some;

    async.every = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator, main_callback)</span> </span>{
        async.each(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(x, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
                <span class="hljs-keyword">if</span> (!v) {
                    main_callback(<span class="hljs-literal">false</span>);
                    main_callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                }
                callback();
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            main_callback(<span class="hljs-literal">true</span>);
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>all alias</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.all = async.every;

    async.sortBy = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator, callback)</span> </span>{
        async.map(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(x, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, criteria)</span> </span>{
                <span class="hljs-keyword">if</span> (err) {
                    callback(err);
                }
                <span class="hljs-keyword">else</span> {
                    callback(<span class="hljs-literal">null</span>, {value: x, criteria: criteria});
                }
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, results)</span> </span>{
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">return</span> callback(err);
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> fn = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(left, right)</span> </span>{
                    <span class="hljs-keyword">var</span> a = left.criteria, b = right.criteria;
                    <span class="hljs-keyword">return</span> a &lt; b ? -<span class="hljs-number">1</span> : a &gt; b ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
                };
                callback(<span class="hljs-literal">null</span>, _map(results.sort(fn), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
                    <span class="hljs-keyword">return</span> x.value;
                }));
            }
        });
    };

    async.auto = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(tasks, callback)</span> </span>{
        callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
        <span class="hljs-keyword">var</span> keys = _keys(tasks);
        <span class="hljs-keyword">if</span> (!keys.length) {
            <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>);
        }

        <span class="hljs-keyword">var</span> results = {};

        <span class="hljs-keyword">var</span> listeners = [];
        <span class="hljs-keyword">var</span> addListener = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
            listeners.unshift(fn);
        };
        <span class="hljs-keyword">var</span> removeListener = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i += <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">if</span> (listeners[i] === fn) {
                    listeners.splice(i, <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">return</span>;
                }
            }
        };
        <span class="hljs-keyword">var</span> taskComplete = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            _each(listeners.slice(<span class="hljs-number">0</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
                fn();
            });
        };

        addListener(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">if</span> (_keys(results).length === keys.length) {
                callback(<span class="hljs-literal">null</span>, results);
                callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
            }
        });

        _each(keys, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k)</span> </span>{
            <span class="hljs-keyword">var</span> task = (tasks[k] <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Function</span>) ? [tasks[k]]: tasks[k];
            <span class="hljs-keyword">var</span> taskCallback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                <span class="hljs-keyword">if</span> (args.length &lt;= <span class="hljs-number">1</span>) {
                    args = args[<span class="hljs-number">0</span>];
                }
                <span class="hljs-keyword">if</span> (err) {
                    <span class="hljs-keyword">var</span> safeResults = {};
                    _each(_keys(results), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(rkey)</span> </span>{
                        safeResults[rkey] = results[rkey];
                    });
                    safeResults[k] = args;
                    callback(err, safeResults);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>stop subsequent errors hitting callback multiple times</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                }
                <span class="hljs-keyword">else</span> {
                    results[k] = args;
                    async.setImmediate(taskComplete);
                }
            };
            <span class="hljs-keyword">var</span> requires = task.slice(<span class="hljs-number">0</span>, <span class="hljs-built_in">Math</span>.abs(task.length - <span class="hljs-number">1</span>)) || [];
            <span class="hljs-keyword">var</span> ready = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> _reduce(requires, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, x)</span> </span>{
                    <span class="hljs-keyword">return</span> (a &amp;&amp; results.hasOwnProperty(x));
                }, <span class="hljs-literal">true</span>) &amp;&amp; !results.hasOwnProperty(k);
            };
            <span class="hljs-keyword">if</span> (ready()) {
                task[task.length - <span class="hljs-number">1</span>](taskCallback, results);
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> listener = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">if</span> (ready()) {
                        removeListener(listener);
                        task[task.length - <span class="hljs-number">1</span>](taskCallback, results);
                    }
                };
                addListener(listener);
            }
        });
    };

    async.waterfall = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(tasks, callback)</span> </span>{
        callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
        <span class="hljs-keyword">if</span> (tasks.constructor !== <span class="hljs-built_in">Array</span>) {
          <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'First argument to waterfall must be an array of functions'</span>);
          <span class="hljs-keyword">return</span> callback(err);
        }
        <span class="hljs-keyword">if</span> (!tasks.length) {
            <span class="hljs-keyword">return</span> callback();
        }
        <span class="hljs-keyword">var</span> wrapIterator = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(iterator)</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">if</span> (err) {
                    callback.apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
                    callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">var</span> next = iterator.next();
                    <span class="hljs-keyword">if</span> (next) {
                        args.push(wrapIterator(next));
                    }
                    <span class="hljs-keyword">else</span> {
                        args.push(callback);
                    }
                    async.setImmediate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        iterator.apply(<span class="hljs-literal">null</span>, args);
                    });
                }
            };
        };
        wrapIterator(async.iterator(tasks))();
    };

    <span class="hljs-keyword">var</span> _parallel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eachfn, tasks, callback)</span> </span>{
        callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
        <span class="hljs-keyword">if</span> (tasks.constructor === <span class="hljs-built_in">Array</span>) {
            eachfn.map(tasks, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn, callback)</span> </span>{
                <span class="hljs-keyword">if</span> (fn) {
                    fn(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                        <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                        <span class="hljs-keyword">if</span> (args.length &lt;= <span class="hljs-number">1</span>) {
                            args = args[<span class="hljs-number">0</span>];
                        }
                        callback.call(<span class="hljs-literal">null</span>, err, args);
                    });
                }
            }, callback);
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> results = {};
            eachfn.each(_keys(tasks), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k, callback)</span> </span>{
                tasks[k](<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">if</span> (args.length &lt;= <span class="hljs-number">1</span>) {
                        args = args[<span class="hljs-number">0</span>];
                    }
                    results[k] = args;
                    callback(err);
                });
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                callback(err, results);
            });
        }
    };

    async.parallel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(tasks, callback)</span> </span>{
        _parallel({ map: async.map, each: async.each }, tasks, callback);
    };

    async.parallelLimit = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tasks, limit, callback)</span> </span>{
        _parallel({ map: _mapLimit(limit), each: _eachLimit(limit) }, tasks, callback);
    };

    async.series = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(tasks, callback)</span> </span>{
        callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
        <span class="hljs-keyword">if</span> (tasks.constructor === <span class="hljs-built_in">Array</span>) {
            async.mapSeries(tasks, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn, callback)</span> </span>{
                <span class="hljs-keyword">if</span> (fn) {
                    fn(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                        <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                        <span class="hljs-keyword">if</span> (args.length &lt;= <span class="hljs-number">1</span>) {
                            args = args[<span class="hljs-number">0</span>];
                        }
                        callback.call(<span class="hljs-literal">null</span>, err, args);
                    });
                }
            }, callback);
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> results = {};
            async.eachSeries(_keys(tasks), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k, callback)</span> </span>{
                tasks[k](<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">if</span> (args.length &lt;= <span class="hljs-number">1</span>) {
                        args = args[<span class="hljs-number">0</span>];
                    }
                    results[k] = args;
                    callback(err);
                });
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                callback(err, results);
            });
        }
    };

    async.iterator = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(tasks)</span> </span>{
        <span class="hljs-keyword">var</span> makeCallback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(index)</span> </span>{
            <span class="hljs-keyword">var</span> fn = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">if</span> (tasks.length) {
                    tasks[index].apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
                }
                <span class="hljs-keyword">return</span> fn.next();
            };
            fn.next = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> (index &lt; tasks.length - <span class="hljs-number">1</span>) ? makeCallback(index + <span class="hljs-number">1</span>): <span class="hljs-literal">null</span>;
            };
            <span class="hljs-keyword">return</span> fn;
        };
        <span class="hljs-keyword">return</span> makeCallback(<span class="hljs-number">0</span>);
    };

    async.apply = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
        <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> fn.apply(
                <span class="hljs-literal">null</span>, args.concat(<span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>))
            );
        };
    };

    <span class="hljs-keyword">var</span> _concat = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eachfn, arr, fn, callback)</span> </span>{
        <span class="hljs-keyword">var</span> r = [];
        eachfn(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, cb)</span> </span>{
            fn(x, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, y)</span> </span>{
                r = r.concat(y || []);
                cb(err);
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            callback(err, r);
        });
    };
    async.concat = doParallel(_concat);
    async.concatSeries = doSeries(_concat);

    async.whilst = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(test, iterator, callback)</span> </span>{
        <span class="hljs-keyword">if</span> (test()) {
            iterator(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">if</span> (err) {
                    <span class="hljs-keyword">return</span> callback(err);
                }
                async.whilst(test, iterator, callback);
            });
        }
        <span class="hljs-keyword">else</span> {
            callback();
        }
    };

    async.doWhilst = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(iterator, test, callback)</span> </span>{
        iterator(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">return</span> callback(err);
            }
            <span class="hljs-keyword">if</span> (test()) {
                async.doWhilst(iterator, test, callback);
            }
            <span class="hljs-keyword">else</span> {
                callback();
            }
        });
    };

    async.until = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(test, iterator, callback)</span> </span>{
        <span class="hljs-keyword">if</span> (!test()) {
            iterator(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">if</span> (err) {
                    <span class="hljs-keyword">return</span> callback(err);
                }
                async.until(test, iterator, callback);
            });
        }
        <span class="hljs-keyword">else</span> {
            callback();
        }
    };

    async.doUntil = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(iterator, test, callback)</span> </span>{
        iterator(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">return</span> callback(err);
            }
            <span class="hljs-keyword">if</span> (!test()) {
                async.doUntil(iterator, test, callback);
            }
            <span class="hljs-keyword">else</span> {
                callback();
            }
        });
    };

    async.queue = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(worker, concurrency)</span> </span>{
        <span class="hljs-keyword">if</span> (concurrency === <span class="hljs-literal">undefined</span>) {
            concurrency = <span class="hljs-number">1</span>;
        }
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_insert</span><span class="hljs-params">(q, data, pos, callback)</span> </span>{
          <span class="hljs-keyword">if</span>(data.constructor !== <span class="hljs-built_in">Array</span>) {
              data = [data];
          }
          _each(data, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(task)</span> </span>{
              <span class="hljs-keyword">var</span> item = {
                  data: task,
                  callback: <span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span> ? callback : <span class="hljs-literal">null</span>
              };

              <span class="hljs-keyword">if</span> (pos) {
                q.tasks.unshift(item);
              } <span class="hljs-keyword">else</span> {
                q.tasks.push(item);
              }

              <span class="hljs-keyword">if</span> (q.saturated &amp;&amp; q.tasks.length === concurrency) {
                  q.saturated();
              }
              async.setImmediate(q.process);
          });
        }

        <span class="hljs-keyword">var</span> workers = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> q = {
            tasks: [],
            concurrency: concurrency,
            saturated: <span class="hljs-literal">null</span>,
            empty: <span class="hljs-literal">null</span>,
            drain: <span class="hljs-literal">null</span>,
            push: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data, callback)</span> </span>{
              _insert(q, data, <span class="hljs-literal">false</span>, callback);
            },
            unshift: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data, callback)</span> </span>{
              _insert(q, data, <span class="hljs-literal">true</span>, callback);
            },
            process: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">if</span> (workers &lt; q.concurrency &amp;&amp; q.tasks.length) {
                    <span class="hljs-keyword">var</span> task = q.tasks.shift();
                    <span class="hljs-keyword">if</span> (q.empty &amp;&amp; q.tasks.length === <span class="hljs-number">0</span>) {
                        q.empty();
                    }
                    workers += <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">var</span> next = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        workers -= <span class="hljs-number">1</span>;
                        <span class="hljs-keyword">if</span> (task.callback) {
                            task.callback.apply(task, <span class="hljs-built_in">arguments</span>);
                        }
                        <span class="hljs-keyword">if</span> (q.drain &amp;&amp; q.tasks.length + workers === <span class="hljs-number">0</span>) {
                            q.drain();
                        }
                        q.process();
                    };
                    <span class="hljs-keyword">var</span> cb = only_once(next);
                    worker(task.data, cb);
                }
            },
            length: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> q.tasks.length;
            },
            running: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> workers;
            }
        };
        <span class="hljs-keyword">return</span> q;
    };

    async.cargo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(worker, payload)</span> </span>{
        <span class="hljs-keyword">var</span> working     = <span class="hljs-literal">false</span>,
            tasks       = [];

        <span class="hljs-keyword">var</span> cargo = {
            tasks: tasks,
            payload: payload,
            saturated: <span class="hljs-literal">null</span>,
            empty: <span class="hljs-literal">null</span>,
            drain: <span class="hljs-literal">null</span>,
            push: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data, callback)</span> </span>{
                <span class="hljs-keyword">if</span>(data.constructor !== <span class="hljs-built_in">Array</span>) {
                    data = [data];
                }
                _each(data, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(task)</span> </span>{
                    tasks.push({
                        data: task,
                        callback: <span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span> ? callback : <span class="hljs-literal">null</span>
                    });
                    <span class="hljs-keyword">if</span> (cargo.saturated &amp;&amp; tasks.length === payload) {
                        cargo.saturated();
                    }
                });
                async.setImmediate(cargo.process);
            },
            process: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">if</span> (working) <span class="hljs-keyword">return</span>;
                <span class="hljs-keyword">if</span> (tasks.length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">if</span>(cargo.drain) cargo.drain();
                    <span class="hljs-keyword">return</span>;
                }

                <span class="hljs-keyword">var</span> ts = <span class="hljs-keyword">typeof</span> payload === <span class="hljs-string">'number'</span>
                            ? tasks.splice(<span class="hljs-number">0</span>, payload)
                            : tasks.splice(<span class="hljs-number">0</span>);

                <span class="hljs-keyword">var</span> ds = _map(ts, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(task)</span> </span>{
                    <span class="hljs-keyword">return</span> task.data;
                });

                <span class="hljs-keyword">if</span>(cargo.empty) cargo.empty();
                working = <span class="hljs-literal">true</span>;
                worker(ds, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    working = <span class="hljs-literal">false</span>;

                    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>;
                    _each(ts, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
                        <span class="hljs-keyword">if</span> (data.callback) {
                            data.callback.apply(<span class="hljs-literal">null</span>, args);
                        }
                    });

                    process();
                });
            },
            length: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> tasks.length;
            },
            running: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> working;
            }
        };
        <span class="hljs-keyword">return</span> cargo;
    };

    <span class="hljs-keyword">var</span> _console_fn = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
            fn.apply(<span class="hljs-literal">null</span>, args.concat([<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">console</span> !== <span class="hljs-string">'undefined'</span>) {
                    <span class="hljs-keyword">if</span> (err) {
                        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">console</span>.error) {
                            <span class="hljs-built_in">console</span>.error(err);
                        }
                    }
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">console</span>[name]) {
                        _each(args, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
                            <span class="hljs-built_in">console</span>[name](x);
                        });
                    }
                }
            }]));
        };
    };
    async.log = _console_fn(<span class="hljs-string">'log'</span>);
    async.dir = _console_fn(<span class="hljs-string">'dir'</span>);
    <span class="hljs-comment">/*async.info = _console_fn('info');
    async.warn = _console_fn('warn');
    async.error = _console_fn('error');*/</span>

    async.memoize = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn, hasher)</span> </span>{
        <span class="hljs-keyword">var</span> memo = {};
        <span class="hljs-keyword">var</span> queues = {};
        hasher = hasher || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
            <span class="hljs-keyword">return</span> x;
        };
        <span class="hljs-keyword">var</span> memoized = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">var</span> callback = args.pop();
            <span class="hljs-keyword">var</span> key = hasher.apply(<span class="hljs-literal">null</span>, args);
            <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> memo) {
                callback.apply(<span class="hljs-literal">null</span>, memo[key]);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> queues) {
                queues[key].push(callback);
            }
            <span class="hljs-keyword">else</span> {
                queues[key] = [callback];
                fn.apply(<span class="hljs-literal">null</span>, args.concat([<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    memo[key] = <span class="hljs-built_in">arguments</span>;
                    <span class="hljs-keyword">var</span> q = queues[key];
                    <span class="hljs-keyword">delete</span> queues[key];
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = q.length; i &lt; l; i++) {
                      q[i].apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
                    }
                }]));
            }
        };
        memoized.memo = memo;
        memoized.unmemoized = fn;
        <span class="hljs-keyword">return</span> memoized;
    };

    async.unmemoize = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> (fn.unmemoized || fn).apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
      };
    };

    async.times = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(count, iterator, callback)</span> </span>{
        <span class="hljs-keyword">var</span> counter = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
            counter.push(i);
        }
        <span class="hljs-keyword">return</span> async.map(counter, iterator, callback);
    };

    async.timesSeries = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(count, iterator, callback)</span> </span>{
        <span class="hljs-keyword">var</span> counter = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
            counter.push(i);
        }
        <span class="hljs-keyword">return</span> async.mapSeries(counter, iterator, callback);
    };

    async.compose = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-comment">/* functions... */</span>)</span> </span>{
        <span class="hljs-keyword">var</span> fns = <span class="hljs-built_in">Array</span>.prototype.reverse.call(<span class="hljs-built_in">arguments</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">var</span> callback = args.pop();
            async.reduce(fns, args, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newargs, fn, cb)</span> </span>{
                fn.apply(that, newargs.concat([<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">var</span> err = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>];
                    <span class="hljs-keyword">var</span> nextargs = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                    cb(err, nextargs);
                }]))
            },
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, results)</span> </span>{
                callback.apply(that, [err].concat(results));
            });
        };
    };

    <span class="hljs-keyword">var</span> _applyEach = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eachfn, fns <span class="hljs-comment">/*args...*/</span>)</span> </span>{
        <span class="hljs-keyword">var</span> go = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">var</span> callback = args.pop();
            <span class="hljs-keyword">return</span> eachfn(fns, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn, cb)</span> </span>{
                fn.apply(that, args.concat([cb]));
            },
            callback);
        };
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>);
            <span class="hljs-keyword">return</span> go.apply(<span class="hljs-keyword">this</span>, args);
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> go;
        }
    };
    async.applyEach = doParallel(_applyEach);
    async.applyEachSeries = doSeries(_applyEach);

    async.forever = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn, callback)</span> </span>{
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span><span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">if</span> (callback) {
                    <span class="hljs-keyword">return</span> callback(err);
                }
                <span class="hljs-keyword">throw</span> err;
            }
            fn(next);
        }
        next();
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>AMD / RequireJS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define !== <span class="hljs-string">'undefined'</span> &amp;&amp; define.amd) {
        define([], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> async;
        });
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Node.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-built_in">module</span>.exports) {
        <span class="hljs-built_in">module</span>.exports = async;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>included directly via <script> tag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> {
        root.async = async;
    }

}());</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
