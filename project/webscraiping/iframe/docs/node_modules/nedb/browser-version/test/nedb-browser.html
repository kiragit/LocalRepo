<!DOCTYPE html>

<html>
<head>
  <title>nedb-browser.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>nedb-browser.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
 * Testing the browser version of NeDB
 * The goal of these tests is not to be exhaustive, we have the server-side NeDB tests for that
 * This is more of a sanity check which executes most of the code at least once and checks
 * it behaves as the server version does
 */</span>

<span class="hljs-keyword">var</span> assert = chai.assert;
chai.should();

<span class="hljs-comment">/**
 * Given a docs array and an id, return the document whose id matches, or null if none is found
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findById</span> <span class="hljs-params">(docs, id)</span> </span>{
  <span class="hljs-keyword">return</span> _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === id; }) || <span class="hljs-literal">null</span>;
}


describe(<span class="hljs-string">'Basic CRUD functionality'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

  it(<span class="hljs-string">'Able to create a database object in the browser'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> Nedb();

    db.inMemoryOnly.should.equal(<span class="hljs-literal">true</span>);
    db.persistence.inMemoryOnly.should.equal(<span class="hljs-literal">true</span>);
  });

  it(<span class="hljs-string">'Insertion and querying'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    <span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> Nedb();

    db.insert({ a: <span class="hljs-number">4</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc1)</span> </span>{
      assert.isNull(err);
      db.insert({ a: <span class="hljs-number">40</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc2)</span> </span>{
        assert.isNull(err);
        db.insert({ a: <span class="hljs-number">400</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc3)</span> </span>{
          assert.isNull(err);

          db.find({ a: { $gt: <span class="hljs-number">36</span> } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            <span class="hljs-keyword">var</span> doc2 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === newDoc2._id; })
              , doc3 = _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === newDoc3._id; })
              ;

            assert.isNull(err);
            docs.length.should.equal(<span class="hljs-number">2</span>);
            doc2.a.should.equal(<span class="hljs-number">40</span>);
            doc3.a.should.equal(<span class="hljs-number">400</span>);

            db.find({ a: { $lt: <span class="hljs-number">36</span> } }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
              assert.isNull(err);
              docs.length.should.equal(<span class="hljs-number">1</span>);
              docs[<span class="hljs-number">0</span>].a.should.equal(<span class="hljs-number">4</span>);
              done();
            });
          });
        });
      });
    });
  });

  it(<span class="hljs-string">'Querying with regular expressions'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    <span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> Nedb();

    db.insert({ planet: <span class="hljs-string">'Earth'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc1)</span> </span>{
      assert.isNull(err);
      db.insert({ planet: <span class="hljs-string">'Mars'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc2)</span> </span>{
        assert.isNull(err);
        db.insert({ planet: <span class="hljs-string">'Jupiter'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc3)</span> </span>{
          assert.isNull(err);
          db.insert({ planet: <span class="hljs-string">'Eaaaaaarth'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc4)</span> </span>{
            assert.isNull(err);
            db.insert({ planet: <span class="hljs-string">'Maaaars'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc5)</span> </span>{
              assert.isNull(err);

              db.find({ planet: <span class="hljs-regexp">/ar/</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                assert.isNull(err);
                docs.length.should.equal(<span class="hljs-number">4</span>);
                _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === newDoc1._id; }).planet.should.equal(<span class="hljs-string">'Earth'</span>);
                _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === newDoc2._id; }).planet.should.equal(<span class="hljs-string">'Mars'</span>);
                _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === newDoc4._id; }).planet.should.equal(<span class="hljs-string">'Eaaaaaarth'</span>);
                _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === newDoc5._id; }).planet.should.equal(<span class="hljs-string">'Maaaars'</span>);

                db.find({ planet: <span class="hljs-regexp">/aa+r/</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                  assert.isNull(err);
                  docs.length.should.equal(<span class="hljs-number">2</span>);
                  _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === newDoc4._id; }).planet.should.equal(<span class="hljs-string">'Eaaaaaarth'</span>);
                  _.find(docs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc._id === newDoc5._id; }).planet.should.equal(<span class="hljs-string">'Maaaars'</span>);

                  done();
                });
              });
            });
          });
        });
      });
    });
  });

  it(<span class="hljs-string">'Updating documents'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    <span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> Nedb();

    db.insert({ planet: <span class="hljs-string">'Eaaaaarth'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc1)</span> </span>{
      db.insert({ planet: <span class="hljs-string">'Maaaaars'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc2)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Simple update</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        db.update({ _id: newDoc2._id }, { $set: { planet: <span class="hljs-string">'Saturn'</span> } }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
          assert.isNull(err);
          nr.should.equal(<span class="hljs-number">1</span>);

          db.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">2</span>);
            findById(docs, newDoc1._id).planet.should.equal(<span class="hljs-string">'Eaaaaarth'</span>);
            findById(docs, newDoc2._id).planet.should.equal(<span class="hljs-string">'Saturn'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Failing update</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            db.update({ _id: <span class="hljs-string">'unknown'</span> }, { $inc: { count: <span class="hljs-number">1</span> } }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
              assert.isNull(err);
              nr.should.equal(<span class="hljs-number">0</span>);

              db.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                docs.length.should.equal(<span class="hljs-number">2</span>);
                findById(docs, newDoc1._id).planet.should.equal(<span class="hljs-string">'Eaaaaarth'</span>);
                findById(docs, newDoc2._id).planet.should.equal(<span class="hljs-string">'Saturn'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Document replacement</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                db.update({ planet: <span class="hljs-string">'Eaaaaarth'</span> }, { planet: <span class="hljs-string">'Uranus'</span> }, { multi: <span class="hljs-literal">false</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
                  assert.isNull(err);
                  nr.should.equal(<span class="hljs-number">1</span>);

                  db.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                    docs.length.should.equal(<span class="hljs-number">2</span>);
                    findById(docs, newDoc1._id).planet.should.equal(<span class="hljs-string">'Uranus'</span>);
                    findById(docs, newDoc2._id).planet.should.equal(<span class="hljs-string">'Saturn'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Multi update</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    db.update({}, { $inc: { count: <span class="hljs-number">3</span> } }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
                      assert.isNull(err);
                      nr.should.equal(<span class="hljs-number">2</span>);

                      db.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                        docs.length.should.equal(<span class="hljs-number">2</span>);
                        findById(docs, newDoc1._id).planet.should.equal(<span class="hljs-string">'Uranus'</span>);
                        findById(docs, newDoc1._id).count.should.equal(<span class="hljs-number">3</span>);
                        findById(docs, newDoc2._id).planet.should.equal(<span class="hljs-string">'Saturn'</span>);
                        findById(docs, newDoc2._id).count.should.equal(<span class="hljs-number">3</span>);

                        done();
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });
  });

  it(<span class="hljs-string">'Updating documents: special modifiers'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    <span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> Nedb();

    db.insert({ planet: <span class="hljs-string">'Earth'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc1)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Pushing to an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      db.update({}, { $push: { satellites: <span class="hljs-string">'Phobos'</span> } }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
        assert.isNull(err);
        nr.should.equal(<span class="hljs-number">1</span>);

        db.findOne({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
          assert.deepEqual(doc, { planet: <span class="hljs-string">'Earth'</span>, _id: newDoc1._id, satellites: [<span class="hljs-string">'Phobos'</span>] });

          db.update({}, { $push: { satellites: <span class="hljs-string">'Deimos'</span> } }, {}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
            assert.isNull(err);
            nr.should.equal(<span class="hljs-number">1</span>);

            db.findOne({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, doc)</span> </span>{
              assert.deepEqual(doc, { planet: <span class="hljs-string">'Earth'</span>, _id: newDoc1._id, satellites: [<span class="hljs-string">'Phobos'</span>, <span class="hljs-string">'Deimos'</span>] });

              done();
            });
          });
        });
      });
    });
  });

  it(<span class="hljs-string">'Upserts'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    <span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> Nedb();

    db.update({ a: <span class="hljs-number">4</span> }, { $inc: { b: <span class="hljs-number">1</span> } }, { upsert: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr, upsert)</span> </span>{
      assert.isNull(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Return upserted document</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      upsert.a.should.equal(<span class="hljs-number">4</span>);
      upsert.b.should.equal(<span class="hljs-number">1</span>);
      nr.should.equal(<span class="hljs-number">1</span>);

      db.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
        docs.length.should.equal(<span class="hljs-number">1</span>);
        docs[<span class="hljs-number">0</span>].a.should.equal(<span class="hljs-number">4</span>);
        docs[<span class="hljs-number">0</span>].b.should.equal(<span class="hljs-number">1</span>);

        done();
      });
    });
  });

  it(<span class="hljs-string">'Removing documents'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    <span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> Nedb();

    db.insert({ a: <span class="hljs-number">2</span> });
    db.insert({ a: <span class="hljs-number">5</span> });
    db.insert({ a: <span class="hljs-number">7</span> });</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Multi remove</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    db.remove({ a: { $<span class="hljs-keyword">in</span>: [ <span class="hljs-number">5</span>, <span class="hljs-number">7</span> ] } }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
      assert.isNull(err);
      nr.should.equal(<span class="hljs-number">2</span>);

      db.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
        docs.length.should.equal(<span class="hljs-number">1</span>);
        docs[<span class="hljs-number">0</span>].a.should.equal(<span class="hljs-number">2</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Remove with no match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        db.remove({ b: { $exists: <span class="hljs-literal">true</span> } }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
          assert.isNull(err);
          nr.should.equal(<span class="hljs-number">0</span>);

          db.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
            docs.length.should.equal(<span class="hljs-number">1</span>);
            docs[<span class="hljs-number">0</span>].a.should.equal(<span class="hljs-number">2</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Simple remove</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            db.remove({ a: { $exists: <span class="hljs-literal">true</span> } }, { multi: <span class="hljs-literal">true</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, nr)</span> </span>{
              assert.isNull(err);
              nr.should.equal(<span class="hljs-number">1</span>);

              db.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
                docs.length.should.equal(<span class="hljs-number">0</span>);

                done();
              });
            });
          });
        });
      });
    });
  });

});   <span class="hljs-comment">// ==== End of 'Basic CRUD functionality' ==== //</span>


describe(<span class="hljs-string">'Indexing'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

  it(<span class="hljs-string">'getCandidates works as expected'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    <span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> Nedb();

    db.insert({ a: <span class="hljs-number">4</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      db.insert({ a: <span class="hljs-number">6</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        db.insert({ a: <span class="hljs-number">7</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">var</span> candidates = db.getCandidates({ a: <span class="hljs-number">6</span> })
          candidates.length.should.equal(<span class="hljs-number">3</span>);
          assert.isDefined(_.find(candidates, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">4</span>; }));
          assert.isDefined(_.find(candidates, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">6</span>; }));
          assert.isDefined(_.find(candidates, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">7</span>; }));

          db.ensureIndex({ fieldName: <span class="hljs-string">'a'</span> });

          candidates = db.getCandidates({ a: <span class="hljs-number">6</span> })
          candidates.length.should.equal(<span class="hljs-number">1</span>);
          assert.isDefined(_.find(candidates, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ <span class="hljs-keyword">return</span> doc.a === <span class="hljs-number">6</span>; }));

          done();
        });
      });
    });
  });

  it(<span class="hljs-string">'Can use indexes to enforce a unique constraint'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
    <span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> Nedb();

    db.ensureIndex({ fieldName: <span class="hljs-string">'u'</span>, unique: <span class="hljs-literal">true</span> });

    db.insert({ u : <span class="hljs-number">5</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
      assert.isNull(err);

      db.insert({ u : <span class="hljs-number">98</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
        assert.isNull(err);

        db.insert({ u : <span class="hljs-number">5</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          err.errorType.should.equal(<span class="hljs-string">'uniqueViolated'</span>);

          done();
        });
      });
    });
  });

});   <span class="hljs-comment">// ==== End of 'Indexing' ==== //</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
