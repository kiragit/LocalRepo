<!DOCTYPE html>

<html>
<head>
  <title>nedb.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>nedb.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{<span class="hljs-keyword">if</span>(<span class="hljs-string">"function"</span>==<span class="hljs-keyword">typeof</span> bootstrap)bootstrap(<span class="hljs-string">"nedb"</span>,e);<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">"object"</span>==<span class="hljs-keyword">typeof</span> exports)<span class="hljs-built_in">module</span>.exports=e();<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">"function"</span>==<span class="hljs-keyword">typeof</span> define&amp;&amp;define.amd)define(e);<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">"undefined"</span>!=<span class="hljs-keyword">typeof</span> ses){<span class="hljs-keyword">if</span>(!ses.ok())<span class="hljs-keyword">return</span>;ses.makeNedb=e}<span class="hljs-keyword">else</span><span class="hljs-string">"undefined"</span>!=<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span>?<span class="hljs-built_in">window</span>.Nedb=e():global.Nedb=e()})(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{<span class="hljs-keyword">var</span> define,ses,bootstrap,<span class="hljs-built_in">module</span>,exports;
<span class="hljs-keyword">return</span> (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e,t,n)</span></span>{<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">i</span><span class="hljs-params">(n,s)</span></span>{<span class="hljs-keyword">if</span>(!t[n]){<span class="hljs-keyword">if</span>(!e[n]){<span class="hljs-keyword">var</span> o=<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">require</span>==<span class="hljs-string">"function"</span>&amp;&amp;<span class="hljs-built_in">require</span>;<span class="hljs-keyword">if</span>(!s&amp;&amp;o)<span class="hljs-keyword">return</span> o(n,!<span class="hljs-number">0</span>);<span class="hljs-keyword">if</span>(r)<span class="hljs-keyword">return</span> r(n,!<span class="hljs-number">0</span>);<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot find module '"</span>+n+<span class="hljs-string">"'"</span>)}<span class="hljs-keyword">var</span> u=t[n]={exports:{}};e[n][<span class="hljs-number">0</span>].call(u.exports,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span></span>{<span class="hljs-keyword">var</span> r=e[n][<span class="hljs-number">1</span>][t];<span class="hljs-keyword">return</span> i(r?r:t)},u,u.exports)}<span class="hljs-keyword">return</span> t[n].exports}<span class="hljs-keyword">var</span> r=<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">require</span>==<span class="hljs-string">"function"</span>&amp;&amp;<span class="hljs-built_in">require</span>;<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> s=<span class="hljs-number">0</span>;s&lt;n.length;s++)i(n[s]);<span class="hljs-keyword">return</span> i})({<span class="hljs-number">1</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{
<span class="hljs-keyword">var</span> process=<span class="hljs-built_in">require</span>(<span class="hljs-string">"__browserify_process"</span>);<span class="hljs-keyword">if</span> (!process.EventEmitter) process.EventEmitter = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};

<span class="hljs-keyword">var</span> EventEmitter = exports.EventEmitter = process.EventEmitter;
<span class="hljs-keyword">var</span> isArray = <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">Array</span>.isArray === <span class="hljs-string">'function'</span>
    ? <span class="hljs-built_in">Array</span>.isArray
    : <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(xs)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.prototype.toString.call(xs) === <span class="hljs-string">'[object Array]'</span>
    }
;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">indexOf</span> <span class="hljs-params">(xs, x)</span> </span>{
    <span class="hljs-keyword">if</span> (xs.indexOf) <span class="hljs-keyword">return</span> xs.indexOf(x);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; xs.length; i++) {
        <span class="hljs-keyword">if</span> (x === xs[i]) <span class="hljs-keyword">return</span> i;
    }
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>By default EventEmitters will print a warning if more than
10 listeners are added to it. This is a useful default which
helps finding memory leaks.</p>
<p>Obviously not all Emitters should be limited to 10. This function allows
that to be increased. Set to zero for unlimited.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> defaultMaxListeners = <span class="hljs-number">10</span>;
EventEmitter.prototype.setMaxListeners = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n)</span> </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events) <span class="hljs-keyword">this</span>._events = {};
  <span class="hljs-keyword">this</span>._events.maxListeners = n;
};


EventEmitter.prototype.emit = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>If there is no ‘error’ event listener then throw.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'error'</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events || !<span class="hljs-keyword">this</span>._events.error ||
        (isArray(<span class="hljs-keyword">this</span>._events.error) &amp;&amp; !<span class="hljs-keyword">this</span>._events.error.length))
    {
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>] <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>]; <span class="hljs-comment">// Unhandled 'error' event</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Uncaught, unspecified 'error' event."</span>);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> handler = <span class="hljs-keyword">this</span>._events[type];
  <span class="hljs-keyword">if</span> (!handler) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> handler == <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">arguments</span>.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>fast cases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
        handler.call(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
        handler.call(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>]);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
        handler.call(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>], <span class="hljs-built_in">arguments</span>[<span class="hljs-number">2</span>]);
        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>slower</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
        handler.apply(<span class="hljs-keyword">this</span>, args);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isArray(handler)) {
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);

    <span class="hljs-keyword">var</span> listeners = handler.slice();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = listeners.length; i &lt; l; i++) {
      listeners[i].apply(<span class="hljs-keyword">this</span>, args);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>EventEmitter is defined in src/node_events.cc
EventEmitter.prototype.emit() is also defined there.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>EventEmitter.prototype.addListener = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type, listener)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'function'</span> !== <span class="hljs-keyword">typeof</span> listener) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'addListener only takes instances of Function'</span>);
  }

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events) <span class="hljs-keyword">this</span>._events = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>To avoid recursion in the case that type == “newListeners”! Before
adding it to the listeners, first emit “newListeners”.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'newListener'</span>, type, listener);

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events[type]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Optimize the case of one listener. Don’t need the extra array object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._events[type] = listener;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isArray(<span class="hljs-keyword">this</span>._events[type])) {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Check for listener leak</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events[type].warned) {
      <span class="hljs-keyword">var</span> m;
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._events.maxListeners !== <span class="hljs-literal">undefined</span>) {
        m = <span class="hljs-keyword">this</span>._events.maxListeners;
      } <span class="hljs-keyword">else</span> {
        m = defaultMaxListeners;
      }

      <span class="hljs-keyword">if</span> (m &amp;&amp; m &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>._events[type].length &gt; m) {
        <span class="hljs-keyword">this</span>._events[type].warned = <span class="hljs-literal">true</span>;
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'(node) warning: possible EventEmitter memory '</span> +
                      <span class="hljs-string">'leak detected. %d listeners added. '</span> +
                      <span class="hljs-string">'Use emitter.setMaxListeners() to increase limit.'</span>,
                      <span class="hljs-keyword">this</span>._events[type].length);
        <span class="hljs-built_in">console</span>.trace();
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>If we’ve already got an array, just append.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._events[type].push(listener);
  } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Adding the second element, need to change to array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._events[type] = [<span class="hljs-keyword">this</span>._events[type], listener];
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

EventEmitter.prototype.on = EventEmitter.prototype.addListener;

EventEmitter.prototype.once = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type, listener)</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  self.on(type, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">g</span><span class="hljs-params">()</span> </span>{
    self.removeListener(type, g);
    listener.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  });

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

EventEmitter.prototype.removeListener = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type, listener)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'function'</span> !== <span class="hljs-keyword">typeof</span> listener) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'removeListener only takes instances of Function'</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>does not use listeners(), so no side effect of creating _events[type]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events || !<span class="hljs-keyword">this</span>._events[type]) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">var</span> list = <span class="hljs-keyword">this</span>._events[type];

  <span class="hljs-keyword">if</span> (isArray(list)) {
    <span class="hljs-keyword">var</span> i = indexOf(list, listener);
    <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    list.splice(i, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span> (list.length == <span class="hljs-number">0</span>)
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._events[type];
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._events[type] === listener) {
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._events[type];
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

EventEmitter.prototype.removeAllListeners = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">this</span>._events = {};
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>does not use listeners(), so no side effect of creating _events[type]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (type &amp;&amp; <span class="hljs-keyword">this</span>._events &amp;&amp; <span class="hljs-keyword">this</span>._events[type]) <span class="hljs-keyword">this</span>._events[type] = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

EventEmitter.prototype.listeners = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type)</span> </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events) <span class="hljs-keyword">this</span>._events = {};
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events[type]) <span class="hljs-keyword">this</span>._events[type] = [];
  <span class="hljs-keyword">if</span> (!isArray(<span class="hljs-keyword">this</span>._events[type])) {
    <span class="hljs-keyword">this</span>._events[type] = [<span class="hljs-keyword">this</span>._events[type]];
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._events[type];
};

EventEmitter.listenerCount = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(emitter, type)</span> </span>{
  <span class="hljs-keyword">var</span> ret;
  <span class="hljs-keyword">if</span> (!emitter._events || !emitter._events[type])
    ret = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> emitter._events[type] === <span class="hljs-string">'function'</span>)
    ret = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">else</span>
    ret = emitter._events[type].length;
  <span class="hljs-keyword">return</span> ret;
};

},{<span class="hljs-string">"__browserify_process"</span>:<span class="hljs-number">3</span>}],<span class="hljs-number">2</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{
<span class="hljs-keyword">var</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>);

exports.isArray = isArray;
exports.isDate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span></span>{<span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.prototype.toString.call(obj) === <span class="hljs-string">'[object Date]'</span>};
exports.isRegExp = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span></span>{<span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.prototype.toString.call(obj) === <span class="hljs-string">'[object RegExp]'</span>};


exports.print = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
exports.puts = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
exports.debug = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{};

exports.inspect = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, showHidden, depth, colors)</span> </span>{
  <span class="hljs-keyword">var</span> seen = [];

  <span class="hljs-keyword">var</span> stylize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, styleType)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><a href="http://en.wikipedia.org/wiki/ANSI_escape_code#graphics">http://en.wikipedia.org/wiki/ANSI_escape_code#graphics</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> styles =
        { <span class="hljs-string">'bold'</span> : [<span class="hljs-number">1</span>, <span class="hljs-number">22</span>],
          <span class="hljs-string">'italic'</span> : [<span class="hljs-number">3</span>, <span class="hljs-number">23</span>],
          <span class="hljs-string">'underline'</span> : [<span class="hljs-number">4</span>, <span class="hljs-number">24</span>],
          <span class="hljs-string">'inverse'</span> : [<span class="hljs-number">7</span>, <span class="hljs-number">27</span>],
          <span class="hljs-string">'white'</span> : [<span class="hljs-number">37</span>, <span class="hljs-number">39</span>],
          <span class="hljs-string">'grey'</span> : [<span class="hljs-number">90</span>, <span class="hljs-number">39</span>],
          <span class="hljs-string">'black'</span> : [<span class="hljs-number">30</span>, <span class="hljs-number">39</span>],
          <span class="hljs-string">'blue'</span> : [<span class="hljs-number">34</span>, <span class="hljs-number">39</span>],
          <span class="hljs-string">'cyan'</span> : [<span class="hljs-number">36</span>, <span class="hljs-number">39</span>],
          <span class="hljs-string">'green'</span> : [<span class="hljs-number">32</span>, <span class="hljs-number">39</span>],
          <span class="hljs-string">'magenta'</span> : [<span class="hljs-number">35</span>, <span class="hljs-number">39</span>],
          <span class="hljs-string">'red'</span> : [<span class="hljs-number">31</span>, <span class="hljs-number">39</span>],
          <span class="hljs-string">'yellow'</span> : [<span class="hljs-number">33</span>, <span class="hljs-number">39</span>] };

    <span class="hljs-keyword">var</span> style =
        { <span class="hljs-string">'special'</span>: <span class="hljs-string">'cyan'</span>,
          <span class="hljs-string">'number'</span>: <span class="hljs-string">'blue'</span>,
          <span class="hljs-string">'boolean'</span>: <span class="hljs-string">'yellow'</span>,
          <span class="hljs-string">'undefined'</span>: <span class="hljs-string">'grey'</span>,
          <span class="hljs-string">'null'</span>: <span class="hljs-string">'bold'</span>,
          <span class="hljs-string">'string'</span>: <span class="hljs-string">'green'</span>,
          <span class="hljs-string">'date'</span>: <span class="hljs-string">'magenta'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>“name”: intentionally not styling</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-string">'regexp'</span>: <span class="hljs-string">'red'</span> }[styleType];

    <span class="hljs-keyword">if</span> (style) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'\u001b['</span> + styles[style][<span class="hljs-number">0</span>] + <span class="hljs-string">'m'</span> + str +
             <span class="hljs-string">'\u001b['</span> + styles[style][<span class="hljs-number">1</span>] + <span class="hljs-string">'m'</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> str;
    }
  };
  <span class="hljs-keyword">if</span> (! colors) {
    stylize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, styleType)</span> </span>{ <span class="hljs-keyword">return</span> str; };
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">format</span><span class="hljs-params">(value, recurseTimes)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Provide a hook for user-specified inspect functions.
Check that value is an object with an inspect function on it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (value &amp;&amp; <span class="hljs-keyword">typeof</span> value.inspect === <span class="hljs-string">'function'</span> &amp;&amp;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Filter out the util module, it’s inspect function is special</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        value !== exports &amp;&amp;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Also filter out any prototype objects using the circular check.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        !(value.constructor &amp;&amp; value.constructor.prototype === value)) {
      <span class="hljs-keyword">return</span> value.inspect(recurseTimes);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Primitive types cannot have properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">typeof</span> value) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'undefined'</span>:
        <span class="hljs-keyword">return</span> stylize(<span class="hljs-string">'undefined'</span>, <span class="hljs-string">'undefined'</span>);

      <span class="hljs-keyword">case</span> <span class="hljs-string">'string'</span>:
        <span class="hljs-keyword">var</span> simple = <span class="hljs-string">'\''</span> + <span class="hljs-built_in">JSON</span>.stringify(value).replace(<span class="hljs-regexp">/^"|"$/g</span>, <span class="hljs-string">''</span>)
                                                 .replace(<span class="hljs-regexp">/'/g</span>, <span class="hljs-string">"\\'"</span>)
                                                 .replace(<span class="hljs-regexp">/\\"/g</span>, <span class="hljs-string">'"'</span>) + <span class="hljs-string">'\''</span>;
        <span class="hljs-keyword">return</span> stylize(simple, <span class="hljs-string">'string'</span>);

      <span class="hljs-keyword">case</span> <span class="hljs-string">'number'</span>:
        <span class="hljs-keyword">return</span> stylize(<span class="hljs-string">''</span> + value, <span class="hljs-string">'number'</span>);

      <span class="hljs-keyword">case</span> <span class="hljs-string">'boolean'</span>:
        <span class="hljs-keyword">return</span> stylize(<span class="hljs-string">''</span> + value, <span class="hljs-string">'boolean'</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>For some reason typeof null is “object”, so special case here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> stylize(<span class="hljs-string">'null'</span>, <span class="hljs-string">'null'</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Look up the keys of the object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> visible_keys = Object_keys(value);
    <span class="hljs-keyword">var</span> keys = showHidden ? Object_getOwnPropertyNames(value) : visible_keys;</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Functions without properties can be shortcutted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'function'</span> &amp;&amp; keys.length === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (isRegExp(value)) {
        <span class="hljs-keyword">return</span> stylize(<span class="hljs-string">''</span> + value, <span class="hljs-string">'regexp'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> name = value.name ? <span class="hljs-string">': '</span> + value.name : <span class="hljs-string">''</span>;
        <span class="hljs-keyword">return</span> stylize(<span class="hljs-string">'[Function'</span> + name + <span class="hljs-string">']'</span>, <span class="hljs-string">'special'</span>);
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Dates without properties can be shortcutted</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (isDate(value) &amp;&amp; keys.length === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> stylize(value.toUTCString(), <span class="hljs-string">'date'</span>);
    }

    <span class="hljs-keyword">var</span> base, type, braces;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Determine the object type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (isArray(value)) {
      type = <span class="hljs-string">'Array'</span>;
      braces = [<span class="hljs-string">'['</span>, <span class="hljs-string">']'</span>];
    } <span class="hljs-keyword">else</span> {
      type = <span class="hljs-string">'Object'</span>;
      braces = [<span class="hljs-string">'{'</span>, <span class="hljs-string">'}'</span>];
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Make functions say that they are functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">var</span> n = value.name ? <span class="hljs-string">': '</span> + value.name : <span class="hljs-string">''</span>;
      base = (isRegExp(value)) ? <span class="hljs-string">' '</span> + value : <span class="hljs-string">' [Function'</span> + n + <span class="hljs-string">']'</span>;
    } <span class="hljs-keyword">else</span> {
      base = <span class="hljs-string">''</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Make dates with properties first say the date</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (isDate(value)) {
      base = <span class="hljs-string">' '</span> + value.toUTCString();
    }

    <span class="hljs-keyword">if</span> (keys.length === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> braces[<span class="hljs-number">0</span>] + base + braces[<span class="hljs-number">1</span>];
    }

    <span class="hljs-keyword">if</span> (recurseTimes &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (isRegExp(value)) {
        <span class="hljs-keyword">return</span> stylize(<span class="hljs-string">''</span> + value, <span class="hljs-string">'regexp'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> stylize(<span class="hljs-string">'[Object]'</span>, <span class="hljs-string">'special'</span>);
      }
    }

    seen.push(value);

    <span class="hljs-keyword">var</span> output = keys.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
      <span class="hljs-keyword">var</span> name, str;
      <span class="hljs-keyword">if</span> (value.__lookupGetter__) {
        <span class="hljs-keyword">if</span> (value.__lookupGetter__(key)) {
          <span class="hljs-keyword">if</span> (value.__lookupSetter__(key)) {
            str = stylize(<span class="hljs-string">'[Getter/Setter]'</span>, <span class="hljs-string">'special'</span>);
          } <span class="hljs-keyword">else</span> {
            str = stylize(<span class="hljs-string">'[Getter]'</span>, <span class="hljs-string">'special'</span>);
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (value.__lookupSetter__(key)) {
            str = stylize(<span class="hljs-string">'[Setter]'</span>, <span class="hljs-string">'special'</span>);
          }
        }
      }
      <span class="hljs-keyword">if</span> (visible_keys.indexOf(key) &lt; <span class="hljs-number">0</span>) {
        name = <span class="hljs-string">'['</span> + key + <span class="hljs-string">']'</span>;
      }
      <span class="hljs-keyword">if</span> (!str) {
        <span class="hljs-keyword">if</span> (seen.indexOf(value[key]) &lt; <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">if</span> (recurseTimes === <span class="hljs-literal">null</span>) {
            str = format(value[key]);
          } <span class="hljs-keyword">else</span> {
            str = format(value[key], recurseTimes - <span class="hljs-number">1</span>);
          }
          <span class="hljs-keyword">if</span> (str.indexOf(<span class="hljs-string">'\n'</span>) &gt; -<span class="hljs-number">1</span>) {
            <span class="hljs-keyword">if</span> (isArray(value)) {
              str = str.split(<span class="hljs-string">'\n'</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(line)</span> </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-string">'  '</span> + line;
              }).join(<span class="hljs-string">'\n'</span>).substr(<span class="hljs-number">2</span>);
            } <span class="hljs-keyword">else</span> {
              str = <span class="hljs-string">'\n'</span> + str.split(<span class="hljs-string">'\n'</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(line)</span> </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-string">'   '</span> + line;
              }).join(<span class="hljs-string">'\n'</span>);
            }
          }
        } <span class="hljs-keyword">else</span> {
          str = stylize(<span class="hljs-string">'[Circular]'</span>, <span class="hljs-string">'special'</span>);
        }
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> name === <span class="hljs-string">'undefined'</span>) {
        <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'Array'</span> &amp;&amp; key.match(<span class="hljs-regexp">/^\d+$/</span>)) {
          <span class="hljs-keyword">return</span> str;
        }
        name = <span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-string">''</span> + key);
        <span class="hljs-keyword">if</span> (name.match(<span class="hljs-regexp">/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/</span>)) {
          name = name.substr(<span class="hljs-number">1</span>, name.length - <span class="hljs-number">2</span>);
          name = stylize(name, <span class="hljs-string">'name'</span>);
        } <span class="hljs-keyword">else</span> {
          name = name.replace(<span class="hljs-regexp">/'/g</span>, <span class="hljs-string">"\\'"</span>)
                     .replace(<span class="hljs-regexp">/\\"/g</span>, <span class="hljs-string">'"'</span>)
                     .replace(<span class="hljs-regexp">/(^"|"$)/g</span>, <span class="hljs-string">"'"</span>);
          name = stylize(name, <span class="hljs-string">'string'</span>);
        }
      }

      <span class="hljs-keyword">return</span> name + <span class="hljs-string">': '</span> + str;
    });

    seen.pop();

    <span class="hljs-keyword">var</span> numLinesEst = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> length = output.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(prev, cur)</span> </span>{
      numLinesEst++;
      <span class="hljs-keyword">if</span> (cur.indexOf(<span class="hljs-string">'\n'</span>) &gt;= <span class="hljs-number">0</span>) numLinesEst++;
      <span class="hljs-keyword">return</span> prev + cur.length + <span class="hljs-number">1</span>;
    }, <span class="hljs-number">0</span>);

    <span class="hljs-keyword">if</span> (length &gt; <span class="hljs-number">50</span>) {
      output = braces[<span class="hljs-number">0</span>] +
               (base === <span class="hljs-string">''</span> ? <span class="hljs-string">''</span> : base + <span class="hljs-string">'\n '</span>) +
               <span class="hljs-string">' '</span> +
               output.join(<span class="hljs-string">',\n  '</span>) +
               <span class="hljs-string">' '</span> +
               braces[<span class="hljs-number">1</span>];

    } <span class="hljs-keyword">else</span> {
      output = braces[<span class="hljs-number">0</span>] + base + <span class="hljs-string">' '</span> + output.join(<span class="hljs-string">', '</span>) + <span class="hljs-string">' '</span> + braces[<span class="hljs-number">1</span>];
    }

    <span class="hljs-keyword">return</span> output;
  }
  <span class="hljs-keyword">return</span> format(obj, (<span class="hljs-keyword">typeof</span> depth === <span class="hljs-string">'undefined'</span> ? <span class="hljs-number">2</span> : depth));
};


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isArray</span><span class="hljs-params">(ar)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Array</span>.isArray(ar) ||
         (<span class="hljs-keyword">typeof</span> ar === <span class="hljs-string">'object'</span> &amp;&amp; <span class="hljs-built_in">Object</span>.prototype.toString.call(ar) === <span class="hljs-string">'[object Array]'</span>);
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isRegExp</span><span class="hljs-params">(re)</span> </span>{
  <span class="hljs-keyword">typeof</span> re === <span class="hljs-string">'object'</span> &amp;&amp; <span class="hljs-built_in">Object</span>.prototype.toString.call(re) === <span class="hljs-string">'[object RegExp]'</span>;
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isDate</span><span class="hljs-params">(d)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> d === <span class="hljs-string">'object'</span> &amp;&amp; <span class="hljs-built_in">Object</span>.prototype.toString.call(d) === <span class="hljs-string">'[object Date]'</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pad</span><span class="hljs-params">(n)</span> </span>{
  <span class="hljs-keyword">return</span> n &lt; <span class="hljs-number">10</span> ? <span class="hljs-string">'0'</span> + n.toString(<span class="hljs-number">10</span>) : n.toString(<span class="hljs-number">10</span>);
}

<span class="hljs-keyword">var</span> months = [<span class="hljs-string">'Jan'</span>, <span class="hljs-string">'Feb'</span>, <span class="hljs-string">'Mar'</span>, <span class="hljs-string">'Apr'</span>, <span class="hljs-string">'May'</span>, <span class="hljs-string">'Jun'</span>, <span class="hljs-string">'Jul'</span>, <span class="hljs-string">'Aug'</span>, <span class="hljs-string">'Sep'</span>,
              <span class="hljs-string">'Oct'</span>, <span class="hljs-string">'Nov'</span>, <span class="hljs-string">'Dec'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>26 Feb 16:19:34</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">timestamp</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> d = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
  <span class="hljs-keyword">var</span> time = [pad(d.getHours()),
              pad(d.getMinutes()),
              pad(d.getSeconds())].join(<span class="hljs-string">':'</span>);
  <span class="hljs-keyword">return</span> [d.getDate(), months[d.getMonth()], time].join(<span class="hljs-string">' '</span>);
}

exports.log = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg)</span> </span>{};

exports.pump = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">var</span> Object_keys = <span class="hljs-built_in">Object</span>.keys || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> res = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj) res.push(key);
    <span class="hljs-keyword">return</span> res;
};

<span class="hljs-keyword">var</span> Object_getOwnPropertyNames = <span class="hljs-built_in">Object</span>.getOwnPropertyNames || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> res = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.hasOwnProperty.call(obj, key)) res.push(key);
    }
    <span class="hljs-keyword">return</span> res;
};

<span class="hljs-keyword">var</span> Object_create = <span class="hljs-built_in">Object</span>.create || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(prototype, properties)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>from es5-shim</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> object;
    <span class="hljs-keyword">if</span> (prototype === <span class="hljs-literal">null</span>) {
        object = { <span class="hljs-string">'__proto__'</span> : <span class="hljs-literal">null</span> };
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> prototype !== <span class="hljs-string">'object'</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(
                <span class="hljs-string">'typeof prototype['</span> + (<span class="hljs-keyword">typeof</span> prototype) + <span class="hljs-string">'] != \'object\''</span>
            );
        }
        <span class="hljs-keyword">var</span> Type = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
        Type.prototype = prototype;
        object = <span class="hljs-keyword">new</span> Type();
        object.__proto__ = prototype;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> properties !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-built_in">Object</span>.defineProperties) {
        <span class="hljs-built_in">Object</span>.defineProperties(object, properties);
    }
    <span class="hljs-keyword">return</span> object;
};

exports.inherits = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ctor, superCtor)</span> </span>{
  ctor.super_ = superCtor;
  ctor.prototype = Object_create(superCtor.prototype, {
    constructor: {
      value: ctor,
      enumerable: <span class="hljs-literal">false</span>,
      writable: <span class="hljs-literal">true</span>,
      configurable: <span class="hljs-literal">true</span>
    }
  });
};

<span class="hljs-keyword">var</span> formatRegExp = <span class="hljs-regexp">/%[sdj%]/g</span>;
exports.format = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> f !== <span class="hljs-string">'string'</span>) {
    <span class="hljs-keyword">var</span> objects = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; i++) {
      objects.push(exports.inspect(<span class="hljs-built_in">arguments</span>[i]));
    }
    <span class="hljs-keyword">return</span> objects.join(<span class="hljs-string">' '</span>);
  }

  <span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>;
  <span class="hljs-keyword">var</span> len = args.length;
  <span class="hljs-keyword">var</span> str = <span class="hljs-built_in">String</span>(f).replace(formatRegExp, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span> </span>{
    <span class="hljs-keyword">if</span> (x === <span class="hljs-string">'%%'</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'%'</span>;
    <span class="hljs-keyword">if</span> (i &gt;= len) <span class="hljs-keyword">return</span> x;
    <span class="hljs-keyword">switch</span> (x) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'%s'</span>: <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>(args[i++]);
      <span class="hljs-keyword">case</span> <span class="hljs-string">'%d'</span>: <span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(args[i++]);
      <span class="hljs-keyword">case</span> <span class="hljs-string">'%j'</span>: <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.stringify(args[i++]);
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> x;
    }
  });
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> x = args[i]; i &lt; len; x = args[++i]){
    <span class="hljs-keyword">if</span> (x === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> x !== <span class="hljs-string">'object'</span>) {
      str += <span class="hljs-string">' '</span> + x;
    } <span class="hljs-keyword">else</span> {
      str += <span class="hljs-string">' '</span> + exports.inspect(x);
    }
  }
  <span class="hljs-keyword">return</span> str;
};

},{<span class="hljs-string">"events"</span>:<span class="hljs-number">1</span>}],<span class="hljs-number">3</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>shim for using process in browser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> process = <span class="hljs-built_in">module</span>.exports = {};

process.nextTick = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> canSetImmediate = <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> !== <span class="hljs-string">'undefined'</span>
    &amp;&amp; <span class="hljs-built_in">window</span>.setImmediate;
    <span class="hljs-keyword">var</span> canPost = <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> !== <span class="hljs-string">'undefined'</span>
    &amp;&amp; <span class="hljs-built_in">window</span>.postMessage &amp;&amp; <span class="hljs-built_in">window</span>.addEventListener
    ;

    <span class="hljs-keyword">if</span> (canSetImmediate) {
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(f)</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.setImmediate(f) };
    }

    <span class="hljs-keyword">if</span> (canPost) {
        <span class="hljs-keyword">var</span> queue = [];
        <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ev)</span> </span>{
            <span class="hljs-keyword">if</span> (ev.source === <span class="hljs-built_in">window</span> &amp;&amp; ev.data === <span class="hljs-string">'process-tick'</span>) {
                ev.stopPropagation();
                <span class="hljs-keyword">if</span> (queue.length &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">var</span> fn = queue.shift();
                    fn();
                }
            }
        }, <span class="hljs-literal">true</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nextTick</span><span class="hljs-params">(fn)</span> </span>{
            queue.push(fn);
            <span class="hljs-built_in">window</span>.postMessage(<span class="hljs-string">'process-tick'</span>, <span class="hljs-string">'*'</span>);
        };
    }

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nextTick</span><span class="hljs-params">(fn)</span> </span>{
        setTimeout(fn, <span class="hljs-number">0</span>);
    };
})();

process.title = <span class="hljs-string">'browser'</span>;
process.browser = <span class="hljs-literal">true</span>;
process.env = {};
process.argv = [];

process.binding = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name)</span> </span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'process.binding is not supported'</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>TODO(shtylman)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>process.cwd = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">'/'</span> };
process.chdir = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dir)</span> </span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'process.chdir is not supported'</span>);
};

},{}],<span class="hljs-number">4</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{
<span class="hljs-comment">/**
 * Manage access to data, be it to find, update or remove it
 */</span>
<span class="hljs-keyword">var</span> model = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./model'</span>);

 

<span class="hljs-comment">/**
 * Create a new cursor for this collection
 * @param {Datastore} db - The datastore this cursor is bound to
 * @param {Query} query - The query this cursor will operate on
 * @param {Function} execDn - Handler to be executed  after cursor has found the results and before the callback passed to find/findOne/update/remove
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Cursor</span> <span class="hljs-params">(db, query, execFn)</span> </span>{
  <span class="hljs-keyword">this</span>.db = db;
  <span class="hljs-keyword">this</span>.query = query || {};
  <span class="hljs-keyword">if</span> (execFn) { <span class="hljs-keyword">this</span>.execFn = execFn; }
}


<span class="hljs-comment">/**
 * Set a limit to the number of results
 */</span>
Cursor.prototype.limit = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(limit)</span> </span>{
  <span class="hljs-keyword">this</span>._limit = limit;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};


<span class="hljs-comment">/**
 * Skip a the number of results
 */</span>
Cursor.prototype.skip = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(skip)</span> </span>{
  <span class="hljs-keyword">this</span>._skip = skip;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};


<span class="hljs-comment">/**
 * Sort results of the query
 * @Param {SortQuery} sortQuery - SortQuery is { field: order }, field can use the dot-notation, order is 1 for ascending and -1 for descending
 */</span>
Cursor.prototype.sort = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(sortQuery)</span> </span>{
  <span class="hljs-keyword">this</span>._sort = sortQuery;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};


<span class="hljs-comment">/**
 * Get all matching elements
 * Will return pointers to matched elements (shallow copies), returning full copies is the role of find or findOne
 * This is an internal function, use exec which uses the executor
 *
 * @param {Function} callback - Signature: err, results
 */</span>
Cursor.prototype._exec = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> </span>{
  <span class="hljs-keyword">var</span> candidates = <span class="hljs-keyword">this</span>.db.getCandidates(<span class="hljs-keyword">this</span>.query)
    , res = [], added = <span class="hljs-number">0</span>, skipped = <span class="hljs-number">0</span>, self = <span class="hljs-keyword">this</span>
    , i, keys, key
    ;
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; candidates.length; i += <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">if</span> (model.match(candidates[i], <span class="hljs-keyword">this</span>.query)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>If a sort is defined, wait for the results to be sorted before applying limit and skip</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._sort) {
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._skip &amp;&amp; <span class="hljs-keyword">this</span>._skip &gt; skipped) {
            skipped += <span class="hljs-number">1</span>;
          } <span class="hljs-keyword">else</span> {
            res.push(candidates[i]);
            added += <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._limit &amp;&amp; <span class="hljs-keyword">this</span>._limit &lt;= added) { <span class="hljs-keyword">break</span>; }                  
          }
        } <span class="hljs-keyword">else</span> {
          res.push(candidates[i]);
        }
      }
    }
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-keyword">return</span> callback(err);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Apply all sorts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._sort) {
    keys = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>._sort);</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Sorting</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> criteria = [];
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; keys.length; i++) {
      key = keys[i];
      criteria.push({ key: key, direction: self._sort[key] });
    }
    res.sort(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b)</span> </span>{
      <span class="hljs-keyword">var</span> criterion, compare, i;
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; criteria.length; i++) {
        criterion = criteria[i];
        compare = criterion.direction * model.compareThings(model.getDotValue(a, criterion.key), model.getDotValue(b, criterion.key));
        <span class="hljs-keyword">if</span> (compare !== <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">return</span> compare;
        }
      }
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Applying limit and skip</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> limit = <span class="hljs-keyword">this</span>._limit || res.length
      , skip = <span class="hljs-keyword">this</span>._skip || <span class="hljs-number">0</span>;
      
    res = res.slice(skip, skip + limit);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.execFn) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.execFn(<span class="hljs-literal">null</span>, res, callback);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, res);
  }
};

Cursor.prototype.exec = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.db.executor.push({ <span class="hljs-keyword">this</span>: <span class="hljs-keyword">this</span>, fn: <span class="hljs-keyword">this</span>._exec, <span class="hljs-built_in">arguments</span>: <span class="hljs-built_in">arguments</span> });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = Cursor;
},{<span class="hljs-string">"./model"</span>:<span class="hljs-number">9</span>}],<span class="hljs-number">5</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{
<span class="hljs-comment">/**
 * Specific customUtils for the browser, where we don't have access to the Crypto and Buffer modules
 */</span>

<span class="hljs-comment">/**
 * Taken from the crypto-browserify module
 * https://github.com/dominictarr/crypto-browserify
 * NOTE: Math.random() does not guarantee "cryptographic quality" but we actually don't need it
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">randomBytes</span> <span class="hljs-params">(size)</span> </span>{
  <span class="hljs-keyword">var</span> bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(size);
  <span class="hljs-keyword">var</span> r;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, r; i &lt; size; i++) {
    <span class="hljs-keyword">if</span> ((i &amp; <span class="hljs-number">0x03</span>) == <span class="hljs-number">0</span>) r = <span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">0x100000000</span>;
    bytes[i] = r &gt;&gt;&gt; ((i &amp; <span class="hljs-number">0x03</span>) &lt;&lt; <span class="hljs-number">3</span>) &amp; <span class="hljs-number">0xff</span>;
  }

  <span class="hljs-keyword">return</span> bytes;
}


<span class="hljs-comment">/**
 * Taken from the base64-js module
 * https://github.com/beatgammit/base64-js/
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">byteArrayToBase64</span> <span class="hljs-params">(uint8)</span> </span>{
  <span class="hljs-keyword">var</span> lookup = <span class="hljs-string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'</span>
    , extraBytes = uint8.length % <span class="hljs-number">3</span>   <span class="hljs-comment">// if we have 1 byte left, pad 2 bytes</span>
    , output = <span class="hljs-string">""</span>
    , temp, length, i;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tripletToBase64</span> <span class="hljs-params">(num)</span> </span>{
    <span class="hljs-keyword">return</span> lookup[num &gt;&gt; <span class="hljs-number">18</span> &amp; <span class="hljs-number">0x3F</span>] + lookup[num &gt;&gt; <span class="hljs-number">12</span> &amp; <span class="hljs-number">0x3F</span>] + lookup[num &gt;&gt; <span class="hljs-number">6</span> &amp; <span class="hljs-number">0x3F</span>] + lookup[num &amp; <span class="hljs-number">0x3F</span>];
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>go through the array every three bytes, we’ll deal with trailing stuff later</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, length = uint8.length - extraBytes; i &lt; length; i += <span class="hljs-number">3</span>) {
    temp = (uint8[i] &lt;&lt; <span class="hljs-number">16</span>) + (uint8[i + <span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">8</span>) + (uint8[i + <span class="hljs-number">2</span>]);
    output += tripletToBase64(temp);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>pad the end with zeros, but make sure to not forget the extra bytes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">switch</span> (extraBytes) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
      temp = uint8[uint8.length - <span class="hljs-number">1</span>];
      output += lookup[temp &gt;&gt; <span class="hljs-number">2</span>];
      output += lookup[(temp &lt;&lt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0x3F</span>];
      output += <span class="hljs-string">'=='</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
      temp = (uint8[uint8.length - <span class="hljs-number">2</span>] &lt;&lt; <span class="hljs-number">8</span>) + (uint8[uint8.length - <span class="hljs-number">1</span>]);
      output += lookup[temp &gt;&gt; <span class="hljs-number">10</span>];
      output += lookup[(temp &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0x3F</span>];
      output += lookup[(temp &lt;&lt; <span class="hljs-number">2</span>) &amp; <span class="hljs-number">0x3F</span>];
      output += <span class="hljs-string">'='</span>;
      <span class="hljs-keyword">break</span>;
  }

  <span class="hljs-keyword">return</span> output;
}


<span class="hljs-comment">/**
 * Return a random alphanumerical string of length len
 * There is a very small probability (less than 1/1,000,000) for the length to be less than len
 * (il the base64 conversion yields too many pluses and slashes) but
 * that's not an issue here
 * The probability of a collision is extremely small (need 3*10^12 documents to have one chance in a million of a collision)
 * See http://en.wikipedia.org/wiki/Birthday_problem
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uid</span> <span class="hljs-params">(len)</span> </span>{
  <span class="hljs-keyword">return</span> byteArrayToBase64(randomBytes(<span class="hljs-built_in">Math</span>.ceil(<span class="hljs-built_in">Math</span>.max(<span class="hljs-number">8</span>, len * <span class="hljs-number">2</span>)))).replace(<span class="hljs-regexp">/[+\/]/g</span>, <span class="hljs-string">''</span>).slice(<span class="hljs-number">0</span>, len);
}



<span class="hljs-built_in">module</span>.exports.uid = uid;

},{}],<span class="hljs-number">6</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{
<span class="hljs-keyword">var</span> customUtils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./customUtils'</span>)
  , model = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./model'</span>)
  , async = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)
  , Executor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./executor'</span>)
  , Index = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./indexes'</span>)
  , util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
  , _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
  , Persistence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./persistence'</span>)
  , Cursor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./cursor'</span>)
  ;


<span class="hljs-comment">/**
 * Create a new collection
 * @param {String} options.filename Optional, datastore will be in-memory only if not provided
 * @param {Boolean} options.inMemoryOnly Optional, default to false
 * @param {Boolean} options.nodeWebkitAppName Optional, specify the name of your NW app if you want options.filename to be relative to the directory where
 *                                            Node Webkit stores application data such as cookies and local storage (the best place to store data in my opinion)
 * @param {Boolean} options.autoload Optional, defaults to false
 * @param {Function} options.onload Optional, if autoload is used this will be called after the load database with the error object as parameter. If you don't pass it the error will be thrown
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Datastore</span> <span class="hljs-params">(options)</span> </span>{
  <span class="hljs-keyword">var</span> filename;</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Retrocompatibility with v0.6 and before</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'string'</span>) {
    filename = options;
    <span class="hljs-keyword">this</span>.inMemoryOnly = <span class="hljs-literal">false</span>;   <span class="hljs-comment">// Default</span>
  } <span class="hljs-keyword">else</span> {
    options = options || {};
    filename = options.filename;
    <span class="hljs-keyword">this</span>.inMemoryOnly = options.inMemoryOnly || <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.autoload = options.autoload || <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Determine whether in memory or persistent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!filename || <span class="hljs-keyword">typeof</span> filename !== <span class="hljs-string">'string'</span> || filename.length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">this</span>.filename = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.inMemoryOnly = <span class="hljs-literal">true</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.filename = filename;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Persistence handling</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.persistence = <span class="hljs-keyword">new</span> Persistence({ db: <span class="hljs-keyword">this</span>, nodeWebkitAppName: options.nodeWebkitAppName });</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>This new executor is ready if we don’t use persistence
If we do, it will only be ready once loadDatabase is called</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.executor = <span class="hljs-keyword">new</span> Executor();
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.inMemoryOnly) { <span class="hljs-keyword">this</span>.executor.ready = <span class="hljs-literal">true</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Indexed by field name, dot notation can be used
_id is always indexed and since _ids are generated randomly the underlying
binary is always well-balanced</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.indexes = {};
  <span class="hljs-keyword">this</span>.indexes._id = <span class="hljs-keyword">new</span> Index({ fieldName: <span class="hljs-string">'_id'</span>, unique: <span class="hljs-literal">true</span> });</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Queue a load of the database right away and call the onload handler
By default (no onload handler), if there is an error there, no operation will be possible so warn the user by throwing an exception</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.autoload) { <span class="hljs-keyword">this</span>.loadDatabase(options.onload || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
    <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">throw</span> err; }
  }); }
}


<span class="hljs-comment">/**
 * Load the database from the datafile, and trigger the execution of buffered commands if any
 */</span>
Datastore.prototype.loadDatabase = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.executor.push({ <span class="hljs-keyword">this</span>: <span class="hljs-keyword">this</span>.persistence, fn: <span class="hljs-keyword">this</span>.persistence.loadDatabase, <span class="hljs-built_in">arguments</span>: <span class="hljs-built_in">arguments</span> }, <span class="hljs-literal">true</span>);
};


<span class="hljs-comment">/**
 * Get an array of all the data in the database
 */</span>
Datastore.prototype.getAllData = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.indexes._id.getAll();
};


<span class="hljs-comment">/**
 * Reset all currently defined indexes
 */</span>
Datastore.prototype.resetIndexes = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newData)</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

  <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.indexes).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(i)</span> </span>{
    self.indexes[i].reset(newData);
  });
};


<span class="hljs-comment">/**
 * Ensure an index is kept for this field. Same parameters as lib/indexes
 * For now this function is synchronous, we need to test how much time it takes
 * We use an async API for consistency with the rest of the code
 * @param {String} options.fieldName
 * @param {Boolean} options.unique
 * @param {Boolean} options.sparse
 * @param {Function} cb Optional callback, signature: err
 */</span>
Datastore.prototype.ensureIndex = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options, cb)</span> </span>{
  <span class="hljs-keyword">var</span> callback = cb || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};

  options = options || {};

  <span class="hljs-keyword">if</span> (!options.fieldName) { <span class="hljs-keyword">return</span> callback({ missingFieldName: <span class="hljs-literal">true</span> }); }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.indexes[options.fieldName]) { <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>); }

  <span class="hljs-keyword">this</span>.indexes[options.fieldName] = <span class="hljs-keyword">new</span> Index(options);

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">this</span>.indexes[options.fieldName].insert(<span class="hljs-keyword">this</span>.getAllData());
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.indexes[options.fieldName];
    <span class="hljs-keyword">return</span> callback(e);
  }

  <span class="hljs-keyword">this</span>.persistence.persistNewState([{ $$indexCreated: options }], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
    <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> callback(err); }
    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>);
  });
};


<span class="hljs-comment">/**
 * Remove an index
 * @param {String} fieldName
 * @param {Function} cb Optional callback, signature: err 
 */</span>
Datastore.prototype.removeIndex = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fieldName, cb)</span> </span>{
  <span class="hljs-keyword">var</span> callback = cb || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
  
  <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.indexes[fieldName];
  
  <span class="hljs-keyword">this</span>.persistence.persistNewState([{ $$indexRemoved: fieldName }], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
    <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> callback(err); }
    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>);
  });  
};


<span class="hljs-comment">/**
 * Add one or several document(s) to all indexes
 */</span>
Datastore.prototype.addToIndexes = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{
  <span class="hljs-keyword">var</span> i, failingIndex, error
    , keys = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.indexes)
    ;

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; keys.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">this</span>.indexes[keys[i]].insert(doc);
    } <span class="hljs-keyword">catch</span> (e) {
      failingIndex = i;
      error = e;
      <span class="hljs-keyword">break</span>;
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>If an error happened, we need to rollback the insert on all other indexes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; failingIndex; i += <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">this</span>.indexes[keys[i]].remove(doc);
    }

    <span class="hljs-keyword">throw</span> error;
  }
};


<span class="hljs-comment">/**
 * Remove one or several document(s) from all indexes
 */</span>
Datastore.prototype.removeFromIndexes = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

  <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.indexes).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(i)</span> </span>{
    self.indexes[i].remove(doc);
  });
};


<span class="hljs-comment">/**
 * Update one or several documents in all indexes
 * To update multiple documents, oldDoc must be an array of { oldDoc, newDoc } pairs
 * If one update violates a constraint, all changes are rolled back
 */</span>
Datastore.prototype.updateIndexes = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(oldDoc, newDoc)</span> </span>{
  <span class="hljs-keyword">var</span> i, failingIndex, error
    , keys = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.indexes)
    ;

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; keys.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">this</span>.indexes[keys[i]].update(oldDoc, newDoc);
    } <span class="hljs-keyword">catch</span> (e) {
      failingIndex = i;
      error = e;
      <span class="hljs-keyword">break</span>;
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>If an error happened, we need to rollback the update on all other indexes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; failingIndex; i += <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">this</span>.indexes[keys[i]].revertUpdate(oldDoc, newDoc);
    }

    <span class="hljs-keyword">throw</span> error;
  }
};


<span class="hljs-comment">/**
 * Return the list of candidates for a given query
 * Crude implementation for now, we return the candidates given by the first usable index if any
 * We try the following query types, in this order: basic match, $in match, comparison match
 * One way to make it better would be to enable the use of multiple indexes if the first usable index
 * returns too much data. I may do it in the future.
 *
 * TODO: needs to be moved to the Cursor module
 */</span>
Datastore.prototype.getCandidates = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(query)</span> </span>{
  <span class="hljs-keyword">var</span> indexNames = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.indexes)
    , usableQueryKeys;</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>For a basic match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  usableQueryKeys = [];
  <span class="hljs-built_in">Object</span>.keys(query).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k)</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> query[k] === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> query[k] === <span class="hljs-string">'number'</span> || <span class="hljs-keyword">typeof</span> query[k] === <span class="hljs-string">'boolean'</span> || util.isDate(query[k]) || query[k] === <span class="hljs-literal">null</span>) {
      usableQueryKeys.push(k);
    }
  });
  usableQueryKeys = _.intersection(usableQueryKeys, indexNames);
  <span class="hljs-keyword">if</span> (usableQueryKeys.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.indexes[usableQueryKeys[<span class="hljs-number">0</span>]].getMatching(query[usableQueryKeys[<span class="hljs-number">0</span>]]);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>For a $in match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  usableQueryKeys = [];
  <span class="hljs-built_in">Object</span>.keys(query).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k)</span> </span>{
    <span class="hljs-keyword">if</span> (query[k] &amp;&amp; query[k].hasOwnProperty(<span class="hljs-string">'$in'</span>)) {
      usableQueryKeys.push(k);
    }
  });
  usableQueryKeys = _.intersection(usableQueryKeys, indexNames);
  <span class="hljs-keyword">if</span> (usableQueryKeys.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.indexes[usableQueryKeys[<span class="hljs-number">0</span>]].getMatching(query[usableQueryKeys[<span class="hljs-number">0</span>]].$<span class="hljs-keyword">in</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>For a comparison match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  usableQueryKeys = [];
  <span class="hljs-built_in">Object</span>.keys(query).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k)</span> </span>{
    <span class="hljs-keyword">if</span> (query[k] &amp;&amp; (query[k].hasOwnProperty(<span class="hljs-string">'$lt'</span>) || query[k].hasOwnProperty(<span class="hljs-string">'$lte'</span>) || query[k].hasOwnProperty(<span class="hljs-string">'$gt'</span>) || query[k].hasOwnProperty(<span class="hljs-string">'$gte'</span>))) {
      usableQueryKeys.push(k);
    }
  });
  usableQueryKeys = _.intersection(usableQueryKeys, indexNames);
  <span class="hljs-keyword">if</span> (usableQueryKeys.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.indexes[usableQueryKeys[<span class="hljs-number">0</span>]].getBetweenBounds(query[usableQueryKeys[<span class="hljs-number">0</span>]]);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>By default, return all the DB data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getAllData();
};


<span class="hljs-comment">/**
 * Insert a new document
 * @param {Function} cb Optional callback, signature: err, insertedDoc
 *
 * @api private Use Datastore.insert which has the same signature
 */</span>
Datastore.prototype._insert = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newDoc, cb)</span> </span>{
  <span class="hljs-keyword">var</span> callback = cb || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{}
    ;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">this</span>._insertInCache(newDoc);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> callback(e);
  }

  <span class="hljs-keyword">this</span>.persistence.persistNewState(util.isArray(newDoc) ? newDoc : [newDoc], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
    <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> callback(err); }
    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, newDoc);
  });
};

<span class="hljs-comment">/**
 * Prepare a document (or array of documents) to be inserted in a database
 * @api private
 */</span>
Datastore.prototype.prepareDocumentForInsertion = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newDoc)</span> </span>{
  <span class="hljs-keyword">var</span> preparedDoc, self = <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">if</span> (util.isArray(newDoc)) {
    preparedDoc = [];
    newDoc.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{ preparedDoc.push(self.prepareDocumentForInsertion(doc)); });
  } <span class="hljs-keyword">else</span> {
    newDoc._id = newDoc._id || customUtils.uid(<span class="hljs-number">16</span>);
    preparedDoc = model.deepCopy(newDoc);
    model.checkObject(preparedDoc);
  }
  
  <span class="hljs-keyword">return</span> preparedDoc;
};

<span class="hljs-comment">/**
 * If newDoc is an array of documents, this will insert all documents in the cache
 * @api private
 */</span>
Datastore.prototype._insertInCache = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newDoc)</span> </span>{
  <span class="hljs-keyword">if</span> (util.isArray(newDoc)) {
    <span class="hljs-keyword">this</span>._insertMultipleDocsInCache(newDoc);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.addToIndexes(<span class="hljs-keyword">this</span>.prepareDocumentForInsertion(newDoc));  
  }
};

<span class="hljs-comment">/**
 * If one insertion fails (e.g. because of a unique constraint), roll back all previous
 * inserts and throws the error
 * @api private
 */</span>
Datastore.prototype._insertMultipleDocsInCache = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newDocs)</span> </span>{
  <span class="hljs-keyword">var</span> i, failingI, error
    , preparedDocs = <span class="hljs-keyword">this</span>.prepareDocumentForInsertion(newDocs)
    ;
  
  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; preparedDocs.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">this</span>.addToIndexes(preparedDocs[i]);
    } <span class="hljs-keyword">catch</span> (e) {
      error = e;
      failingI = i;
      <span class="hljs-keyword">break</span>;
    }
  }
  
  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; failingI; i += <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">this</span>.removeFromIndexes(preparedDocs[i]);
    }
    
    <span class="hljs-keyword">throw</span> error;
  }
};

Datastore.prototype.insert = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.executor.push({ <span class="hljs-keyword">this</span>: <span class="hljs-keyword">this</span>, fn: <span class="hljs-keyword">this</span>._insert, <span class="hljs-built_in">arguments</span>: <span class="hljs-built_in">arguments</span> });
};


<span class="hljs-comment">/**
 * Count all documents matching the query
 * @param {Object} query MongoDB-style query
 */</span>
Datastore.prototype.count = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(query, callback)</span> </span>{
  <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(<span class="hljs-keyword">this</span>, query, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, docs, callback)</span> </span>{
    <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> callback(err); }
    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, docs.length);
  });

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span>) {
    cursor.exec(callback);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> cursor;
  }
};


<span class="hljs-comment">/**
 * Find all documents matching the query
 * If no callback is passed, we return the cursor so that user can limit, skip and finally exec
 * @param {Object} query MongoDB-style query
 */</span>
Datastore.prototype.find = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(query, callback)</span> </span>{
  <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(<span class="hljs-keyword">this</span>, query, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, docs, callback)</span> </span>{
    <span class="hljs-keyword">var</span> res = [], i;
  
    <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> callback(err); }
    
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; docs.length; i += <span class="hljs-number">1</span>) {
      res.push(model.deepCopy(docs[i]));
    }
    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, res);
  });

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span>) {
    cursor.exec(callback);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> cursor;
  }
};


<span class="hljs-comment">/**
 * Find one document matching the query
 * @param {Object} query MongoDB-style query
 */</span>
Datastore.prototype.findOne = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(query, callback)</span> </span>{
  <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(<span class="hljs-keyword">this</span>, query, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, docs, callback)</span> </span>{
    <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> callback(err); }
    <span class="hljs-keyword">if</span> (docs.length === <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, model.deepCopy(docs[<span class="hljs-number">0</span>]));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);    
    }
  });

  cursor.limit(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span>) {
    cursor.exec(callback);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> cursor;
  }
};


<span class="hljs-comment">/**
 * Update all docs matching query
 * For now, very naive implementation (recalculating the whole database)
 * @param {Object} query
 * @param {Object} updateQuery
 * @param {Object} options Optional options
 *                 options.multi If true, can update multiple documents (defaults to false)
 *                 options.upsert If true, document is inserted if the query doesn't match anything
 * @param {Function} cb Optional callback, signature: err, numReplaced, upsert (set to true if the update was in fact an upsert)
 *
 * @api private Use Datastore.update which has the same signature
 */</span>
Datastore.prototype._update = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(query, updateQuery, options, cb)</span> </span>{
  <span class="hljs-keyword">var</span> callback
    , self = <span class="hljs-keyword">this</span>
    , numReplaced = <span class="hljs-number">0</span>
    , multi, upsert
    , i
    ;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'function'</span>) { cb = options; options = {}; }
  callback = cb || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
  multi = options.multi !== <span class="hljs-literal">undefined</span> ? options.multi : <span class="hljs-literal">false</span>;
  upsert = options.upsert !== <span class="hljs-literal">undefined</span> ? options.upsert : <span class="hljs-literal">false</span>;

  async.waterfall([
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{   <span class="hljs-comment">// If upsert option is set, check whether we need to insert the doc</span>
    <span class="hljs-keyword">if</span> (!upsert) { <span class="hljs-keyword">return</span> cb(); }</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Need to use an internal function not tied to the executor to avoid deadlock</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> cursor = <span class="hljs-keyword">new</span> Cursor(self, query);
    cursor.limit(<span class="hljs-number">1</span>)._exec(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, docs)</span> </span>{
      <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> callback(err); }
      <span class="hljs-keyword">if</span> (docs.length === <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> cb();
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> self._insert(model.modify(query, updateQuery), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, newDoc)</span> </span>{
          <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> callback(err); }
          <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, <span class="hljs-number">1</span>, newDoc);
        });
      }
    });
  }
  , <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{   <span class="hljs-comment">// Perform the update</span>
    <span class="hljs-keyword">var</span> modifiedDoc
	  , candidates = self.getCandidates(query)
	  , modifications = []
	  ;</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Preparing update (if an error is thrown here neither the datafile nor
the in-memory indexes are affected)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; candidates.length; i += <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">if</span> (model.match(candidates[i], query) &amp;&amp; (multi || numReplaced === <span class="hljs-number">0</span>)) {
          numReplaced += <span class="hljs-number">1</span>;
          modifiedDoc = model.modify(candidates[i], updateQuery);
          modifications.push({ oldDoc: candidates[i], newDoc: modifiedDoc });
        }
      }
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-keyword">return</span> callback(err);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Change the docs in memory</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">try</span> {
      self.updateIndexes(modifications);
	} <span class="hljs-keyword">catch</span> (err) {
	  <span class="hljs-keyword">return</span> callback(err);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Update the datafile</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.persistence.persistNewState(_.pluck(modifications, <span class="hljs-string">'newDoc'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
      <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> callback(err); }
      <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, numReplaced);
    });
  }
  ]);
};
Datastore.prototype.update = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.executor.push({ <span class="hljs-keyword">this</span>: <span class="hljs-keyword">this</span>, fn: <span class="hljs-keyword">this</span>._update, <span class="hljs-built_in">arguments</span>: <span class="hljs-built_in">arguments</span> });
};


<span class="hljs-comment">/**
 * Remove all docs matching the query
 * For now very naive implementation (similar to update)
 * @param {Object} query
 * @param {Object} options Optional options
 *                 options.multi If true, can update multiple documents (defaults to false)
 * @param {Function} cb Optional callback, signature: err, numRemoved
 *
 * @api private Use Datastore.remove which has the same signature
 */</span>
Datastore.prototype._remove = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(query, options, cb)</span> </span>{
  <span class="hljs-keyword">var</span> callback
    , self = <span class="hljs-keyword">this</span>
    , numRemoved = <span class="hljs-number">0</span>
    , multi
    , removedDocs = []
    , candidates = <span class="hljs-keyword">this</span>.getCandidates(query)
    ;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'function'</span>) { cb = options; options = {}; }
  callback = cb || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
  multi = options.multi !== <span class="hljs-literal">undefined</span> ? options.multi : <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">try</span> {
    candidates.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
      <span class="hljs-keyword">if</span> (model.match(d, query) &amp;&amp; (multi || numRemoved === <span class="hljs-number">0</span>)) {
        numRemoved += <span class="hljs-number">1</span>;
        removedDocs.push({ $$deleted: <span class="hljs-literal">true</span>, _id: d._id });
        self.removeFromIndexes(d);
      }
    });
  } <span class="hljs-keyword">catch</span> (err) { <span class="hljs-keyword">return</span> callback(err); }

  self.persistence.persistNewState(removedDocs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
    <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> callback(err); }
    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, numRemoved);
  });
};
Datastore.prototype.remove = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.executor.push({ <span class="hljs-keyword">this</span>: <span class="hljs-keyword">this</span>, fn: <span class="hljs-keyword">this</span>._remove, <span class="hljs-built_in">arguments</span>: <span class="hljs-built_in">arguments</span> });
};



<span class="hljs-built_in">module</span>.exports = Datastore;

},{<span class="hljs-string">"./cursor"</span>:<span class="hljs-number">4</span>,<span class="hljs-string">"./customUtils"</span>:<span class="hljs-number">5</span>,<span class="hljs-string">"./executor"</span>:<span class="hljs-number">7</span>,<span class="hljs-string">"./indexes"</span>:<span class="hljs-number">8</span>,<span class="hljs-string">"./model"</span>:<span class="hljs-number">9</span>,<span class="hljs-string">"./persistence"</span>:<span class="hljs-number">10</span>,<span class="hljs-string">"async"</span>:<span class="hljs-number">11</span>,<span class="hljs-string">"underscore"</span>:<span class="hljs-number">16</span>,<span class="hljs-string">"util"</span>:<span class="hljs-number">2</span>}],<span class="hljs-number">7</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{
<span class="hljs-keyword">var</span> process=<span class="hljs-built_in">require</span>(<span class="hljs-string">"__browserify_process"</span>);<span class="hljs-comment">/**
 * Responsible for sequentially executing actions on the database
 */</span>

<span class="hljs-keyword">var</span> async = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)
  ;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Executor</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.buffer = [];
  <span class="hljs-keyword">this</span>.ready = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>This queue will execute all commands, one-by-one in order</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.queue = async.queue(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(task, cb)</span> </span>{
    <span class="hljs-keyword">var</span> callback
      , lastArg = task.arguments[task.arguments.length - <span class="hljs-number">1</span>]
      , i, newArguments = []
      ;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>task.arguments is an array-like object on which adding a new field doesn’t work, so we transform it into a real array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; task.arguments.length; i += <span class="hljs-number">1</span>) { newArguments.push(task.arguments[i]); }</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Always tell the queue task is complete. Execute callback if any was given.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> lastArg === <span class="hljs-string">'function'</span>) {
      callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        process.nextTick(cb);
        lastArg.apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
      };

      newArguments[newArguments.length - <span class="hljs-number">1</span>] = callback;
    } <span class="hljs-keyword">else</span> {
      callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ cb(); };
      newArguments.push(callback);
    }


    task.fn.apply(task.this, newArguments);
  }, <span class="hljs-number">1</span>);
}


<span class="hljs-comment">/**
 * If executor is ready, queue task (and process it immediately if executor was idle)
 * If not, buffer task for later processing
 * @param {Object} task
 *                 task.this - Object to use as this
 *                 task.fn - Function to execute
 *                 task.arguments - Array of arguments
 * @param {Boolean} forceQueuing Optional (defaults to false) force executor to queue task even if it is not ready
 */</span>
Executor.prototype.push = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(task, forceQueuing)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.ready || forceQueuing) {
    <span class="hljs-keyword">this</span>.queue.push(task);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.buffer.push(task);
  }
};


<span class="hljs-comment">/**
 * Queue all tasks in buffer (in the same order they came in)
 * Automatically sets executor as ready
 */</span>
Executor.prototype.processBuffer = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> i;
  <span class="hljs-keyword">this</span>.ready = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.buffer.length; i += <span class="hljs-number">1</span>) { <span class="hljs-keyword">this</span>.queue.push(<span class="hljs-keyword">this</span>.buffer[i]); }
  <span class="hljs-keyword">this</span>.buffer = [];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = Executor;

},{<span class="hljs-string">"__browserify_process"</span>:<span class="hljs-number">3</span>,<span class="hljs-string">"async"</span>:<span class="hljs-number">11</span>}],<span class="hljs-number">8</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{
<span class="hljs-keyword">var</span> BinarySearchTree = <span class="hljs-built_in">require</span>(<span class="hljs-string">'binary-search-tree'</span>).AVLTree
  , model = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./model'</span>)
  , _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
  , util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
  ;

<span class="hljs-comment">/**
 * Two indexed pointers are equal iif they point to the same place
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkValueEquality</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> a === b;
}

<span class="hljs-comment">/**
 * Type-aware projection
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">projectForUnique</span> <span class="hljs-params">(elt)</span> </span>{
  <span class="hljs-keyword">if</span> (elt === <span class="hljs-literal">null</span>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'$null'</span>; }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> elt === <span class="hljs-string">'string'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'$string'</span> + elt; }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> elt === <span class="hljs-string">'boolean'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'$boolean'</span> + elt; }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> elt === <span class="hljs-string">'number'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'$number'</span> + elt; }
  <span class="hljs-keyword">if</span> (util.isArray(elt)) { <span class="hljs-keyword">return</span> <span class="hljs-string">'$date'</span> + elt.getTime(); }
  
  <span class="hljs-keyword">return</span> elt;   <span class="hljs-comment">// Arrays and objects, will check for pointer equality</span>
}


<span class="hljs-comment">/**
 * Create a new index
 * All methods on an index guarantee that either the whole operation was successful and the index changed
 * or the operation was unsuccessful and an error is thrown while the index is unchanged
 * @param {String} options.fieldName On which field should the index apply (can use dot notation to index on sub fields)
 * @param {Boolean} options.unique Optional, enforce a unique constraint (default: false)
 * @param {Boolean} options.sparse Optional, allow a sparse index (we can have documents for which fieldName is undefined) (default: false)
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Index</span> <span class="hljs-params">(options)</span> </span>{
  <span class="hljs-keyword">this</span>.fieldName = options.fieldName;
  <span class="hljs-keyword">this</span>.unique = options.unique || <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">this</span>.sparse = options.sparse || <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">this</span>.treeOptions = { unique: <span class="hljs-keyword">this</span>.unique, compareKeys: model.compareThings, checkValueEquality: checkValueEquality };

  <span class="hljs-keyword">this</span>.reset();   <span class="hljs-comment">// No data in the beginning</span>
}


<span class="hljs-comment">/**
 * Reset an index
 * @param {Document or Array of documents} newData Optional, data to initialize the index with
 *                                                 If an error is thrown during insertion, the index is not modified
 */</span>
Index.prototype.reset = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newData)</span> </span>{
  <span class="hljs-keyword">this</span>.tree = <span class="hljs-keyword">new</span> BinarySearchTree(<span class="hljs-keyword">this</span>.treeOptions);

  <span class="hljs-keyword">if</span> (newData) { <span class="hljs-keyword">this</span>.insert(newData); }
};


<span class="hljs-comment">/**
 * Insert a new document in the index
 * If an array is passed, we insert all its elements (if one insertion fails the index is not modified)
 * O(log(n))
 */</span>
Index.prototype.insert = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{
  <span class="hljs-keyword">var</span> key, self = <span class="hljs-keyword">this</span>
    , keys, i, failingI, error
    ;

  <span class="hljs-keyword">if</span> (util.isArray(doc)) { <span class="hljs-keyword">this</span>.insertMultipleDocs(doc); <span class="hljs-keyword">return</span>; }

  key = model.getDotValue(doc, <span class="hljs-keyword">this</span>.fieldName);</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>We don’t index documents that don’t contain the field if the index is sparse</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (key === <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-keyword">this</span>.sparse) { <span class="hljs-keyword">return</span>; }

  <span class="hljs-keyword">if</span> (!util.isArray(key)) {
    <span class="hljs-keyword">this</span>.tree.insert(key, doc);
  } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>If an insert fails due to a unique constraint, roll back all inserts before it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    keys = _.uniq(key, projectForUnique);

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; keys.length; i += <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">this</span>.tree.insert(keys[i], doc);
      } <span class="hljs-keyword">catch</span> (e) {
        error = e;
        failingI = i;
        <span class="hljs-keyword">break</span>;
      }
    }
    
    <span class="hljs-keyword">if</span> (error) {
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; failingI; i += <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">this</span>.tree.delete(keys[i], doc);
      }
      
      <span class="hljs-keyword">throw</span> error;
    }
  }
};


<span class="hljs-comment">/**
 * Insert an array of documents in the index
 * If a constraint is violated, the changes should be rolled back and an error thrown
 *
 * @API private
 */</span>
Index.prototype.insertMultipleDocs = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(docs)</span> </span>{
  <span class="hljs-keyword">var</span> i, error, failingI;

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; docs.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">this</span>.insert(docs[i]);
    } <span class="hljs-keyword">catch</span> (e) {
      error = e;
      failingI = i;
      <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; failingI; i += <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">this</span>.remove(docs[i]);
    }

    <span class="hljs-keyword">throw</span> error;
  }
};


<span class="hljs-comment">/**
 * Remove a document from the index
 * If an array is passed, we remove all its elements
 * The remove operation is safe with regards to the 'unique' constraint
 * O(log(n))
 */</span>
Index.prototype.remove = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(doc)</span> </span>{
  <span class="hljs-keyword">var</span> key, self = <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">if</span> (util.isArray(doc)) { doc.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{ self.remove(d); }); <span class="hljs-keyword">return</span>; }

  key = model.getDotValue(doc, <span class="hljs-keyword">this</span>.fieldName);

  <span class="hljs-keyword">if</span> (key === <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-keyword">this</span>.sparse) { <span class="hljs-keyword">return</span>; }

  <span class="hljs-keyword">if</span> (!util.isArray(key)) {
    <span class="hljs-keyword">this</span>.tree.delete(key, doc);
  } <span class="hljs-keyword">else</span> {
    _.uniq(key, projectForUnique).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(_key)</span> </span>{
      self.tree.delete(_key, doc);
    });
  }
};


<span class="hljs-comment">/**
 * Update a document in the index
 * If a constraint is violated, changes are rolled back and an error thrown
 * Naive implementation, still in O(log(n))
 */</span>
Index.prototype.update = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(oldDoc, newDoc)</span> </span>{
  <span class="hljs-keyword">if</span> (util.isArray(oldDoc)) { <span class="hljs-keyword">this</span>.updateMultipleDocs(oldDoc); <span class="hljs-keyword">return</span>; }

  <span class="hljs-keyword">this</span>.remove(oldDoc);

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">this</span>.insert(newDoc);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">this</span>.insert(oldDoc);
    <span class="hljs-keyword">throw</span> e;
  }
};


<span class="hljs-comment">/**
 * Update multiple documents in the index
 * If a constraint is violated, the changes need to be rolled back
 * and an error thrown
 * @param {Array of oldDoc, newDoc pairs} pairs
 *
 * @API private
 */</span>
Index.prototype.updateMultipleDocs = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(pairs)</span> </span>{
  <span class="hljs-keyword">var</span> i, failingI, error;

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; pairs.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">this</span>.remove(pairs[i].oldDoc);
  }

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; pairs.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">this</span>.insert(pairs[i].newDoc);
    } <span class="hljs-keyword">catch</span> (e) {
      error = e;
      failingI = i;
      <span class="hljs-keyword">break</span>;
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>If an error was raised, roll back changes in the inverse order</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; failingI; i += <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">this</span>.remove(pairs[i].newDoc);
    }

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; pairs.length; i += <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">this</span>.insert(pairs[i].oldDoc);
    }

    <span class="hljs-keyword">throw</span> error;
  }
};


<span class="hljs-comment">/**
 * Revert an update
 */</span>
Index.prototype.revertUpdate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(oldDoc, newDoc)</span> </span>{
  <span class="hljs-keyword">var</span> revert = [];

  <span class="hljs-keyword">if</span> (!util.isArray(oldDoc)) {
    <span class="hljs-keyword">this</span>.update(newDoc, oldDoc);
  } <span class="hljs-keyword">else</span> {
    oldDoc.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(pair)</span> </span>{
      revert.push({ oldDoc: pair.newDoc, newDoc: pair.oldDoc });
    });
    <span class="hljs-keyword">this</span>.update(revert);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Append all elements in toAppend to array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">append</span> <span class="hljs-params">(array, toAppend)</span> </span>{
  <span class="hljs-keyword">var</span> i;

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; toAppend.length; i += <span class="hljs-number">1</span>) {
    array.push(toAppend[i]);
  }
}


<span class="hljs-comment">/**
 * Get all documents in index whose key match value (if it is a Thing) or one of the elements of value (if it is an array of Things)
 * @param {Thing} value Value to match the key against
 * @return {Array of documents}
 */</span>
Index.prototype.getMatching = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
  <span class="hljs-keyword">var</span> res, self = <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">if</span> (!util.isArray(value)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.tree.search(value);
  } <span class="hljs-keyword">else</span> {
    res = [];
    value.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{ append(res, self.getMatching(v)); });
    <span class="hljs-keyword">return</span> res;
  }
};


<span class="hljs-comment">/**
 * Get all documents in index whose key is between bounds are they are defined by query
 * Documents are sorted by key
 * @param {Query} query
 * @return {Array of documents}
 */</span>
Index.prototype.getBetweenBounds = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(query)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.tree.betweenBounds(query);
};


<span class="hljs-comment">/**
 * Get all elements in the index
 * @return {Array of documents}
 */</span>
Index.prototype.getAll = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> res = [];

  <span class="hljs-keyword">this</span>.tree.executeOnEveryNode(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(node)</span> </span>{
    <span class="hljs-keyword">var</span> i;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; node.data.length; i += <span class="hljs-number">1</span>) {
      res.push(node.data[i]);
    }
  });

  <span class="hljs-keyword">return</span> res;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = Index;

},{<span class="hljs-string">"./model"</span>:<span class="hljs-number">9</span>,<span class="hljs-string">"binary-search-tree"</span>:<span class="hljs-number">12</span>,<span class="hljs-string">"underscore"</span>:<span class="hljs-number">16</span>,<span class="hljs-string">"util"</span>:<span class="hljs-number">2</span>}],<span class="hljs-number">9</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{
<span class="hljs-comment">/**
 * Handle models (i.e. docs)
 * Serialization/deserialization
 * Copying
 * Querying, update
 */</span>

<span class="hljs-keyword">var</span> dateToJSON = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> { $$date: <span class="hljs-keyword">this</span>.getTime() }; }
  , originalDateToJSON = <span class="hljs-built_in">Date</span>.prototype.toJSON
  , util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
  , _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
  , modifierFunctions = {}
  , lastStepModifierFunctions = {}
  , comparisonFunctions = {}
  , logicalOperators = {}
  , arrayComparisonFunctions = {}
  ;


<span class="hljs-comment">/**
 * Check a key, throw an error if the key is non valid
 * @param {String} k key
 * @param {Model} v value, needed to treat the Date edge case
 * Non-treatable edge cases here: if part of the object if of the form { $$date: number } or { $$deleted: true }
 * Its serialized-then-deserialized version it will transformed into a Date object
 * But you really need to want it to trigger such behaviour, even when warned not to use '$' at the beginning of the field names...
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkKey</span> <span class="hljs-params">(k, v)</span> </span>{
  <span class="hljs-keyword">if</span> (k[<span class="hljs-number">0</span>] === <span class="hljs-string">'$'</span> &amp;&amp; !(k === <span class="hljs-string">'$$date'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'number'</span>) &amp;&amp; !(k === <span class="hljs-string">'$$deleted'</span> &amp;&amp; v === <span class="hljs-literal">true</span>) &amp;&amp; !(k === <span class="hljs-string">'$$indexCreated'</span>) &amp;&amp; !(k === <span class="hljs-string">'$$indexRemoved'</span>)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Field names cannot begin with the $ character'</span>;
  }

  <span class="hljs-keyword">if</span> (k.indexOf(<span class="hljs-string">'.'</span>) !== -<span class="hljs-number">1</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Field names cannot contain a .'</span>;
  }
}


<span class="hljs-comment">/**
 * Check a DB object and throw an error if it's not valid
 * Works by applying the above checkKey function to all fields recursively
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkObject</span> <span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">if</span> (util.isArray(obj)) {
    obj.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> </span>{
      checkObject(o);
    });
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'object'</span> &amp;&amp; obj !== <span class="hljs-literal">null</span>) {
    <span class="hljs-built_in">Object</span>.keys(obj).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k)</span> </span>{
      checkKey(k, obj[k]);
      checkObject(obj[k]);
    });
  }
}


<span class="hljs-comment">/**
 * Serialize an object to be persisted to a one-line string
 * For serialization/deserialization, we use the native JSON parser and not eval or Function
 * That gives us less freedom but data entered in the database may come from users
 * so eval and the like are not safe
 * Accepted primitive types: Number, String, Boolean, Date, null
 * Accepted secondary types: Objects, Arrays
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serialize</span> <span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">var</span> res;</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Keep track of the fact that this is a Date object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">Date</span>.prototype.toJSON = dateToJSON;

  res = <span class="hljs-built_in">JSON</span>.stringify(obj, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k, v)</span> </span>{
    checkKey(k, v);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'number'</span> || <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'boolean'</span> || v === <span class="hljs-literal">null</span>) { <span class="hljs-keyword">return</span> v; }

    <span class="hljs-keyword">return</span> v;
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Return Date to its original state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">Date</span>.prototype.toJSON = originalDateToJSON;

  <span class="hljs-keyword">return</span> res;
}


<span class="hljs-comment">/**
 * From a one-line representation of an object generate by the serialize function
 * Return the object itself
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deserialize</span> <span class="hljs-params">(rawData)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(rawData, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k, v)</span> </span>{
    <span class="hljs-keyword">if</span> (k === <span class="hljs-string">'$$date'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(v); }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'number'</span> || <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'boolean'</span> || v === <span class="hljs-literal">null</span>) { <span class="hljs-keyword">return</span> v; }
    <span class="hljs-keyword">if</span> (v &amp;&amp; v.$$date) { <span class="hljs-keyword">return</span> v.$$date; }

    <span class="hljs-keyword">return</span> v;
  });
}


<span class="hljs-comment">/**
 * Deep copy a DB object
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deepCopy</span> <span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">var</span> res;

  <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'boolean'</span> ||
       <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'number'</span> ||
       <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'string'</span> ||
       obj === <span class="hljs-literal">null</span> ||
       (util.isDate(obj)) ) {
    <span class="hljs-keyword">return</span> obj;
  }

  <span class="hljs-keyword">if</span> (util.isArray(obj)) {
    res = [];
    obj.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> </span>{ res.push(o); });
    <span class="hljs-keyword">return</span> res;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'object'</span>) {
    res = {};
    <span class="hljs-built_in">Object</span>.keys(obj).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k)</span> </span>{
      res[k] = deepCopy(obj[k]);
    });
    <span class="hljs-keyword">return</span> res;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;   <span class="hljs-comment">// For now everything else is undefined. We should probably throw an error instead</span>
}


<span class="hljs-comment">/**
 * Tells if an object is a primitive type or a "real" object
 * Arrays are considered primitive
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isPrimitiveType</span> <span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">return</span> ( <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'boolean'</span> ||
       <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'number'</span> ||
       <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'string'</span> ||
       obj === <span class="hljs-literal">null</span> ||
       util.isDate(obj) ||
       util.isArray(obj));
}


<span class="hljs-comment">/**
 * Utility functions for comparing things
 * Assumes type checking was already done (a and b already have the same type)
 * compareNSB works for numbers, strings and booleans
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compareNSB</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">if</span> (a &lt; b) { <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (a &gt; b) { <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; }
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compareArrays</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">var</span> i, comp;

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">Math</span>.min(a.length, b.length); i += <span class="hljs-number">1</span>) {
    comp = compareThings(a[i], b[i]);

    <span class="hljs-keyword">if</span> (comp !== <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> comp; }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Common section was identical, longest one wins</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> compareNSB(a.length, b.length);
}


<span class="hljs-comment">/**
 * Compare { things U undefined }
 * Things are defined as any native types (string, number, boolean, null, date) and objects
 * We need to compare with undefined as it will be used in indexes
 * In the case of objects and arrays, we deep-compare
 * If two objects dont have the same type, the (arbitrary) type hierarchy is: undefined, null, number, strings, boolean, dates, arrays, objects
 * Return -1 if a &lt; b, 1 if a &gt; b and 0 if a = b (note that equality here is NOT the same as defined in areThingsEqual!)
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compareThings</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">var</span> aKeys, bKeys, comp, i;</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>undefined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (a === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">return</span> b === <span class="hljs-literal">undefined</span> ? <span class="hljs-number">0</span> : -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (b === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">return</span> a === <span class="hljs-literal">undefined</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (a === <span class="hljs-literal">null</span>) { <span class="hljs-keyword">return</span> b === <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (b === <span class="hljs-literal">null</span>) { <span class="hljs-keyword">return</span> a === <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Numbers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'number'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'number'</span> ? compareNSB(a, b) : -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'number'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'number'</span> ? compareNSB(a, b) : <span class="hljs-number">1</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Strings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'string'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'string'</span> ? compareNSB(a, b) : -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'string'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'string'</span> ? compareNSB(a, b) : <span class="hljs-number">1</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Booleans</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'boolean'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'boolean'</span> ? compareNSB(a, b) : -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'boolean'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'boolean'</span> ? compareNSB(a, b) : <span class="hljs-number">1</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Dates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (util.isDate(a)) { <span class="hljs-keyword">return</span> util.isDate(b) ? compareNSB(a.getTime(), b.getTime()) : -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (util.isDate(b)) { <span class="hljs-keyword">return</span> util.isDate(a) ? compareNSB(a.getTime(), b.getTime()) : <span class="hljs-number">1</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Arrays (first element is most significant and so on)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (util.isArray(a)) { <span class="hljs-keyword">return</span> util.isArray(b) ? compareArrays(a, b) : -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (util.isArray(b)) { <span class="hljs-keyword">return</span> util.isArray(a) ? compareArrays(a, b) : <span class="hljs-number">1</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  aKeys = <span class="hljs-built_in">Object</span>.keys(a).sort();
  bKeys = <span class="hljs-built_in">Object</span>.keys(b).sort();

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">Math</span>.min(aKeys.length, bKeys.length); i += <span class="hljs-number">1</span>) {
    comp = compareThings(a[aKeys[i]], b[bKeys[i]]);

    <span class="hljs-keyword">if</span> (comp !== <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> comp; }
  }

  <span class="hljs-keyword">return</span> compareNSB(aKeys.length, bKeys.length);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>==============================================================</p>
<h1 id="updating-documents">Updating documents</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/**
 * The signature of modifier functions is as follows
 * Their structure is always the same: recursively follow the dot notation while creating
 * the nested documents if needed, then apply the "last step modifier"
 * @param {Object} obj The model to modify
 * @param {String} field Can contain dots, in that case that means we will set a subfield recursively
 * @param {Model} value
 */</span>

<span class="hljs-comment">/**
 * Set a field to a new value
 */</span>
lastStepModifierFunctions.$set = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{
  obj[field] = value;
};


<span class="hljs-comment">/**
 * Unset a field
 */</span>
lastStepModifierFunctions.$unset = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{
  <span class="hljs-keyword">delete</span> obj[field];
};


<span class="hljs-comment">/**
 * Push an element to the end of an array field
 */</span>
lastStepModifierFunctions.$push = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Create the array if it doesn’t exist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!obj.hasOwnProperty(field)) { obj[field] = []; }

  <span class="hljs-keyword">if</span> (!util.isArray(obj[field])) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can't $push an element on non-array values"</span>; }

  <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span> &amp;&amp; value.$each) {
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(value).length &gt; <span class="hljs-number">1</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can't use another field in conjunction with $each"</span>; }
    <span class="hljs-keyword">if</span> (!util.isArray(value.$each)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$each requires an array value"</span>; }

    value.$each.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
      obj[field].push(v);
    });
  } <span class="hljs-keyword">else</span> {
    obj[field].push(value);
  }
};


<span class="hljs-comment">/**
 * Add an element to an array field only if it is not already in it
 * No modification if the element is already in the array
 * Note that it doesn't check whether the original array contains duplicates
 */</span>
lastStepModifierFunctions.$addToSet = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{
  <span class="hljs-keyword">var</span> addToSet = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Create the array if it doesn’t exist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!obj.hasOwnProperty(field)) { obj[field] = []; }

  <span class="hljs-keyword">if</span> (!util.isArray(obj[field])) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can't $addToSet an element on non-array values"</span>; }

  <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span> &amp;&amp; value.$each) {
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(value).length &gt; <span class="hljs-number">1</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can't use another field in conjunction with $each"</span>; }
    <span class="hljs-keyword">if</span> (!util.isArray(value.$each)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$each requires an array value"</span>; }

    value.$each.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
      lastStepModifierFunctions.$addToSet(obj, field, v);
    });
  } <span class="hljs-keyword">else</span> {
    obj[field].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
      <span class="hljs-keyword">if</span> (compareThings(v, value) === <span class="hljs-number">0</span>) { addToSet = <span class="hljs-literal">false</span>; }
    });
    <span class="hljs-keyword">if</span> (addToSet) { obj[field].push(value); }
  }
};


<span class="hljs-comment">/**
 * Remove the first or last element of an array
 */</span>
lastStepModifierFunctions.$pop = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{
  <span class="hljs-keyword">if</span> (!util.isArray(obj[field])) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can't $pop an element from non-array values"</span>; }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value !== <span class="hljs-string">'number'</span>) { <span class="hljs-keyword">throw</span> value + <span class="hljs-string">" isn't an integer, can't use it with $pop"</span>; }
  <span class="hljs-keyword">if</span> (value === <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span>; }

  <span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">0</span>) {
    obj[field] = obj[field].slice(<span class="hljs-number">0</span>, obj[field].length - <span class="hljs-number">1</span>);
  } <span class="hljs-keyword">else</span> {
    obj[field] = obj[field].slice(<span class="hljs-number">1</span>);
  }
};


<span class="hljs-comment">/**
 * Removes all instances of a value from an existing array
 */</span>
lastStepModifierFunctions.$pull = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{
  <span class="hljs-keyword">var</span> arr, i;
  
  <span class="hljs-keyword">if</span> (!util.isArray(obj[field])) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can't $pull an element from non-array values"</span>; }

  arr = obj[field];
  <span class="hljs-keyword">for</span> (i = arr.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i -= <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (match(arr[i], value)) {
      arr.splice(i, <span class="hljs-number">1</span>);
    }
  }
};


<span class="hljs-comment">/**
 * Increment a numeric field's value
 */</span>
lastStepModifierFunctions.$inc = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value !== <span class="hljs-string">'number'</span>) { <span class="hljs-keyword">throw</span> value + <span class="hljs-string">" must be a number"</span>; }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj[field] !== <span class="hljs-string">'number'</span>) {
    <span class="hljs-keyword">if</span> (!_.has(obj, field)) {
      obj[field] = value;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">"Don't use the $inc modifier on non-number fields"</span>;
    }
  } <span class="hljs-keyword">else</span> {
    obj[field] += value;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Given its name, create the complete modifier function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createModifierFunction</span> <span class="hljs-params">(modifier)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{
    <span class="hljs-keyword">var</span> fieldParts = <span class="hljs-keyword">typeof</span> field === <span class="hljs-string">'string'</span> ? field.split(<span class="hljs-string">'.'</span>) : field;

    <span class="hljs-keyword">if</span> (fieldParts.length === <span class="hljs-number">1</span>) {
      lastStepModifierFunctions[modifier](obj, field, value);
    } <span class="hljs-keyword">else</span> {
      obj[fieldParts[<span class="hljs-number">0</span>]] = obj[fieldParts[<span class="hljs-number">0</span>]] || {};
      modifierFunctions[modifier](obj[fieldParts[<span class="hljs-number">0</span>]], fieldParts.slice(<span class="hljs-number">1</span>), value);
    }
  };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Actually create all modifier functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">Object</span>.keys(lastStepModifierFunctions).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(modifier)</span> </span>{
  modifierFunctions[modifier] = createModifierFunction(modifier);
});


<span class="hljs-comment">/**
 * Modify a DB object according to an update query
 * For now the updateQuery only replaces the object
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">modify</span> <span class="hljs-params">(obj, updateQuery)</span> </span>{
  <span class="hljs-keyword">var</span> keys = <span class="hljs-built_in">Object</span>.keys(updateQuery)
    , firstChars = _.map(keys, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{ <span class="hljs-keyword">return</span> item[<span class="hljs-number">0</span>]; })
    , dollarFirstChars = _.filter(firstChars, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(c)</span> </span>{ <span class="hljs-keyword">return</span> c === <span class="hljs-string">'$'</span>; })
    , newDoc, modifiers
    ;

  <span class="hljs-keyword">if</span> (keys.indexOf(<span class="hljs-string">'_id'</span>) !== -<span class="hljs-number">1</span> &amp;&amp; updateQuery._id !== obj._id) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"You cannot change a document's _id"</span>; }

  <span class="hljs-keyword">if</span> (dollarFirstChars.length !== <span class="hljs-number">0</span> &amp;&amp; dollarFirstChars.length !== firstChars.length) {
    <span class="hljs-keyword">throw</span> <span class="hljs-string">"You cannot mix modifiers and normal fields"</span>;
  }

  <span class="hljs-keyword">if</span> (dollarFirstChars.length === <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Simply replace the object with the update query contents</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    newDoc = deepCopy(updateQuery);
    newDoc._id = obj._id;
  } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Apply modifiers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    modifiers = _.uniq(keys);
    newDoc = deepCopy(obj);
    modifiers.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(m)</span> </span>{
      <span class="hljs-keyword">var</span> keys;

      <span class="hljs-keyword">if</span> (!modifierFunctions[m]) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Unknown modifier "</span> + m; }

      <span class="hljs-keyword">try</span> {
        keys = <span class="hljs-built_in">Object</span>.keys(updateQuery[m]);
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">"Modifier "</span> + m + <span class="hljs-string">"'s argument must be an object"</span>;
      }

      keys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k)</span> </span>{
        modifierFunctions[m](newDoc, k, updateQuery[m][k]);
      });
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Check result is valid and return it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  checkObject(newDoc);
  <span class="hljs-keyword">if</span> (obj._id !== newDoc._id) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"You can't change a document's _id"</span>; }
  <span class="hljs-keyword">return</span> newDoc;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>==============================================================</p>
<h1 id="finding-documents">Finding documents</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/**
 * Get a value from object with dot notation
 * @param {Object} obj
 * @param {String} field
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDotValue</span> <span class="hljs-params">(obj, field)</span> </span>{
  <span class="hljs-keyword">var</span> fieldParts = <span class="hljs-keyword">typeof</span> field === <span class="hljs-string">'string'</span> ? field.split(<span class="hljs-string">'.'</span>) : field
    , i, objs;

  <span class="hljs-keyword">if</span> (!obj) { <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>; }   <span class="hljs-comment">// field cannot be empty so that means we should return undefined so that nothing can match</span>

  <span class="hljs-keyword">if</span> (fieldParts.length === <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> obj; }

  <span class="hljs-keyword">if</span> (fieldParts.length === <span class="hljs-number">1</span>) { <span class="hljs-keyword">return</span> obj[fieldParts[<span class="hljs-number">0</span>]]; }
  
  <span class="hljs-keyword">if</span> (util.isArray(obj[fieldParts[<span class="hljs-number">0</span>]])) {</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>If the next field is an integer, return only this item of the array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    i = <span class="hljs-built_in">parseInt</span>(fieldParts[<span class="hljs-number">1</span>], <span class="hljs-number">10</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> i === <span class="hljs-string">'number'</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(i)) {
      <span class="hljs-keyword">return</span> getDotValue(obj[fieldParts[<span class="hljs-number">0</span>]][i], fieldParts.slice(<span class="hljs-number">2</span>))
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Return the array of values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    objs = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>();
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; obj[fieldParts[<span class="hljs-number">0</span>]].length; i += <span class="hljs-number">1</span>) {
       objs.push(getDotValue(obj[fieldParts[<span class="hljs-number">0</span>]][i], fieldParts.slice(<span class="hljs-number">1</span>)));
    }
    <span class="hljs-keyword">return</span> objs;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> getDotValue(obj[fieldParts[<span class="hljs-number">0</span>]], fieldParts.slice(<span class="hljs-number">1</span>));
  }
}


<span class="hljs-comment">/**
 * Check whether 'things' are equal
 * Things are defined as any native types (string, number, boolean, null, date) and objects
 * In the case of object, we check deep equality
 * Returns true if they are, false otherwise
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">areThingsEqual</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">var</span> aKeys , bKeys , i;</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Strings, booleans, numbers, null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (a === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'boolean'</span> || <span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'number'</span> ||
      b === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'boolean'</span> || <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'number'</span>) { <span class="hljs-keyword">return</span> a === b; }</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Dates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (util.isDate(a) || util.isDate(b)) { <span class="hljs-keyword">return</span> util.isDate(a) &amp;&amp; util.isDate(b) &amp;&amp; a.getTime() === b.getTime(); }</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Arrays (no match since arrays are used as a $in)
undefined (no match since they mean field doesn’t exist and can’t be serialized)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (util.isArray(a) || util.isArray(b) || a === <span class="hljs-literal">undefined</span> || b === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>General objects (check for deep equality)
a and b should be objects at this point</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">try</span> {
    aKeys = <span class="hljs-built_in">Object</span>.keys(a);
    bKeys = <span class="hljs-built_in">Object</span>.keys(b);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> (aKeys.length !== bKeys.length) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; aKeys.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (bKeys.indexOf(aKeys[i]) === -<span class="hljs-number">1</span>) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
    <span class="hljs-keyword">if</span> (!areThingsEqual(a[aKeys[i]], b[aKeys[i]])) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}


<span class="hljs-comment">/**
 * Check that two values are comparable
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">areComparable</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a !== <span class="hljs-string">'string'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> a !== <span class="hljs-string">'number'</span> &amp;&amp; !util.isDate(a) &amp;&amp;
      <span class="hljs-keyword">typeof</span> b !== <span class="hljs-string">'string'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> b !== <span class="hljs-string">'number'</span> &amp;&amp; !util.isDate(b)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a !== <span class="hljs-keyword">typeof</span> b) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}


<span class="hljs-comment">/**
 * Arithmetic and comparison operators
 * @param {Native value} a Value in the object
 * @param {Native value} b Value in the query
 */</span>
comparisonFunctions.$lt = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> areComparable(a, b) &amp;&amp; a &lt; b;
};

comparisonFunctions.$lte = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> areComparable(a, b) &amp;&amp; a &lt;= b;
};

comparisonFunctions.$gt = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> areComparable(a, b) &amp;&amp; a &gt; b;
};

comparisonFunctions.$gte = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> areComparable(a, b) &amp;&amp; a &gt;= b;
};

comparisonFunctions.$ne = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">if</span> (!a) { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }
  <span class="hljs-keyword">return</span> !areThingsEqual(a, b);
};

comparisonFunctions.$<span class="hljs-keyword">in</span> = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">var</span> i;

  <span class="hljs-keyword">if</span> (!util.isArray(b)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$in operator called with a non-array"</span>; }

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; b.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (areThingsEqual(a, b[i])) { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

comparisonFunctions.$nin = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">if</span> (!util.isArray(b)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$nin operator called with a non-array"</span>; }

  <span class="hljs-keyword">return</span> !comparisonFunctions.$<span class="hljs-keyword">in</span>(a, b);
};

comparisonFunctions.$regex = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">if</span> (!util.isRegExp(b)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$regex operator called with non regular expression"</span>; }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a !== <span class="hljs-string">'string'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> b.test(a);
  }
};

comparisonFunctions.$exists = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, exists)</span> </span>{
  <span class="hljs-keyword">if</span> (exists || exists === <span class="hljs-string">''</span>) {   <span class="hljs-comment">// This will be true for all values of exists except false, null, undefined and 0</span>
    exists = <span class="hljs-literal">true</span>;                 <span class="hljs-comment">// That's strange behaviour (we should only use true/false) but that's the way Mongo does it...</span>
  } <span class="hljs-keyword">else</span> {
    exists = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">return</span> !exists
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> exists;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Specific to arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>comparisonFunctions.$size = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, value)</span> </span>{
    <span class="hljs-keyword">if</span> (!util.isArray(obj)) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
    <span class="hljs-keyword">if</span> (value % <span class="hljs-number">1</span> !== <span class="hljs-number">0</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$size operator called without an integer"</span>; }

    <span class="hljs-keyword">return</span> (obj.length == value);
};
arrayComparisonFunctions.$size = <span class="hljs-literal">true</span>;


<span class="hljs-comment">/**
 * Match any of the subqueries
 * @param {Model} obj
 * @param {Array of Queries} query
 */</span>
logicalOperators.$or = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, query)</span> </span>{
  <span class="hljs-keyword">var</span> i;

  <span class="hljs-keyword">if</span> (!util.isArray(query)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$or operator used without an array"</span>; }

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; query.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (match(obj, query[i])) { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};


<span class="hljs-comment">/**
 * Match all of the subqueries
 * @param {Model} obj
 * @param {Array of Queries} query
 */</span>
logicalOperators.$and = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, query)</span> </span>{
  <span class="hljs-keyword">var</span> i;

  <span class="hljs-keyword">if</span> (!util.isArray(query)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$and operator used without an array"</span>; }

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; query.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (!match(obj, query[i])) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};


<span class="hljs-comment">/**
 * Inverted match of the query
 * @param {Model} obj
 * @param {Query} query
 */</span>
logicalOperators.$not = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, query)</span> </span>{
  <span class="hljs-keyword">return</span> !match(obj, query);
};


<span class="hljs-comment">/**
 * Use a function to match
 * @param {Model} obj
 * @param {Query} query
 */</span>
logicalOperators.$where = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, fn)</span> </span>{
  <span class="hljs-keyword">var</span> result;

  <span class="hljs-keyword">if</span> (!_.isFunction(fn)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$where operator used without a function"</span>; }

  result = fn.call(obj);
  <span class="hljs-keyword">if</span> (!_.isBoolean(result)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$where function must return boolean"</span>; }

  <span class="hljs-keyword">return</span> result;
};


<span class="hljs-comment">/**
 * Tell if a given document matches a query
 * @param {Object} obj Document to check
 * @param {Object} query
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">match</span> <span class="hljs-params">(obj, query)</span> </span>{
  <span class="hljs-keyword">var</span> queryKeys, queryKey, queryValue, i;</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Primitive query against a primitive type
This is a bit of a hack since we construct an object with an arbitrary key only to dereference it later
But I don’t have time for a cleaner implementation now</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (isPrimitiveType(obj) || isPrimitiveType(query)) {
    <span class="hljs-keyword">return</span> matchQueryPart({ needAKey: obj }, <span class="hljs-string">'needAKey'</span>, query);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Normal query</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  queryKeys = <span class="hljs-built_in">Object</span>.keys(query);
  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; queryKeys.length; i += <span class="hljs-number">1</span>) {
    queryKey = queryKeys[i];
    queryValue = query[queryKey];
  
    <span class="hljs-keyword">if</span> (queryKey[<span class="hljs-number">0</span>] === <span class="hljs-string">'$'</span>) {
      <span class="hljs-keyword">if</span> (!logicalOperators[queryKey]) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Unknown logical operator "</span> + queryKey; }
      <span class="hljs-keyword">if</span> (!logicalOperators[queryKey](obj, queryValue)) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (!matchQueryPart(obj, queryKey, queryValue)) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};


<span class="hljs-comment">/**
 * Match an object against a specific { key: value } part of a query
 * if the treatObjAsValue flag is set, don't try to match every part separately, but the array as a whole
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">matchQueryPart</span> <span class="hljs-params">(obj, queryKey, queryValue, treatObjAsValue)</span> </span>{
  <span class="hljs-keyword">var</span> objValue = getDotValue(obj, queryKey)
    , i, keys, firstChars, dollarFirstChars;</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Check if the value is an array if we don’t force a treatment as value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (util.isArray(objValue) &amp;&amp; !treatObjAsValue) {</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Check if we are using an array-specific comparison function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (queryValue !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> queryValue === <span class="hljs-string">'object'</span> &amp;&amp; !util.isRegExp(queryValue)) {
      keys = <span class="hljs-built_in">Object</span>.keys(queryValue);      
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; keys.length; i += <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">if</span> (arrayComparisonFunctions[keys[i]]) { <span class="hljs-keyword">return</span> matchQueryPart(obj, queryKey, queryValue, <span class="hljs-literal">true</span>); }
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>If not, treat it as an array of { obj, query } where there needs to be at least one match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; objValue.length; i += <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">if</span> (matchQueryPart({ k: objValue[i] }, <span class="hljs-string">'k'</span>, queryValue)) { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }   <span class="hljs-comment">// k here could be any string</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>queryValue is an actual object. Determine whether it contains comparison operators
or only normal fields. Mixed objects are not allowed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (queryValue !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> queryValue === <span class="hljs-string">'object'</span> &amp;&amp; !util.isRegExp(queryValue)) {
    keys = <span class="hljs-built_in">Object</span>.keys(queryValue);
    firstChars = _.map(keys, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{ <span class="hljs-keyword">return</span> item[<span class="hljs-number">0</span>]; });
    dollarFirstChars = _.filter(firstChars, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(c)</span> </span>{ <span class="hljs-keyword">return</span> c === <span class="hljs-string">'$'</span>; });

    <span class="hljs-keyword">if</span> (dollarFirstChars.length !== <span class="hljs-number">0</span> &amp;&amp; dollarFirstChars.length !== firstChars.length) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">"You cannot mix operators and normal fields"</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>queryValue is an object of this form: { $comparisonOperator1: value1, … }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (dollarFirstChars.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; keys.length; i += <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">if</span> (!comparisonFunctions[keys[i]]) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Unknown comparison function "</span> + keys[i]; }

        <span class="hljs-keyword">if</span> (!comparisonFunctions[keys[i]](objValue, queryValue[keys[i]])) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Using regular expressions with basic querying</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (util.isRegExp(queryValue)) { <span class="hljs-keyword">return</span> comparisonFunctions.$regex(objValue, queryValue); }</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>queryValue is either a native value or a normal object
Basic matching is possible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!areThingsEqual(objValue, queryValue)) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports.serialize = serialize;
<span class="hljs-built_in">module</span>.exports.deserialize = deserialize;
<span class="hljs-built_in">module</span>.exports.deepCopy = deepCopy;
<span class="hljs-built_in">module</span>.exports.checkObject = checkObject;
<span class="hljs-built_in">module</span>.exports.isPrimitiveType = isPrimitiveType;
<span class="hljs-built_in">module</span>.exports.modify = modify;
<span class="hljs-built_in">module</span>.exports.getDotValue = getDotValue;
<span class="hljs-built_in">module</span>.exports.match = match;
<span class="hljs-built_in">module</span>.exports.areThingsEqual = areThingsEqual;
<span class="hljs-built_in">module</span>.exports.compareThings = compareThings;

},{<span class="hljs-string">"underscore"</span>:<span class="hljs-number">16</span>,<span class="hljs-string">"util"</span>:<span class="hljs-number">2</span>}],<span class="hljs-number">10</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{
<span class="hljs-comment">/**
 * Handle every persistence-related task
 * The interface Datastore expects to be implemented is
 * * Persistence.loadDatabase(callback) and callback has signature err
 * * Persistence.persistNewState(newDocs, callback) where newDocs is an array of documents and callback has signature err
 *
 * Shim for the browser
 */</span>

<span class="hljs-comment">/**
 * Create a new Persistence object for database options.db
 * For now, no browser persistence supported, in-memory only mode forced
 * @param {Datastore} options.db
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Persistence</span> <span class="hljs-params">(options)</span> </span>{
  <span class="hljs-keyword">this</span>.db = options.db;
  <span class="hljs-keyword">this</span>.db.inMemoryOnly = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">this</span>.db.filename = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">this</span>.inMemoryOnly = <span class="hljs-literal">true</span>;
};


<span class="hljs-comment">/**
 * No persistence in the browser (for now)
 */</span>
Persistence.prototype.persistNewState = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newDocs, cb)</span> </span>{
  <span class="hljs-keyword">if</span> (cb) { <span class="hljs-keyword">return</span> cb(); }
};


<span class="hljs-comment">/**
 * No persistence in the browser (for now)
 */</span>
Persistence.prototype.loadDatabase = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> </span>{
  <span class="hljs-keyword">if</span> (cb) { <span class="hljs-keyword">return</span> cb(); }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = Persistence;

},{}],<span class="hljs-number">11</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{
<span class="hljs-keyword">var</span> process=<span class="hljs-built_in">require</span>(<span class="hljs-string">"__browserify_process"</span>);<span class="hljs-comment">/*global setImmediate: false, setTimeout: false, console: false */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">var</span> async = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>global on the server, window in the browser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> root, previous_async;

    root = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">if</span> (root != <span class="hljs-literal">null</span>) {
      previous_async = root.async;
    }

    async.noConflict = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        root.async = previous_async;
        <span class="hljs-keyword">return</span> async;
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">only_once</span><span class="hljs-params">(fn)</span> </span>{
        <span class="hljs-keyword">var</span> called = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Callback was already called."</span>);
            called = <span class="hljs-literal">true</span>;
            fn.apply(root, <span class="hljs-built_in">arguments</span>);
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>// cross-browser compatiblity functions ////</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">var</span> _each = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator)</span> </span>{
        <span class="hljs-keyword">if</span> (arr.forEach) {
            <span class="hljs-keyword">return</span> arr.forEach(iterator);
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; arr.length; i += <span class="hljs-number">1</span>) {
            iterator(arr[i], i, arr);
        }
    };

    <span class="hljs-keyword">var</span> _map = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator)</span> </span>{
        <span class="hljs-keyword">if</span> (arr.map) {
            <span class="hljs-keyword">return</span> arr.map(iterator);
        }
        <span class="hljs-keyword">var</span> results = [];
        _each(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, i, a)</span> </span>{
            results.push(iterator(x, i, a));
        });
        <span class="hljs-keyword">return</span> results;
    };

    <span class="hljs-keyword">var</span> _reduce = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator, memo)</span> </span>{
        <span class="hljs-keyword">if</span> (arr.reduce) {
            <span class="hljs-keyword">return</span> arr.reduce(iterator, memo);
        }
        _each(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, i, a)</span> </span>{
            memo = iterator(memo, x, i, a);
        });
        <span class="hljs-keyword">return</span> memo;
    };

    <span class="hljs-keyword">var</span> _keys = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys) {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(obj);
        }
        <span class="hljs-keyword">var</span> keys = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> obj) {
            <span class="hljs-keyword">if</span> (obj.hasOwnProperty(k)) {
                keys.push(k);
            }
        }
        <span class="hljs-keyword">return</span> keys;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>// exported async module functions ////</p>

            </div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>// nextTick implementation with browser-compatible fallback ////</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> process === <span class="hljs-string">'undefined'</span> || !(process.nextTick)) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> setImmediate === <span class="hljs-string">'function'</span>) {
            async.nextTick = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>not a direct alias for IE10 compatibility</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                setImmediate(fn);
            };
            async.setImmediate = async.nextTick;
        }
        <span class="hljs-keyword">else</span> {
            async.nextTick = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
                setTimeout(fn, <span class="hljs-number">0</span>);
            };
            async.setImmediate = async.nextTick;
        }
    }
    <span class="hljs-keyword">else</span> {
        async.nextTick = process.nextTick;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> setImmediate !== <span class="hljs-string">'undefined'</span>) {
            async.setImmediate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>not a direct alias for IE10 compatibility</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              setImmediate(fn);
            };
        }
        <span class="hljs-keyword">else</span> {
            async.setImmediate = async.nextTick;
        }
    }

    async.each = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator, callback)</span> </span>{
        callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
        <span class="hljs-keyword">if</span> (!arr.length) {
            <span class="hljs-keyword">return</span> callback();
        }
        <span class="hljs-keyword">var</span> completed = <span class="hljs-number">0</span>;
        _each(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
            iterator(x, only_once(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">if</span> (err) {
                    callback(err);
                    callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                }
                <span class="hljs-keyword">else</span> {
                    completed += <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">if</span> (completed &gt;= arr.length) {
                        callback(<span class="hljs-literal">null</span>);
                    }
                }
            }));
        });
    };
    async.forEach = async.each;

    async.eachSeries = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator, callback)</span> </span>{
        callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
        <span class="hljs-keyword">if</span> (!arr.length) {
            <span class="hljs-keyword">return</span> callback();
        }
        <span class="hljs-keyword">var</span> completed = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> iterate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            iterator(arr[completed], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">if</span> (err) {
                    callback(err);
                    callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                }
                <span class="hljs-keyword">else</span> {
                    completed += <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">if</span> (completed &gt;= arr.length) {
                        callback(<span class="hljs-literal">null</span>);
                    }
                    <span class="hljs-keyword">else</span> {
                        iterate();
                    }
                }
            });
        };
        iterate();
    };
    async.forEachSeries = async.eachSeries;

    async.eachLimit = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, limit, iterator, callback)</span> </span>{
        <span class="hljs-keyword">var</span> fn = _eachLimit(limit);
        fn.apply(<span class="hljs-literal">null</span>, [arr, iterator, callback]);
    };
    async.forEachLimit = async.eachLimit;

    <span class="hljs-keyword">var</span> _eachLimit = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(limit)</span> </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator, callback)</span> </span>{
            callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
            <span class="hljs-keyword">if</span> (!arr.length || limit &lt;= <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> callback();
            }
            <span class="hljs-keyword">var</span> completed = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">var</span> started = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">var</span> running = <span class="hljs-number">0</span>;

            (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">replenish</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">if</span> (completed &gt;= arr.length) {
                    <span class="hljs-keyword">return</span> callback();
                }

                <span class="hljs-keyword">while</span> (running &lt; limit &amp;&amp; started &lt; arr.length) {
                    started += <span class="hljs-number">1</span>;
                    running += <span class="hljs-number">1</span>;
                    iterator(arr[started - <span class="hljs-number">1</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                        <span class="hljs-keyword">if</span> (err) {
                            callback(err);
                            callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                        }
                        <span class="hljs-keyword">else</span> {
                            completed += <span class="hljs-number">1</span>;
                            running -= <span class="hljs-number">1</span>;
                            <span class="hljs-keyword">if</span> (completed &gt;= arr.length) {
                                callback();
                            }
                            <span class="hljs-keyword">else</span> {
                                replenish();
                            }
                        }
                    });
                }
            })();
        };
    };


    <span class="hljs-keyword">var</span> doParallel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">return</span> fn.apply(<span class="hljs-literal">null</span>, [async.each].concat(args));
        };
    };
    <span class="hljs-keyword">var</span> doParallelLimit = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(limit, fn)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">return</span> fn.apply(<span class="hljs-literal">null</span>, [_eachLimit(limit)].concat(args));
        };
    };
    <span class="hljs-keyword">var</span> doSeries = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">return</span> fn.apply(<span class="hljs-literal">null</span>, [async.eachSeries].concat(args));
        };
    };


    <span class="hljs-keyword">var</span> _asyncMap = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eachfn, arr, iterator, callback)</span> </span>{
        <span class="hljs-keyword">var</span> results = [];
        arr = _map(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, i)</span> </span>{
            <span class="hljs-keyword">return</span> {index: i, value: x};
        });
        eachfn(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(x.value, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, v)</span> </span>{
                results[x.index] = v;
                callback(err);
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            callback(err, results);
        });
    };
    async.map = doParallel(_asyncMap);
    async.mapSeries = doSeries(_asyncMap);
    async.mapLimit = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, limit, iterator, callback)</span> </span>{
        <span class="hljs-keyword">return</span> _mapLimit(limit)(arr, iterator, callback);
    };

    <span class="hljs-keyword">var</span> _mapLimit = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(limit)</span> </span>{
        <span class="hljs-keyword">return</span> doParallelLimit(limit, _asyncMap);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>reduce only has a series version, as doing reduce in parallel won’t
work in many situations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.reduce = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, memo, iterator, callback)</span> </span>{
        async.eachSeries(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(memo, x, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, v)</span> </span>{
                memo = v;
                callback(err);
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            callback(err, memo);
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>inject alias</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.inject = async.reduce;</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>foldl alias</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.foldl = async.reduce;

    async.reduceRight = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, memo, iterator, callback)</span> </span>{
        <span class="hljs-keyword">var</span> reversed = _map(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
            <span class="hljs-keyword">return</span> x;
        }).reverse();
        async.reduce(reversed, memo, iterator, callback);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>foldr alias</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.foldr = async.reduceRight;

    <span class="hljs-keyword">var</span> _filter = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eachfn, arr, iterator, callback)</span> </span>{
        <span class="hljs-keyword">var</span> results = [];
        arr = _map(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, i)</span> </span>{
            <span class="hljs-keyword">return</span> {index: i, value: x};
        });
        eachfn(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(x.value, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
                <span class="hljs-keyword">if</span> (v) {
                    results.push(x);
                }
                callback();
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            callback(_map(results.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
                <span class="hljs-keyword">return</span> a.index - b.index;
            }), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
                <span class="hljs-keyword">return</span> x.value;
            }));
        });
    };
    async.filter = doParallel(_filter);
    async.filterSeries = doSeries(_filter);</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>select alias</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.select = async.filter;
    async.selectSeries = async.filterSeries;

    <span class="hljs-keyword">var</span> _reject = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eachfn, arr, iterator, callback)</span> </span>{
        <span class="hljs-keyword">var</span> results = [];
        arr = _map(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, i)</span> </span>{
            <span class="hljs-keyword">return</span> {index: i, value: x};
        });
        eachfn(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(x.value, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
                <span class="hljs-keyword">if</span> (!v) {
                    results.push(x);
                }
                callback();
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            callback(_map(results.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
                <span class="hljs-keyword">return</span> a.index - b.index;
            }), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
                <span class="hljs-keyword">return</span> x.value;
            }));
        });
    };
    async.reject = doParallel(_reject);
    async.rejectSeries = doSeries(_reject);

    <span class="hljs-keyword">var</span> _detect = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eachfn, arr, iterator, main_callback)</span> </span>{
        eachfn(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(x, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(result)</span> </span>{
                <span class="hljs-keyword">if</span> (result) {
                    main_callback(x);
                    main_callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                }
                <span class="hljs-keyword">else</span> {
                    callback();
                }
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            main_callback();
        });
    };
    async.detect = doParallel(_detect);
    async.detectSeries = doSeries(_detect);

    async.some = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator, main_callback)</span> </span>{
        async.each(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(x, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
                <span class="hljs-keyword">if</span> (v) {
                    main_callback(<span class="hljs-literal">true</span>);
                    main_callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                }
                callback();
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            main_callback(<span class="hljs-literal">false</span>);
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>any alias</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.any = async.some;

    async.every = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator, main_callback)</span> </span>{
        async.each(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(x, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
                <span class="hljs-keyword">if</span> (!v) {
                    main_callback(<span class="hljs-literal">false</span>);
                    main_callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                }
                callback();
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            main_callback(<span class="hljs-literal">true</span>);
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>all alias</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    async.all = async.every;

    async.sortBy = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr, iterator, callback)</span> </span>{
        async.map(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, callback)</span> </span>{
            iterator(x, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, criteria)</span> </span>{
                <span class="hljs-keyword">if</span> (err) {
                    callback(err);
                }
                <span class="hljs-keyword">else</span> {
                    callback(<span class="hljs-literal">null</span>, {value: x, criteria: criteria});
                }
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, results)</span> </span>{
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">return</span> callback(err);
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> fn = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(left, right)</span> </span>{
                    <span class="hljs-keyword">var</span> a = left.criteria, b = right.criteria;
                    <span class="hljs-keyword">return</span> a &lt; b ? -<span class="hljs-number">1</span> : a &gt; b ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
                };
                callback(<span class="hljs-literal">null</span>, _map(results.sort(fn), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
                    <span class="hljs-keyword">return</span> x.value;
                }));
            }
        });
    };

    async.auto = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(tasks, callback)</span> </span>{
        callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
        <span class="hljs-keyword">var</span> keys = _keys(tasks);
        <span class="hljs-keyword">if</span> (!keys.length) {
            <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>);
        }

        <span class="hljs-keyword">var</span> results = {};

        <span class="hljs-keyword">var</span> listeners = [];
        <span class="hljs-keyword">var</span> addListener = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
            listeners.unshift(fn);
        };
        <span class="hljs-keyword">var</span> removeListener = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i += <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">if</span> (listeners[i] === fn) {
                    listeners.splice(i, <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">return</span>;
                }
            }
        };
        <span class="hljs-keyword">var</span> taskComplete = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            _each(listeners.slice(<span class="hljs-number">0</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
                fn();
            });
        };

        addListener(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">if</span> (_keys(results).length === keys.length) {
                callback(<span class="hljs-literal">null</span>, results);
                callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
            }
        });

        _each(keys, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k)</span> </span>{
            <span class="hljs-keyword">var</span> task = (tasks[k] <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Function</span>) ? [tasks[k]]: tasks[k];
            <span class="hljs-keyword">var</span> taskCallback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                <span class="hljs-keyword">if</span> (args.length &lt;= <span class="hljs-number">1</span>) {
                    args = args[<span class="hljs-number">0</span>];
                }
                <span class="hljs-keyword">if</span> (err) {
                    <span class="hljs-keyword">var</span> safeResults = {};
                    _each(_keys(results), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(rkey)</span> </span>{
                        safeResults[rkey] = results[rkey];
                    });
                    safeResults[k] = args;
                    callback(err, safeResults);</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>stop subsequent errors hitting callback multiple times</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                }
                <span class="hljs-keyword">else</span> {
                    results[k] = args;
                    async.setImmediate(taskComplete);
                }
            };
            <span class="hljs-keyword">var</span> requires = task.slice(<span class="hljs-number">0</span>, <span class="hljs-built_in">Math</span>.abs(task.length - <span class="hljs-number">1</span>)) || [];
            <span class="hljs-keyword">var</span> ready = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> _reduce(requires, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, x)</span> </span>{
                    <span class="hljs-keyword">return</span> (a &amp;&amp; results.hasOwnProperty(x));
                }, <span class="hljs-literal">true</span>) &amp;&amp; !results.hasOwnProperty(k);
            };
            <span class="hljs-keyword">if</span> (ready()) {
                task[task.length - <span class="hljs-number">1</span>](taskCallback, results);
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> listener = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">if</span> (ready()) {
                        removeListener(listener);
                        task[task.length - <span class="hljs-number">1</span>](taskCallback, results);
                    }
                };
                addListener(listener);
            }
        });
    };

    async.waterfall = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(tasks, callback)</span> </span>{
        callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
        <span class="hljs-keyword">if</span> (tasks.constructor !== <span class="hljs-built_in">Array</span>) {
          <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'First argument to waterfall must be an array of functions'</span>);
          <span class="hljs-keyword">return</span> callback(err);
        }
        <span class="hljs-keyword">if</span> (!tasks.length) {
            <span class="hljs-keyword">return</span> callback();
        }
        <span class="hljs-keyword">var</span> wrapIterator = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(iterator)</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">if</span> (err) {
                    callback.apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
                    callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">var</span> next = iterator.next();
                    <span class="hljs-keyword">if</span> (next) {
                        args.push(wrapIterator(next));
                    }
                    <span class="hljs-keyword">else</span> {
                        args.push(callback);
                    }
                    async.setImmediate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        iterator.apply(<span class="hljs-literal">null</span>, args);
                    });
                }
            };
        };
        wrapIterator(async.iterator(tasks))();
    };

    <span class="hljs-keyword">var</span> _parallel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eachfn, tasks, callback)</span> </span>{
        callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
        <span class="hljs-keyword">if</span> (tasks.constructor === <span class="hljs-built_in">Array</span>) {
            eachfn.map(tasks, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn, callback)</span> </span>{
                <span class="hljs-keyword">if</span> (fn) {
                    fn(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                        <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                        <span class="hljs-keyword">if</span> (args.length &lt;= <span class="hljs-number">1</span>) {
                            args = args[<span class="hljs-number">0</span>];
                        }
                        callback.call(<span class="hljs-literal">null</span>, err, args);
                    });
                }
            }, callback);
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> results = {};
            eachfn.each(_keys(tasks), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k, callback)</span> </span>{
                tasks[k](<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">if</span> (args.length &lt;= <span class="hljs-number">1</span>) {
                        args = args[<span class="hljs-number">0</span>];
                    }
                    results[k] = args;
                    callback(err);
                });
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                callback(err, results);
            });
        }
    };

    async.parallel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(tasks, callback)</span> </span>{
        _parallel({ map: async.map, each: async.each }, tasks, callback);
    };

    async.parallelLimit = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tasks, limit, callback)</span> </span>{
        _parallel({ map: _mapLimit(limit), each: _eachLimit(limit) }, tasks, callback);
    };

    async.series = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(tasks, callback)</span> </span>{
        callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};
        <span class="hljs-keyword">if</span> (tasks.constructor === <span class="hljs-built_in">Array</span>) {
            async.mapSeries(tasks, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn, callback)</span> </span>{
                <span class="hljs-keyword">if</span> (fn) {
                    fn(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                        <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                        <span class="hljs-keyword">if</span> (args.length &lt;= <span class="hljs-number">1</span>) {
                            args = args[<span class="hljs-number">0</span>];
                        }
                        callback.call(<span class="hljs-literal">null</span>, err, args);
                    });
                }
            }, callback);
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> results = {};
            async.eachSeries(_keys(tasks), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k, callback)</span> </span>{
                tasks[k](<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">if</span> (args.length &lt;= <span class="hljs-number">1</span>) {
                        args = args[<span class="hljs-number">0</span>];
                    }
                    results[k] = args;
                    callback(err);
                });
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                callback(err, results);
            });
        }
    };

    async.iterator = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(tasks)</span> </span>{
        <span class="hljs-keyword">var</span> makeCallback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(index)</span> </span>{
            <span class="hljs-keyword">var</span> fn = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">if</span> (tasks.length) {
                    tasks[index].apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
                }
                <span class="hljs-keyword">return</span> fn.next();
            };
            fn.next = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> (index &lt; tasks.length - <span class="hljs-number">1</span>) ? makeCallback(index + <span class="hljs-number">1</span>): <span class="hljs-literal">null</span>;
            };
            <span class="hljs-keyword">return</span> fn;
        };
        <span class="hljs-keyword">return</span> makeCallback(<span class="hljs-number">0</span>);
    };

    async.apply = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
        <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> fn.apply(
                <span class="hljs-literal">null</span>, args.concat(<span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>))
            );
        };
    };

    <span class="hljs-keyword">var</span> _concat = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eachfn, arr, fn, callback)</span> </span>{
        <span class="hljs-keyword">var</span> r = [];
        eachfn(arr, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, cb)</span> </span>{
            fn(x, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, y)</span> </span>{
                r = r.concat(y || []);
                cb(err);
            });
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            callback(err, r);
        });
    };
    async.concat = doParallel(_concat);
    async.concatSeries = doSeries(_concat);

    async.whilst = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(test, iterator, callback)</span> </span>{
        <span class="hljs-keyword">if</span> (test()) {
            iterator(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">if</span> (err) {
                    <span class="hljs-keyword">return</span> callback(err);
                }
                async.whilst(test, iterator, callback);
            });
        }
        <span class="hljs-keyword">else</span> {
            callback();
        }
    };

    async.doWhilst = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(iterator, test, callback)</span> </span>{
        iterator(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">return</span> callback(err);
            }
            <span class="hljs-keyword">if</span> (test()) {
                async.doWhilst(iterator, test, callback);
            }
            <span class="hljs-keyword">else</span> {
                callback();
            }
        });
    };

    async.until = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(test, iterator, callback)</span> </span>{
        <span class="hljs-keyword">if</span> (!test()) {
            iterator(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">if</span> (err) {
                    <span class="hljs-keyword">return</span> callback(err);
                }
                async.until(test, iterator, callback);
            });
        }
        <span class="hljs-keyword">else</span> {
            callback();
        }
    };

    async.doUntil = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(iterator, test, callback)</span> </span>{
        iterator(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">return</span> callback(err);
            }
            <span class="hljs-keyword">if</span> (!test()) {
                async.doUntil(iterator, test, callback);
            }
            <span class="hljs-keyword">else</span> {
                callback();
            }
        });
    };

    async.queue = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(worker, concurrency)</span> </span>{
        <span class="hljs-keyword">if</span> (concurrency === <span class="hljs-literal">undefined</span>) {
            concurrency = <span class="hljs-number">1</span>;
        }
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_insert</span><span class="hljs-params">(q, data, pos, callback)</span> </span>{
          <span class="hljs-keyword">if</span>(data.constructor !== <span class="hljs-built_in">Array</span>) {
              data = [data];
          }
          _each(data, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(task)</span> </span>{
              <span class="hljs-keyword">var</span> item = {
                  data: task,
                  callback: <span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span> ? callback : <span class="hljs-literal">null</span>
              };

              <span class="hljs-keyword">if</span> (pos) {
                q.tasks.unshift(item);
              } <span class="hljs-keyword">else</span> {
                q.tasks.push(item);
              }

              <span class="hljs-keyword">if</span> (q.saturated &amp;&amp; q.tasks.length === concurrency) {
                  q.saturated();
              }
              async.setImmediate(q.process);
          });
        }

        <span class="hljs-keyword">var</span> workers = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> q = {
            tasks: [],
            concurrency: concurrency,
            saturated: <span class="hljs-literal">null</span>,
            empty: <span class="hljs-literal">null</span>,
            drain: <span class="hljs-literal">null</span>,
            push: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data, callback)</span> </span>{
              _insert(q, data, <span class="hljs-literal">false</span>, callback);
            },
            unshift: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data, callback)</span> </span>{
              _insert(q, data, <span class="hljs-literal">true</span>, callback);
            },
            process: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">if</span> (workers &lt; q.concurrency &amp;&amp; q.tasks.length) {
                    <span class="hljs-keyword">var</span> task = q.tasks.shift();
                    <span class="hljs-keyword">if</span> (q.empty &amp;&amp; q.tasks.length === <span class="hljs-number">0</span>) {
                        q.empty();
                    }
                    workers += <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">var</span> next = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        workers -= <span class="hljs-number">1</span>;
                        <span class="hljs-keyword">if</span> (task.callback) {
                            task.callback.apply(task, <span class="hljs-built_in">arguments</span>);
                        }
                        <span class="hljs-keyword">if</span> (q.drain &amp;&amp; q.tasks.length + workers === <span class="hljs-number">0</span>) {
                            q.drain();
                        }
                        q.process();
                    };
                    <span class="hljs-keyword">var</span> cb = only_once(next);
                    worker(task.data, cb);
                }
            },
            length: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> q.tasks.length;
            },
            running: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> workers;
            }
        };
        <span class="hljs-keyword">return</span> q;
    };

    async.cargo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(worker, payload)</span> </span>{
        <span class="hljs-keyword">var</span> working     = <span class="hljs-literal">false</span>,
            tasks       = [];

        <span class="hljs-keyword">var</span> cargo = {
            tasks: tasks,
            payload: payload,
            saturated: <span class="hljs-literal">null</span>,
            empty: <span class="hljs-literal">null</span>,
            drain: <span class="hljs-literal">null</span>,
            push: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data, callback)</span> </span>{
                <span class="hljs-keyword">if</span>(data.constructor !== <span class="hljs-built_in">Array</span>) {
                    data = [data];
                }
                _each(data, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(task)</span> </span>{
                    tasks.push({
                        data: task,
                        callback: <span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span> ? callback : <span class="hljs-literal">null</span>
                    });
                    <span class="hljs-keyword">if</span> (cargo.saturated &amp;&amp; tasks.length === payload) {
                        cargo.saturated();
                    }
                });
                async.setImmediate(cargo.process);
            },
            process: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">if</span> (working) <span class="hljs-keyword">return</span>;
                <span class="hljs-keyword">if</span> (tasks.length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">if</span>(cargo.drain) cargo.drain();
                    <span class="hljs-keyword">return</span>;
                }

                <span class="hljs-keyword">var</span> ts = <span class="hljs-keyword">typeof</span> payload === <span class="hljs-string">'number'</span>
                            ? tasks.splice(<span class="hljs-number">0</span>, payload)
                            : tasks.splice(<span class="hljs-number">0</span>);

                <span class="hljs-keyword">var</span> ds = _map(ts, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(task)</span> </span>{
                    <span class="hljs-keyword">return</span> task.data;
                });

                <span class="hljs-keyword">if</span>(cargo.empty) cargo.empty();
                working = <span class="hljs-literal">true</span>;
                worker(ds, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    working = <span class="hljs-literal">false</span>;

                    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>;
                    _each(ts, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
                        <span class="hljs-keyword">if</span> (data.callback) {
                            data.callback.apply(<span class="hljs-literal">null</span>, args);
                        }
                    });

                    process();
                });
            },
            length: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> tasks.length;
            },
            running: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> working;
            }
        };
        <span class="hljs-keyword">return</span> cargo;
    };

    <span class="hljs-keyword">var</span> _console_fn = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
            fn.apply(<span class="hljs-literal">null</span>, args.concat([<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">console</span> !== <span class="hljs-string">'undefined'</span>) {
                    <span class="hljs-keyword">if</span> (err) {
                        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">console</span>.error) {
                            <span class="hljs-built_in">console</span>.error(err);
                        }
                    }
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">console</span>[name]) {
                        _each(args, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
                            <span class="hljs-built_in">console</span>[name](x);
                        });
                    }
                }
            }]));
        };
    };
    async.log = _console_fn(<span class="hljs-string">'log'</span>);
    async.dir = _console_fn(<span class="hljs-string">'dir'</span>);
    <span class="hljs-comment">/*async.info = _console_fn('info');
    async.warn = _console_fn('warn');
    async.error = _console_fn('error');*/</span>

    async.memoize = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn, hasher)</span> </span>{
        <span class="hljs-keyword">var</span> memo = {};
        <span class="hljs-keyword">var</span> queues = {};
        hasher = hasher || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> </span>{
            <span class="hljs-keyword">return</span> x;
        };
        <span class="hljs-keyword">var</span> memoized = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">var</span> callback = args.pop();
            <span class="hljs-keyword">var</span> key = hasher.apply(<span class="hljs-literal">null</span>, args);
            <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> memo) {
                callback.apply(<span class="hljs-literal">null</span>, memo[key]);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> queues) {
                queues[key].push(callback);
            }
            <span class="hljs-keyword">else</span> {
                queues[key] = [callback];
                fn.apply(<span class="hljs-literal">null</span>, args.concat([<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    memo[key] = <span class="hljs-built_in">arguments</span>;
                    <span class="hljs-keyword">var</span> q = queues[key];
                    <span class="hljs-keyword">delete</span> queues[key];
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = q.length; i &lt; l; i++) {
                      q[i].apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
                    }
                }]));
            }
        };
        memoized.memo = memo;
        memoized.unmemoized = fn;
        <span class="hljs-keyword">return</span> memoized;
    };

    async.unmemoize = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> (fn.unmemoized || fn).apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
      };
    };

    async.times = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(count, iterator, callback)</span> </span>{
        <span class="hljs-keyword">var</span> counter = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
            counter.push(i);
        }
        <span class="hljs-keyword">return</span> async.map(counter, iterator, callback);
    };

    async.timesSeries = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(count, iterator, callback)</span> </span>{
        <span class="hljs-keyword">var</span> counter = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
            counter.push(i);
        }
        <span class="hljs-keyword">return</span> async.mapSeries(counter, iterator, callback);
    };

    async.compose = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-comment">/* functions... */</span>)</span> </span>{
        <span class="hljs-keyword">var</span> fns = <span class="hljs-built_in">Array</span>.prototype.reverse.call(<span class="hljs-built_in">arguments</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">var</span> callback = args.pop();
            async.reduce(fns, args, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newargs, fn, cb)</span> </span>{
                fn.apply(that, newargs.concat([<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">var</span> err = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>];
                    <span class="hljs-keyword">var</span> nextargs = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
                    cb(err, nextargs);
                }]))
            },
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, results)</span> </span>{
                callback.apply(that, [err].concat(results));
            });
        };
    };

    <span class="hljs-keyword">var</span> _applyEach = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eachfn, fns <span class="hljs-comment">/*args...*/</span>)</span> </span>{
        <span class="hljs-keyword">var</span> go = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">var</span> callback = args.pop();
            <span class="hljs-keyword">return</span> eachfn(fns, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn, cb)</span> </span>{
                fn.apply(that, args.concat([cb]));
            },
            callback);
        };
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>);
            <span class="hljs-keyword">return</span> go.apply(<span class="hljs-keyword">this</span>, args);
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> go;
        }
    };
    async.applyEach = doParallel(_applyEach);
    async.applyEachSeries = doSeries(_applyEach);

    async.forever = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn, callback)</span> </span>{
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span><span class="hljs-params">(err)</span> </span>{
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">if</span> (callback) {
                    <span class="hljs-keyword">return</span> callback(err);
                }
                <span class="hljs-keyword">throw</span> err;
            }
            fn(next);
        }
        next();
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>AMD / RequireJS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define !== <span class="hljs-string">'undefined'</span> &amp;&amp; define.amd) {
        define([], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> async;
        });
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>Node.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-built_in">module</span>.exports) {
        <span class="hljs-built_in">module</span>.exports = async;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>included directly via <script> tag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> {
        root.async = async;
    }

}());

},{<span class="hljs-string">"__browserify_process"</span>:<span class="hljs-number">3</span>}],<span class="hljs-number">12</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{
<span class="hljs-built_in">module</span>.exports.BinarySearchTree = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/bst'</span>);
<span class="hljs-built_in">module</span>.exports.AVLTree = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/avltree'</span>);

},{<span class="hljs-string">"./lib/avltree"</span>:<span class="hljs-number">13</span>,<span class="hljs-string">"./lib/bst"</span>:<span class="hljs-number">14</span>}],<span class="hljs-number">13</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{
<span class="hljs-comment">/**
 * Self-balancing binary search tree using the AVL implementation
 */</span>
<span class="hljs-keyword">var</span> BinarySearchTree = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./bst'</span>)
  , customUtils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./customUtils'</span>)
  , util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
  , _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
  ;


<span class="hljs-comment">/**
 * Constructor
 * We can't use a direct pointer to the root node (as in the simple binary search tree)
 * as the root will change during tree rotations
 * @param {Boolean}  options.unique Whether to enforce a 'unique' constraint on the key or not
 * @param {Function} options.compareKeys Initialize this BST's compareKeys
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">AVLTree</span> <span class="hljs-params">(options)</span> </span>{
  <span class="hljs-keyword">this</span>.tree = <span class="hljs-keyword">new</span> _AVLTree(options);
}


<span class="hljs-comment">/**
 * Constructor of the internal AVLTree
 * @param {Object} options Optional
 * @param {Boolean}  options.unique Whether to enforce a 'unique' constraint on the key or not
 * @param {Key}      options.key Initialize this BST's key with key
 * @param {Value}    options.value Initialize this BST's data with [value]
 * @param {Function} options.compareKeys Initialize this BST's compareKeys
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_AVLTree</span> <span class="hljs-params">(options)</span> </span>{
  options = options || {};

  <span class="hljs-keyword">this</span>.left = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">this</span>.right = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">this</span>.parent = options.parent !== <span class="hljs-literal">undefined</span> ? options.parent : <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span> (options.hasOwnProperty(<span class="hljs-string">'key'</span>)) { <span class="hljs-keyword">this</span>.key = options.key; }
  <span class="hljs-keyword">this</span>.data = options.hasOwnProperty(<span class="hljs-string">'value'</span>) ? [options.value] : [];
  <span class="hljs-keyword">this</span>.unique = options.unique || <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">this</span>.compareKeys = options.compareKeys || customUtils.defaultCompareKeysFunction;
  <span class="hljs-keyword">this</span>.checkValueEquality = options.checkValueEquality || customUtils.defaultCheckValueEquality;
}


<span class="hljs-comment">/**
 * Inherit basic functions from the basic binary search tree
 */</span>
util.inherits(_AVLTree, BinarySearchTree);

<span class="hljs-comment">/**
 * Keep a pointer to the internal tree constructor for testing purposes
 */</span>
AVLTree._AVLTree = _AVLTree;


<span class="hljs-comment">/**
 * Check the recorded height is correct for every node
 * Throws if one height doesn't match
 */</span>
_AVLTree.prototype.checkHeightCorrect = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> leftH, rightH;

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasOwnProperty(<span class="hljs-string">'key'</span>)) { <span class="hljs-keyword">return</span>; }   <span class="hljs-comment">// Empty tree</span>

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left &amp;&amp; <span class="hljs-keyword">this</span>.left.height === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Undefined height for node "</span> + <span class="hljs-keyword">this</span>.left.key; }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right &amp;&amp; <span class="hljs-keyword">this</span>.right.height === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Undefined height for node "</span> + <span class="hljs-keyword">this</span>.right.key; }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.height === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Undefined height for node "</span> + <span class="hljs-keyword">this</span>.key; }

  leftH = <span class="hljs-keyword">this</span>.left ? <span class="hljs-keyword">this</span>.left.height : <span class="hljs-number">0</span>;
  rightH = <span class="hljs-keyword">this</span>.right ? <span class="hljs-keyword">this</span>.right.height : <span class="hljs-number">0</span>;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.height !== <span class="hljs-number">1</span> + <span class="hljs-built_in">Math</span>.max(leftH, rightH)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Height constraint failed for node "</span> + <span class="hljs-keyword">this</span>.key; }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left) { <span class="hljs-keyword">this</span>.left.checkHeightCorrect(); }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right) { <span class="hljs-keyword">this</span>.right.checkHeightCorrect(); }
};


<span class="hljs-comment">/**
 * Return the balance factor
 */</span>
_AVLTree.prototype.balanceFactor = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> leftH = <span class="hljs-keyword">this</span>.left ? <span class="hljs-keyword">this</span>.left.height : <span class="hljs-number">0</span>
    , rightH = <span class="hljs-keyword">this</span>.right ? <span class="hljs-keyword">this</span>.right.height : <span class="hljs-number">0</span>
    ;
  <span class="hljs-keyword">return</span> leftH - rightH;
};


<span class="hljs-comment">/**
 * Check that the balance factors are all between -1 and 1
 */</span>
_AVLTree.prototype.checkBalanceFactors = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(<span class="hljs-keyword">this</span>.balanceFactor()) &gt; <span class="hljs-number">1</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-string">'Tree is unbalanced at node '</span> + <span class="hljs-keyword">this</span>.key; }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left) { <span class="hljs-keyword">this</span>.left.checkBalanceFactors(); }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right) { <span class="hljs-keyword">this</span>.right.checkBalanceFactors(); }
};


<span class="hljs-comment">/**
 * When checking if the BST conditions are met, also check that the heights are correct
 * and the tree is balanced
 */</span>
_AVLTree.prototype.checkIsAVLT = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  _AVLTree.super_.prototype.checkIsBST.call(<span class="hljs-keyword">this</span>);
  <span class="hljs-keyword">this</span>.checkHeightCorrect();
  <span class="hljs-keyword">this</span>.checkBalanceFactors();
};
AVLTree.prototype.checkIsAVLT = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">this</span>.tree.checkIsAVLT(); };


<span class="hljs-comment">/**
 * Perform a right rotation of the tree if possible
 * and return the root of the resulting tree
 * The resulting tree's nodes' heights are also updated
 */</span>
_AVLTree.prototype.rightRotation = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> q = <span class="hljs-keyword">this</span>
    , p = <span class="hljs-keyword">this</span>.left
    , b
    , ah, bh, ch;

  <span class="hljs-keyword">if</span> (!p) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>; }   <span class="hljs-comment">// No change</span>

  b = p.right;</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>Alter tree structure</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (q.parent) {
    p.parent = q.parent;
    <span class="hljs-keyword">if</span> (q.parent.left === q) { q.parent.left = p; } <span class="hljs-keyword">else</span> { q.parent.right = p; }
  } <span class="hljs-keyword">else</span> {
    p.parent = <span class="hljs-literal">null</span>;
  }
  p.right = q;
  q.parent = p;
  q.left = b;
  <span class="hljs-keyword">if</span> (b) { b.parent = q; }</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Update heights</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ah = p.left ? p.left.height : <span class="hljs-number">0</span>;
  bh = b ? b.height : <span class="hljs-number">0</span>;
  ch = q.right ? q.right.height : <span class="hljs-number">0</span>;
  q.height = <span class="hljs-built_in">Math</span>.max(bh, ch) + <span class="hljs-number">1</span>;
  p.height = <span class="hljs-built_in">Math</span>.max(ah, q.height) + <span class="hljs-number">1</span>;

  <span class="hljs-keyword">return</span> p;
};


<span class="hljs-comment">/**
 * Perform a left rotation of the tree if possible
 * and return the root of the resulting tree
 * The resulting tree's nodes' heights are also updated
 */</span>
_AVLTree.prototype.leftRotation = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> p = <span class="hljs-keyword">this</span>
    , q = <span class="hljs-keyword">this</span>.right
    , b
    , ah, bh, ch;

  <span class="hljs-keyword">if</span> (!q) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>; }   <span class="hljs-comment">// No change</span>

  b = q.left;</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Alter tree structure</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (p.parent) {
    q.parent = p.parent;
    <span class="hljs-keyword">if</span> (p.parent.left === p) { p.parent.left = q; } <span class="hljs-keyword">else</span> { p.parent.right = q; }
  } <span class="hljs-keyword">else</span> {
    q.parent = <span class="hljs-literal">null</span>;
  }
  q.left = p;
  p.parent = q;
  p.right = b;
  <span class="hljs-keyword">if</span> (b) { b.parent = p; }</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>Update heights</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ah = p.left ? p.left.height : <span class="hljs-number">0</span>;
  bh = b ? b.height : <span class="hljs-number">0</span>;
  ch = q.right ? q.right.height : <span class="hljs-number">0</span>;
  p.height = <span class="hljs-built_in">Math</span>.max(ah, bh) + <span class="hljs-number">1</span>;
  q.height = <span class="hljs-built_in">Math</span>.max(ch, p.height) + <span class="hljs-number">1</span>;

  <span class="hljs-keyword">return</span> q;
};


<span class="hljs-comment">/**
 * Modify the tree if its right subtree is too small compared to the left
 * Return the new root if any
 */</span>
_AVLTree.prototype.rightTooSmall = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.balanceFactor() &lt;= <span class="hljs-number">1</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>; }   <span class="hljs-comment">// Right is not too small, don't change</span>

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left.balanceFactor() &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">this</span>.left.leftRotation();
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.rightRotation();
};


<span class="hljs-comment">/**
 * Modify the tree if its left subtree is too small compared to the right
 * Return the new root if any
 */</span>
_AVLTree.prototype.leftTooSmall = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.balanceFactor() &gt;= -<span class="hljs-number">1</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>; }   <span class="hljs-comment">// Left is not too small, don't change</span>

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right.balanceFactor() &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">this</span>.right.rightRotation();
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.leftRotation();
};


<span class="hljs-comment">/**
 * Rebalance the tree along the given path. The path is given reversed (as he was calculated
 * in the insert and delete functions).
 * Returns the new root of the tree
 * Of course, the first element of the path must be the root of the tree
 */</span>
_AVLTree.prototype.rebalanceAlongPath = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path)</span> </span>{
  <span class="hljs-keyword">var</span> newRoot = <span class="hljs-keyword">this</span>
    , rotated
    , i;

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasOwnProperty(<span class="hljs-string">'key'</span>)) { <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.height; <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>; }   <span class="hljs-comment">// Empty tree</span></pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>Rebalance the tree and update all heights</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> (i = path.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i -= <span class="hljs-number">1</span>) {
    path[i].height = <span class="hljs-number">1</span> + <span class="hljs-built_in">Math</span>.max(path[i].left ? path[i].left.height : <span class="hljs-number">0</span>, path[i].right ? path[i].right.height : <span class="hljs-number">0</span>);

    <span class="hljs-keyword">if</span> (path[i].balanceFactor() &gt; <span class="hljs-number">1</span>) {
      rotated = path[i].rightTooSmall();
      <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) { newRoot = rotated; }
    }

    <span class="hljs-keyword">if</span> (path[i].balanceFactor() &lt; -<span class="hljs-number">1</span>) {
      rotated = path[i].leftTooSmall();
      <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) { newRoot = rotated; }
    }
  }

  <span class="hljs-keyword">return</span> newRoot;
};


<span class="hljs-comment">/**
 * Insert a key, value pair in the tree while maintaining the AVL tree height constraint
 * Return a pointer to the root node, which may have changed
 */</span>
_AVLTree.prototype.insert = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, value)</span> </span>{
  <span class="hljs-keyword">var</span> insertPath = []
    , currentNode = <span class="hljs-keyword">this</span>
    ;</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>Empty tree, insert as root</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasOwnProperty(<span class="hljs-string">'key'</span>)) {
    <span class="hljs-keyword">this</span>.key = key;
    <span class="hljs-keyword">this</span>.data.push(value);
    <span class="hljs-keyword">this</span>.height = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>Insert new leaf at the right place</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Same key: no change in the tree structure</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (currentNode.compareKeys(currentNode.key, key) === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (currentNode.unique) {
        <span class="hljs-keyword">throw</span> { message: <span class="hljs-string">"Can't insert key "</span> + key + <span class="hljs-string">", it violates the unique constraint"</span>
              , key: key
              , errorType: <span class="hljs-string">'uniqueViolated'</span>
              };
      } <span class="hljs-keyword">else</span> {
        currentNode.data.push(value);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }

    insertPath.push(currentNode);

    <span class="hljs-keyword">if</span> (currentNode.compareKeys(key, currentNode.key) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (!currentNode.left) {
        insertPath.push(currentNode.createLeftChild({ key: key, value: value }));
        <span class="hljs-keyword">break</span>;
      } <span class="hljs-keyword">else</span> {
        currentNode = currentNode.left;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (!currentNode.right) {
        insertPath.push(currentNode.createRightChild({ key: key, value: value }));
        <span class="hljs-keyword">break</span>;
      } <span class="hljs-keyword">else</span> {
        currentNode = currentNode.right;
      }
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.rebalanceAlongPath(insertPath);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Insert in the internal tree, update the pointer to the root if needed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>AVLTree.prototype.insert = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, value)</span> </span>{
  <span class="hljs-keyword">var</span> newTree = <span class="hljs-keyword">this</span>.tree.insert(key, value);</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>If newTree is undefined, that means its structure was not modified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (newTree) { <span class="hljs-keyword">this</span>.tree = newTree; }
};


<span class="hljs-comment">/**
 * Delete a key or just a value and return the new root of the tree
 * @param {Key} key
 * @param {Value} value Optional. If not set, the whole key is deleted. If set, only this value is deleted
 */</span>
_AVLTree.prototype.delete = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, value)</span> </span>{
  <span class="hljs-keyword">var</span> newData = [], replaceWith
    , self = <span class="hljs-keyword">this</span>
    , currentNode = <span class="hljs-keyword">this</span>
    , deletePath = []
    ;

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasOwnProperty(<span class="hljs-string">'key'</span>)) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>; }   <span class="hljs-comment">// Empty tree</span></pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>Either no match is found and the function will return from within the loop
Or a match is found and deletePath will contain the path from the root to the node to delete after the loop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">if</span> (currentNode.compareKeys(key, currentNode.key) === <span class="hljs-number">0</span>) { <span class="hljs-keyword">break</span>; }

    deletePath.push(currentNode);

    <span class="hljs-keyword">if</span> (currentNode.compareKeys(key, currentNode.key) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (currentNode.left) {
        currentNode = currentNode.left;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;   <span class="hljs-comment">// Key not found, no modification</span>
      }
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>currentNode.compareKeys(key, currentNode.key) is &gt; 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (currentNode.right) {
        currentNode = currentNode.right;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;   <span class="hljs-comment">// Key not found, no modification</span>
      }
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Delete only a value (no tree modification)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (currentNode.data.length &gt; <span class="hljs-number">1</span> &amp;&amp; value) {
    currentNode.data.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
      <span class="hljs-keyword">if</span> (!currentNode.checkValueEquality(d, value)) { newData.push(d); }
    });
    currentNode.data = newData;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>Delete a whole node</p>

            </div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>Leaf</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!currentNode.left &amp;&amp; !currentNode.right) {
    <span class="hljs-keyword">if</span> (currentNode === <span class="hljs-keyword">this</span>) {   <span class="hljs-comment">// This leaf is also the root</span>
      <span class="hljs-keyword">delete</span> currentNode.key;
      currentNode.data = [];
      <span class="hljs-keyword">delete</span> currentNode.height;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (currentNode.parent.left === currentNode) {
        currentNode.parent.left = <span class="hljs-literal">null</span>;
      } <span class="hljs-keyword">else</span> {
        currentNode.parent.right = <span class="hljs-literal">null</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.rebalanceAlongPath(deletePath);
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>Node with only one child</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!currentNode.left || !currentNode.right) {
    replaceWith = currentNode.left ? currentNode.left : currentNode.right;

    <span class="hljs-keyword">if</span> (currentNode === <span class="hljs-keyword">this</span>) {   <span class="hljs-comment">// This node is also the root</span>
      replaceWith.parent = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">return</span> replaceWith;   <span class="hljs-comment">// height of replaceWith is necessarily 1 because the tree was balanced before deletion</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (currentNode.parent.left === currentNode) {
        currentNode.parent.left = replaceWith;
        replaceWith.parent = currentNode.parent;
      } <span class="hljs-keyword">else</span> {
        currentNode.parent.right = replaceWith;
        replaceWith.parent = currentNode.parent;
      }

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.rebalanceAlongPath(deletePath);
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>Node with two children
Use the in-order predecessor (no need to randomize since we actively rebalance)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  deletePath.push(currentNode);
  replaceWith = currentNode.left;</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>Special case: the in-order predecessor is right below the node to delete</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!replaceWith.right) {
    currentNode.key = replaceWith.key;
    currentNode.data = replaceWith.data;
    currentNode.left = replaceWith.left;
    <span class="hljs-keyword">if</span> (replaceWith.left) { replaceWith.left.parent = currentNode; }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.rebalanceAlongPath(deletePath);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>After this loop, replaceWith is the right-most leaf in the left subtree
and deletePath the path from the root (inclusive) to replaceWith (exclusive)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">if</span> (replaceWith.right) {
      deletePath.push(replaceWith);
      replaceWith = replaceWith.right;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">break</span>;
    }
  }

  currentNode.key = replaceWith.key;
  currentNode.data = replaceWith.data;

  replaceWith.parent.right = replaceWith.left;
  <span class="hljs-keyword">if</span> (replaceWith.left) { replaceWith.left.parent = replaceWith.parent; }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.rebalanceAlongPath(deletePath);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>Delete a value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>AVLTree.prototype.delete = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, value)</span> </span>{
  <span class="hljs-keyword">var</span> newTree = <span class="hljs-keyword">this</span>.tree.delete(key, value);</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>If newTree is undefined, that means its structure was not modified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (newTree) { <span class="hljs-keyword">this</span>.tree = newTree; }
};


<span class="hljs-comment">/**
 * Other functions we want to use on an AVLTree as if it were the internal _AVLTree
 */</span>
[<span class="hljs-string">'getNumberOfKeys'</span>, <span class="hljs-string">'search'</span>, <span class="hljs-string">'betweenBounds'</span>, <span class="hljs-string">'prettyPrint'</span>, <span class="hljs-string">'executeOnEveryNode'</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
  AVLTree.prototype[fn] = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.tree[fn].apply(<span class="hljs-keyword">this</span>.tree, <span class="hljs-built_in">arguments</span>);
  };
});</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>Interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = AVLTree;

},{<span class="hljs-string">"./bst"</span>:<span class="hljs-number">14</span>,<span class="hljs-string">"./customUtils"</span>:<span class="hljs-number">15</span>,<span class="hljs-string">"underscore"</span>:<span class="hljs-number">16</span>,<span class="hljs-string">"util"</span>:<span class="hljs-number">2</span>}],<span class="hljs-number">14</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{
<span class="hljs-comment">/**
 * Simple binary search tree
 */</span>
<span class="hljs-keyword">var</span> customUtils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./customUtils'</span>);


<span class="hljs-comment">/**
 * Constructor
 * @param {Object} options Optional
 * @param {Boolean}  options.unique Whether to enforce a 'unique' constraint on the key or not
 * @param {Key}      options.key Initialize this BST's key with key
 * @param {Value}    options.value Initialize this BST's data with [value]
 * @param {Function} options.compareKeys Initialize this BST's compareKeys
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BinarySearchTree</span> <span class="hljs-params">(options)</span> </span>{
  options = options || {};

  <span class="hljs-keyword">this</span>.left = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">this</span>.right = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">this</span>.parent = options.parent !== <span class="hljs-literal">undefined</span> ? options.parent : <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span> (options.hasOwnProperty(<span class="hljs-string">'key'</span>)) { <span class="hljs-keyword">this</span>.key = options.key; }
  <span class="hljs-keyword">this</span>.data = options.hasOwnProperty(<span class="hljs-string">'value'</span>) ? [options.value] : [];
  <span class="hljs-keyword">this</span>.unique = options.unique || <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">this</span>.compareKeys = options.compareKeys || customUtils.defaultCompareKeysFunction;
  <span class="hljs-keyword">this</span>.checkValueEquality = options.checkValueEquality || customUtils.defaultCheckValueEquality;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>================================</p>
<h1 id="methods-used-to-test-the-tree">Methods used to test the tree</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-comment">/**
 * Get the descendant with max key
 */</span>
BinarySearchTree.prototype.getMaxKeyDescendant = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.right.getMaxKeyDescendant();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }
};


<span class="hljs-comment">/**
 * Get the maximum key
 */</span>
BinarySearchTree.prototype.getMaxKey = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getMaxKeyDescendant().key;
};


<span class="hljs-comment">/**
 * Get the descendant with min key
 */</span>
BinarySearchTree.prototype.getMinKeyDescendant = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.left.getMinKeyDescendant()
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }
};


<span class="hljs-comment">/**
 * Get the minimum key
 */</span>
BinarySearchTree.prototype.getMinKey = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getMinKeyDescendant().key;
};


<span class="hljs-comment">/**
 * Check that all nodes (incl. leaves) fullfil condition given by fn
 * test is a function passed every (key, data) and which throws if the condition is not met
 */</span>
BinarySearchTree.prototype.checkAllNodesFullfillCondition = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(test)</span> </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasOwnProperty(<span class="hljs-string">'key'</span>)) { <span class="hljs-keyword">return</span>; }

  test(<span class="hljs-keyword">this</span>.key, <span class="hljs-keyword">this</span>.data);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left) { <span class="hljs-keyword">this</span>.left.checkAllNodesFullfillCondition(test); }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right) { <span class="hljs-keyword">this</span>.right.checkAllNodesFullfillCondition(test); }
};


<span class="hljs-comment">/**
 * Check that the core BST properties on node ordering are verified
 * Throw if they aren't
 */</span>
BinarySearchTree.prototype.checkNodeOrdering = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasOwnProperty(<span class="hljs-string">'key'</span>)) { <span class="hljs-keyword">return</span>; }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left) {
    <span class="hljs-keyword">this</span>.left.checkAllNodesFullfillCondition(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k)</span> </span>{
      <span class="hljs-keyword">if</span> (self.compareKeys(k, self.key) &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">'Tree with root '</span> + self.key + <span class="hljs-string">' is not a binary search tree'</span>;
      }
    });
    <span class="hljs-keyword">this</span>.left.checkNodeOrdering();
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right) {
    <span class="hljs-keyword">this</span>.right.checkAllNodesFullfillCondition(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k)</span> </span>{
      <span class="hljs-keyword">if</span> (self.compareKeys(k, self.key) &lt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">'Tree with root '</span> + self.key + <span class="hljs-string">' is not a binary search tree'</span>;
      }
    });
    <span class="hljs-keyword">this</span>.right.checkNodeOrdering();
  }
};


<span class="hljs-comment">/**
 * Check that all pointers are coherent in this tree
 */</span>
BinarySearchTree.prototype.checkInternalPointers = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left.parent !== <span class="hljs-keyword">this</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-string">'Parent pointer broken for key '</span> + <span class="hljs-keyword">this</span>.key; }
    <span class="hljs-keyword">this</span>.left.checkInternalPointers();
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right.parent !== <span class="hljs-keyword">this</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-string">'Parent pointer broken for key '</span> + <span class="hljs-keyword">this</span>.key; }
    <span class="hljs-keyword">this</span>.right.checkInternalPointers();
  }
};


<span class="hljs-comment">/**
 * Check that a tree is a BST as defined here (node ordering and pointer references)
 */</span>
BinarySearchTree.prototype.checkIsBST = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.checkNodeOrdering();
  <span class="hljs-keyword">this</span>.checkInternalPointers();
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.parent) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"The root shouldn't have a parent"</span>; }
};


<span class="hljs-comment">/**
 * Get number of keys inserted
 */</span>
BinarySearchTree.prototype.getNumberOfKeys = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> res;

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasOwnProperty(<span class="hljs-string">'key'</span>)) { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }

  res = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left) { res += <span class="hljs-keyword">this</span>.left.getNumberOfKeys(); }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right) { res += <span class="hljs-keyword">this</span>.right.getNumberOfKeys(); }

  <span class="hljs-keyword">return</span> res;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>============================================</p>
<h1 id="methods-used-to-actually-work-on-the-tree">Methods used to actually work on the tree</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/**
 * Create a BST similar (i.e. same options except for key and value) to the current one
 * Use the same constructor (i.e. BinarySearchTree, AVLTree etc)
 * @param {Object} options see constructor
 */</span>
BinarySearchTree.prototype.createSimilar = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> </span>{
  options = options || {};
  options.unique = <span class="hljs-keyword">this</span>.unique;
  options.compareKeys = <span class="hljs-keyword">this</span>.compareKeys;
  options.checkValueEquality = <span class="hljs-keyword">this</span>.checkValueEquality;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>.constructor(options);
};


<span class="hljs-comment">/**
 * Create the left child of this BST and return it
 */</span>
BinarySearchTree.prototype.createLeftChild = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> </span>{
  <span class="hljs-keyword">var</span> leftChild = <span class="hljs-keyword">this</span>.createSimilar(options);
  leftChild.parent = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>.left = leftChild;

  <span class="hljs-keyword">return</span> leftChild;
};


<span class="hljs-comment">/**
 * Create the right child of this BST and return it
 */</span>
BinarySearchTree.prototype.createRightChild = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> </span>{
  <span class="hljs-keyword">var</span> rightChild = <span class="hljs-keyword">this</span>.createSimilar(options);
  rightChild.parent = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>.right = rightChild;

  <span class="hljs-keyword">return</span> rightChild;
};


<span class="hljs-comment">/**
 * Insert a new element
 */</span>
BinarySearchTree.prototype.insert = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, value)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>Empty tree, insert as root</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasOwnProperty(<span class="hljs-string">'key'</span>)) {
    <span class="hljs-keyword">this</span>.key = key;
    <span class="hljs-keyword">this</span>.data.push(value);
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>Same key as root</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.compareKeys(<span class="hljs-keyword">this</span>.key, key) === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.unique) {
      <span class="hljs-keyword">throw</span> { message: <span class="hljs-string">"Can't insert key "</span> + key + <span class="hljs-string">", it violates the unique constraint"</span>
            , key: key
            , errorType: <span class="hljs-string">'uniqueViolated'</span>
            };
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.data.push(value);
    }
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.compareKeys(key, <span class="hljs-keyword">this</span>.key) &lt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>Insert in left subtree</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left) {
      <span class="hljs-keyword">this</span>.left.insert(key, value);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.createLeftChild({ key: key, value: value });
    }
  } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>Insert in right subtree</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right) {
      <span class="hljs-keyword">this</span>.right.insert(key, value);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.createRightChild({ key: key, value: value });
    }
  }
};


<span class="hljs-comment">/**
 * Search for all data corresponding to a key
 */</span>
BinarySearchTree.prototype.search = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasOwnProperty(<span class="hljs-string">'key'</span>)) { <span class="hljs-keyword">return</span> []; }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.compareKeys(<span class="hljs-keyword">this</span>.key, key) === <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.data; }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.compareKeys(key, <span class="hljs-keyword">this</span>.key) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.left.search(key);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> [];
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.right.search(key);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> [];
    }
  }
};


<span class="hljs-comment">/**
 * Return a function that tells whether a given key matches a lower bound
 */</span>
BinarySearchTree.prototype.getLowerBoundMatcher = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(query)</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>No lower bound</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!query.hasOwnProperty(<span class="hljs-string">'$gt'</span>) &amp;&amp; !query.hasOwnProperty(<span class="hljs-string">'$gte'</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; };
  }

  <span class="hljs-keyword">if</span> (query.hasOwnProperty(<span class="hljs-string">'$gt'</span>) &amp;&amp; query.hasOwnProperty(<span class="hljs-string">'$gte'</span>)) {
    <span class="hljs-keyword">if</span> (self.compareKeys(query.$gte, query.$gt) === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{ <span class="hljs-keyword">return</span> self.compareKeys(key, query.$gt) &gt; <span class="hljs-number">0</span>; };
    }

    <span class="hljs-keyword">if</span> (self.compareKeys(query.$gte, query.$gt) &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{ <span class="hljs-keyword">return</span> self.compareKeys(key, query.$gte) &gt;= <span class="hljs-number">0</span>; };
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{ <span class="hljs-keyword">return</span> self.compareKeys(key, query.$gt) &gt; <span class="hljs-number">0</span>; };
    }
  }

  <span class="hljs-keyword">if</span> (query.hasOwnProperty(<span class="hljs-string">'$gt'</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{ <span class="hljs-keyword">return</span> self.compareKeys(key, query.$gt) &gt; <span class="hljs-number">0</span>; };
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{ <span class="hljs-keyword">return</span> self.compareKeys(key, query.$gte) &gt;= <span class="hljs-number">0</span>; };
  }
};


<span class="hljs-comment">/**
 * Return a function that tells whether a given key matches an upper bound
 */</span>
BinarySearchTree.prototype.getUpperBoundMatcher = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(query)</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>No lower bound</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!query.hasOwnProperty(<span class="hljs-string">'$lt'</span>) &amp;&amp; !query.hasOwnProperty(<span class="hljs-string">'$lte'</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; };
  }

  <span class="hljs-keyword">if</span> (query.hasOwnProperty(<span class="hljs-string">'$lt'</span>) &amp;&amp; query.hasOwnProperty(<span class="hljs-string">'$lte'</span>)) {
    <span class="hljs-keyword">if</span> (self.compareKeys(query.$lte, query.$lt) === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{ <span class="hljs-keyword">return</span> self.compareKeys(key, query.$lt) &lt; <span class="hljs-number">0</span>; };
    }

    <span class="hljs-keyword">if</span> (self.compareKeys(query.$lte, query.$lt) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{ <span class="hljs-keyword">return</span> self.compareKeys(key, query.$lte) &lt;= <span class="hljs-number">0</span>; };
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{ <span class="hljs-keyword">return</span> self.compareKeys(key, query.$lt) &lt; <span class="hljs-number">0</span>; };
    }
  }

  <span class="hljs-keyword">if</span> (query.hasOwnProperty(<span class="hljs-string">'$lt'</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{ <span class="hljs-keyword">return</span> self.compareKeys(key, query.$lt) &lt; <span class="hljs-number">0</span>; };
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{ <span class="hljs-keyword">return</span> self.compareKeys(key, query.$lte) &lt;= <span class="hljs-number">0</span>; };
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Append all elements in toAppend to array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">append</span> <span class="hljs-params">(array, toAppend)</span> </span>{
  <span class="hljs-keyword">var</span> i;

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; toAppend.length; i += <span class="hljs-number">1</span>) {
    array.push(toAppend[i]);
  }
}


<span class="hljs-comment">/**
 * Get all data for a key between bounds
 * Return it in key order
 * @param {Object} query Mongo-style query where keys are $lt, $lte, $gt or $gte (other keys are not considered)
 * @param {Functions} lbm/ubm matching functions calculated at the first recursive step
 */</span>
BinarySearchTree.prototype.betweenBounds = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(query, lbm, ubm)</span> </span>{
  <span class="hljs-keyword">var</span> res = [];

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasOwnProperty(<span class="hljs-string">'key'</span>)) { <span class="hljs-keyword">return</span> []; }   <span class="hljs-comment">// Empty tree</span>

  lbm = lbm || <span class="hljs-keyword">this</span>.getLowerBoundMatcher(query);
  ubm = ubm || <span class="hljs-keyword">this</span>.getUpperBoundMatcher(query);

  <span class="hljs-keyword">if</span> (lbm(<span class="hljs-keyword">this</span>.key) &amp;&amp; <span class="hljs-keyword">this</span>.left) { append(res, <span class="hljs-keyword">this</span>.left.betweenBounds(query, lbm, ubm)); }
  <span class="hljs-keyword">if</span> (lbm(<span class="hljs-keyword">this</span>.key) &amp;&amp; ubm(<span class="hljs-keyword">this</span>.key)) { append(res, <span class="hljs-keyword">this</span>.data); }
  <span class="hljs-keyword">if</span> (ubm(<span class="hljs-keyword">this</span>.key) &amp;&amp; <span class="hljs-keyword">this</span>.right) { append(res, <span class="hljs-keyword">this</span>.right.betweenBounds(query, lbm, ubm)); }

  <span class="hljs-keyword">return</span> res;
};


<span class="hljs-comment">/**
 * Delete the current node if it is a leaf
 * Return true if it was deleted
 */</span>
BinarySearchTree.prototype.deleteIfLeaf = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left || <span class="hljs-keyword">this</span>.right) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>The leaf is itself a root</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.parent) {
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.key;
    <span class="hljs-keyword">this</span>.data = [];
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.parent.left === <span class="hljs-keyword">this</span>) {
    <span class="hljs-keyword">this</span>.parent.left = <span class="hljs-literal">null</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.parent.right = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};


<span class="hljs-comment">/**
 * Delete the current node if it has only one child
 * Return true if it was deleted
 */</span>
BinarySearchTree.prototype.deleteIfOnlyOneChild = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> child;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left &amp;&amp; !<span class="hljs-keyword">this</span>.right) { child = <span class="hljs-keyword">this</span>.left; }
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.left &amp;&amp; <span class="hljs-keyword">this</span>.right) { child = <span class="hljs-keyword">this</span>.right; }
  <span class="hljs-keyword">if</span> (!child) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>Root</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.parent) {
    <span class="hljs-keyword">this</span>.key = child.key;
    <span class="hljs-keyword">this</span>.data = child.data;

    <span class="hljs-keyword">this</span>.left = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (child.left) {
      <span class="hljs-keyword">this</span>.left = child.left;
      child.left.parent = <span class="hljs-keyword">this</span>;
    }

    <span class="hljs-keyword">this</span>.right = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (child.right) {
      <span class="hljs-keyword">this</span>.right = child.right;
      child.right.parent = <span class="hljs-keyword">this</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.parent.left === <span class="hljs-keyword">this</span>) {
    <span class="hljs-keyword">this</span>.parent.left = child;
    child.parent = <span class="hljs-keyword">this</span>.parent;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.parent.right = child;
    child.parent = <span class="hljs-keyword">this</span>.parent;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};


<span class="hljs-comment">/**
 * Delete a key or just a value
 * @param {Key} key
 * @param {Value} value Optional. If not set, the whole key is deleted. If set, only this value is deleted
 */</span>
BinarySearchTree.prototype.delete = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, value)</span> </span>{
  <span class="hljs-keyword">var</span> newData = [], replaceWith
    , self = <span class="hljs-keyword">this</span>
    ;

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasOwnProperty(<span class="hljs-string">'key'</span>)) { <span class="hljs-keyword">return</span>; }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.compareKeys(key, <span class="hljs-keyword">this</span>.key) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left) { <span class="hljs-keyword">this</span>.left.delete(key, value); }
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.compareKeys(key, <span class="hljs-keyword">this</span>.key) &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right) { <span class="hljs-keyword">this</span>.right.delete(key, value); }
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.compareKeys(key, <span class="hljs-keyword">this</span>.key) === <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>Delete only a value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data.length &gt; <span class="hljs-number">1</span> &amp;&amp; value) {
    <span class="hljs-keyword">this</span>.data.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
      <span class="hljs-keyword">if</span> (!self.checkValueEquality(d, value)) { newData.push(d); }
    });
    self.data = newData;
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>Delete the whole node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.deleteIfLeaf()) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.deleteIfOnlyOneChild()) {
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>We are in the case where the node to delete has two children</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.random() &gt;= <span class="hljs-number">0.5</span>) {   <span class="hljs-comment">// Randomize replacement to avoid unbalancing the tree too much</span></pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>Use the in-order predecessor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    replaceWith = <span class="hljs-keyword">this</span>.left.getMaxKeyDescendant();

    <span class="hljs-keyword">this</span>.key = replaceWith.key;
    <span class="hljs-keyword">this</span>.data = replaceWith.data;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> === replaceWith.parent) {   <span class="hljs-comment">// Special case</span>
      <span class="hljs-keyword">this</span>.left = replaceWith.left;
      <span class="hljs-keyword">if</span> (replaceWith.left) { replaceWith.left.parent = replaceWith.parent; }
    } <span class="hljs-keyword">else</span> {
      replaceWith.parent.right = replaceWith.left;
      <span class="hljs-keyword">if</span> (replaceWith.left) { replaceWith.left.parent = replaceWith.parent; }
    }
  } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>Use the in-order successor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    replaceWith = <span class="hljs-keyword">this</span>.right.getMinKeyDescendant();

    <span class="hljs-keyword">this</span>.key = replaceWith.key;
    <span class="hljs-keyword">this</span>.data = replaceWith.data;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> === replaceWith.parent) {   <span class="hljs-comment">// Special case</span>
      <span class="hljs-keyword">this</span>.right = replaceWith.right;
      <span class="hljs-keyword">if</span> (replaceWith.right) { replaceWith.right.parent = replaceWith.parent; }
    } <span class="hljs-keyword">else</span> {
      replaceWith.parent.left = replaceWith.right;
      <span class="hljs-keyword">if</span> (replaceWith.right) { replaceWith.right.parent = replaceWith.parent; }
    }
  }
};


<span class="hljs-comment">/**
 * Execute a function on every node of the tree, in key order
 * @param {Function} fn Signature: node. Most useful will probably be node.key and node.data
 */</span>
BinarySearchTree.prototype.executeOnEveryNode = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left) { <span class="hljs-keyword">this</span>.left.executeOnEveryNode(fn); }
  fn(<span class="hljs-keyword">this</span>);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right) { <span class="hljs-keyword">this</span>.right.executeOnEveryNode(fn); }
};


<span class="hljs-comment">/**
 * Pretty print a tree
 * @param {Boolean} printData To print the nodes' data along with the key
 */</span>
BinarySearchTree.prototype.prettyPrint = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(printData, spacing)</span> </span>{
  spacing = spacing || <span class="hljs-string">""</span>;

  <span class="hljs-built_in">console</span>.log(spacing + <span class="hljs-string">"* "</span> + <span class="hljs-keyword">this</span>.key);
  <span class="hljs-keyword">if</span> (printData) { <span class="hljs-built_in">console</span>.log(spacing + <span class="hljs-string">"* "</span> + <span class="hljs-keyword">this</span>.data); }

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.left &amp;&amp; !<span class="hljs-keyword">this</span>.right) { <span class="hljs-keyword">return</span>; }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left) {
    <span class="hljs-keyword">this</span>.left.prettyPrint(printData, spacing + <span class="hljs-string">"  "</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">console</span>.log(spacing + <span class="hljs-string">"  *"</span>);
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.right) {
    <span class="hljs-keyword">this</span>.right.prettyPrint(printData, spacing + <span class="hljs-string">"  "</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">console</span>.log(spacing + <span class="hljs-string">"  *"</span>);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>Interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = BinarySearchTree;

},{<span class="hljs-string">"./customUtils"</span>:<span class="hljs-number">15</span>}],<span class="hljs-number">15</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{
<span class="hljs-comment">/**
 * Return an array with the numbers from 0 to n-1, in a random order
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRandomArray</span> <span class="hljs-params">(n)</span> </span>{
  <span class="hljs-keyword">var</span> res, next;

  <span class="hljs-keyword">if</span> (n === <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> []; }
  <span class="hljs-keyword">if</span> (n === <span class="hljs-number">1</span>) { <span class="hljs-keyword">return</span> [<span class="hljs-number">0</span>]; }

  res = getRandomArray(n - <span class="hljs-number">1</span>);
  next = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * n);
  res.splice(next, <span class="hljs-number">0</span>, n - <span class="hljs-number">1</span>);   <span class="hljs-comment">// Add n-1 at a random position in the array</span>

  <span class="hljs-keyword">return</span> res;
};
<span class="hljs-built_in">module</span>.exports.getRandomArray = getRandomArray;


<span class="hljs-comment">/*
 * Default compareKeys function will work for numbers, strings and dates
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">defaultCompareKeysFunction</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">if</span> (a &lt; b) { <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (a &gt; b) { <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (a === b) { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }

  <span class="hljs-keyword">throw</span> { message: <span class="hljs-string">"Couldn't compare elements"</span>, a: a, b: b };
}
<span class="hljs-built_in">module</span>.exports.defaultCompareKeysFunction = defaultCompareKeysFunction;


<span class="hljs-comment">/**
 * Check whether two values are equal (used in non-unique deletion)
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">defaultCheckValueEquality</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> a === b;
}
<span class="hljs-built_in">module</span>.exports.defaultCheckValueEquality = defaultCheckValueEquality;

},{}],<span class="hljs-number">16</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require,module,exports)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <pre><code>Underscore.js <span class="hljs-number">1.4</span><span class="hljs-number">.4</span>
http:<span class="hljs-comment">//underscorejs.org</span>
(c) <span class="hljs-number">2009</span>-<span class="hljs-number">2013</span> Jeremy Ashkenas, DocumentCloud Inc.
Underscore may be freely distributed under the MIT license.
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <h2 id="baseline-setup">Baseline setup</h2>

            </div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>Establish the root object, <code>window</code> in the browser, or <code>global</code> on the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> root = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>Save the previous value of the <code>_</code> variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> previousUnderscore = root._;</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>Establish the object that gets returned to break out of a loop iteration.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> breaker = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>Save bytes in the minified (but not gzipped) version:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> ArrayProto = <span class="hljs-built_in">Array</span>.prototype, ObjProto = <span class="hljs-built_in">Object</span>.prototype, FuncProto = <span class="hljs-built_in">Function</span>.prototype;</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>Create quick reference variables for speed access to core prototypes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> push             = ArrayProto.push,
      slice            = ArrayProto.slice,
      concat           = ArrayProto.concat,
      toString         = ObjProto.toString,
      hasOwnProperty   = ObjProto.hasOwnProperty;</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>All <strong>ECMAScript 5</strong> native function implementations that we hope to use
are declared here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span>
    nativeForEach      = ArrayProto.forEach,
    nativeMap          = ArrayProto.map,
    nativeReduce       = ArrayProto.reduce,
    nativeReduceRight  = ArrayProto.reduceRight,
    nativeFilter       = ArrayProto.filter,
    nativeEvery        = ArrayProto.every,
    nativeSome         = ArrayProto.some,
    nativeIndexOf      = ArrayProto.indexOf,
    nativeLastIndexOf  = ArrayProto.lastIndexOf,
    nativeIsArray      = <span class="hljs-built_in">Array</span>.isArray,
    nativeKeys         = <span class="hljs-built_in">Object</span>.keys,
    nativeBind         = FuncProto.bind;</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>Create a safe reference to the Underscore object for use below.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> _ = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> _) <span class="hljs-keyword">return</span> obj;
    <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> _)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> _(obj);
    <span class="hljs-keyword">this</span>._wrapped = obj;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>Export the Underscore object for <strong>Node.js</strong>, with
backwards-compatibility for the old <code>require()</code> API. If we’re in
the browser, add <code>_</code> as a global object via a string identifier,
for Closure Compiler “advanced” mode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> exports !== <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-built_in">module</span>.exports) {
      exports = <span class="hljs-built_in">module</span>.exports = _;
    }
    exports._ = _;
  } <span class="hljs-keyword">else</span> {
    root._ = _;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>Current version.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.VERSION = <span class="hljs-string">'1.4.4'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <h2 id="collection-functions">Collection Functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>The cornerstone, an <code>each</code> implementation, aka <code>forEach</code>.
Handles objects with the built-in <code>forEach</code>, arrays, and raw objects.
Delegates to <strong>ECMAScript 5</strong>‘s native <code>forEach</code> if available.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> each = _.each = _.forEach = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, iterator, context)</span> </span>{
    <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (nativeForEach &amp;&amp; obj.forEach === nativeForEach) {
      obj.forEach(iterator, context);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (obj.length === +obj.length) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = obj.length; i &lt; l; i++) {
        <span class="hljs-keyword">if</span> (iterator.call(context, obj[i], i, obj) === breaker) <span class="hljs-keyword">return</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj) {
        <span class="hljs-keyword">if</span> (_.has(obj, key)) {
          <span class="hljs-keyword">if</span> (iterator.call(context, obj[key], key, obj) === breaker) <span class="hljs-keyword">return</span>;
        }
      }
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>Return the results of applying the iterator to each element.
Delegates to <strong>ECMAScript 5</strong>‘s native <code>map</code> if available.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.map = _.collect = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, iterator, context)</span> </span>{
    <span class="hljs-keyword">var</span> results = [];
    <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> results;
    <span class="hljs-keyword">if</span> (nativeMap &amp;&amp; obj.map === nativeMap) <span class="hljs-keyword">return</span> obj.map(iterator, context);
    each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, index, list)</span> </span>{
      results[results.length] = iterator.call(context, value, index, list);
    });
    <span class="hljs-keyword">return</span> results;
  };

  <span class="hljs-keyword">var</span> reduceError = <span class="hljs-string">'Reduce of empty array with no initial value'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p><strong>Reduce</strong> builds up a single result from a list of values, aka <code>inject</code>,
or <code>foldl</code>. Delegates to <strong>ECMAScript 5</strong>‘s native <code>reduce</code> if available.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.reduce = _.foldl = _.inject = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, iterator, memo, context)</span> </span>{
    <span class="hljs-keyword">var</span> initial = <span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">2</span>;
    <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) obj = [];
    <span class="hljs-keyword">if</span> (nativeReduce &amp;&amp; obj.reduce === nativeReduce) {
      <span class="hljs-keyword">if</span> (context) iterator = _.bind(iterator, context);
      <span class="hljs-keyword">return</span> initial ? obj.reduce(iterator, memo) : obj.reduce(iterator);
    }
    each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, index, list)</span> </span>{
      <span class="hljs-keyword">if</span> (!initial) {
        memo = value;
        initial = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        memo = iterator.call(context, memo, value, index, list);
      }
    });
    <span class="hljs-keyword">if</span> (!initial) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(reduceError);
    <span class="hljs-keyword">return</span> memo;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>The right-associative version of reduce, also known as <code>foldr</code>.
Delegates to <strong>ECMAScript 5</strong>‘s native <code>reduceRight</code> if available.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.reduceRight = _.foldr = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, iterator, memo, context)</span> </span>{
    <span class="hljs-keyword">var</span> initial = <span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">2</span>;
    <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) obj = [];
    <span class="hljs-keyword">if</span> (nativeReduceRight &amp;&amp; obj.reduceRight === nativeReduceRight) {
      <span class="hljs-keyword">if</span> (context) iterator = _.bind(iterator, context);
      <span class="hljs-keyword">return</span> initial ? obj.reduceRight(iterator, memo) : obj.reduceRight(iterator);
    }
    <span class="hljs-keyword">var</span> length = obj.length;
    <span class="hljs-keyword">if</span> (length !== +length) {
      <span class="hljs-keyword">var</span> keys = _.keys(obj);
      length = keys.length;
    }
    each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, index, list)</span> </span>{
      index = keys ? keys[--length] : --length;
      <span class="hljs-keyword">if</span> (!initial) {
        memo = obj[index];
        initial = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        memo = iterator.call(context, memo, obj[index], index, list);
      }
    });
    <span class="hljs-keyword">if</span> (!initial) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(reduceError);
    <span class="hljs-keyword">return</span> memo;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>Return the first value which passes a truth test. Aliased as <code>detect</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.find = _.detect = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, iterator, context)</span> </span>{
    <span class="hljs-keyword">var</span> result;
    any(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, index, list)</span> </span>{
      <span class="hljs-keyword">if</span> (iterator.call(context, value, index, list)) {
        result = value;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
    });
    <span class="hljs-keyword">return</span> result;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p>Return all the elements that pass a truth test.
Delegates to <strong>ECMAScript 5</strong>‘s native <code>filter</code> if available.
Aliased as <code>select</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.filter = _.select = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, iterator, context)</span> </span>{
    <span class="hljs-keyword">var</span> results = [];
    <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> results;
    <span class="hljs-keyword">if</span> (nativeFilter &amp;&amp; obj.filter === nativeFilter) <span class="hljs-keyword">return</span> obj.filter(iterator, context);
    each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, index, list)</span> </span>{
      <span class="hljs-keyword">if</span> (iterator.call(context, value, index, list)) results[results.length] = value;
    });
    <span class="hljs-keyword">return</span> results;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>Return all the elements for which a truth test fails.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.reject = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, iterator, context)</span> </span>{
    <span class="hljs-keyword">return</span> _.filter(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, index, list)</span> </span>{
      <span class="hljs-keyword">return</span> !iterator.call(context, value, index, list);
    }, context);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>Determine whether all of the elements match a truth test.
Delegates to <strong>ECMAScript 5</strong>‘s native <code>every</code> if available.
Aliased as <code>all</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.every = _.all = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, iterator, context)</span> </span>{
    iterator || (iterator = _.identity);
    <span class="hljs-keyword">var</span> result = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> result;
    <span class="hljs-keyword">if</span> (nativeEvery &amp;&amp; obj.every === nativeEvery) <span class="hljs-keyword">return</span> obj.every(iterator, context);
    each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, index, list)</span> </span>{
      <span class="hljs-keyword">if</span> (!(result = result &amp;&amp; iterator.call(context, value, index, list))) <span class="hljs-keyword">return</span> breaker;
    });
    <span class="hljs-keyword">return</span> !!result;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>Determine if at least one element in the object matches a truth test.
Delegates to <strong>ECMAScript 5</strong>‘s native <code>some</code> if available.
Aliased as <code>any</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> any = _.some = _.any = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, iterator, context)</span> </span>{
    iterator || (iterator = _.identity);
    <span class="hljs-keyword">var</span> result = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> result;
    <span class="hljs-keyword">if</span> (nativeSome &amp;&amp; obj.some === nativeSome) <span class="hljs-keyword">return</span> obj.some(iterator, context);
    each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, index, list)</span> </span>{
      <span class="hljs-keyword">if</span> (result || (result = iterator.call(context, value, index, list))) <span class="hljs-keyword">return</span> breaker;
    });
    <span class="hljs-keyword">return</span> !!result;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>Determine if the array or object contains a given value (using <code>===</code>).
Aliased as <code>include</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.contains = _.include = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, target)</span> </span>{
    <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (nativeIndexOf &amp;&amp; obj.indexOf === nativeIndexOf) <span class="hljs-keyword">return</span> obj.indexOf(target) != -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> any(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
      <span class="hljs-keyword">return</span> value === target;
    });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>Invoke a method (with arguments) on every item in a collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.invoke = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, method)</span> </span>{
    <span class="hljs-keyword">var</span> args = slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>);
    <span class="hljs-keyword">var</span> isFunc = _.isFunction(method);
    <span class="hljs-keyword">return</span> _.map(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
      <span class="hljs-keyword">return</span> (isFunc ? method : value[method]).apply(value, args);
    });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p>Convenience version of a common use case of <code>map</code>: fetching a property.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.pluck = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, key)</span> </span>{
    <span class="hljs-keyword">return</span> _.map(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span></span>{ <span class="hljs-keyword">return</span> value[key]; });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>Convenience version of a common use case of <code>filter</code>: selecting only objects
containing specific <code>key:value</code> pairs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.where = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, attrs, first)</span> </span>{
    <span class="hljs-keyword">if</span> (_.isEmpty(attrs)) <span class="hljs-keyword">return</span> first ? <span class="hljs-literal">null</span> : [];
    <span class="hljs-keyword">return</span> _[first ? <span class="hljs-string">'find'</span> : <span class="hljs-string">'filter'</span>](obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> attrs) {
        <span class="hljs-keyword">if</span> (attrs[key] !== value[key]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>Convenience version of a common use case of <code>find</code>: getting the first object
containing specific <code>key:value</code> pairs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.findWhere = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, attrs)</span> </span>{
    <span class="hljs-keyword">return</span> _.where(obj, attrs, <span class="hljs-literal">true</span>);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p>Return the maximum element or (element-based computation).
Can’t optimize arrays of integers longer than 65,535 elements.
See: <a href="https://bugs.webkit.org/show_bug.cgi?id=80797">https://bugs.webkit.org/show_bug.cgi?id=80797</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.max = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, iterator, context)</span> </span>{
    <span class="hljs-keyword">if</span> (!iterator &amp;&amp; _.isArray(obj) &amp;&amp; obj[<span class="hljs-number">0</span>] === +obj[<span class="hljs-number">0</span>] &amp;&amp; obj.length &lt; <span class="hljs-number">65535</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.max.apply(<span class="hljs-built_in">Math</span>, obj);
    }
    <span class="hljs-keyword">if</span> (!iterator &amp;&amp; _.isEmpty(obj)) <span class="hljs-keyword">return</span> -<span class="hljs-literal">Infinity</span>;
    <span class="hljs-keyword">var</span> result = {computed : -<span class="hljs-literal">Infinity</span>, value: -<span class="hljs-literal">Infinity</span>};
    each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, index, list)</span> </span>{
      <span class="hljs-keyword">var</span> computed = iterator ? iterator.call(context, value, index, list) : value;
      computed &gt;= result.computed &amp;&amp; (result = {value : value, computed : computed});
    });
    <span class="hljs-keyword">return</span> result.value;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p>Return the minimum element (or element-based computation).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.min = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, iterator, context)</span> </span>{
    <span class="hljs-keyword">if</span> (!iterator &amp;&amp; _.isArray(obj) &amp;&amp; obj[<span class="hljs-number">0</span>] === +obj[<span class="hljs-number">0</span>] &amp;&amp; obj.length &lt; <span class="hljs-number">65535</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.min.apply(<span class="hljs-built_in">Math</span>, obj);
    }
    <span class="hljs-keyword">if</span> (!iterator &amp;&amp; _.isEmpty(obj)) <span class="hljs-keyword">return</span> <span class="hljs-literal">Infinity</span>;
    <span class="hljs-keyword">var</span> result = {computed : <span class="hljs-literal">Infinity</span>, value: <span class="hljs-literal">Infinity</span>};
    each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, index, list)</span> </span>{
      <span class="hljs-keyword">var</span> computed = iterator ? iterator.call(context, value, index, list) : value;
      computed &lt; result.computed &amp;&amp; (result = {value : value, computed : computed});
    });
    <span class="hljs-keyword">return</span> result.value;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>Shuffle an array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.shuffle = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> rand;
    <span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> shuffled = [];
    each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
      rand = _.random(index++);
      shuffled[index - <span class="hljs-number">1</span>] = shuffled[rand];
      shuffled[rand] = value;
    });
    <span class="hljs-keyword">return</span> shuffled;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p>An internal function to generate lookup iterators.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> lookupIterator = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">return</span> _.isFunction(value) ? value : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span></span>{ <span class="hljs-keyword">return</span> obj[value]; };
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <p>Sort the object’s values by a criterion produced by an iterator.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.sortBy = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, value, context)</span> </span>{
    <span class="hljs-keyword">var</span> iterator = lookupIterator(value);
    <span class="hljs-keyword">return</span> _.pluck(_.map(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, index, list)</span> </span>{
      <span class="hljs-keyword">return</span> {
        value : value,
        index : index,
        criteria : iterator.call(context, value, index, list)
      };
    }).sort(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(left, right)</span> </span>{
      <span class="hljs-keyword">var</span> a = left.criteria;
      <span class="hljs-keyword">var</span> b = right.criteria;
      <span class="hljs-keyword">if</span> (a !== b) {
        <span class="hljs-keyword">if</span> (a &gt; b || a === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (a &lt; b || b === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
      }
      <span class="hljs-keyword">return</span> left.index &lt; right.index ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
    }), <span class="hljs-string">'value'</span>);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p>An internal function used for aggregate “group by” operations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> group = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, value, context, behavior)</span> </span>{
    <span class="hljs-keyword">var</span> result = {};
    <span class="hljs-keyword">var</span> iterator = lookupIterator(value || _.identity);
    each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, index)</span> </span>{
      <span class="hljs-keyword">var</span> key = iterator.call(context, value, index, obj);
      behavior(result, key, value);
    });
    <span class="hljs-keyword">return</span> result;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p>Groups the object’s values by a criterion. Pass either a string attribute
to group by, or a function that returns the criterion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.groupBy = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, value, context)</span> </span>{
    <span class="hljs-keyword">return</span> group(obj, value, context, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result, key, value)</span> </span>{
      (_.has(result, key) ? result[key] : (result[key] = [])).push(value);
    });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p>Counts instances of an object that group by a certain criterion. Pass
either a string attribute to count by, or a function that returns the
criterion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.countBy = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, value, context)</span> </span>{
    <span class="hljs-keyword">return</span> group(obj, value, context, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result, key)</span> </span>{
      <span class="hljs-keyword">if</span> (!_.has(result, key)) result[key] = <span class="hljs-number">0</span>;
      result[key]++;
    });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p>Use a comparator function to figure out the smallest index at which
an object should be inserted so as to maintain order. Uses binary search.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.sortedIndex = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, obj, iterator, context)</span> </span>{
    iterator = iterator == <span class="hljs-literal">null</span> ? _.identity : lookupIterator(iterator);
    <span class="hljs-keyword">var</span> value = iterator.call(context, obj);
    <span class="hljs-keyword">var</span> low = <span class="hljs-number">0</span>, high = array.length;
    <span class="hljs-keyword">while</span> (low &lt; high) {
      <span class="hljs-keyword">var</span> mid = (low + high) &gt;&gt;&gt; <span class="hljs-number">1</span>;
      iterator.call(context, array[mid]) &lt; value ? low = mid + <span class="hljs-number">1</span> : high = mid;
    }
    <span class="hljs-keyword">return</span> low;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>Safely convert anything iterable into a real, live array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.toArray = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">if</span> (!obj) <span class="hljs-keyword">return</span> [];
    <span class="hljs-keyword">if</span> (_.isArray(obj)) <span class="hljs-keyword">return</span> slice.call(obj);
    <span class="hljs-keyword">if</span> (obj.length === +obj.length) <span class="hljs-keyword">return</span> _.map(obj, _.identity);
    <span class="hljs-keyword">return</span> _.values(obj);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p>Return the number of elements in an object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.size = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> (obj.length === +obj.length) ? obj.length : _.keys(obj).length;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <h2 id="array-functions">Array Functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p>Get the first element of an array. Passing <strong>n</strong> will return the first N
values in the array. Aliased as <code>head</code> and <code>take</code>. The <strong>guard</strong> check
allows it to work with <code>_.map</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.first = _.head = _.take = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, n, guard)</span> </span>{
    <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> (n != <span class="hljs-literal">null</span>) &amp;&amp; !guard ? slice.call(array, <span class="hljs-number">0</span>, n) : array[<span class="hljs-number">0</span>];
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p>Returns everything but the last entry of the array. Especially useful on
the arguments object. Passing <strong>n</strong> will return all the values in
the array, excluding the last N. The <strong>guard</strong> check allows it to work with
<code>_.map</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.initial = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, n, guard)</span> </span>{
    <span class="hljs-keyword">return</span> slice.call(array, <span class="hljs-number">0</span>, array.length - ((n == <span class="hljs-literal">null</span>) || guard ? <span class="hljs-number">1</span> : n));
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>Get the last element of an array. Passing <strong>n</strong> will return the last N
values in the array. The <strong>guard</strong> check allows it to work with <code>_.map</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.last = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, n, guard)</span> </span>{
    <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> ((n != <span class="hljs-literal">null</span>) &amp;&amp; !guard) {
      <span class="hljs-keyword">return</span> slice.call(array, <span class="hljs-built_in">Math</span>.max(array.length - n, <span class="hljs-number">0</span>));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> array[array.length - <span class="hljs-number">1</span>];
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>Returns everything but the first entry of the array. Aliased as <code>tail</code> and <code>drop</code>.
Especially useful on the arguments object. Passing an <strong>n</strong> will return
the rest N values in the array. The <strong>guard</strong>
check allows it to work with <code>_.map</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.rest = _.tail = _.drop = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, n, guard)</span> </span>{
    <span class="hljs-keyword">return</span> slice.call(array, (n == <span class="hljs-literal">null</span>) || guard ? <span class="hljs-number">1</span> : n);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p>Trim out all falsy values from an array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.compact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array)</span> </span>{
    <span class="hljs-keyword">return</span> _.filter(array, _.identity);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p>Internal implementation of a recursive <code>flatten</code> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> flatten = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(input, shallow, output)</span> </span>{
    each(input, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
      <span class="hljs-keyword">if</span> (_.isArray(value)) {
        shallow ? push.apply(output, value) : flatten(value, shallow, output);
      } <span class="hljs-keyword">else</span> {
        output.push(value);
      }
    });
    <span class="hljs-keyword">return</span> output;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p>Return a completely flattened version of an array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.flatten = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, shallow)</span> </span>{
    <span class="hljs-keyword">return</span> flatten(array, shallow, []);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p>Return a version of the array that does not contain the specified value(s).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.without = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array)</span> </span>{
    <span class="hljs-keyword">return</span> _.difference(array, slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>));
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p>Produce a duplicate-free version of the array. If the array has already
been sorted, you have the option of using a faster algorithm.
Aliased as <code>unique</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.uniq = _.unique = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, isSorted, iterator, context)</span> </span>{
    <span class="hljs-keyword">if</span> (_.isFunction(isSorted)) {
      context = iterator;
      iterator = isSorted;
      isSorted = <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">var</span> initial = iterator ? _.map(array, iterator, context) : array;
    <span class="hljs-keyword">var</span> results = [];
    <span class="hljs-keyword">var</span> seen = [];
    each(initial, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, index)</span> </span>{
      <span class="hljs-keyword">if</span> (isSorted ? (!index || seen[seen.length - <span class="hljs-number">1</span>] !== value) : !_.contains(seen, value)) {
        seen.push(value);
        results.push(array[index]);
      }
    });
    <span class="hljs-keyword">return</span> results;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>Produce an array that contains the union: each distinct element from all of
the passed-in arrays.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.union = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> _.uniq(concat.apply(ArrayProto, <span class="hljs-built_in">arguments</span>));
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <p>Produce an array that contains every item shared between all the
passed-in arrays.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.intersection = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array)</span> </span>{
    <span class="hljs-keyword">var</span> rest = slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">return</span> _.filter(_.uniq(array), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> </span>{
      <span class="hljs-keyword">return</span> _.every(rest, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(other)</span> </span>{
        <span class="hljs-keyword">return</span> _.indexOf(other, item) &gt;= <span class="hljs-number">0</span>;
      });
    });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              <p>Take the difference between one array and a number of other arrays.
Only the elements present in just the first array will remain.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.difference = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array)</span> </span>{
    <span class="hljs-keyword">var</span> rest = concat.apply(ArrayProto, slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>));
    <span class="hljs-keyword">return</span> _.filter(array, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span></span>{ <span class="hljs-keyword">return</span> !_.contains(rest, value); });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-207">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <p>Zip together multiple lists into a single array — elements that share
an index go together.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.zip = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> length = _.max(_.pluck(args, <span class="hljs-string">'length'</span>));
    <span class="hljs-keyword">var</span> results = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(length);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) {
      results[i] = _.pluck(args, <span class="hljs-string">""</span> + i);
    }
    <span class="hljs-keyword">return</span> results;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-208">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <p>Converts lists into objects. Pass either a single array of <code>[key, value]</code>
pairs, or two parallel arrays of the same length — one of keys, and one of
the corresponding values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.object = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(list, values)</span> </span>{
    <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> {};
    <span class="hljs-keyword">var</span> result = {};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = list.length; i &lt; l; i++) {
      <span class="hljs-keyword">if</span> (values) {
        result[list[i]] = values[i];
      } <span class="hljs-keyword">else</span> {
        result[list[i][<span class="hljs-number">0</span>]] = list[i][<span class="hljs-number">1</span>];
      }
    }
    <span class="hljs-keyword">return</span> result;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-209">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              <p>If the browser doesn’t supply us with indexOf (I’m looking at you, <strong>MSIE</strong>),
we need this function. Return the position of the first occurrence of an
item in an array, or -1 if the item is not included in the array.
Delegates to <strong>ECMAScript 5</strong>‘s native <code>indexOf</code> if available.
If the array is large and already in sort order, pass <code>true</code>
for <strong>isSorted</strong> to use binary search.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.indexOf = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, item, isSorted)</span> </span>{
    <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = array.length;
    <span class="hljs-keyword">if</span> (isSorted) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> isSorted == <span class="hljs-string">'number'</span>) {
        i = (isSorted &lt; <span class="hljs-number">0</span> ? <span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, l + isSorted) : isSorted);
      } <span class="hljs-keyword">else</span> {
        i = _.sortedIndex(array, item);
        <span class="hljs-keyword">return</span> array[i] === item ? i : -<span class="hljs-number">1</span>;
      }
    }
    <span class="hljs-keyword">if</span> (nativeIndexOf &amp;&amp; array.indexOf === nativeIndexOf) <span class="hljs-keyword">return</span> array.indexOf(item, isSorted);
    <span class="hljs-keyword">for</span> (; i &lt; l; i++) <span class="hljs-keyword">if</span> (array[i] === item) <span class="hljs-keyword">return</span> i;
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-210">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              <p>Delegates to <strong>ECMAScript 5</strong>‘s native <code>lastIndexOf</code> if available.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.lastIndexOf = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, item, from)</span> </span>{
    <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> hasIndex = from != <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (nativeLastIndexOf &amp;&amp; array.lastIndexOf === nativeLastIndexOf) {
      <span class="hljs-keyword">return</span> hasIndex ? array.lastIndexOf(item, from) : array.lastIndexOf(item);
    }
    <span class="hljs-keyword">var</span> i = (hasIndex ? from : array.length);
    <span class="hljs-keyword">while</span> (i--) <span class="hljs-keyword">if</span> (array[i] === item) <span class="hljs-keyword">return</span> i;
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-211">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <p>Generate an integer Array containing an arithmetic progression. A port of
the native Python <code>range()</code> function. See
<a href="http://docs.python.org/library/functions.html#range">the Python documentation</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.range = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(start, stop, step)</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt;= <span class="hljs-number">1</span>) {
      stop = start || <span class="hljs-number">0</span>;
      start = <span class="hljs-number">0</span>;
    }
    step = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">2</span>] || <span class="hljs-number">1</span>;

    <span class="hljs-keyword">var</span> len = <span class="hljs-built_in">Math</span>.max(<span class="hljs-built_in">Math</span>.ceil((stop - start) / step), <span class="hljs-number">0</span>);
    <span class="hljs-keyword">var</span> idx = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> range = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(len);

    <span class="hljs-keyword">while</span>(idx &lt; len) {
      range[idx++] = start;
      start += step;
    }

    <span class="hljs-keyword">return</span> range;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-212">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              <h2 id="function-ahem-functions">Function (ahem) Functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-213">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              <p>Create a function bound to a given object (assigning <code>this</code>, and arguments,
optionally). Delegates to <strong>ECMAScript 5</strong>‘s native <code>Function.bind</code> if
available.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.bind = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(func, context)</span> </span>{
    <span class="hljs-keyword">if</span> (func.bind === nativeBind &amp;&amp; nativeBind) <span class="hljs-keyword">return</span> nativeBind.apply(func, slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>));
    <span class="hljs-keyword">var</span> args = slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> func.apply(context, args.concat(slice.call(<span class="hljs-built_in">arguments</span>)));
    };
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-214">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p>Partially apply a function by creating a version that has had some of its
arguments pre-filled, without changing its dynamic <code>this</code> context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.partial = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(func)</span> </span>{
    <span class="hljs-keyword">var</span> args = slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> func.apply(<span class="hljs-keyword">this</span>, args.concat(slice.call(<span class="hljs-built_in">arguments</span>)));
    };
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-215">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p>Bind all of an object’s methods to that object. Useful for ensuring that
all callbacks defined on an object belong to it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.bindAll = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> funcs = slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span> (funcs.length === <span class="hljs-number">0</span>) funcs = _.functions(obj);
    each(funcs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span> </span>{ obj[f] = _.bind(obj[f], obj); });
    <span class="hljs-keyword">return</span> obj;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-216">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <p>Memoize an expensive function by storing its results.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.memoize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(func, hasher)</span> </span>{
    <span class="hljs-keyword">var</span> memo = {};
    hasher || (hasher = _.identity);
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> key = hasher.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
      <span class="hljs-keyword">return</span> _.has(memo, key) ? memo[key] : (memo[key] = func.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>));
    };
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-217">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              <p>Delays a function for the given number of milliseconds, and then calls
it with the arguments supplied.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.delay = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(func, wait)</span> </span>{
    <span class="hljs-keyword">var</span> args = slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>);
    <span class="hljs-keyword">return</span> setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> func.apply(<span class="hljs-literal">null</span>, args); }, wait);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-218">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <p>Defers a function, scheduling it to run after the current call stack has
cleared.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.defer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(func)</span> </span>{
    <span class="hljs-keyword">return</span> _.delay.apply(_, [func, <span class="hljs-number">1</span>].concat(slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>)));
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-219">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p>Returns a function, that, when invoked, will only be triggered at most once
during a given window of time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.throttle = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(func, wait)</span> </span>{
    <span class="hljs-keyword">var</span> context, args, timeout, result;
    <span class="hljs-keyword">var</span> previous = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> later = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      previous = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>;
      timeout = <span class="hljs-literal">null</span>;
      result = func.apply(context, args);
    };
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>;
      <span class="hljs-keyword">var</span> remaining = wait - (now - previous);
      context = <span class="hljs-keyword">this</span>;
      args = <span class="hljs-built_in">arguments</span>;
      <span class="hljs-keyword">if</span> (remaining &lt;= <span class="hljs-number">0</span>) {
        clearTimeout(timeout);
        timeout = <span class="hljs-literal">null</span>;
        previous = now;
        result = func.apply(context, args);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!timeout) {
        timeout = setTimeout(later, remaining);
      }
      <span class="hljs-keyword">return</span> result;
    };
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-220">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p>Returns a function, that, as long as it continues to be invoked, will not
be triggered. The function will be called after it stops being called for
N milliseconds. If <code>immediate</code> is passed, trigger the function on the
leading edge, instead of the trailing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.debounce = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(func, wait, immediate)</span> </span>{
    <span class="hljs-keyword">var</span> timeout, result;
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">this</span>, args = <span class="hljs-built_in">arguments</span>;
      <span class="hljs-keyword">var</span> later = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        timeout = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (!immediate) result = func.apply(context, args);
      };
      <span class="hljs-keyword">var</span> callNow = immediate &amp;&amp; !timeout;
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
      <span class="hljs-keyword">if</span> (callNow) result = func.apply(context, args);
      <span class="hljs-keyword">return</span> result;
    };
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-221">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <p>Returns a function that will be executed at most one time, no matter how
often you call it. Useful for lazy initialization.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.once = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(func)</span> </span>{
    <span class="hljs-keyword">var</span> ran = <span class="hljs-literal">false</span>, memo;
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span> (ran) <span class="hljs-keyword">return</span> memo;
      ran = <span class="hljs-literal">true</span>;
      memo = func.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
      func = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">return</span> memo;
    };
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-222">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              <p>Returns the first function passed as an argument to the second,
allowing you to adjust arguments, run code before and after, and
conditionally execute the original function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.wrap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(func, wrapper)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> args = [func];
      push.apply(args, <span class="hljs-built_in">arguments</span>);
      <span class="hljs-keyword">return</span> wrapper.apply(<span class="hljs-keyword">this</span>, args);
    };
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-223">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <p>Returns a function that is the composition of a list of functions, each
consuming the return value of the function that follows.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.compose = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> funcs = <span class="hljs-built_in">arguments</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = funcs.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
        args = [funcs[i].apply(<span class="hljs-keyword">this</span>, args)];
      }
      <span class="hljs-keyword">return</span> args[<span class="hljs-number">0</span>];
    };
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-224">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <p>Returns a function that will only be executed after being called N times.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.after = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(times, func)</span> </span>{
    <span class="hljs-keyword">if</span> (times &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> func();
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span> (--times &lt; <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> func.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
      }
    };
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-225">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              <h2 id="object-functions">Object Functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-226">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              <p>Retrieve the names of an object’s properties.
Delegates to <strong>ECMAScript 5</strong>‘s native <code>Object.keys</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.keys = nativeKeys || <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">if</span> (obj !== <span class="hljs-built_in">Object</span>(obj)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'Invalid object'</span>);
    <span class="hljs-keyword">var</span> keys = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj) <span class="hljs-keyword">if</span> (_.has(obj, key)) keys[keys.length] = key;
    <span class="hljs-keyword">return</span> keys;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-227">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p>Retrieve the values of an object’s properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.values = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> values = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj) <span class="hljs-keyword">if</span> (_.has(obj, key)) values.push(obj[key]);
    <span class="hljs-keyword">return</span> values;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-228">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <p>Convert an object into a list of <code>[key, value]</code> pairs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.pairs = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> pairs = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj) <span class="hljs-keyword">if</span> (_.has(obj, key)) pairs.push([key, obj[key]]);
    <span class="hljs-keyword">return</span> pairs;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-229">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p>Invert the keys and values of an object. The values must be serializable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.invert = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> result = {};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj) <span class="hljs-keyword">if</span> (_.has(obj, key)) result[obj[key]] = key;
    <span class="hljs-keyword">return</span> result;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-230">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <p>Return a sorted list of the function names available on the object.
Aliased as <code>methods</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.functions = _.methods = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> names = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj) {
      <span class="hljs-keyword">if</span> (_.isFunction(obj[key])) names.push(key);
    }
    <span class="hljs-keyword">return</span> names.sort();
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-231">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              <p>Extend a given object with all the properties in passed-in object(s).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.extend = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    each(slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(source)</span> </span>{
      <span class="hljs-keyword">if</span> (source) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> prop <span class="hljs-keyword">in</span> source) {
          obj[prop] = source[prop];
        }
      }
    });
    <span class="hljs-keyword">return</span> obj;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-232">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              <p>Return a copy of the object only containing the whitelisted properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.pick = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> copy = {};
    <span class="hljs-keyword">var</span> keys = concat.apply(ArrayProto, slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>));
    each(keys, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
      <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> obj) copy[key] = obj[key];
    });
    <span class="hljs-keyword">return</span> copy;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-233">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              <p>Return a copy of the object without the blacklisted properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.omit = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> copy = {};
    <span class="hljs-keyword">var</span> keys = concat.apply(ArrayProto, slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>));
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj) {
      <span class="hljs-keyword">if</span> (!_.contains(keys, key)) copy[key] = obj[key];
    }
    <span class="hljs-keyword">return</span> copy;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-234">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <p>Fill in a given object with default properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.defaults = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    each(slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(source)</span> </span>{
      <span class="hljs-keyword">if</span> (source) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> prop <span class="hljs-keyword">in</span> source) {
          <span class="hljs-keyword">if</span> (obj[prop] == <span class="hljs-literal">null</span>) obj[prop] = source[prop];
        }
      }
    });
    <span class="hljs-keyword">return</span> obj;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-235">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <p>Create a (shallow-cloned) duplicate of an object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.clone = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">if</span> (!_.isObject(obj)) <span class="hljs-keyword">return</span> obj;
    <span class="hljs-keyword">return</span> _.isArray(obj) ? obj.slice() : _.extend({}, obj);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-236">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p>Invokes interceptor with the obj, and then returns obj.
The primary purpose of this method is to “tap into” a method chain, in
order to perform operations on intermediate results within the chain.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.tap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, interceptor)</span> </span>{
    interceptor(obj);
    <span class="hljs-keyword">return</span> obj;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-237">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p>Internal recursive comparison function for <code>isEqual</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> eq = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b, aStack, bStack)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-238">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>Identical objects are equal. <code>0 === -0</code>, but they aren’t identical.
See the Harmony <code>egal</code> proposal: <a href="http://wiki.ecmascript.org/doku.php?id=harmony:egal">http://wiki.ecmascript.org/doku.php?id=harmony:egal</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (a === b) <span class="hljs-keyword">return</span> a !== <span class="hljs-number">0</span> || <span class="hljs-number">1</span> / a == <span class="hljs-number">1</span> / b;</pre></div></div>
            
        </li>
        
        
        <li id="section-239">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              <p>A strict comparison is necessary because <code>null == undefined</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (a == <span class="hljs-literal">null</span> || b == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> a === b;</pre></div></div>
            
        </li>
        
        
        <li id="section-240">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              <p>Unwrap any wrapped objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (a <span class="hljs-keyword">instanceof</span> _) a = a._wrapped;
    <span class="hljs-keyword">if</span> (b <span class="hljs-keyword">instanceof</span> _) b = b._wrapped;</pre></div></div>
            
        </li>
        
        
        <li id="section-241">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p>Compare <code>[[Class]]</code> names.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> className = toString.call(a);
    <span class="hljs-keyword">if</span> (className != toString.call(b)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">switch</span> (className) {</pre></div></div>
            
        </li>
        
        
        <li id="section-242">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <p>Strings, numbers, dates, and booleans are compared by value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">case</span> <span class="hljs-string">'[object String]'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-243">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              <p>Primitives and their corresponding object wrappers are equivalent; thus, <code>&quot;5&quot;</code> is
equivalent to <code>new String(&quot;5&quot;)</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> a == <span class="hljs-built_in">String</span>(b);
      <span class="hljs-keyword">case</span> <span class="hljs-string">'[object Number]'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-244">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              <p><code>NaN</code>s are equivalent, but non-reflexive. An <code>egal</code> comparison is performed for
other numeric values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> a != +a ? b != +b : (a == <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> / a == <span class="hljs-number">1</span> / b : a == +b);
      <span class="hljs-keyword">case</span> <span class="hljs-string">'[object Date]'</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-string">'[object Boolean]'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-245">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-245">&#182;</a>
              </div>
              <p>Coerce dates and booleans to numeric primitive values. Dates are compared by their
millisecond representations. Note that invalid dates with millisecond representations
of <code>NaN</code> are not equivalent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> +a == +b;</pre></div></div>
            
        </li>
        
        
        <li id="section-246">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-246">&#182;</a>
              </div>
              <p>RegExps are compared by their source patterns and flags.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">case</span> <span class="hljs-string">'[object RegExp]'</span>:
        <span class="hljs-keyword">return</span> a.source == b.source &amp;&amp;
               a.global == b.global &amp;&amp;
               a.multiline == b.multiline &amp;&amp;
               a.ignoreCase == b.ignoreCase;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a != <span class="hljs-string">'object'</span> || <span class="hljs-keyword">typeof</span> b != <span class="hljs-string">'object'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-247">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-247">&#182;</a>
              </div>
              <p>Assume equality for cyclic structures. The algorithm for detecting cyclic
structures is adapted from ES 5.1 section 15.12.3, abstract operation <code>JO</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> length = aStack.length;
    <span class="hljs-keyword">while</span> (length--) {</pre></div></div>
            
        </li>
        
        
        <li id="section-248">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-248">&#182;</a>
              </div>
              <p>Linear search. Performance is inversely proportional to the number of
unique nested structures.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (aStack[length] == a) <span class="hljs-keyword">return</span> bStack[length] == b;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-249">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-249">&#182;</a>
              </div>
              <p>Add the first object to the stack of traversed objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    aStack.push(a);
    bStack.push(b);
    <span class="hljs-keyword">var</span> size = <span class="hljs-number">0</span>, result = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-250">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-250">&#182;</a>
              </div>
              <p>Recursively compare objects and arrays.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (className == <span class="hljs-string">'[object Array]'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-251">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-251">&#182;</a>
              </div>
              <p>Compare array lengths to determine if a deep comparison is necessary.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      size = a.length;
      result = size == b.length;
      <span class="hljs-keyword">if</span> (result) {</pre></div></div>
            
        </li>
        
        
        <li id="section-252">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-252">&#182;</a>
              </div>
              <p>Deep compare the contents, ignoring non-numeric properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">while</span> (size--) {
          <span class="hljs-keyword">if</span> (!(result = eq(a[size], b[size], aStack, bStack))) <span class="hljs-keyword">break</span>;
        }
      }
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-253">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-253">&#182;</a>
              </div>
              <p>Objects with different constructors are not equivalent, but <code>Object</code>s
from different frames are.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> aCtor = a.constructor, bCtor = b.constructor;
      <span class="hljs-keyword">if</span> (aCtor !== bCtor &amp;&amp; !(_.isFunction(aCtor) &amp;&amp; (aCtor <span class="hljs-keyword">instanceof</span> aCtor) &amp;&amp;
                               _.isFunction(bCtor) &amp;&amp; (bCtor <span class="hljs-keyword">instanceof</span> bCtor))) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-254">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-254">&#182;</a>
              </div>
              <p>Deep compare objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> a) {
        <span class="hljs-keyword">if</span> (_.has(a, key)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-255">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-255">&#182;</a>
              </div>
              <p>Count the expected number of properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          size++;</pre></div></div>
            
        </li>
        
        
        <li id="section-256">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-256">&#182;</a>
              </div>
              <p>Deep compare each member.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (!(result = _.has(b, key) &amp;&amp; eq(a[key], b[key], aStack, bStack))) <span class="hljs-keyword">break</span>;
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-257">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-257">&#182;</a>
              </div>
              <p>Ensure that both objects contain the same number of properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (result) {
        <span class="hljs-keyword">for</span> (key <span class="hljs-keyword">in</span> b) {
          <span class="hljs-keyword">if</span> (_.has(b, key) &amp;&amp; !(size--)) <span class="hljs-keyword">break</span>;
        }
        result = !size;
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-258">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-258">&#182;</a>
              </div>
              <p>Remove the first object from the stack of traversed objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    aStack.pop();
    bStack.pop();
    <span class="hljs-keyword">return</span> result;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-259">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-259">&#182;</a>
              </div>
              <p>Perform a deep comparison to check if two objects are equal.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.isEqual = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b)</span> </span>{
    <span class="hljs-keyword">return</span> eq(a, b, [], []);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-260">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-260">&#182;</a>
              </div>
              <p>Is a given array, string, or object empty?
An “empty” object has no enumerable own-properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.isEmpty = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (_.isArray(obj) || _.isString(obj)) <span class="hljs-keyword">return</span> obj.length === <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj) <span class="hljs-keyword">if</span> (_.has(obj, key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-261">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-261">&#182;</a>
              </div>
              <p>Is a given value a DOM element?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.isElement = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">return</span> !!(obj &amp;&amp; obj.nodeType === <span class="hljs-number">1</span>);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-262">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-262">&#182;</a>
              </div>
              <p>Is a given value an array?
Delegates to ECMA5’s native Array.isArray</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.isArray = nativeIsArray || <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">return</span> toString.call(obj) == <span class="hljs-string">'[object Array]'</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-263">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-263">&#182;</a>
              </div>
              <p>Is a given variable an object?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.isObject = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">return</span> obj === <span class="hljs-built_in">Object</span>(obj);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-264">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-264">&#182;</a>
              </div>
              <p>Add some isType methods: isArguments, isFunction, isString, isNumber, isDate, isRegExp.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  each([<span class="hljs-string">'Arguments'</span>, <span class="hljs-string">'Function'</span>, <span class="hljs-string">'String'</span>, <span class="hljs-string">'Number'</span>, <span class="hljs-string">'Date'</span>, <span class="hljs-string">'RegExp'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
    _[<span class="hljs-string">'is'</span> + name] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
      <span class="hljs-keyword">return</span> toString.call(obj) == <span class="hljs-string">'[object '</span> + name + <span class="hljs-string">']'</span>;
    };
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-265">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-265">&#182;</a>
              </div>
              <p>Define a fallback version of the method in browsers (ahem, IE), where
there isn’t any inspectable “Arguments” type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!_.isArguments(<span class="hljs-built_in">arguments</span>)) {
    _.isArguments = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
      <span class="hljs-keyword">return</span> !!(obj &amp;&amp; _.has(obj, <span class="hljs-string">'callee'</span>));
    };
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-266">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-266">&#182;</a>
              </div>
              <p>Optimize <code>isFunction</code> if appropriate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> (<span class="hljs-regexp">/./</span>) !== <span class="hljs-string">'function'</span>) {
    _.isFunction = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'function'</span>;
    };
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-267">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-267">&#182;</a>
              </div>
              <p>Is a given object a finite number?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.isFinite = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">isFinite</span>(obj) &amp;&amp; !<span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseFloat</span>(obj));
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-268">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-268">&#182;</a>
              </div>
              <p>Is the given value <code>NaN</code>? (NaN is the only number which does not equal itself).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.isNaN = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">return</span> _.isNumber(obj) &amp;&amp; obj != +obj;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-269">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-269">&#182;</a>
              </div>
              <p>Is a given value a boolean?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.isBoolean = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">return</span> obj === <span class="hljs-literal">true</span> || obj === <span class="hljs-literal">false</span> || toString.call(obj) == <span class="hljs-string">'[object Boolean]'</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-270">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-270">&#182;</a>
              </div>
              <p>Is a given value equal to null?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.isNull = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">return</span> obj === <span class="hljs-literal">null</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-271">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-271">&#182;</a>
              </div>
              <p>Is a given variable undefined?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.isUndefined = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">return</span> obj === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-272">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-272">&#182;</a>
              </div>
              <p>Shortcut function for checking if an object has a given property directly
on itself (in other words, not on a prototype).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.has = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, key)</span> </span>{
    <span class="hljs-keyword">return</span> hasOwnProperty.call(obj, key);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-273">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-273">&#182;</a>
              </div>
              <h2 id="utility-functions">Utility Functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-274">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-274">&#182;</a>
              </div>
              <p>Run Underscore.js in <em>noConflict</em> mode, returning the <code>_</code> variable to its
previous owner. Returns a reference to the Underscore object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.noConflict = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    root._ = previousUnderscore;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-275">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-275">&#182;</a>
              </div>
              <p>Keep the identity function around for default iterators.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.identity = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">return</span> value;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-276">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-276">&#182;</a>
              </div>
              <p>Run a function <strong>n</strong> times.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.times = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n, iterator, context)</span> </span>{
    <span class="hljs-keyword">var</span> accum = <span class="hljs-built_in">Array</span>(n);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) accum[i] = iterator.call(context, i);
    <span class="hljs-keyword">return</span> accum;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-277">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-277">&#182;</a>
              </div>
              <p>Return a random integer between min and max (inclusive).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.random = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(min, max)</span> </span>{
    <span class="hljs-keyword">if</span> (max == <span class="hljs-literal">null</span>) {
      max = min;
      min = <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">return</span> min + <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * (max - min + <span class="hljs-number">1</span>));
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-278">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-278">&#182;</a>
              </div>
              <p>List of HTML entities for escaping.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> entityMap = {
    <span class="hljs-built_in">escape</span>: {
      <span class="hljs-string">'&amp;'</span>: <span class="hljs-string">'&amp;amp;'</span>,
      <span class="hljs-string">'&lt;'</span>: <span class="hljs-string">'&amp;lt;'</span>,
      <span class="hljs-string">'&gt;'</span>: <span class="hljs-string">'&amp;gt;'</span>,
      <span class="hljs-string">'"'</span>: <span class="hljs-string">'&amp;quot;'</span>,
      <span class="hljs-string">"'"</span>: <span class="hljs-string">'&amp;#x27;'</span>,
      <span class="hljs-string">'/'</span>: <span class="hljs-string">'&amp;#x2F;'</span>
    }
  };
  entityMap.unescape = _.invert(entityMap.escape);</pre></div></div>
            
        </li>
        
        
        <li id="section-279">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-279">&#182;</a>
              </div>
              <p>Regexes containing the keys and values listed immediately above.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> entityRegexes = {
    <span class="hljs-built_in">escape</span>:   <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'['</span> + _.keys(entityMap.escape).join(<span class="hljs-string">''</span>) + <span class="hljs-string">']'</span>, <span class="hljs-string">'g'</span>),
    <span class="hljs-built_in">unescape</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'('</span> + _.keys(entityMap.unescape).join(<span class="hljs-string">'|'</span>) + <span class="hljs-string">')'</span>, <span class="hljs-string">'g'</span>)
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-280">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-280">&#182;</a>
              </div>
              <p>Functions for escaping and unescaping strings to/from HTML interpolation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.each([<span class="hljs-string">'escape'</span>, <span class="hljs-string">'unescape'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method)</span> </span>{
    _[method] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(string)</span> </span>{
      <span class="hljs-keyword">if</span> (string == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
      <span class="hljs-keyword">return</span> (<span class="hljs-string">''</span> + string).replace(entityRegexes[method], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match)</span> </span>{
        <span class="hljs-keyword">return</span> entityMap[method][match];
      });
    };
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-281">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-281">&#182;</a>
              </div>
              <p>If the value of the named property is a function then invoke it;
otherwise, return it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.result = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(object, property)</span> </span>{
    <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> value = object[property];
    <span class="hljs-keyword">return</span> _.isFunction(value) ? value.call(object) : value;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-282">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-282">&#182;</a>
              </div>
              <p>Add your own custom functions to the Underscore object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.mixin = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    each(_.functions(obj), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span></span>{
      <span class="hljs-keyword">var</span> func = _[name] = obj[name];
      _.prototype[name] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> args = [<span class="hljs-keyword">this</span>._wrapped];
        push.apply(args, <span class="hljs-built_in">arguments</span>);
        <span class="hljs-keyword">return</span> result.call(<span class="hljs-keyword">this</span>, func.apply(_, args));
      };
    });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-283">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-283">&#182;</a>
              </div>
              <p>Generate a unique integer id (unique within the entire client session).
Useful for temporary DOM ids.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> idCounter = <span class="hljs-number">0</span>;
  _.uniqueId = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(prefix)</span> </span>{
    <span class="hljs-keyword">var</span> id = ++idCounter + <span class="hljs-string">''</span>;
    <span class="hljs-keyword">return</span> prefix ? prefix + id : id;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-284">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-284">&#182;</a>
              </div>
              <p>By default, Underscore uses ERB-style template delimiters, change the
following template settings to use alternative delimiters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.templateSettings = {
    evaluate    : <span class="hljs-regexp">/&lt;%([\s\S]+?)%&gt;/g</span>,
    interpolate : <span class="hljs-regexp">/&lt;%=([\s\S]+?)%&gt;/g</span>,
    <span class="hljs-built_in">escape</span>      : <span class="hljs-regexp">/&lt;%-([\s\S]+?)%&gt;/g</span>
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-285">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-285">&#182;</a>
              </div>
              <p>When customizing <code>templateSettings</code>, if you don’t want to define an
interpolation, evaluation or escaping regex, we need one that is
guaranteed not to match.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> noMatch = <span class="hljs-regexp">/(.)^/</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-286">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-286">&#182;</a>
              </div>
              <p>Certain characters need to be escaped so that they can be put into a
string literal.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> escapes = {
    <span class="hljs-string">"'"</span>:      <span class="hljs-string">"'"</span>,
    <span class="hljs-string">'\\'</span>:     <span class="hljs-string">'\\'</span>,
    <span class="hljs-string">'\r'</span>:     <span class="hljs-string">'r'</span>,
    <span class="hljs-string">'\n'</span>:     <span class="hljs-string">'n'</span>,
    <span class="hljs-string">'\t'</span>:     <span class="hljs-string">'t'</span>,
    <span class="hljs-string">'\u2028'</span>: <span class="hljs-string">'u2028'</span>,
    <span class="hljs-string">'\u2029'</span>: <span class="hljs-string">'u2029'</span>
  };

  <span class="hljs-keyword">var</span> escaper = <span class="hljs-regexp">/\\|'|\r|\n|\t|\u2028|\u2029/g</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-287">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-287">&#182;</a>
              </div>
              <p>JavaScript micro-templating, similar to John Resig’s implementation.
Underscore templating handles arbitrary delimiters, preserves whitespace,
and correctly escapes quotes within interpolated code.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.template = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(text, data, settings)</span> </span>{
    <span class="hljs-keyword">var</span> render;
    settings = _.defaults({}, settings, _.templateSettings);</pre></div></div>
            
        </li>
        
        
        <li id="section-288">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-288">&#182;</a>
              </div>
              <p>Combine delimiters into one regular expression via alternation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> matcher = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>([
      (settings.escape || noMatch).source,
      (settings.interpolate || noMatch).source,
      (settings.evaluate || noMatch).source
    ].join(<span class="hljs-string">'|'</span>) + <span class="hljs-string">'|$'</span>, <span class="hljs-string">'g'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-289">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-289">&#182;</a>
              </div>
              <p>Compile the template source, escaping string literals appropriately.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> source = <span class="hljs-string">"__p+='"</span>;
    text.replace(matcher, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, escape, interpolate, evaluate, offset)</span> </span>{
      source += text.slice(index, offset)
        .replace(escaper, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match)</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">'\\'</span> + escapes[match]; });

      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">escape</span>) {
        source += <span class="hljs-string">"'+\n((__t=("</span> + <span class="hljs-built_in">escape</span> + <span class="hljs-string">"))==null?'':_.escape(__t))+\n'"</span>;
      }
      <span class="hljs-keyword">if</span> (interpolate) {
        source += <span class="hljs-string">"'+\n((__t=("</span> + interpolate + <span class="hljs-string">"))==null?'':__t)+\n'"</span>;
      }
      <span class="hljs-keyword">if</span> (evaluate) {
        source += <span class="hljs-string">"';\n"</span> + evaluate + <span class="hljs-string">"\n__p+='"</span>;
      }
      index = offset + match.length;
      <span class="hljs-keyword">return</span> match;
    });
    source += <span class="hljs-string">"';\n"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-290">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-290">&#182;</a>
              </div>
              <p>If a variable is not specified, place data values in local scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!settings.variable) source = <span class="hljs-string">'with(obj||{}){\n'</span> + source + <span class="hljs-string">'}\n'</span>;

    source = <span class="hljs-string">"var __t,__p='',__j=Array.prototype.join,"</span> +
      <span class="hljs-string">"print=function(){__p+=__j.call(arguments,'');};\n"</span> +
      source + <span class="hljs-string">"return __p;\n"</span>;

    <span class="hljs-keyword">try</span> {
      render = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(settings.variable || <span class="hljs-string">'obj'</span>, <span class="hljs-string">'_'</span>, source);
    } <span class="hljs-keyword">catch</span> (e) {
      e.source = source;
      <span class="hljs-keyword">throw</span> e;
    }

    <span class="hljs-keyword">if</span> (data) <span class="hljs-keyword">return</span> render(data, _);
    <span class="hljs-keyword">var</span> template = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
      <span class="hljs-keyword">return</span> render.call(<span class="hljs-keyword">this</span>, data, _);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-291">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-291">&#182;</a>
              </div>
              <p>Provide the compiled function source as a convenience for precompilation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    template.source = <span class="hljs-string">'function('</span> + (settings.variable || <span class="hljs-string">'obj'</span>) + <span class="hljs-string">'){\n'</span> + source + <span class="hljs-string">'}'</span>;

    <span class="hljs-keyword">return</span> template;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-292">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-292">&#182;</a>
              </div>
              <p>Add a “chain” function, which will delegate to the wrapper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.chain = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">return</span> _(obj).chain();
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-293">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-293">&#182;</a>
              </div>
              <h2 id="oop">OOP</h2>
<p>If Underscore is called as a function, it returns a wrapped object that
can be used OO-style. This wrapper holds altered versions of all the
underscore functions. Wrapped objects may be chained.</p>

            </div>
            
        </li>
        
        
        <li id="section-294">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-294">&#182;</a>
              </div>
              <p>Helper function to continue chaining intermediate results.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> result = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._chain ? _(obj).chain() : obj;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-295">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-295">&#182;</a>
              </div>
              <p>Add all of the Underscore functions to the wrapper object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.mixin(_);</pre></div></div>
            
        </li>
        
        
        <li id="section-296">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-296">&#182;</a>
              </div>
              <p>Add all mutator Array functions to the wrapper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  each([<span class="hljs-string">'pop'</span>, <span class="hljs-string">'push'</span>, <span class="hljs-string">'reverse'</span>, <span class="hljs-string">'shift'</span>, <span class="hljs-string">'sort'</span>, <span class="hljs-string">'splice'</span>, <span class="hljs-string">'unshift'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
    <span class="hljs-keyword">var</span> method = ArrayProto[name];
    _.prototype[name] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>._wrapped;
      method.apply(obj, <span class="hljs-built_in">arguments</span>);
      <span class="hljs-keyword">if</span> ((name == <span class="hljs-string">'shift'</span> || name == <span class="hljs-string">'splice'</span>) &amp;&amp; obj.length === <span class="hljs-number">0</span>) <span class="hljs-keyword">delete</span> obj[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">return</span> result.call(<span class="hljs-keyword">this</span>, obj);
    };
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-297">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-297">&#182;</a>
              </div>
              <p>Add all accessor Array functions to the wrapper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  each([<span class="hljs-string">'concat'</span>, <span class="hljs-string">'join'</span>, <span class="hljs-string">'slice'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
    <span class="hljs-keyword">var</span> method = ArrayProto[name];
    _.prototype[name] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> result.call(<span class="hljs-keyword">this</span>, method.apply(<span class="hljs-keyword">this</span>._wrapped, <span class="hljs-built_in">arguments</span>));
    };
  });

  _.extend(_.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-298">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-298">&#182;</a>
              </div>
              <p>Start chaining a wrapped Underscore object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    chain: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">this</span>._chain = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-299">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-299">&#182;</a>
              </div>
              <p>Extracts the result from a wrapped and chained object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    value: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._wrapped;
    }

  });

}).call(<span class="hljs-keyword">this</span>);

},{}]},{},[<span class="hljs-number">6</span>])(<span class="hljs-number">6</span>)
});
;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
