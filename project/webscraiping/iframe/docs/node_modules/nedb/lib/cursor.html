<!DOCTYPE html>

<html>
<head>
  <title>cursor.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>cursor.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
 * Manage access to data, be it to find, update or remove it
 */</span>
<span class="hljs-keyword">var</span> model = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./model'</span>);

 

<span class="hljs-comment">/**
 * Create a new cursor for this collection
 * @param {Datastore} db - The datastore this cursor is bound to
 * @param {Query} query - The query this cursor will operate on
 * @param {Function} execDn - Handler to be executed  after cursor has found the results and before the callback passed to find/findOne/update/remove
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Cursor</span> <span class="hljs-params">(db, query, execFn)</span> </span>{
  <span class="hljs-keyword">this</span>.db = db;
  <span class="hljs-keyword">this</span>.query = query || {};
  <span class="hljs-keyword">if</span> (execFn) { <span class="hljs-keyword">this</span>.execFn = execFn; }
}


<span class="hljs-comment">/**
 * Set a limit to the number of results
 */</span>
Cursor.prototype.limit = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(limit)</span> </span>{
  <span class="hljs-keyword">this</span>._limit = limit;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};


<span class="hljs-comment">/**
 * Skip a the number of results
 */</span>
Cursor.prototype.skip = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(skip)</span> </span>{
  <span class="hljs-keyword">this</span>._skip = skip;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};


<span class="hljs-comment">/**
 * Sort results of the query
 * @Param {SortQuery} sortQuery - SortQuery is { field: order }, field can use the dot-notation, order is 1 for ascending and -1 for descending
 */</span>
Cursor.prototype.sort = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(sortQuery)</span> </span>{
  <span class="hljs-keyword">this</span>._sort = sortQuery;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};


<span class="hljs-comment">/**
 * Get all matching elements
 * Will return pointers to matched elements (shallow copies), returning full copies is the role of find or findOne
 * This is an internal function, use exec which uses the executor
 *
 * @param {Function} callback - Signature: err, results
 */</span>
Cursor.prototype._exec = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> </span>{
  <span class="hljs-keyword">var</span> candidates = <span class="hljs-keyword">this</span>.db.getCandidates(<span class="hljs-keyword">this</span>.query)
    , res = [], added = <span class="hljs-number">0</span>, skipped = <span class="hljs-number">0</span>, self = <span class="hljs-keyword">this</span>
    , i, keys, key
    ;
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; candidates.length; i += <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">if</span> (model.match(candidates[i], <span class="hljs-keyword">this</span>.query)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>If a sort is defined, wait for the results to be sorted before applying limit and skip</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._sort) {
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._skip &amp;&amp; <span class="hljs-keyword">this</span>._skip &gt; skipped) {
            skipped += <span class="hljs-number">1</span>;
          } <span class="hljs-keyword">else</span> {
            res.push(candidates[i]);
            added += <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._limit &amp;&amp; <span class="hljs-keyword">this</span>._limit &lt;= added) { <span class="hljs-keyword">break</span>; }                  
          }
        } <span class="hljs-keyword">else</span> {
          res.push(candidates[i]);
        }
      }
    }
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-keyword">return</span> callback(err);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Apply all sorts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._sort) {
    keys = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>._sort);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Sorting</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> criteria = [];
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; keys.length; i++) {
      key = keys[i];
      criteria.push({ key: key, direction: self._sort[key] });
    }
    res.sort(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b)</span> </span>{
      <span class="hljs-keyword">var</span> criterion, compare, i;
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; criteria.length; i++) {
        criterion = criteria[i];
        compare = criterion.direction * model.compareThings(model.getDotValue(a, criterion.key), model.getDotValue(b, criterion.key));
        <span class="hljs-keyword">if</span> (compare !== <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">return</span> compare;
        }
      }
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Applying limit and skip</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> limit = <span class="hljs-keyword">this</span>._limit || res.length
      , skip = <span class="hljs-keyword">this</span>._skip || <span class="hljs-number">0</span>;
      
    res = res.slice(skip, skip + limit);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.execFn) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.execFn(<span class="hljs-literal">null</span>, res, callback);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, res);
  }
};

Cursor.prototype.exec = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.db.executor.push({ <span class="hljs-keyword">this</span>: <span class="hljs-keyword">this</span>, fn: <span class="hljs-keyword">this</span>._exec, <span class="hljs-built_in">arguments</span>: <span class="hljs-built_in">arguments</span> });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = Cursor;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
