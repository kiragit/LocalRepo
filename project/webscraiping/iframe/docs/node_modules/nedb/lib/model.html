<!DOCTYPE html>

<html>
<head>
  <title>model.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>model.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
 * Handle models (i.e. docs)
 * Serialization/deserialization
 * Copying
 * Querying, update
 */</span>

<span class="hljs-keyword">var</span> dateToJSON = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> { $$date: <span class="hljs-keyword">this</span>.getTime() }; }
  , originalDateToJSON = <span class="hljs-built_in">Date</span>.prototype.toJSON
  , util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
  , _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
  , modifierFunctions = {}
  , lastStepModifierFunctions = {}
  , comparisonFunctions = {}
  , logicalOperators = {}
  , arrayComparisonFunctions = {}
  ;


<span class="hljs-comment">/**
 * Check a key, throw an error if the key is non valid
 * @param {String} k key
 * @param {Model} v value, needed to treat the Date edge case
 * Non-treatable edge cases here: if part of the object if of the form { $$date: number } or { $$deleted: true }
 * Its serialized-then-deserialized version it will transformed into a Date object
 * But you really need to want it to trigger such behaviour, even when warned not to use '$' at the beginning of the field names...
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkKey</span> <span class="hljs-params">(k, v)</span> </span>{
  <span class="hljs-keyword">if</span> (k[<span class="hljs-number">0</span>] === <span class="hljs-string">'$'</span> &amp;&amp; !(k === <span class="hljs-string">'$$date'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'number'</span>) &amp;&amp; !(k === <span class="hljs-string">'$$deleted'</span> &amp;&amp; v === <span class="hljs-literal">true</span>) &amp;&amp; !(k === <span class="hljs-string">'$$indexCreated'</span>) &amp;&amp; !(k === <span class="hljs-string">'$$indexRemoved'</span>)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Field names cannot begin with the $ character'</span>;
  }

  <span class="hljs-keyword">if</span> (k.indexOf(<span class="hljs-string">'.'</span>) !== -<span class="hljs-number">1</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Field names cannot contain a .'</span>;
  }
}


<span class="hljs-comment">/**
 * Check a DB object and throw an error if it's not valid
 * Works by applying the above checkKey function to all fields recursively
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkObject</span> <span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">if</span> (util.isArray(obj)) {
    obj.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> </span>{
      checkObject(o);
    });
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'object'</span> &amp;&amp; obj !== <span class="hljs-literal">null</span>) {
    <span class="hljs-built_in">Object</span>.keys(obj).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k)</span> </span>{
      checkKey(k, obj[k]);
      checkObject(obj[k]);
    });
  }
}


<span class="hljs-comment">/**
 * Serialize an object to be persisted to a one-line string
 * For serialization/deserialization, we use the native JSON parser and not eval or Function
 * That gives us less freedom but data entered in the database may come from users
 * so eval and the like are not safe
 * Accepted primitive types: Number, String, Boolean, Date, null
 * Accepted secondary types: Objects, Arrays
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serialize</span> <span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">var</span> res;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Keep track of the fact that this is a Date object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">Date</span>.prototype.toJSON = dateToJSON;

  res = <span class="hljs-built_in">JSON</span>.stringify(obj, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k, v)</span> </span>{
    checkKey(k, v);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'number'</span> || <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'boolean'</span> || v === <span class="hljs-literal">null</span>) { <span class="hljs-keyword">return</span> v; }

    <span class="hljs-keyword">return</span> v;
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Return Date to its original state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">Date</span>.prototype.toJSON = originalDateToJSON;

  <span class="hljs-keyword">return</span> res;
}


<span class="hljs-comment">/**
 * From a one-line representation of an object generate by the serialize function
 * Return the object itself
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deserialize</span> <span class="hljs-params">(rawData)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(rawData, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k, v)</span> </span>{
    <span class="hljs-keyword">if</span> (k === <span class="hljs-string">'$$date'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(v); }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'number'</span> || <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'boolean'</span> || v === <span class="hljs-literal">null</span>) { <span class="hljs-keyword">return</span> v; }
    <span class="hljs-keyword">if</span> (v &amp;&amp; v.$$date) { <span class="hljs-keyword">return</span> v.$$date; }

    <span class="hljs-keyword">return</span> v;
  });
}


<span class="hljs-comment">/**
 * Deep copy a DB object
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deepCopy</span> <span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">var</span> res;

  <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'boolean'</span> ||
       <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'number'</span> ||
       <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'string'</span> ||
       obj === <span class="hljs-literal">null</span> ||
       (util.isDate(obj)) ) {
    <span class="hljs-keyword">return</span> obj;
  }

  <span class="hljs-keyword">if</span> (util.isArray(obj)) {
    res = [];
    obj.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> </span>{ res.push(o); });
    <span class="hljs-keyword">return</span> res;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'object'</span>) {
    res = {};
    <span class="hljs-built_in">Object</span>.keys(obj).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k)</span> </span>{
      res[k] = deepCopy(obj[k]);
    });
    <span class="hljs-keyword">return</span> res;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;   <span class="hljs-comment">// For now everything else is undefined. We should probably throw an error instead</span>
}


<span class="hljs-comment">/**
 * Tells if an object is a primitive type or a "real" object
 * Arrays are considered primitive
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isPrimitiveType</span> <span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">return</span> ( <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'boolean'</span> ||
       <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'number'</span> ||
       <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'string'</span> ||
       obj === <span class="hljs-literal">null</span> ||
       util.isDate(obj) ||
       util.isArray(obj));
}


<span class="hljs-comment">/**
 * Utility functions for comparing things
 * Assumes type checking was already done (a and b already have the same type)
 * compareNSB works for numbers, strings and booleans
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compareNSB</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">if</span> (a &lt; b) { <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (a &gt; b) { <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; }
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compareArrays</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">var</span> i, comp;

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">Math</span>.min(a.length, b.length); i += <span class="hljs-number">1</span>) {
    comp = compareThings(a[i], b[i]);

    <span class="hljs-keyword">if</span> (comp !== <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> comp; }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Common section was identical, longest one wins</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> compareNSB(a.length, b.length);
}


<span class="hljs-comment">/**
 * Compare { things U undefined }
 * Things are defined as any native types (string, number, boolean, null, date) and objects
 * We need to compare with undefined as it will be used in indexes
 * In the case of objects and arrays, we deep-compare
 * If two objects dont have the same type, the (arbitrary) type hierarchy is: undefined, null, number, strings, boolean, dates, arrays, objects
 * Return -1 if a &lt; b, 1 if a &gt; b and 0 if a = b (note that equality here is NOT the same as defined in areThingsEqual!)
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compareThings</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">var</span> aKeys, bKeys, comp, i;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>undefined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (a === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">return</span> b === <span class="hljs-literal">undefined</span> ? <span class="hljs-number">0</span> : -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (b === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">return</span> a === <span class="hljs-literal">undefined</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (a === <span class="hljs-literal">null</span>) { <span class="hljs-keyword">return</span> b === <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (b === <span class="hljs-literal">null</span>) { <span class="hljs-keyword">return</span> a === <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Numbers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'number'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'number'</span> ? compareNSB(a, b) : -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'number'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'number'</span> ? compareNSB(a, b) : <span class="hljs-number">1</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Strings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'string'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'string'</span> ? compareNSB(a, b) : -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'string'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'string'</span> ? compareNSB(a, b) : <span class="hljs-number">1</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Booleans</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'boolean'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'boolean'</span> ? compareNSB(a, b) : -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'boolean'</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'boolean'</span> ? compareNSB(a, b) : <span class="hljs-number">1</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Dates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (util.isDate(a)) { <span class="hljs-keyword">return</span> util.isDate(b) ? compareNSB(a.getTime(), b.getTime()) : -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (util.isDate(b)) { <span class="hljs-keyword">return</span> util.isDate(a) ? compareNSB(a.getTime(), b.getTime()) : <span class="hljs-number">1</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Arrays (first element is most significant and so on)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (util.isArray(a)) { <span class="hljs-keyword">return</span> util.isArray(b) ? compareArrays(a, b) : -<span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (util.isArray(b)) { <span class="hljs-keyword">return</span> util.isArray(a) ? compareArrays(a, b) : <span class="hljs-number">1</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  aKeys = <span class="hljs-built_in">Object</span>.keys(a).sort();
  bKeys = <span class="hljs-built_in">Object</span>.keys(b).sort();

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">Math</span>.min(aKeys.length, bKeys.length); i += <span class="hljs-number">1</span>) {
    comp = compareThings(a[aKeys[i]], b[bKeys[i]]);

    <span class="hljs-keyword">if</span> (comp !== <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> comp; }
  }

  <span class="hljs-keyword">return</span> compareNSB(aKeys.length, bKeys.length);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>==============================================================</p>
<h1 id="updating-documents">Updating documents</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/**
 * The signature of modifier functions is as follows
 * Their structure is always the same: recursively follow the dot notation while creating
 * the nested documents if needed, then apply the "last step modifier"
 * @param {Object} obj The model to modify
 * @param {String} field Can contain dots, in that case that means we will set a subfield recursively
 * @param {Model} value
 */</span>

<span class="hljs-comment">/**
 * Set a field to a new value
 */</span>
lastStepModifierFunctions.$set = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{
  obj[field] = value;
};


<span class="hljs-comment">/**
 * Unset a field
 */</span>
lastStepModifierFunctions.$unset = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{
  <span class="hljs-keyword">delete</span> obj[field];
};


<span class="hljs-comment">/**
 * Push an element to the end of an array field
 */</span>
lastStepModifierFunctions.$push = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Create the array if it doesn’t exist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!obj.hasOwnProperty(field)) { obj[field] = []; }

  <span class="hljs-keyword">if</span> (!util.isArray(obj[field])) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can't $push an element on non-array values"</span>; }

  <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span> &amp;&amp; value.$each) {
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(value).length &gt; <span class="hljs-number">1</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can't use another field in conjunction with $each"</span>; }
    <span class="hljs-keyword">if</span> (!util.isArray(value.$each)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$each requires an array value"</span>; }

    value.$each.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
      obj[field].push(v);
    });
  } <span class="hljs-keyword">else</span> {
    obj[field].push(value);
  }
};


<span class="hljs-comment">/**
 * Add an element to an array field only if it is not already in it
 * No modification if the element is already in the array
 * Note that it doesn't check whether the original array contains duplicates
 */</span>
lastStepModifierFunctions.$addToSet = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{
  <span class="hljs-keyword">var</span> addToSet = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Create the array if it doesn’t exist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!obj.hasOwnProperty(field)) { obj[field] = []; }

  <span class="hljs-keyword">if</span> (!util.isArray(obj[field])) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can't $addToSet an element on non-array values"</span>; }

  <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span> &amp;&amp; value.$each) {
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(value).length &gt; <span class="hljs-number">1</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can't use another field in conjunction with $each"</span>; }
    <span class="hljs-keyword">if</span> (!util.isArray(value.$each)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$each requires an array value"</span>; }

    value.$each.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
      lastStepModifierFunctions.$addToSet(obj, field, v);
    });
  } <span class="hljs-keyword">else</span> {
    obj[field].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> </span>{
      <span class="hljs-keyword">if</span> (compareThings(v, value) === <span class="hljs-number">0</span>) { addToSet = <span class="hljs-literal">false</span>; }
    });
    <span class="hljs-keyword">if</span> (addToSet) { obj[field].push(value); }
  }
};


<span class="hljs-comment">/**
 * Remove the first or last element of an array
 */</span>
lastStepModifierFunctions.$pop = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{
  <span class="hljs-keyword">if</span> (!util.isArray(obj[field])) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can't $pop an element from non-array values"</span>; }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value !== <span class="hljs-string">'number'</span>) { <span class="hljs-keyword">throw</span> value + <span class="hljs-string">" isn't an integer, can't use it with $pop"</span>; }
  <span class="hljs-keyword">if</span> (value === <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span>; }

  <span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">0</span>) {
    obj[field] = obj[field].slice(<span class="hljs-number">0</span>, obj[field].length - <span class="hljs-number">1</span>);
  } <span class="hljs-keyword">else</span> {
    obj[field] = obj[field].slice(<span class="hljs-number">1</span>);
  }
};


<span class="hljs-comment">/**
 * Removes all instances of a value from an existing array
 */</span>
lastStepModifierFunctions.$pull = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{
  <span class="hljs-keyword">var</span> arr, i;
  
  <span class="hljs-keyword">if</span> (!util.isArray(obj[field])) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can't $pull an element from non-array values"</span>; }

  arr = obj[field];
  <span class="hljs-keyword">for</span> (i = arr.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i -= <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (match(arr[i], value)) {
      arr.splice(i, <span class="hljs-number">1</span>);
    }
  }
};


<span class="hljs-comment">/**
 * Increment a numeric field's value
 */</span>
lastStepModifierFunctions.$inc = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value !== <span class="hljs-string">'number'</span>) { <span class="hljs-keyword">throw</span> value + <span class="hljs-string">" must be a number"</span>; }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj[field] !== <span class="hljs-string">'number'</span>) {
    <span class="hljs-keyword">if</span> (!_.has(obj, field)) {
      obj[field] = value;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">"Don't use the $inc modifier on non-number fields"</span>;
    }
  } <span class="hljs-keyword">else</span> {
    obj[field] += value;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Given its name, create the complete modifier function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createModifierFunction</span> <span class="hljs-params">(modifier)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, field, value)</span> </span>{
    <span class="hljs-keyword">var</span> fieldParts = <span class="hljs-keyword">typeof</span> field === <span class="hljs-string">'string'</span> ? field.split(<span class="hljs-string">'.'</span>) : field;

    <span class="hljs-keyword">if</span> (fieldParts.length === <span class="hljs-number">1</span>) {
      lastStepModifierFunctions[modifier](obj, field, value);
    } <span class="hljs-keyword">else</span> {
      obj[fieldParts[<span class="hljs-number">0</span>]] = obj[fieldParts[<span class="hljs-number">0</span>]] || {};
      modifierFunctions[modifier](obj[fieldParts[<span class="hljs-number">0</span>]], fieldParts.slice(<span class="hljs-number">1</span>), value);
    }
  };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Actually create all modifier functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">Object</span>.keys(lastStepModifierFunctions).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(modifier)</span> </span>{
  modifierFunctions[modifier] = createModifierFunction(modifier);
});


<span class="hljs-comment">/**
 * Modify a DB object according to an update query
 * For now the updateQuery only replaces the object
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">modify</span> <span class="hljs-params">(obj, updateQuery)</span> </span>{
  <span class="hljs-keyword">var</span> keys = <span class="hljs-built_in">Object</span>.keys(updateQuery)
    , firstChars = _.map(keys, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{ <span class="hljs-keyword">return</span> item[<span class="hljs-number">0</span>]; })
    , dollarFirstChars = _.filter(firstChars, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(c)</span> </span>{ <span class="hljs-keyword">return</span> c === <span class="hljs-string">'$'</span>; })
    , newDoc, modifiers
    ;

  <span class="hljs-keyword">if</span> (keys.indexOf(<span class="hljs-string">'_id'</span>) !== -<span class="hljs-number">1</span> &amp;&amp; updateQuery._id !== obj._id) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"You cannot change a document's _id"</span>; }

  <span class="hljs-keyword">if</span> (dollarFirstChars.length !== <span class="hljs-number">0</span> &amp;&amp; dollarFirstChars.length !== firstChars.length) {
    <span class="hljs-keyword">throw</span> <span class="hljs-string">"You cannot mix modifiers and normal fields"</span>;
  }

  <span class="hljs-keyword">if</span> (dollarFirstChars.length === <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Simply replace the object with the update query contents</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    newDoc = deepCopy(updateQuery);
    newDoc._id = obj._id;
  } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Apply modifiers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    modifiers = _.uniq(keys);
    newDoc = deepCopy(obj);
    modifiers.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(m)</span> </span>{
      <span class="hljs-keyword">var</span> keys;

      <span class="hljs-keyword">if</span> (!modifierFunctions[m]) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Unknown modifier "</span> + m; }

      <span class="hljs-keyword">try</span> {
        keys = <span class="hljs-built_in">Object</span>.keys(updateQuery[m]);
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">"Modifier "</span> + m + <span class="hljs-string">"'s argument must be an object"</span>;
      }

      keys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(k)</span> </span>{
        modifierFunctions[m](newDoc, k, updateQuery[m][k]);
      });
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Check result is valid and return it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  checkObject(newDoc);
  <span class="hljs-keyword">if</span> (obj._id !== newDoc._id) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"You can't change a document's _id"</span>; }
  <span class="hljs-keyword">return</span> newDoc;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>==============================================================</p>
<h1 id="finding-documents">Finding documents</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/**
 * Get a value from object with dot notation
 * @param {Object} obj
 * @param {String} field
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDotValue</span> <span class="hljs-params">(obj, field)</span> </span>{
  <span class="hljs-keyword">var</span> fieldParts = <span class="hljs-keyword">typeof</span> field === <span class="hljs-string">'string'</span> ? field.split(<span class="hljs-string">'.'</span>) : field
    , i, objs;

  <span class="hljs-keyword">if</span> (!obj) { <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>; }   <span class="hljs-comment">// field cannot be empty so that means we should return undefined so that nothing can match</span>

  <span class="hljs-keyword">if</span> (fieldParts.length === <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> obj; }

  <span class="hljs-keyword">if</span> (fieldParts.length === <span class="hljs-number">1</span>) { <span class="hljs-keyword">return</span> obj[fieldParts[<span class="hljs-number">0</span>]]; }
  
  <span class="hljs-keyword">if</span> (util.isArray(obj[fieldParts[<span class="hljs-number">0</span>]])) {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>If the next field is an integer, return only this item of the array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    i = <span class="hljs-built_in">parseInt</span>(fieldParts[<span class="hljs-number">1</span>], <span class="hljs-number">10</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> i === <span class="hljs-string">'number'</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(i)) {
      <span class="hljs-keyword">return</span> getDotValue(obj[fieldParts[<span class="hljs-number">0</span>]][i], fieldParts.slice(<span class="hljs-number">2</span>))
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Return the array of values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    objs = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>();
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; obj[fieldParts[<span class="hljs-number">0</span>]].length; i += <span class="hljs-number">1</span>) {
       objs.push(getDotValue(obj[fieldParts[<span class="hljs-number">0</span>]][i], fieldParts.slice(<span class="hljs-number">1</span>)));
    }
    <span class="hljs-keyword">return</span> objs;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> getDotValue(obj[fieldParts[<span class="hljs-number">0</span>]], fieldParts.slice(<span class="hljs-number">1</span>));
  }
}


<span class="hljs-comment">/**
 * Check whether 'things' are equal
 * Things are defined as any native types (string, number, boolean, null, date) and objects
 * In the case of object, we check deep equality
 * Returns true if they are, false otherwise
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">areThingsEqual</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">var</span> aKeys , bKeys , i;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Strings, booleans, numbers, null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (a === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'boolean'</span> || <span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'number'</span> ||
      b === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'boolean'</span> || <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'number'</span>) { <span class="hljs-keyword">return</span> a === b; }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Dates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (util.isDate(a) || util.isDate(b)) { <span class="hljs-keyword">return</span> util.isDate(a) &amp;&amp; util.isDate(b) &amp;&amp; a.getTime() === b.getTime(); }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Arrays (no match since arrays are used as a $in)
undefined (no match since they mean field doesn’t exist and can’t be serialized)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (util.isArray(a) || util.isArray(b) || a === <span class="hljs-literal">undefined</span> || b === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>General objects (check for deep equality)
a and b should be objects at this point</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">try</span> {
    aKeys = <span class="hljs-built_in">Object</span>.keys(a);
    bKeys = <span class="hljs-built_in">Object</span>.keys(b);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> (aKeys.length !== bKeys.length) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; aKeys.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (bKeys.indexOf(aKeys[i]) === -<span class="hljs-number">1</span>) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
    <span class="hljs-keyword">if</span> (!areThingsEqual(a[aKeys[i]], b[aKeys[i]])) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}


<span class="hljs-comment">/**
 * Check that two values are comparable
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">areComparable</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a !== <span class="hljs-string">'string'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> a !== <span class="hljs-string">'number'</span> &amp;&amp; !util.isDate(a) &amp;&amp;
      <span class="hljs-keyword">typeof</span> b !== <span class="hljs-string">'string'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> b !== <span class="hljs-string">'number'</span> &amp;&amp; !util.isDate(b)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a !== <span class="hljs-keyword">typeof</span> b) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}


<span class="hljs-comment">/**
 * Arithmetic and comparison operators
 * @param {Native value} a Value in the object
 * @param {Native value} b Value in the query
 */</span>
comparisonFunctions.$lt = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> areComparable(a, b) &amp;&amp; a &lt; b;
};

comparisonFunctions.$lte = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> areComparable(a, b) &amp;&amp; a &lt;= b;
};

comparisonFunctions.$gt = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> areComparable(a, b) &amp;&amp; a &gt; b;
};

comparisonFunctions.$gte = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> areComparable(a, b) &amp;&amp; a &gt;= b;
};

comparisonFunctions.$ne = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">if</span> (!a) { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }
  <span class="hljs-keyword">return</span> !areThingsEqual(a, b);
};

comparisonFunctions.$<span class="hljs-keyword">in</span> = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">var</span> i;

  <span class="hljs-keyword">if</span> (!util.isArray(b)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$in operator called with a non-array"</span>; }

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; b.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (areThingsEqual(a, b[i])) { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

comparisonFunctions.$nin = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">if</span> (!util.isArray(b)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$nin operator called with a non-array"</span>; }

  <span class="hljs-keyword">return</span> !comparisonFunctions.$<span class="hljs-keyword">in</span>(a, b);
};

comparisonFunctions.$regex = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">if</span> (!util.isRegExp(b)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$regex operator called with non regular expression"</span>; }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a !== <span class="hljs-string">'string'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> b.test(a);
  }
};

comparisonFunctions.$exists = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, exists)</span> </span>{
  <span class="hljs-keyword">if</span> (exists || exists === <span class="hljs-string">''</span>) {   <span class="hljs-comment">// This will be true for all values of exists except false, null, undefined and 0</span>
    exists = <span class="hljs-literal">true</span>;                 <span class="hljs-comment">// That's strange behaviour (we should only use true/false) but that's the way Mongo does it...</span>
  } <span class="hljs-keyword">else</span> {
    exists = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">return</span> !exists
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> exists;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Specific to arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>comparisonFunctions.$size = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, value)</span> </span>{
    <span class="hljs-keyword">if</span> (!util.isArray(obj)) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
    <span class="hljs-keyword">if</span> (value % <span class="hljs-number">1</span> !== <span class="hljs-number">0</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$size operator called without an integer"</span>; }

    <span class="hljs-keyword">return</span> (obj.length == value);
};
arrayComparisonFunctions.$size = <span class="hljs-literal">true</span>;


<span class="hljs-comment">/**
 * Match any of the subqueries
 * @param {Model} obj
 * @param {Array of Queries} query
 */</span>
logicalOperators.$or = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, query)</span> </span>{
  <span class="hljs-keyword">var</span> i;

  <span class="hljs-keyword">if</span> (!util.isArray(query)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$or operator used without an array"</span>; }

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; query.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (match(obj, query[i])) { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};


<span class="hljs-comment">/**
 * Match all of the subqueries
 * @param {Model} obj
 * @param {Array of Queries} query
 */</span>
logicalOperators.$and = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, query)</span> </span>{
  <span class="hljs-keyword">var</span> i;

  <span class="hljs-keyword">if</span> (!util.isArray(query)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$and operator used without an array"</span>; }

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; query.length; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (!match(obj, query[i])) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};


<span class="hljs-comment">/**
 * Inverted match of the query
 * @param {Model} obj
 * @param {Query} query
 */</span>
logicalOperators.$not = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, query)</span> </span>{
  <span class="hljs-keyword">return</span> !match(obj, query);
};


<span class="hljs-comment">/**
 * Use a function to match
 * @param {Model} obj
 * @param {Query} query
 */</span>
logicalOperators.$where = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, fn)</span> </span>{
  <span class="hljs-keyword">var</span> result;

  <span class="hljs-keyword">if</span> (!_.isFunction(fn)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$where operator used without a function"</span>; }

  result = fn.call(obj);
  <span class="hljs-keyword">if</span> (!_.isBoolean(result)) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"$where function must return boolean"</span>; }

  <span class="hljs-keyword">return</span> result;
};


<span class="hljs-comment">/**
 * Tell if a given document matches a query
 * @param {Object} obj Document to check
 * @param {Object} query
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">match</span> <span class="hljs-params">(obj, query)</span> </span>{
  <span class="hljs-keyword">var</span> queryKeys, queryKey, queryValue, i;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Primitive query against a primitive type
This is a bit of a hack since we construct an object with an arbitrary key only to dereference it later
But I don’t have time for a cleaner implementation now</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (isPrimitiveType(obj) || isPrimitiveType(query)) {
    <span class="hljs-keyword">return</span> matchQueryPart({ needAKey: obj }, <span class="hljs-string">'needAKey'</span>, query);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Normal query</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  queryKeys = <span class="hljs-built_in">Object</span>.keys(query);
  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; queryKeys.length; i += <span class="hljs-number">1</span>) {
    queryKey = queryKeys[i];
    queryValue = query[queryKey];
  
    <span class="hljs-keyword">if</span> (queryKey[<span class="hljs-number">0</span>] === <span class="hljs-string">'$'</span>) {
      <span class="hljs-keyword">if</span> (!logicalOperators[queryKey]) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Unknown logical operator "</span> + queryKey; }
      <span class="hljs-keyword">if</span> (!logicalOperators[queryKey](obj, queryValue)) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (!matchQueryPart(obj, queryKey, queryValue)) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};


<span class="hljs-comment">/**
 * Match an object against a specific { key: value } part of a query
 * if the treatObjAsValue flag is set, don't try to match every part separately, but the array as a whole
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">matchQueryPart</span> <span class="hljs-params">(obj, queryKey, queryValue, treatObjAsValue)</span> </span>{
  <span class="hljs-keyword">var</span> objValue = getDotValue(obj, queryKey)
    , i, keys, firstChars, dollarFirstChars;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Check if the value is an array if we don’t force a treatment as value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (util.isArray(objValue) &amp;&amp; !treatObjAsValue) {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Check if we are using an array-specific comparison function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (queryValue !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> queryValue === <span class="hljs-string">'object'</span> &amp;&amp; !util.isRegExp(queryValue)) {
      keys = <span class="hljs-built_in">Object</span>.keys(queryValue);      
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; keys.length; i += <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">if</span> (arrayComparisonFunctions[keys[i]]) { <span class="hljs-keyword">return</span> matchQueryPart(obj, queryKey, queryValue, <span class="hljs-literal">true</span>); }
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>If not, treat it as an array of { obj, query } where there needs to be at least one match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; objValue.length; i += <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">if</span> (matchQueryPart({ k: objValue[i] }, <span class="hljs-string">'k'</span>, queryValue)) { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }   <span class="hljs-comment">// k here could be any string</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>queryValue is an actual object. Determine whether it contains comparison operators
or only normal fields. Mixed objects are not allowed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (queryValue !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> queryValue === <span class="hljs-string">'object'</span> &amp;&amp; !util.isRegExp(queryValue)) {
    keys = <span class="hljs-built_in">Object</span>.keys(queryValue);
    firstChars = _.map(keys, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{ <span class="hljs-keyword">return</span> item[<span class="hljs-number">0</span>]; });
    dollarFirstChars = _.filter(firstChars, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(c)</span> </span>{ <span class="hljs-keyword">return</span> c === <span class="hljs-string">'$'</span>; });

    <span class="hljs-keyword">if</span> (dollarFirstChars.length !== <span class="hljs-number">0</span> &amp;&amp; dollarFirstChars.length !== firstChars.length) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">"You cannot mix operators and normal fields"</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>queryValue is an object of this form: { $comparisonOperator1: value1, … }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (dollarFirstChars.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; keys.length; i += <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">if</span> (!comparisonFunctions[keys[i]]) { <span class="hljs-keyword">throw</span> <span class="hljs-string">"Unknown comparison function "</span> + keys[i]; }

        <span class="hljs-keyword">if</span> (!comparisonFunctions[keys[i]](objValue, queryValue[keys[i]])) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Using regular expressions with basic querying</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (util.isRegExp(queryValue)) { <span class="hljs-keyword">return</span> comparisonFunctions.$regex(objValue, queryValue); }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>queryValue is either a native value or a normal object
Basic matching is possible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!areThingsEqual(objValue, queryValue)) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports.serialize = serialize;
<span class="hljs-built_in">module</span>.exports.deserialize = deserialize;
<span class="hljs-built_in">module</span>.exports.deepCopy = deepCopy;
<span class="hljs-built_in">module</span>.exports.checkObject = checkObject;
<span class="hljs-built_in">module</span>.exports.isPrimitiveType = isPrimitiveType;
<span class="hljs-built_in">module</span>.exports.modify = modify;
<span class="hljs-built_in">module</span>.exports.getDotValue = getDotValue;
<span class="hljs-built_in">module</span>.exports.match = match;
<span class="hljs-built_in">module</span>.exports.areThingsEqual = areThingsEqual;
<span class="hljs-built_in">module</span>.exports.compareThings = compareThings;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
